"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[534],{63773:(e,t,a)=>{a.d(t,{O:()=>l});var i=a(49198),r=a(87982),s=a(98712);const n={http:80,https:443,ftp:21};class l{constructor(){this.absUrl=this.wrapInDeprecationWarning(this.absUrl),this.hash=this.wrapInDeprecationWarning(this.hash),this.host=this.wrapInDeprecationWarning(this.host),this.path=this.wrapInDeprecationWarning(this.path),this.port=this.wrapInDeprecationWarning(this.port,"window.location"),this.protocol=this.wrapInDeprecationWarning(this.protocol,"window.location"),this.replace=this.wrapInDeprecationWarning(this.replace),this.search=this.wrapInDeprecationWarning(this.search),this.state=this.wrapInDeprecationWarning(this.state),this.url=this.wrapInDeprecationWarning(this.url)}wrapInDeprecationWarning(e,t){let a=this;return function(){return(0,i.d)("$location",e.name,t||"locationService"),e.apply(a,arguments)}}absUrl(){return`${window.location.origin}${this.url()}`}hash(e){if((0,s.GQ)("AngularLocationWrapper",!1,"Angular compat layer: hash"),e)throw new Error("AngularLocationWrapper method not implemented.");return s.E1.getLocation().hash.slice(1)}host(){return new URL(window.location.href).hostname}path(e){(0,s.GQ)("AngularLocationWrapper",!1,"Angular compat layer: path");const t=s.E1.getLocation();if(null!=e){let a=String(e);a=a.startsWith("/")?a:`/${a}`;const i=new URL(`${window.location.origin}${a}`);return s.E1.push({pathname:i.pathname,search:i.search.length>0?i.search:t.search,hash:i.hash.length>0?i.hash:t.hash}),this}return null===e?(s.E1.push("/"),this):t.pathname}port(){const e=new URL(window.location.href);return parseInt(e.port,10)||n[e.protocol]||null}protocol(){return new URL(window.location.href).protocol.slice(0,-1)}replace(){throw new Error("AngularLocationWrapper method not implemented.")}search(e,t){if((0,s.GQ)("AngularLocationWrapper",!1,"Angular compat layer: search"),!e)return s.E1.getSearchObject();if(e&&arguments.length>1)return s.E1.partial({[e]:t}),this;if(e){let t;t="object"==typeof e?Object.assign({},e):(0,s.Ox)(e);for(const e of Object.keys(t))null!==t[e]&&void 0!==t[e]||delete t[e];const a=r.Cj.renderUrl(s.E1.getLocation().pathname,t);s.E1.push(a)}return this}state(e){throw(0,s.GQ)("AngularLocationWrapper",!1,"Angular compat layer: state"),new Error("AngularLocationWrapper method not implemented.")}url(e){if((0,s.GQ)("AngularLocationWrapper",!1,"Angular compat layer: url"),void 0!==e)return e.startsWith("#")?s.E1.push(Object.assign({},s.E1.getLocation(),{hash:e})):e.startsWith("?")?s.E1.push(Object.assign({},s.E1.getLocation(),{search:e})):0===e.trim().length?s.E1.push("/"):s.E1.push(e),s.E1;const t=s.E1.getLocation();return`${t.pathname}${t.search}${t.hash}`}}},15866:(e,t,a)=>{a.d(t,{k:()=>u});var i=a(82897),r=a(5937),s=a(81351),n=a(19383),l=a(91082),o=a(60301);function h(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class u extends l.q{constructor(e,t){super(e,t),h(this,"contextSrv",void 0),h(this,"datasourceSrv",void 0),h(this,"timeSrv",void 0),h(this,"templateSrv",void 0),h(this,"interval",void 0),h(this,"intervalMs",void 0),h(this,"resolution",void 0),h(this,"timeInfo",void 0),h(this,"skipDataOnInit",!1),h(this,"dataList",[]),h(this,"querySubscription",void 0),h(this,"useDataFrames",!1),h(this,"panelData",void 0),h(this,"panelDataObserver",{next:e=>{if(this.panelData=e,e.state===r.Gu.Error&&(this.loading=!1,this.processDataError(e.error)),e.state===r.Gu.Loading)return this.loading=!0,void this.angularDirtyCheck();if(e.request){const{timeInfo:t}=e.request;t&&(this.timeInfo=t)}if(e.timeRange&&(this.range=e.timeRange),this.useDataFrames)this.handleDataFrames(e.series);else{const t=e.series.map((e=>(0,s.Zr)(e)));this.handleQueryResult({data:t})}this.angularDirtyCheck()}}),this.contextSrv=t.get("contextSrv"),this.datasourceSrv=t.get("datasourceSrv"),this.timeSrv=t.get("timeSrv"),this.templateSrv=t.get("templateSrv"),this.panel.datasource=this.panel.datasource||null,this.events.on(n.Kh.refresh,this.onMetricsPanelRefresh.bind(this)),this.events.on(n.Kh.panelTeardown,this.onPanelTearDown.bind(this)),this.events.on(n.Kh.componentDidMount,this.onMetricsPanelMounted.bind(this))}onMetricsPanelMounted(){const e=this.panel.getQueryRunner();this.querySubscription=e.getData({withTransforms:!0,withFieldConfig:!0}).subscribe(this.panelDataObserver)}onPanelTearDown(){this.querySubscription&&(this.querySubscription.unsubscribe(),this.querySubscription=null)}onMetricsPanelRefresh(){if(!this.otherPanelInFullscreenMode()){if(this.panel.snapshotData){this.updateTimeRange();let e=this.panel.snapshotData;return(0,i.isArray)(e)||(e=e.data),this.panelData={state:r.Gu.Done,series:e,timeRange:this.range},this.$timeout((()=>{this.events.emit(n.Kh.dataSnapshotLoad,e)}))}return delete this.error,this.loading=!0,this.datasourceSrv.get(this.panel.datasource,this.panel.scopedVars).then(this.issueQueries.bind(this)).catch((e=>{this.processDataError(e)}))}}processDataError(e){e.cancelled?console.log("Panel request cancelled",e):(this.error=e.message||"Request Error",e.data&&(e.data.message?this.error=e.data.message:e.data.error&&(this.error=e.data.error)),this.angularDirtyCheck())}angularDirtyCheck(){this.$scope.$root.$$phase||this.$scope.$digest()}updateTimeRange(e){this.datasource=e||this.datasource,this.range=this.timeSrv.timeRange();const t=(0,o.W1)(this.panel,this.range);this.timeInfo=t.timeInfo,this.range=t.timeRange}issueQueries(e){this.updateTimeRange(e),this.datasource=e;const t=this.panel;return t.getQueryRunner().run({datasource:t.datasource,queries:t.targets,panelId:t.id,dashboardId:this.dashboard.id,timezone:this.dashboard.getTimezone(),timeInfo:this.timeInfo,timeRange:this.range,maxDataPoints:t.maxDataPoints||this.width,minInterval:t.interval,scopedVars:t.scopedVars,cacheTimeout:t.cacheTimeout,transformations:t.transformations})}handleDataFrames(e){this.loading=!1,this.dashboard&&this.dashboard.snapshot&&(this.panel.snapshotData=e.map((e=>(0,s.og)(e))));try{this.events.emit(n.Kh.dataFramesReceived,e)}catch(e){this.processDataError(e)}}handleQueryResult(e){this.loading=!1,this.dashboard.snapshot&&(this.panel.snapshotData=e.data),e&&e.data||(console.log("Data source query result invalid, missing data field:",e),e={data:[]});try{this.events.emit(n.Kh.dataReceived,e.data)}catch(e){this.processDataError(e)}}}},91082:(e,t,a)=>{a.d(t,{q:()=>u});var i=a(82897),r=a(97437),s=a(19383),n=a(63773),l=a(78837),o=a(98163);function h(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class u{constructor(e,t){var a,i;h(this,"panel",void 0),h(this,"error",void 0),h(this,"pluginName",""),h(this,"pluginId",""),h(this,"editorTabs",void 0),h(this,"$scope",void 0),h(this,"$injector",void 0),h(this,"$timeout",void 0),h(this,"editModeInitiated",!1),h(this,"containerHeight",void 0),h(this,"events",void 0),h(this,"loading",!1),h(this,"timing",void 0),h(this,"$location",void 0),h(this,"onPluginTypeChange",(e=>{})),this.panel=null!==(a=this.panel)&&void 0!==a?a:e.$parent.panel,this.dashboard=null!==(i=this.dashboard)&&void 0!==i?i:e.$parent.dashboard,this.$injector=t,this.$scope=e,this.$timeout=t.get("$timeout"),this.editorTabs=[],this.$location=new n.O,this.events=new r.F,this.timing={};const o=l.ZP.panels[this.panel.type];o&&(this.pluginId=o.id,this.pluginName=o.name),e.$on(s.Kh.componentDidMount.name,(()=>this.panelDidMount()))}panelDidMount(){this.events.emit(s.Kh.componentDidMount),this.events.emit(s.Kh.initialized),this.dashboard.panelInitialized(this.panel)}renderingCompleted(){o.rv.renderingCompleted()}refresh(){this.panel.refresh()}publishAppEvent(e,t){this.$scope.$root.appEvent(e,t)}initEditMode(){this.editModeInitiated||(this.editModeInitiated=!0,this.events.emit(s.Kh.editModeInitialized))}addEditorTab(e,t,a,r){const s={title:e,directiveFn:t,icon:r};(0,i.isString)(t)&&(s.directiveFn=()=>({templateUrl:t})),a?this.editorTabs.splice(a,0,s):this.editorTabs.push(s)}getExtendedMenu(){const e=[];return this.events.emit(s.Kh.initPanelActions,e),e}async getAdditionalMenuItems(){return[]}otherPanelInFullscreenMode(){return this.dashboard.otherPanelInFullscreen(this.panel)}render(e){this.events.emit(s.Kh.render,e)}}},88643:(e,t,a)=>{a.d(t,{G:()=>s});var i=a(82897);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class s{constructor(e,t){var a,s,n,l,o;r(this,"target",void 0),r(this,"datasource",void 0),r(this,"panelCtrl",void 0),r(this,"panel",void 0),r(this,"hasRawMode",void 0),r(this,"error",void 0),r(this,"isLastQuery",void 0),this.$scope=e,this.$injector=t,this.panelCtrl=null!==(a=this.panelCtrl)&&void 0!==a?a:e.ctrl.panelCtrl,this.target=null!==(s=this.target)&&void 0!==s?s:e.ctrl.target,this.datasource=null!==(n=this.datasource)&&void 0!==n?n:e.ctrl.datasource,this.panel=null!==(l=null===(o=this.panelCtrl)||void 0===o?void 0:o.panel)&&void 0!==l?l:e.ctrl.panelCtrl.panel,this.isLastQuery=(0,i.indexOf)(this.panel.targets,this.target)===this.panel.targets.length-1}refresh(){this.panelCtrl.refresh()}}},2935:(e,t,a)=>{a.d(t,{K:()=>h});a(68404);var i,r,s=a(64624),n=a(24643),l=a(98356),o=a(45916);const h=e=>{const{onPropertyChanged:t,labelWidth:a,jsonData:h}=e,u=e=>a=>{t&&t(e,a)};return(0,o.jsxs)(s.C,{label:"Connection limits",children:[(0,o.jsx)(n._,{tooltip:i||(i=(0,o.jsxs)("span",{children:["The maximum number of open connections to the database.If ",(0,o.jsx)("i",{children:"Max idle connections"})," is greater than 0 and the ",(0,o.jsx)("i",{children:"Max open connections"})," is less than ",(0,o.jsx)("i",{children:"Max idle connections"}),", then",(0,o.jsx)("i",{children:"Max idle connections"})," will be reduced to match the ",(0,o.jsx)("i",{children:"Max open connections"})," limit. If set to 0, there is no limit on the number of open connections."]})),labelWidth:a,label:"Max open",children:(0,o.jsx)(l.Y,{placeholder:"unlimited",value:h.maxOpenConns,onChange:u("maxOpenConns")})}),(0,o.jsx)(n._,{tooltip:r||(r=(0,o.jsxs)("span",{children:["The maximum number of connections in the idle connection pool.If ",(0,o.jsx)("i",{children:"Max open connections"})," is greater than 0 but less than the ",(0,o.jsx)("i",{children:"Max idle connections"}),", then the ",(0,o.jsx)("i",{children:"Max idle connections"})," will be reduced to match the ",(0,o.jsx)("i",{children:"Max open connections"})," limit. If set to 0, no idle connections are retained."]})),labelWidth:a,label:"Max idle",children:(0,o.jsx)(l.Y,{placeholder:"2",value:h.maxIdleConns,onChange:u("maxIdleConns")})}),(0,o.jsx)(n._,{tooltip:"The maximum amount of time in seconds a connection may be reused. If set to 0, connections are reused forever.",labelWidth:a,label:"Max lifetime",children:(0,o.jsx)(l.Y,{placeholder:"14400",value:h.connMaxLifetime,onChange:u("connMaxLifetime")})})]})}},63843:(e,t,a)=>{a.d(t,{d:()=>u});a(68404);var i,r,s,n=a(81391),l=a(24643),o=a(67174),h=a(45916);const u=e=>{const{labelWidth:t,editorProps:a,showCACert:u,showKeyPair:c=!0}=e,{secureJsonFields:d}=a.options;return(0,h.jsxs)(h.Fragment,{children:[c?(0,h.jsx)(l._,{tooltip:i||(i=(0,h.jsx)("span",{children:"To authenticate with an TLS/SSL client certificate, provide the client certificate here."})),labelWidth:t,label:"TLS/SSL Client Certificate",children:(0,h.jsx)(o.Zk,{placeholder:"Begins with -----BEGIN CERTIFICATE-----",cols:45,rows:7,isConfigured:d&&d.tlsClientCert,onChange:(0,n.fi)(a,"tlsClientCert"),onReset:()=>{(0,n.Mf)(a,"tlsClientCert")}})}):null,u?(0,h.jsx)(l._,{tooltip:r||(r=(0,h.jsx)("span",{children:"If the selected TLS/SSL mode requires a server root certificate, provide it here."})),labelWidth:t,label:"TLS/SSL Root Certificate",children:(0,h.jsx)(o.Zk,{placeholder:"Begins with -----BEGIN CERTIFICATE-----",cols:45,rows:7,isConfigured:d&&d.tlsCACert,onChange:(0,n.fi)(a,"tlsCACert"),onReset:()=>{(0,n.Mf)(a,"tlsCACert")}})}):null,c?(0,h.jsx)(l._,{tooltip:s||(s=(0,h.jsx)("span",{children:"To authenticate with a client TLS/SSL certificate, provide the key here."})),labelWidth:t,label:"TLS/SSL Client Key",children:(0,h.jsx)(o.Zk,{placeholder:"Begins with -----BEGIN RSA PRIVATE KEY-----",cols:45,rows:7,isConfigured:d&&d.tlsClientKey,onChange:(0,n.fi)(a,"tlsClientKey"),onReset:()=>{(0,n.Mf)(a,"tlsClientKey")}})}):null]})}},45037:(e,t,a)=>{a.r(t),a.d(t,{plugin:()=>oe});var i=a(12822),r=a(68404),s=a(81391),n=a(64624),l=a(24643),o=a(1652),h=a(78454),u=a(28648),c=a(61884),d=a(72786),m=a(8771),p=a(2935),g=a(63843);let f,v;!function(e){e.disable="disable",e.require="require",e.verifyCA="verify-ca",e.verifyFull="verify-full"}(f||(f={})),function(e){e.filePath="file-path",e.fileContent="file-content"}(v||(v={}));var b=a(56491),y=a(6932),S=a(67436),w=a(82897),C=a(58799),x=a(71808),E=a(35778),_=a(14444),R=a(13924),P=a(45753),T=a(7166);function I(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class j{constructor(e,t,a){I(this,"target",void 0),I(this,"templateSrv",void 0),I(this,"scopedVars",void 0),this.target=e,this.templateSrv=t,this.scopedVars=a,e.format=e.format||"time_series",e.timeColumn=e.timeColumn||"time",e.metricColumn=e.metricColumn||"none",e.group=e.group||[],e.where=e.where||[{type:"macro",name:"$__timeFilter",params:[]}],e.select=e.select||[[{type:"column",params:["value"]}]],"rawQuery"in this.target||(e.rawQuery="rawSql"in e),this.interpolateQueryStr=this.interpolateQueryStr.bind(this)}unquoteIdentifier(e){return'"'===e[0]&&'"'===e[e.length-1]?e.substring(1,e.length-1).replace(/""/g,'"'):e}quoteIdentifier(e){return'"'+String(e).replace(/"/g,'""')+'"'}quoteLiteral(e){return"'"+String(e).replace(/'/g,"''")+"'"}escapeLiteral(e){return String(e).replace(/'/g,"''")}hasTimeGroup(){return(0,w.find)(this.target.group,(e=>"time"===e.type))}hasMetricColumn(){return"none"!==this.target.metricColumn}interpolateQueryStr(e,t,a){if(!t.multi&&!t.includeAll)return this.escapeLiteral(e);if("string"==typeof e)return this.quoteLiteral(e);return(0,w.map)(e,this.quoteLiteral).join(",")}render(e){const t=this.target;return this.target.rawQuery||"table"in this.target?(t.rawQuery||(t.rawSql=this.buildQuery()),e?this.templateSrv.replace(t.rawSql,this.scopedVars,this.interpolateQueryStr):t.rawSql):""}hasUnixEpochTimecolumn(){return["int4","int8","float4","float8","numeric"].indexOf(this.target.timeColumnType)>-1}buildTimeColumn(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=this.hasTimeGroup();let a,i="$__timeGroup";if(t){let r;r=t.params.length>1&&"none"!==t.params[1]?t.params.join(","):t.params[0],this.hasUnixEpochTimecolumn()&&(i="$__unixEpochGroup"),e&&(i+="Alias"),a=i+"("+this.target.timeColumn+","+r+")"}else a=this.target.timeColumn,e&&(a+=' AS "time"');return a}buildMetricColumn(){return this.hasMetricColumn()?this.target.metricColumn+" AS metric":""}buildValueColumns(){let e="";for(const t of this.target.select)e+=",\n  "+this.buildValueColumn(t);return e}buildValueColumn(e){let t="";t=(0,w.find)(e,(e=>"column"===e.type)).params[0];const a=(0,w.find)(e,(e=>"aggregate"===e.type||"percentile"===e.type)),i=(0,w.find)(e,(e=>"window"===e.type||"moving_window"===e.type));if(a){const e=a.params[0];switch(a.type){case"aggregate":t="first"===e||"last"===e?e+"("+t+","+this.target.timeColumn+")":e+"("+t+")";break;case"percentile":t=e+"("+a.params[1]+") WITHIN GROUP (ORDER BY "+t+")"}}if(i){const e=[];this.hasMetricColumn()&&e.push("PARTITION BY "+this.target.metricColumn),e.push("ORDER BY "+this.buildTimeColumn(!1));const r=e.join(" ");let s,n;switch(i.type){case"window":switch(i.params[0]){case"delta":s=t,n="lag("+s+") OVER ("+r+")",t=s+" - "+n;break;case"increase":s=t,n="lag("+s+") OVER ("+r+")",t="(CASE WHEN "+s+" >= "+n+" THEN "+s+" - "+n,t+=" WHEN "+n+" IS NULL THEN NULL ELSE "+s+" END)";break;case"rate":let e=this.target.timeColumn;a&&(e="min("+e+")"),s=t,n="lag("+s+") OVER ("+r+")",t="(CASE WHEN "+s+" >= "+n+" THEN "+s+" - "+n,t+=" WHEN "+n+" IS NULL THEN NULL ELSE "+s+" END)",t+="/extract(epoch from "+e+" - lag("+e+") OVER ("+r+"))";break;default:t=i.params[0]+"("+t+") OVER ("+r+")"}break;case"moving_window":t=i.params[0]+"("+t+") OVER ("+r+" ROWS "+i.params[1]+" PRECEDING)"}}const r=(0,w.find)(e,(e=>"alias"===e.type));return r&&(t+=" AS "+this.quoteIdentifier(r.params[0])),t}buildWhereClause(){let e="";const t=(0,w.map)(this.target.where,((e,t)=>{switch(e.type){case"macro":return e.name+"("+this.target.timeColumn+")";case"expression":return e.params.join(" ")}}));return t.length>0&&(e="\nWHERE\n  "+t.join(" AND\n  ")),e}buildGroupClause(){let e="",t="";for(let e=0;e<this.target.group.length;e++){const a=this.target.group[e];e>0&&(t+=", "),"time"===a.type?t+="1":t+=a.params[0]}return t.length&&(e="\nGROUP BY "+t,this.hasMetricColumn()&&(e+=",2")),e}buildQuery(){let e="SELECT";return e+="\n  "+this.buildTimeColumn(),this.hasMetricColumn()&&(e+=",\n  "+this.buildMetricColumn()),e+=this.buildValueColumns(),e+="\nFROM "+this.target.table,e+=this.buildWhereClause(),e+=this.buildGroupClause(),e+="\nORDER BY 1",this.hasMetricColumn()&&(e+=",2"),e}}j.$inject=["target","templateSrv","scopedVars"];var L=a(5970);class D{transformMetricFindResponse(e){const t=(0,P.z1)(e).data;if(!t||!t.length)return[];const a=t[0],i=[],r=a.fields.find((e=>"__text"===e.name)),s=a.fields.find((e=>"__value"===e.name));if(r&&s)for(let e=0;e<r.values.length;e++)i.push({text:""+r.values.get(e),value:""+s.values.get(e)});else i.push(...a.fields.flatMap((e=>e.values.toArray())).map((e=>({text:e}))));return(0,w.uniqBy)(i,"text")}async transformAnnotationResponse(e,t){const a=(0,P.z1)({data:t}).data;if(!a||!a.length)return[];const i=a[0],r=i.fields.find((e=>"time"===e.name));if(!r)throw new Error("Missing mandatory time column (with time column alias) in annotation query");const s=i.fields.find((e=>"timeend"===e.name)),n=i.fields.find((e=>"text"===e.name)),l=i.fields.find((e=>"tags"===e.name)),o=[];for(let t=0;t<i.length;t++){const a=s&&s.values.get(t)?Math.floor(s.values.get(t)):void 0;o.push({annotation:e.annotation,time:Math.floor(r.values.get(t)),timeEnd:a,text:n&&n.values.get(t)?n.values.get(t):"",tags:l&&l.values.get(t)?l.values.get(t).trim().split(/\s*,\s*/):[]})}return o}}function A(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class M extends R.CK{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,T.J)();super(e),A(this,"id",void 0),A(this,"name",void 0),A(this,"jsonData",void 0),A(this,"responseParser",void 0),A(this,"queryModel",void 0),A(this,"interval",void 0),A(this,"interpolateVariable",((e,t)=>{if("string"==typeof e)return t.multi||t.includeAll?this.queryModel.quoteLiteral(e):e;if("number"==typeof e)return e;return(0,w.map)(e,(e=>this.queryModel.quoteLiteral(e))).join(",")})),this.templateSrv=t,this.name=e.name,this.id=e.id,this.jsonData=e.jsonData,this.responseParser=new D,this.queryModel=new j({});const a=e.jsonData||{};this.interval=a.timeInterval||"1m"}interpolateVariablesInQueries(e,t){let a=e;return e&&e.length>0&&(a=e.map((e=>Object.assign({},e,{datasource:this.getRef(),rawSql:this.templateSrv.replace(e.rawSql,t,this.interpolateVariable),rawQuery:!0})))),a}filterQuery(e){return!e.hide}applyTemplateVariables(e,t){const a=new j(e,this.templateSrv,t);return{refId:e.refId,datasource:this.getRef(),rawSql:a.render(this.interpolateVariable),format:e.format}}async annotationQuery(e){if(!e.annotation.rawQuery)return Promise.reject({message:"Query missing in annotation definition"});const t={refId:e.annotation.name,datasource:this.getRef(),rawSql:this.templateSrv.replace(e.annotation.rawQuery,e.scopedVars,this.interpolateVariable),format:"table"};return(0,C.n)((0,y.i)().fetch({url:"/api/ds/query",method:"POST",data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[t]},requestId:e.annotation.name}).pipe((0,E.U)((async t=>await this.responseParser.transformAnnotationResponse(e,t.data)))))}metricFindQuery(e,t){var a,i,r,s;let n="tempvar";t&&t.variable&&t.variable.name&&(n=t.variable.name);const l=this.templateSrv.replace(e,(0,L._6)({query:e,wildcardChar:"%",options:t}),this.interpolateVariable),o={refId:n,datasource:this.getRef(),rawSql:l,format:"table"},h=null==t?void 0:t.range;return(0,C.n)((0,y.i)().fetch({url:"/api/ds/query",method:"POST",data:{from:null==h||null===(a=h.from)||void 0===a||null===(i=a.valueOf())||void 0===i?void 0:i.toString(),to:null==h||null===(r=h.to)||void 0===r||null===(s=r.valueOf())||void 0===s?void 0:s.toString(),queries:[o]},requestId:n}).pipe((0,E.U)((e=>this.responseParser.transformMetricFindResponse(e))),(0,_.K)((e=>(0,x.of)([])))))}_metaRequest(e){const t="meta",a={refId:t,datasource:this.getRef(),rawSql:e,format:"table"};return(0,y.i)().fetch({url:"/api/ds/query",method:"POST",data:{queries:[a]},requestId:t})}async getVersion(){const e=(await(0,C.n)(this._metaRequest("SELECT current_setting('server_version_num')::int/100"))).data.results.meta;var t;return e.frames?(null===(t=e.frames[0].data)||void 0===t?void 0:t.values[0])[0].toString():""}async getTimescaleDBVersion(){const e=(await(0,C.n)(this._metaRequest("SELECT extversion FROM pg_extension WHERE extname = 'timescaledb'"))).data.results.meta;var t;if(e.frames)return null===(t=e.frames[0].data)||void 0===t?void 0:t.values[0][0]}testDatasource(){return(0,C.n)(this._metaRequest("SELECT 1")).then((()=>({status:"success",message:"Database Connection OK"}))).catch((e=>(0,P.Gw)(e)))}targetContainsTemplate(e){let t="";if(e.rawQuery)t=e.rawSql;else{t=new j(e).buildQuery()}return t=t.replace("$__",""),this.templateSrv.containsTemplate(t)}}function O(e){let{props:t,setVersionOptions:a}=e;const[i,n]=(0,r.useState)(!1),{options:l,onOptionsChange:o}=t;(0,b.Z)((()=>{(function(e){var t,a;return e.url&&e.database&&e.user&&((null===(t=e.secureJsonData)||void 0===t?void 0:t.password)||(null===(a=e.secureJsonFields)||void 0===a?void 0:a.password))&&(e.jsonData.sslmode===f.disable||e.jsonData.sslCertFile&&e.jsonData.sslKeyFile&&e.jsonData.sslRootCertFile)&&!e.jsonData.postgresVersion&&!e.readOnly})(l)&&(async()=>{if(i){const e=await(0,S.ak)().loadDatasource(l.name);if(e instanceof M){const t=await e.getVersion(),i=parseInt(t,10);if(i>=906&&!l.jsonData.timescaledb){const t=await e.getTimescaleDBVersion();null!=t&&t.length&&(0,s.tp)({options:l,onOptionsChange:o},"timescaledb",!0)}const r=Math.trunc(i/100),n=i%100;let h=String(r);i<1e3&&(h=String(r)+"."+String(n)),V.find((e=>e.value===i))||a((e=>[...e,{label:h,value:i}])),void 0!==l.jsonData.postgresVersion&&l.jsonData.postgresVersion===i||(0,s.tp)({options:l,onOptionsChange:o},"postgresVersion",i)}}else{const e=await(0,y.i)().put(`/api/datasources/${l.id}`,l);n(!0),(0,s.fd)({options:l,onOptionsChange:o},"version",e.datasource.version)}})()}),[l,i,a])}var q,Q,N,F,W,$,k,B=a(45916);const V=[{label:"9.0",value:900},{label:"9.1",value:901},{label:"9.2",value:902},{label:"9.3",value:903},{label:"9.4",value:904},{label:"9.5",value:905},{label:"9.6",value:906},{label:"10",value:1e3},{label:"11",value:1100},{label:"12",value:1200},{label:"13",value:1300},{label:"14",value:1400},{label:"15",value:1500}];var G=a(19383),K=a(5831),H=a(60974),U=a(21169);class Y{constructor(e,t){this.target=e,this.queryModel=t}getOperators(e){switch(e){case"float4":case"float8":return["=","!=","<","<=",">",">="];case"text":case"varchar":case"char":return["=","!=","<","<=",">",">=","IN","NOT IN","LIKE","NOT LIKE","~","~*","!~","!~*"];default:return["=","!=","<","<=",">",">=","IN","NOT IN"]}}quoteIdentAsLiteral(e){return this.queryModel.quoteLiteral(this.queryModel.unquoteIdentifier(e))}findMetricTable(){let e="\nSELECT\n\tquote_ident(table_name) as table_name,\n\t( SELECT\n\t    quote_ident(column_name) as column_name\n\t  FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name IN ('timestamptz','timestamp')\n    ORDER BY ordinal_position LIMIT 1\n  ) AS time_column,\n  ( SELECT\n      quote_ident(column_name) AS column_name\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name='float8'\n    ORDER BY ordinal_position LIMIT 1\n  ) AS value_column\nFROM information_schema.tables t\nWHERE ";return e+=this.buildSchemaConstraint(),e+=" AND\n  EXISTS\n  ( SELECT 1\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name IN ('timestamptz','timestamp')\n  ) AND\n  EXISTS\n  ( SELECT 1\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name='float8'\n  )\nLIMIT 1\n;",e}buildSchemaConstraint(){return"\nquote_ident(table_schema) IN (\n  SELECT\n    CASE WHEN trim(s[i]) = '\"$user\"' THEN user ELSE trim(s[i]) END\n  FROM\n    generate_series(\n      array_lower(string_to_array(current_setting('search_path'),','),1),\n      array_upper(string_to_array(current_setting('search_path'),','),1)\n    ) as i,\n    string_to_array(current_setting('search_path'),',') s\n)"}buildTableConstraint(e){let t="";if(e.includes(".")){const a=e.split(".");return t="table_schema = "+this.quoteIdentAsLiteral(a[0]),t+=" AND table_name = "+this.quoteIdentAsLiteral(a[1]),t}return t=this.buildSchemaConstraint(),t+=" AND table_name = "+this.quoteIdentAsLiteral(e),t}buildTableQuery(){let e="SELECT quote_ident(table_name) FROM information_schema.tables WHERE ";return e+=this.buildSchemaConstraint(),e+=" ORDER BY table_name",e}buildColumnQuery(e){let t="SELECT quote_ident(column_name) FROM information_schema.columns WHERE ";switch(t+=this.buildTableConstraint(this.target.table),e){case"time":t+=" AND data_type IN ('timestamp without time zone','timestamp with time zone','bigint','integer','double precision','real')";break;case"metric":t+=" AND data_type IN ('text','character','character varying')";break;case"value":t+=" AND data_type IN ('bigint','integer','double precision','real','numeric')",t+=" AND column_name <> "+this.quoteIdentAsLiteral(this.target.timeColumn);break;case"group":t+=" AND data_type IN ('text','character','character varying','uuid')"}return t+=" ORDER BY column_name",t}buildValueQuery(e){let t="SELECT DISTINCT quote_literal("+e+")";return t+=" FROM "+this.target.table,t+=" WHERE $__timeFilter("+this.target.timeColumn+")",t+=" AND "+e+" IS NOT NULL",t+=" ORDER BY 1 LIMIT 100",t}buildDatatypeQuery(e){let t="SELECT udt_name FROM information_schema.columns WHERE ";return t+=this.buildTableConstraint(this.target.table),t+=" AND column_name = "+this.quoteIdentAsLiteral(e),t}buildAggregateQuery(){let e="SELECT DISTINCT proname FROM pg_aggregate ";return e+="INNER JOIN pg_proc ON pg_aggregate.aggfnoid = pg_proc.oid ",e+="INNER JOIN pg_type ON pg_type.oid=pg_proc.prorettype ",e+="WHERE pronargs=1 AND typname IN ('float8') AND aggkind='n' ORDER BY 1","SELECT DISTINCT proname FROM pg_aggregate INNER JOIN pg_proc ON pg_aggregate.aggfnoid = pg_proc.oid INNER JOIN pg_type ON pg_type.oid=pg_proc.prorettype WHERE pronargs=1 AND typname IN ('float8') AND aggkind='n' ORDER BY 1"}}function z(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class J{constructor(e){z(this,"type",void 0),z(this,"style",void 0),z(this,"label",void 0),z(this,"params",void 0),z(this,"defaultParams",void 0),z(this,"wrapOpen",void 0),z(this,"wrapClose",void 0),z(this,"separator",void 0),this.type=e.type,e.label?this.label=e.label:this.label=this.type[0].toUpperCase()+this.type.substring(1)+":",this.style=e.style,"function"===this.style?(this.wrapOpen="(",this.wrapClose=")",this.separator=", "):(this.wrapOpen=" ",this.wrapClose=" ",this.separator=" "),this.params=e.params,this.defaultParams=e.defaultParams}}class Z{constructor(e,t){if(z(this,"part",void 0),z(this,"def",void 0),z(this,"params",void 0),z(this,"label",void 0),z(this,"name",void 0),z(this,"datatype",void 0),this.part=e,this.def=t,!this.def)throw{message:"Could not find sql part "+e.type};this.datatype=e.datatype,e.name?(this.name=e.name,this.label=t.label+" "+e.name):(this.name="",this.label=t.label),e.params=e.params||(0,w.clone)(this.def.defaultParams),this.params=e.params}updateParam(e,t){""===e&&this.def.params[t].optional?this.params.splice(t,1):this.params[t]=e,this.part.params=this.params}}const X=[];function ee(e){X[e.type]=new J(e)}ee({type:"column",style:"label",params:[{type:"column",dynamicLookup:!0}],defaultParams:["value"]}),ee({type:"expression",style:"expression",label:"Expr:",params:[{name:"left",type:"string",dynamicLookup:!0},{name:"op",type:"string",dynamicLookup:!0},{name:"right",type:"string",dynamicLookup:!0}],defaultParams:["value","=","value"]}),ee({type:"macro",style:"label",label:"Macro:",params:[],defaultParams:[]}),ee({type:"aggregate",style:"label",params:[{name:"name",type:"string",options:[],baseOptions:["avg","count","min","max","sum","stddev","variance"],timescaleOptions:["first","last"]}],defaultParams:["avg"]}),ee({type:"percentile",label:"Aggregate:",style:"label",params:[{name:"name",type:"string",options:["percentile_cont","percentile_disc"]},{name:"fraction",type:"number",options:["0.5","0.75","0.9","0.95","0.99"]}],defaultParams:["percentile_cont","0.95"]}),ee({type:"alias",style:"label",params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"]}),ee({type:"time",style:"function",label:"time",params:[{name:"interval",type:"interval",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]},{name:"fill",type:"string",options:["none","NULL","previous","0"]}],defaultParams:["$__interval","none"]}),ee({type:"window",style:"label",params:[{name:"function",type:"string",options:["delta","increase","rate","sum"]}],defaultParams:["increase"]}),ee({type:"moving_window",style:"label",label:"Moving Window:",params:[{name:"function",type:"string",options:["avg"]},{name:"window_size",type:"number",options:["3","5","7","10","20"]}],defaultParams:["avg","5"]});const te={create:function(e){const t=X[e.type];return t?new Z(e,t):null}};function ae(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class ie extends H.QueryCtrl{constructor(e,t,a,i){super(e,t),ae(this,"formats",void 0),ae(this,"queryModel",void 0),ae(this,"metaBuilder",void 0),ae(this,"lastQueryMeta",void 0),ae(this,"lastQueryError",void 0),ae(this,"showHelp",!1),ae(this,"tableSegment",void 0),ae(this,"whereAdd",void 0),ae(this,"timeColumnSegment",void 0),ae(this,"metricColumnSegment",void 0),ae(this,"selectMenu",[]),ae(this,"selectParts",[[]]),ae(this,"groupParts",[]),ae(this,"whereParts",[]),ae(this,"groupAdd",void 0),this.templateSrv=a,this.uiSegmentSrv=i,this.target=this.target,this.queryModel=new j(this.target,a,this.panel.scopedVars),this.metaBuilder=new Y(this.target,this.queryModel),this.updateProjection(),this.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],this.target.rawSql||("table"===this.panelCtrl.panel.type?(this.target.format="table",this.target.rawSql="SELECT 1",this.target.rawQuery=!0):(this.target.rawSql="SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n",this.datasource.metricFindQuery(this.metaBuilder.findMetricTable()).then((e=>{if(e.length>0){this.target.table=e[0].text;let t=this.uiSegmentSrv.newSegment(this.target.table);this.tableSegment.html=t.html,this.tableSegment.value=t.value,this.target.timeColumn=e[1].text,t=this.uiSegmentSrv.newSegment(this.target.timeColumn),this.timeColumnSegment.html=t.html,this.timeColumnSegment.value=t.value,this.target.timeColumnType="timestamp",this.target.select=[[{type:"column",params:[e[2].text]}]],this.updateProjection(),this.updateRawSqlAndRefresh()}})))),this.target.table?this.tableSegment=i.newSegment(this.target.table):this.tableSegment=i.newSegment({value:"select table",fake:!0}),this.timeColumnSegment=i.newSegment(this.target.timeColumn),this.metricColumnSegment=i.newSegment(this.target.metricColumn),this.buildSelectMenu(),this.whereAdd=this.uiSegmentSrv.newPlusButton(),this.groupAdd=this.uiSegmentSrv.newPlusButton(),this.panelCtrl.events.on(G.Kh.dataReceived,this.onDataReceived.bind(this),e),this.panelCtrl.events.on(G.Kh.dataError,this.onDataError.bind(this),e)}updateRawSqlAndRefresh(){this.target.rawQuery||(this.target.rawSql=this.queryModel.buildQuery()),this.panelCtrl.refresh()}timescaleAggCheck(){const e=this.findAggregateIndex(this.selectParts[0]);if(-1!==e){const t=this.selectParts[0][e].def.params[0].baseOptions,a=t.concat(this.selectParts[0][e].def.params[0].timescaleOptions);!0===this.datasource.jsonData.timescaledb?this.selectParts[0][e].def.params[0].options=a:this.selectParts[0][e].def.params[0].options=t}}updateProjection(){this.selectParts=(0,w.map)(this.target.select,(e=>(0,w.map)(e,te.create).filter((e=>e)))),this.timescaleAggCheck(),this.whereParts=(0,w.map)(this.target.where,te.create).filter((e=>e)),this.groupParts=(0,w.map)(this.target.group,te.create).filter((e=>e))}updatePersistedParts(){this.target.select=(0,w.map)(this.selectParts,(e=>(0,w.map)(e,(e=>({type:e.def.type,datatype:e.datatype,params:e.params}))))),this.timescaleAggCheck(),this.target.where=(0,w.map)(this.whereParts,(e=>({type:e.def.type,datatype:e.datatype,name:e.name,params:e.params}))),this.target.group=(0,w.map)(this.groupParts,(e=>({type:e.def.type,datatype:e.datatype,params:e.params})))}buildSelectMenu(){this.selectMenu=[];const e={text:"Aggregate Functions",value:"aggregate",submenu:[{text:"Average",value:"avg"},{text:"Count",value:"count"},{text:"Maximum",value:"max"},{text:"Minimum",value:"min"},{text:"Sum",value:"sum"},{text:"Standard deviation",value:"stddev"},{text:"Variance",value:"variance"}]};if(!0===this.datasource.jsonData.timescaledb&&(e.submenu.push({text:"First",value:"first"}),e.submenu.push({text:"Last",value:"last"})),this.selectMenu.push(e),this.datasource.jsonData.postgresVersion>=904){const e={text:"Ordered-Set Aggregate Functions",value:"percentile",submenu:[{text:"Percentile (continuous)",value:"percentile_cont"},{text:"Percentile (discrete)",value:"percentile_disc"}]};this.selectMenu.push(e)}this.selectMenu.push({text:"Window Functions",value:"window",submenu:[{text:"Delta",value:"delta"},{text:"Increase",value:"increase"},{text:"Rate",value:"rate"},{text:"Sum",value:"sum"},{text:"Moving Average",value:"avg",type:"moving_window"}]}),this.selectMenu.push({text:"Alias",value:"alias"}),this.selectMenu.push({text:"Column",value:"column"})}toggleEditorMode(){this.target.rawQuery?K.Z.publish(new U.VJ({title:"Warning",text2:"Switching to query builder may overwrite your raw SQL.",icon:"exclamation-triangle",yesText:"Switch",onConfirm:()=>{this.$scope.$evalAsync((()=>{this.target.rawQuery=!this.target.rawQuery}))}})):this.$scope.$evalAsync((()=>{this.target.rawQuery=!this.target.rawQuery}))}resetPlusButton(e){const t=this.uiSegmentSrv.newPlusButton();e.html=t.html,e.value=t.value,e.type=t.type,e.fake=t.fake}getTableSegments(){return this.datasource.metricFindQuery(this.metaBuilder.buildTableQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))}tableChanged(){this.target.table=this.tableSegment.value,this.target.where=[],this.target.group=[],this.updateProjection();const e=this.uiSegmentSrv.newSegment("none");this.metricColumnSegment.html=e.html,this.metricColumnSegment.value=e.value,this.target.metricColumn="none";const t=this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("time")).then((e=>{if(e.length>0&&!(0,w.find)(e,(e=>e.text===this.target.timeColumn))){const t=this.uiSegmentSrv.newSegment(e[0].text);this.timeColumnSegment.html=t.html,this.timeColumnSegment.value=t.value}return this.timeColumnChanged(!1)})),a=this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("value")).then((e=>{e.length>0&&(this.target.select=[[{type:"column",params:[e[0].text]}]],this.updateProjection())}));Promise.all([t,a]).then((()=>{this.updateRawSqlAndRefresh()}))}getTimeColumnSegments(){return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("time")).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))}timeColumnChanged(e){return this.target.timeColumn=this.timeColumnSegment.value,this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(this.target.timeColumn)).then((t=>{if(1===t.length){let e;this.target.timeColumnType!==t[0].text&&(this.target.timeColumnType=t[0].text),e=this.queryModel.hasUnixEpochTimecolumn()?te.create({type:"macro",name:"$__unixEpochFilter",params:[]}):te.create({type:"macro",name:"$__timeFilter",params:[]}),this.whereParts.length>=1&&"macro"===this.whereParts[0].def.type?this.whereParts[0]=e:this.whereParts.splice(0,0,e)}this.updatePersistedParts(),!1!==e&&this.updateRawSqlAndRefresh()}))}getMetricColumnSegments(){return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("metric")).then(this.transformToSegments({addNone:!0})).catch(this.handleQueryError.bind(this))}metricColumnChanged(){this.target.metricColumn=this.metricColumnSegment.value,this.updateRawSqlAndRefresh()}onDataReceived(e){var t;this.lastQueryError=void 0,this.lastQueryMeta=null===(t=e[0])||void 0===t?void 0:t.meta}onDataError(e){if(e.data&&e.data.results){const t=e.data.results[this.target.refId];t&&(this.lastQueryError=t.error)}}transformToSegments(e){return t=>{const a=(0,w.map)(t,(e=>this.uiSegmentSrv.newSegment({value:e.text,expandable:e.expandable})));if(e.addTemplateVars)for(const t of this.templateSrv.getVariables()){let i;i="$"+t.name,e.templateQuoter&&!1===t.multi&&(i=e.templateQuoter(i)),a.unshift(this.uiSegmentSrv.newSegment({type:"template",value:i,expandable:!0}))}return e.addNone&&a.unshift(this.uiSegmentSrv.newSegment({type:"template",value:"none",expandable:!0})),a}}findAggregateIndex(e){return(0,w.findIndex)(e,(e=>"aggregate"===e.def.type||"percentile"===e.def.type))}findWindowIndex(e){return(0,w.findIndex)(e,(e=>"window"===e.def.type||"moving_window"===e.def.type))}addSelectPart(e,t,a){let i=t.value;a&&a.type&&(i=a.type);let r=te.create({type:i});a&&(r.params[0]=a.value);let s=!1;switch(i){case"column":const t=(0,w.map)(e,(e=>te.create({type:e.def.type,params:(0,w.clone)(e.params)})));this.selectParts.push(t);break;case"percentile":case"aggregate":0===this.target.group.length&&this.addGroup("time","$__interval");const a=this.findAggregateIndex(e);-1!==a?e[a]=r:e.splice(1,0,r),(0,w.find)(e,(e=>"alias"===e.def.type))||(s=!0);break;case"moving_window":case"window":const i=this.findWindowIndex(e);if(-1!==i)e[i]=r;else{const t=this.findAggregateIndex(e);-1!==t?e.splice(t+1,0,r):e.splice(1,0,r)}(0,w.find)(e,(e=>"alias"===e.def.type))||(s=!0);break;case"alias":s=!0}s&&(r=te.create({type:"alias",params:[e[0].params[0].replace(/"/g,"")]}),"alias"===e[e.length-1].def.type?e[e.length-1]=r:e.push(r)),this.updatePersistedParts(),this.updateRawSqlAndRefresh()}removeSelectPart(e,t){if("column"===t.def.type){if(this.selectParts.length>1){const t=(0,w.indexOf)(this.selectParts,e);this.selectParts.splice(t,1)}}else{const a=(0,w.indexOf)(e,t);e.splice(a,1)}this.updatePersistedParts()}handleSelectPartEvent(e,t,a){switch(a.name){case"get-param-options":switch(t.def.type){case"aggregate":return this.datasource.metricFindQuery(this.metaBuilder.buildAggregateQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"column":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("value")).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))}case"part-param-changed":this.updatePersistedParts(),this.updateRawSqlAndRefresh();break;case"action":this.removeSelectPart(e,t),this.updateRawSqlAndRefresh();break;case"get-part-actions":return Promise.resolve([{text:"Remove",value:"remove-part"}])}}handleGroupPartEvent(e,t,a){switch(a.name){case"get-param-options":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"part-param-changed":this.updatePersistedParts(),this.updateRawSqlAndRefresh();break;case"action":this.removeGroup(e,t),this.updateRawSqlAndRefresh();break;case"get-part-actions":return Promise.resolve([{text:"Remove",value:"remove-part"}])}}addGroup(e,t){let a=[t];"time"===e&&(a=["$__interval","none"]);const i=te.create({type:e,params:a});"time"===e?this.groupParts.splice(0,0,i):this.groupParts.push(i);for(const e of this.selectParts)if(!e.some((e=>"aggregate"===e.def.type))){const t=te.create({type:"aggregate",params:["avg"]});if(e.splice(1,0,t),!e.some((e=>"alias"===e.def.type))){const t=te.create({type:"alias",params:[e[0].part.params[0]]});e.push(t)}}this.updatePersistedParts()}removeGroup(e,t){"time"===e.def.type&&(this.selectParts=(0,w.map)(this.selectParts,(e=>(0,w.filter)(e,(e=>"aggregate"!==e.def.type&&"percentile"!==e.def.type))))),this.groupParts.splice(t,1),this.updatePersistedParts()}handleWherePartEvent(e,t,a,i){switch(a.name){case"get-param-options":switch(a.param.name){case"left":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"right":return["int4","int8","float4","float8","timestamp","timestamptz"].indexOf(t.datatype)>-1?Promise.resolve([]):this.datasource.metricFindQuery(this.metaBuilder.buildValueQuery(t.params[0])).then(this.transformToSegments({addTemplateVars:!0,templateQuoter:e=>this.queryModel.quoteLiteral(e)})).catch(this.handleQueryError.bind(this));case"op":return Promise.resolve(this.uiSegmentSrv.newOperators(this.metaBuilder.getOperators(t.datatype)));default:return Promise.resolve([])}case"part-param-changed":this.updatePersistedParts(),this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(t.params[0])).then((e=>{1===e.length&&(t.datatype=e[0].text)})),this.updateRawSqlAndRefresh();break;case"action":e.splice(i,1),this.updatePersistedParts(),this.updateRawSqlAndRefresh();break;case"get-part-actions":return Promise.resolve([{text:"Remove",value:"remove-part"}])}}getWhereOptions(){const e=[];return this.queryModel.hasUnixEpochTimecolumn()?e.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__unixEpochFilter"})):e.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__timeFilter"})),e.push(this.uiSegmentSrv.newSegment({type:"expression",value:"Expression"})),Promise.resolve(e)}addWhereAction(e,t){switch(this.whereAdd.type){case"macro":{const e=te.create({type:"macro",name:this.whereAdd.value,params:[]});this.whereParts.length>=1&&"macro"===this.whereParts[0].def.type?this.whereParts[0]=e:this.whereParts.splice(0,0,e);break}default:this.whereParts.push(te.create({type:"expression",params:["value","=","value"]}))}this.updatePersistedParts(),this.resetPlusButton(this.whereAdd),this.updateRawSqlAndRefresh()}getGroupOptions(){return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("group")).then((e=>{const t=[];this.queryModel.hasTimeGroup()||t.push(this.uiSegmentSrv.newSegment({type:"time",value:"time($__interval,none)"}));for(const a of e)t.push(this.uiSegmentSrv.newSegment({type:"column",value:a.text}));return t})).catch(this.handleQueryError.bind(this))}addGroupAction(){this.addGroup(this.groupAdd.type,this.groupAdd.value),this.resetPlusButton(this.groupAdd),this.updateRawSqlAndRefresh()}handleQueryError(e){return this.error=e.message||"Failed to issue metric query",[]}}ie.$inject=["$scope","$injector","templateSrv","uiSegmentSrv"],ae(ie,"templateUrl","partials/query.editor.html");class re{constructor(e){this.annotation=e.ctrl.annotation,this.annotation.rawQuery=this.annotation.rawQuery||"SELECT\n  extract(epoch from time_column) AS time,\n  text_column as text,\n  tags_column as tags\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n"}}var se,ne,le;re.$inject=["$scope"],le="partials/annotations.editor.html",(ne="templateUrl")in(se=re)?Object.defineProperty(se,ne,{value:le,enumerable:!0,configurable:!0,writable:!0}):se[ne]=le;const oe=new i.hf(M).setQueryCtrl(ie).setConfigEditor((e=>{var t;const[a,i]=(0,r.useState)(V);O({props:e,setVersionOptions:i});const{options:b,onOptionsChange:y}=e,S=b.jsonData,w=[{value:f.disable,label:"disable"},{value:f.require,label:"require"},{value:f.verifyCA,label:"verify-ca"},{value:f.verifyFull,label:"verify-full"}],C=[{value:v.filePath,label:"File system path"},{value:v.fileContent,label:"Certificate content"}],x=t=>a=>{(0,s.tp)(e,t,a.value)},E=e=>t=>{y(Object.assign({},b,{[e]:t.currentTarget.value}))};return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsxs)(n.C,{label:"PostgreSQL Connection",width:400,children:[(0,B.jsx)(l._,{labelWidth:20,label:"Host",children:(0,B.jsx)(o.I,{width:40,name:"host",type:"text",value:b.url||"",placeholder:"localhost:5432",onChange:E("url")})}),(0,B.jsx)(l._,{labelWidth:20,label:"Database",children:(0,B.jsx)(o.I,{width:40,name:"database",value:b.database||"",placeholder:"database name",onChange:E("database")})}),(0,B.jsxs)(h.Z,{children:[(0,B.jsx)(l._,{labelWidth:20,label:"User",children:(0,B.jsx)(o.I,{value:b.user||"",placeholder:"user",onChange:E("user")})}),(0,B.jsx)(l._,{label:"Password",children:(0,B.jsx)(u.m4,{placeholder:"Password",isConfigured:null===(t=b.secureJsonFields)||void 0===t?void 0:t.password,onReset:()=>{(0,s.Mf)(e,"password")},onBlur:(0,s.fi)(e,"password")})})]}),(0,B.jsx)(l._,{labelWidth:20,label:"TLS/SSL Mode",htmlFor:"tlsMode",tooltip:"This option determines whether or with what priority a secure TLS/SSL TCP/IP connection will be negotiated with the server.",children:(0,B.jsx)(c.Ph,{options:w,inputId:"tlsMode",value:S.sslmode||f.verifyFull,onChange:x("sslmode")})}),b.jsonData.sslmode!==f.disable?(0,B.jsx)(l._,{labelWidth:20,label:"TLS/SSL Method",htmlFor:"tlsMethod",tooltip:q||(q=(0,B.jsxs)("span",{children:["This option determines how TLS/SSL certifications are configured. Selecting ",(0,B.jsx)("i",{children:"File system path"})," will allow you to configure certificates by specifying paths to existing certificates on the local file system where Grafana is running. Be sure that the file is readable by the user executing the Grafana process.",(0,B.jsx)("br",{}),(0,B.jsx)("br",{}),"Selecting ",(0,B.jsx)("i",{children:"Certificate content"})," will allow you to configure certificates by specifying its content. The content will be stored encrypted in Grafana's database. When connecting to the database the certificates will be written as files to Grafana's configured data path on the local file system."]})),children:(0,B.jsx)(c.Ph,{options:C,inputId:"tlsMethod",value:S.tlsConfigurationMethod||v.filePath,onChange:x("tlsConfigurationMethod")})}):null]}),"disable"!==b.jsonData.sslmode?(0,B.jsx)(n.C,{label:"TLS/SSL Auth Details",children:b.jsonData.tlsConfigurationMethod===v.fileContent?(0,B.jsx)(g.d,{editorProps:e,labelWidth:25}):(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(l._,{tooltip:Q||(Q=(0,B.jsx)("span",{children:"If the selected TLS/SSL mode requires a server root certificate, provide the path to the file here."})),labelWidth:25,label:"TLS/SSL Root Certificate",children:(0,B.jsx)(o.I,{value:S.sslRootCertFile||"",onChange:(0,s._R)(e,"sslRootCertFile"),placeholder:"TLS/SSL root cert file"})}),(0,B.jsx)(l._,{tooltip:N||(N=(0,B.jsx)("span",{children:"To authenticate with an TLS/SSL client certificate, provide the path to the file here. Be sure that the file is readable by the user executing the grafana process."})),labelWidth:25,label:"TLS/SSL Client Certificate",children:(0,B.jsx)(o.I,{value:S.sslCertFile||"",onChange:(0,s._R)(e,"sslCertFile"),placeholder:"TLS/SSL client cert file"})}),(0,B.jsx)(l._,{tooltip:F||(F=(0,B.jsxs)("span",{children:["To authenticate with a client TLS/SSL certificate, provide the path to the corresponding key file here. Be sure that the file is ",(0,B.jsx)("i",{children:"only"})," readable by the user executing the grafana process."]})),labelWidth:25,label:"TLS/SSL Client Key",children:(0,B.jsx)(o.I,{value:S.sslKeyFile||"",onChange:(0,s._R)(e,"sslKeyFile"),placeholder:"TLS/SSL client key file"})})]})}):null,(0,B.jsx)(p.K,{labelWidth:20,jsonData:S,onPropertyChanged:(t,a)=>{(0,s.tp)(e,t,a)}}),(0,B.jsxs)(n.C,{label:"PostgreSQL details",children:[(0,B.jsx)(l._,{tooltip:"This option controls what functions are available in the PostgreSQL query builder",labelWidth:20,htmlFor:"postgresVersion",label:"Version",children:(0,B.jsx)(c.Ph,{value:S.postgresVersion||903,inputId:"postgresVersion",onChange:x("postgresVersion"),options:a})}),(0,B.jsx)(l._,{tooltip:W||(W=(0,B.jsxs)("span",{children:["TimescaleDB is a time-series database built as a PostgreSQL extension. If enabled, Grafana will use",(0,B.jsx)("code",{children:"time_bucket"})," in the ",(0,B.jsx)("code",{children:"$__timeGroup"})," macro and display TimescaleDB specific aggregate functions in the query builder."]})),labelWidth:20,label:"TimescaleDB",htmlFor:"timescaledb",children:(0,B.jsx)(d.x,{id:"timescaledb",value:S.timescaledb||!1,onChange:t=>{(0,s.tp)(e,"timescaledb",t.currentTarget.checked)}})}),(0,B.jsx)(l._,{tooltip:$||($=(0,B.jsxs)("span",{children:["A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example",(0,B.jsx)("code",{children:"1m"})," if your data is written every minute."]})),labelWidth:20,label:"Min time interval",children:(0,B.jsx)(o.I,{placeholder:"1m",value:S.timeInterval||"",onChange:(0,s._R)(e,"timeInterval")})})]}),k||(k=(0,B.jsxs)(m.b,{title:"User Permission",severity:"info",children:["The database user should only be granted SELECT permissions on the specified database & tables you want to query. Grafana does not validate that queries are safe so queries can contain any SQL statement. For example, statements like ",(0,B.jsx)("code",{children:"DELETE FROM user;"})," and ",(0,B.jsx)("code",{children:"DROP TABLE user;"})," would be executed. To protect against this we ",(0,B.jsx)("strong",{children:"Highly"})," recommend you create a specific PostgreSQL user with restricted permissions."]}))]})})).setAnnotationQueryCtrl(re)},60974:(e,t,a)=>{a.r(t),a.d(t,{MetricsPanelCtrl:()=>h,PanelCtrl:()=>o,QueryCtrl:()=>u,loadPluginCss:()=>r.Y});var i=a(86623),r=a(15895),s=a(15866),n=a(91082),l=a(88643);const o=(0,i.s)(n.q),h=(0,i.s)(s.k),u=(0,i.s)(l.G)},56491:(e,t,a)=>{a.d(t,{Z:()=>l});var i=a(68404);const r=function(e,t,a){var r=(0,i.useRef)(void 0);r.current&&a(t,r.current)||(r.current=t),(0,i.useEffect)(e,r.current)};var s=a(48322);const n=a.n(s)();const l=function(e,t){r(e,t,n)}},48322:e=>{e.exports=function e(t,a){if(t===a)return!0;if(t&&a&&"object"==typeof t&&"object"==typeof a){if(t.constructor!==a.constructor)return!1;var i,r,s;if(Array.isArray(t)){if((i=t.length)!=a.length)return!1;for(r=i;0!=r--;)if(!e(t[r],a[r]))return!1;return!0}if(t.constructor===RegExp)return t.source===a.source&&t.flags===a.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===a.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===a.toString();if((i=(s=Object.keys(t)).length)!==Object.keys(a).length)return!1;for(r=i;0!=r--;)if(!Object.prototype.hasOwnProperty.call(a,s[r]))return!1;for(r=i;0!=r--;){var n=s[r];if(("_owner"!==n||!t.$$typeof)&&!e(t[n],a[n]))return!1}return!0}return t!=t&&a!=a}}}]);
//# sourceMappingURL=postgresPlugin.0fe841f0c289ee1cf341.js.map