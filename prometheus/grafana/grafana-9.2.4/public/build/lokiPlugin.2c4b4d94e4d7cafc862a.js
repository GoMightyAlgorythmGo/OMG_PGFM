"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1598],{4184:(e,t,r)=>{r.r(t),r.d(t,{plugin:()=>On});var a,n,s,i,o,l,u,c,d,p=r(12822),m=r(82897),O=r(68404),g=r(21295),h=r(45916);function f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const v=['{job="default/prometheus"}'],b=["job","app","k8s_app"],y=[{title:"Log pipeline",expression:'{job="mysql"} |= "metrics" | logfmt | duration > 10s',label:'This query targets the MySQL job, keeps logs that contain the substring "metrics", and then parses and filters the logs further.'},{title:"Count over time",expression:'count_over_time({job="mysql"}[5m])',label:"This query counts all the log lines within the last five minutes for the MySQL job."},{title:"Rate",expression:'rate(({job="mysql"} |= "error" != "timeout")[10s])',label:"This query gets the per-second rate of all non-timeout errors within the last ten seconds for the MySQL job."},{title:"Aggregate, count, and group",expression:'sum(count_over_time({job="mysql"}[5m])) by (level)',label:"Get the count of logs during the last five minutes, grouping by level."}];class x extends O.PureComponent{constructor(){super(...arguments),f(this,"state",{userExamples:[]}),f(this,"checkUserLabels",(async()=>{var e;const t=null===(e=this.props.datasource)||void 0===e?void 0:e.languageProvider;if(t.started){const e=t.getLabelKeys()||[],r=b.find((t=>e.includes(t)));if(r){const e=await t.getLabelValues(r),a=(0,m.shuffle)(e).slice(0,5).map((e=>`{${r}="${e}"}`));this.setState({userExamples:a})}}else this.scheduleUserLabelChecking()}))}componentDidMount(){this.scheduleUserLabelChecking(),(0,g.ff)("grafana_loki_cheatsheet_opened",{})}componentWillUnmount(){clearTimeout(this.userLabelTimer)}scheduleUserLabelChecking(){this.userLabelTimer=setTimeout(this.checkUserLabels,1e3)}renderExpression(e){const{onClickExample:t}=this.props;return(0,h.jsx)("div",{className:"cheat-sheet-item__example",onClick:r=>(t({refId:"A",expr:e}),void(0,g.ff)("grafana_loki_cheatsheet_example_clicked",{})),children:(0,h.jsx)("code",{children:e})},e)}render(){const{userExamples:e}=this.state,t=e.length>0;return(0,h.jsxs)("div",{children:[a||(a=(0,h.jsx)("h2",{children:"Loki Cheat Sheet"})),(0,h.jsxs)("div",{className:"cheat-sheet-item",children:[n||(n=(0,h.jsx)("div",{className:"cheat-sheet-item__title",children:"See your logs"})),s||(s=(0,h.jsx)("div",{className:"cheat-sheet-item__label",children:"Start by selecting a log stream from the Log browser, or alternatively you can write a stream selector into the query field."})),t?(0,h.jsxs)("div",{children:[i||(i=(0,h.jsx)("div",{className:"cheat-sheet-item__label",children:"Here are some example streams from your logs:"})),e.map((e=>this.renderExpression(e)))]}):(0,h.jsxs)("div",{children:[o||(o=(0,h.jsx)("div",{className:"cheat-sheet-item__label",children:"Here is an example of a log stream:"})),this.renderExpression(v[0])]})]}),(0,h.jsxs)("div",{className:"cheat-sheet-item",children:[l||(l=(0,h.jsx)("div",{className:"cheat-sheet-item__title",children:"Combine stream selectors"})),this.renderExpression('{app="cassandra",namespace="prod"}'),u||(u=(0,h.jsx)("div",{className:"cheat-sheet-item__label",children:"Returns all log lines from streams that have both labels."}))]}),(0,h.jsxs)("div",{className:"cheat-sheet-item",children:[c||(c=(0,h.jsx)("div",{className:"cheat-sheet-item__title",children:"Filtering for search terms."})),this.renderExpression('{app="cassandra"} |~ "(duration|latency)s*(=|is|of)s*[d.]+"'),this.renderExpression('{app="cassandra"} |= "exact match"'),this.renderExpression('{app="cassandra"} != "do not match"'),d||(d=(0,h.jsxs)("div",{className:"cheat-sheet-item__label",children:[(0,h.jsx)("a",{href:"https://grafana.com/docs/loki/latest/logql/#log-pipeline",target:"logql",children:"LogQL"})," ","supports exact and regular expression filters."]}))]}),y.map((e=>(0,h.jsxs)("div",{className:"cheat-sheet-item",children:[(0,h.jsx)("div",{className:"cheat-sheet-item__title",children:e.title}),this.renderExpression(e.expression),(0,h.jsx)("div",{className:"cheat-sheet-item__label",children:e.label})]},e.expression)))]})}}var Q=r(38536),P=r(48147),_=r(5937),L=r(68694),R=r(68522),j=r(95378),q=r(40920),w=r(50966),$=r(82631),S=r(7524),T=r(33621),F=r(37393),k=r(19093);let C,E,N;!function(e){e.Aggregations="Aggregations",e.RangeFunctions="Range functions",e.Functions="Functions",e.Formats="Formats",e.LineFilters="Line filters",e.LabelFilters="Label filters",e.BinaryOps="Binary operations"}(C||(C={})),function(e){e.Json="json",e.Logfmt="logfmt",e.Regexp="regexp",e.Pattern="pattern",e.Unpack="unpack",e.LineFormat="line_format",e.LabelFormat="label_format",e.Rate="rate",e.CountOverTime="count_over_time",e.SumOverTime="sum_over_time",e.AvgOverTime="avg_over_time",e.MaxOverTime="max_over_time",e.MinOverTime="min_over_time",e.FirstOverTime="first_over_time",e.LastOverTime="last_over_time",e.StdvarOverTime="stdvar_over_time",e.StddevOverTime="stddev_over_time",e.QuantileOverTime="quantile_over_time",e.BytesRate="bytes_rate",e.BytesOverTime="bytes_over_time",e.AbsentOverTime="absent_over_time",e.Sum="sum",e.Avg="avg",e.Min="min",e.Max="max",e.Stddev="stddev",e.Stdvar="stdvar",e.Count="count",e.TopK="topk",e.BottomK="bottomk",e.LineContains="__line_contains",e.LineContainsNot="__line_contains_not",e.LineMatchesRegex="__line_matches_regex",e.LineMatchesRegexNot="__line_matches_regex_not",e.LineFilterIpMatches="__line_filter_ip_matches",e.LabelFilter="__label_filter",e.LabelFilterNoErrors="__label_filter_no_errors",e.LabelFilterIpMatches="__label_filter_ip_marches",e.Unwrap="unwrap",e.SumBy="__sum_by",e.SumWithout="__sum_without",e.Addition="__addition",e.Subtraction="__subtraction",e.MultiplyBy="__multiply_by",e.DivideBy="__divide_by",e.Modulo="__modulo",e.Exponent="__exponent",e.NestedQuery="__nested_query",e.EqualTo="__equal_to",e.NotEqualTo="__not_equal_to",e.GreaterThan="__greater_than",e.LessThan="__less_than",e.GreaterOrEqual="__greater_or_equal",e.LessOrEqual="__less_or_equal"}(E||(E={})),function(e){e[e.LineFilters=1]="LineFilters",e[e.LineFormats=2]="LineFormats",e[e.LabelFilters=3]="LabelFilters",e[e.Unwrap=4]="Unwrap",e[e.NoErrors=5]="NoErrors",e[e.RangeVectorFunction=5]="RangeVectorFunction",e[e.Last=6]="Last"}(N||(N={}));const U=[{id:E.Addition,name:"Add scalar",sign:"+"},{id:E.Subtraction,name:"Subtract scalar",sign:"-"},{id:E.MultiplyBy,name:"Multiply by scalar",sign:"*"},{id:E.DivideBy,name:"Divide by scalar",sign:"/"},{id:E.Modulo,name:"Modulo by scalar",sign:"%"},{id:E.Exponent,name:"Exponent",sign:"^"},{id:E.EqualTo,name:"Equal to",sign:"==",comparison:!0},{id:E.NotEqualTo,name:"Not equal to",sign:"!=",comparison:!0},{id:E.GreaterThan,name:"Greater than",sign:">",comparison:!0},{id:E.LessThan,name:"Less than",sign:"<",comparison:!0},{id:E.GreaterOrEqual,name:"Greater or equal to",sign:">=",comparison:!0},{id:E.LessOrEqual,name:"Less or equal to",sign:"<=",comparison:!0}],X=U.map((e=>{const t=[{name:"Value",type:"number"}],r=[2];return e.comparison&&(t.unshift({name:"Bool",type:"boolean",description:"If checked comparison will return 0 or 1 for the value rather than filtering."}),r.unshift(!1)),{id:e.id,name:e.name,params:t,defaultParams:r,alternativesKey:"binary scalar operations",category:C.BinaryOps,renderer:(a=e.sign,function(e,t,r){let n=e.params[0],s="";return 2===e.params.length&&(n=e.params[1],s=e.params[0]?" bool":""),`${r} ${a}${s} ${n}`}),addOperationHandler:k.PP};var a}));var D=r(46196),I=r(90915),V=r(61884),M=r(86558),A=r(58799),W=r(71808),Y=r(3321),G=r(35778),z=r(14444),K=r(75250),B=r(23541),Z=r(76500),H=r(32025),J=r(91115),ee=r(75414),te=r(35089),re=r(60421),ae=r(56193),ne=r(67922),se=r(13924),ie=r(28783),oe=r(62236),le=r(75478),ue=r(7166),ce=r(25857),de=r(18887),pe=r(25890),me=r(20707),Oe=r.n(me),ge=r(57706),he=r.n(ge),fe=r(82777),ve=r(17245);let be,ye,xe,Qe;function Pe(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e){e.Stream="streams",e.Vector="vector",e.Matrix="matrix"}(be||(be={})),function(e){e.Range="range",e.Instant="instant",e.Stream="stream"}(ye||(ye={})),function(e){e.Backward="backward",e.Forward="forward"}(xe||(xe={})),function(e){e[e.LabelNames=0]="LabelNames",e[e.LabelValues=1]="LabelValues"}(Qe||(Qe={}));const _e=["job","namespace"],Le="{}",Re=[{label:"$__interval",sortValue:"$__interval"},{label:"$__range",sortValue:"$__range"},{label:"1m",sortValue:"00:01:00"},{label:"5m",sortValue:"00:05:00"},{label:"10m",sortValue:"00:10:00"},{label:"30m",sortValue:"00:30:00"},{label:"1h",sortValue:"01:00:00"},{label:"1d",sortValue:"24:00:00"}],je=e=>({label:e,filterText:`"${e}"`});class qe extends p.iL{constructor(e,t){super(),Pe(this,"labelKeys",void 0),Pe(this,"labelFetchTs",void 0),Pe(this,"started",!1),Pe(this,"datasource",void 0),Pe(this,"lookupsDisabled",!1),Pe(this,"seriesCache",new(Oe())({max:10})),Pe(this,"labelsCache",new(Oe())({max:10})),Pe(this,"cleanText",(e=>e.replace(/[{}[\]="(),!~+\-*/^%\|]/g,"").trim())),Pe(this,"request",(async(e,t)=>{try{return await this.datasource.metadataRequest(e,t)}catch(e){console.error(e)}})),Pe(this,"start",(()=>(this.startTask||(this.startTask=this.fetchLabels().then((()=>(this.started=!0,[])))),this.startTask))),Pe(this,"getBeginningCompletionItems",(e=>({suggestions:[...this.getEmptyCompletionItems(e).suggestions,...this.getTermCompletionItems().suggestions]}))),Pe(this,"getTermCompletionItems",(()=>{const e=[];return e.push({prefixMatch:!0,label:"Functions",items:ve.r8.map((e=>Object.assign({},e,{kind:"function"})))}),{suggestions:e}})),Pe(this,"getPipeCompletionItem",(()=>{const e=[];return e.push({label:"Operators",items:ve.Rd.map((e=>Object.assign({},e,{kind:"operators"})))}),e.push({label:"Parsers",items:ve.uR.map((e=>Object.assign({},e,{kind:"parsers"})))}),{suggestions:e}})),Pe(this,"fetchSeriesLabels",(async e=>{const t=this.datasource.interpolateString(e),r="series",{start:a,end:n}=this.datasource.getTimeRangeParams(),s=this.generateCacheKey(r,a,n,t);let i=this.seriesCache.get(s);if(!i){this.seriesCache.set(s,{});const e={"match[]":t,start:a,end:n},o=await this.request(r,e),{values:l}=(0,fe.DY)(o);i=l,this.seriesCache.set(s,i)}return i})),Pe(this,"fetchSeries",(async e=>{const{start:t,end:r}=this.datasource.getTimeRangeParams(),a={"match[]":e,start:t,end:r};return await this.request("series",a)})),this.datasource=e,this.labelKeys=[],this.labelFetchTs=0,Object.assign(this,t)}getSyntax(){return ve.ZP}getLabelKeys(){return this.labelKeys}async provideCompletionItems(e,t){const{wrapperClasses:r,value:a,prefix:n,text:s}=e,i={suggestions:[]};if(!a)return i;const o=0===(null==a?void 0:a.document.text.length),l=a.document.getTextsAtRange(a.selection),u=1===l.size?l.first().getText():null,c=u?u[a.selection.anchor.offset]:null,d=r.length>3,p=n&&!d,m=!c||")"===c,O=n&&!s.match(/^['"~=\]})\s]+$/)&&m,g=s.match(/[+\-*/^%]/);return r.includes("context-range")?this.getRangeCompletionItems():r.includes("context-labels")?await this.getLabelCompletionItems(e):r.includes("context-pipe")?this.getPipeCompletionItem():o?this.getEmptyCompletionItems(t):p&&m&&!g?this.getBeginningCompletionItems(t):p&&O?this.getTermCompletionItems():i}getEmptyCompletionItems(e){const t=null==e?void 0:e.history,r=[];if(null!=t&&t.length){const e=(0,m.chain)(t).map((e=>e.query.expr)).filter().uniq().take(10).map(je).map((e=>function(e,t){const r=Date.now()-864e5,a=t.filter((t=>t.ts>r&&t.query.expr===e.label));let n=`Queried ${a.length} times in the last 24h.`;const s=a[0];s&&(n=`${n} Last queried ${(0,J.CQ)(s.ts).fromNow()}.`);return Object.assign({},e,{documentation:n})}(e,t))).value();r.push({prefixMatch:!0,skipSort:!0,label:"History",items:e})}return{suggestions:r}}getRangeCompletionItems(){return{context:"context-range",suggestions:[{label:"Range vector",items:[...Re]}]}}async getLabelCompletionItems(e){let{text:t,wrapperClasses:r,labelKey:a,value:n}=e,s="context-labels";const i=[];if(!n)return{context:s,suggestions:[]};const o=n.anchorBlock.getText(),l=n.selection.anchor.offset,u=t.match(/^(=|=~|!=|!~)/);let c,d;try{d=(0,fe.rV)(o,l),c=d.selector}catch{c=Le}if(!a&&c===Le){await this.start();return{context:s,suggestions:[{label:"Labels",items:this.getLabelKeys().map(je)}]}}const p=d?d.labelKeys:[];let O;if(c)if(c===Le&&a){O={[a]:await this.getLabelValues(a)}}else O=await this.getSeriesLabels(c);if(!O)return console.warn(`Server did not return any values for selector = ${c}`),{context:s,suggestions:i};if(t&&u||r.includes("attr-value"))a&&O[a]&&(s="context-label-values",i.push({label:`Label values for "${a}"`,items:O[a].map(je).filter((e=>{let{filterText:r}=e;return r!==t}))}));else{const e=O?Object.keys(O):_e;if(e){const t=(0,m.difference)(e,p);if(t.length){const e={label:"Labels",items:t.map((e=>({label:e})))};i.push(e)}}}return{context:s,suggestions:i}}importFromAbstractQuery(e){return{refId:e.refId,expr:(0,fe.PL)(e),queryType:ye.Range}}exportToAbstractQuery(e){const t=e.expr;if(!t||0===t.length)return{refId:e.refId,labelMatchers:[]};const r=he().tokenize(t,ve.ZP);return{refId:e.refId,labelMatchers:(0,fe.UO)(r)}}async getSeriesLabels(e){if(!this.lookupsDisabled)try{return await this.fetchSeriesLabels(e)}catch(e){return void console.error(e)}}async fetchLabels(){const e=this.datasource.getTimeRangeParams();this.labelFetchTs=Date.now().valueOf();const t=await this.request("labels",e);if(Array.isArray(t)){const e=t.slice().sort().filter((e=>"__name__"!==e));this.labelKeys=e}return[]}async refreshLogLabels(e){(this.labelKeys&&Date.now().valueOf()-this.labelFetchTs>3e4||e)&&await this.fetchLabels()}generateCacheKey(e,t,r,a){return[e,this.roundTime(t),this.roundTime(r),a].join()}roundTime(e){return e?Math.floor(e/1e6/1e3/60/5):0}async getLabelValues(e){return await this.fetchLabelValues(e)}async fetchLabelValues(e){var t;const r=encodeURIComponent(this.datasource.interpolateString(e)),a=`label/${r}/values`,n=this.datasource.getTimeRangeParams(),{start:s,end:i}=n,o=this.generateCacheKey(a,s,i,r),l={start:s,end:i};let u=this.labelsCache.get(o);if(!u){this.labelsCache.set(o,[]);const e=await this.request(a,l);Array.isArray(e)&&(u=e.slice().sort(),this.labelsCache.set(o,u))}return null!==(t=u)&&void 0!==t?t:[]}}var we=r(46089),$e=r(77809),Se=r(71114),Te=r(24298),Fe=r(9683),ke=r(72646),Ce=r(18151),Ee=r(16976),Ne=r(4203),Ue=r(25918),Xe={url:"",deserializer:function(e){return JSON.parse(e.data)},serializer:function(e){return JSON.stringify(e)}},De=function(e){function t(t,r){var a=e.call(this)||this;if(a._socket=null,t instanceof Ee.y)a.destination=r,a.source=t;else{var n=a._config=(0,Fe.__assign)({},Xe);if(a._output=new ke.x,"string"==typeof t)n.url=t;else for(var s in t)t.hasOwnProperty(s)&&(n[s]=t[s]);if(!n.WebSocketCtor&&WebSocket)n.WebSocketCtor=WebSocket;else if(!n.WebSocketCtor)throw new Error("no WebSocket constructor can be found");a.destination=new Ue.t}return a}return(0,Fe.__extends)(t,e),t.prototype.lift=function(e){var r=new t(this._config,this.destination);return r.operator=e,r.source=this,r},t.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new Ue.t),this._output=new ke.x},t.prototype.multiplex=function(e,t,r){var a=this;return new Ee.y((function(n){try{a.next(e())}catch(e){n.error(e)}var s=a.subscribe({next:function(e){try{r(e)&&n.next(e)}catch(e){n.error(e)}},error:function(e){return n.error(e)},complete:function(){return n.complete()}});return function(){try{a.next(t())}catch(e){n.error(e)}s.unsubscribe()}}))},t.prototype._connectSocket=function(){var e=this,t=this._config,r=t.WebSocketCtor,a=t.protocol,n=t.url,s=t.binaryType,i=this._output,o=null;try{o=a?new r(n,a):new r(n),this._socket=o,s&&(this._socket.binaryType=s)}catch(e){return void i.error(e)}var l=new Ne.w0((function(){e._socket=null,o&&1===o.readyState&&o.close()}));o.onopen=function(t){if(!e._socket)return o.close(),void e._resetState();var r=e._config.openObserver;r&&r.next(t);var a=e.destination;e.destination=Ce.Lv.create((function(t){if(1===o.readyState)try{var r=e._config.serializer;o.send(r(t))}catch(t){e.destination.error(t)}}),(function(t){var r=e._config.closingObserver;r&&r.next(void 0),t&&t.code?o.close(t.code,t.reason):i.error(new TypeError("WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }")),e._resetState()}),(function(){var t=e._config.closingObserver;t&&t.next(void 0),o.close(),e._resetState()})),a&&a instanceof Ue.t&&l.add(a.subscribe(e.destination))},o.onerror=function(t){e._resetState(),i.error(t)},o.onclose=function(t){o===e._socket&&e._resetState();var r=e._config.closeObserver;r&&r.next(t),t.wasClean?i.complete():i.error(t)},o.onmessage=function(t){try{var r=e._config.deserializer;i.next(r(t))}catch(e){i.error(e)}}},t.prototype._subscribe=function(e){var t=this,r=this.source;return r?r.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add((function(){var e=t._socket;0===t._output.observers.length&&(!e||1!==e.readyState&&0!==e.readyState||e.close(),t._resetState())})),e)},t.prototype.unsubscribe=function(){var t=this._socket;!t||1!==t.readyState&&0!==t.readyState||t.close(),this._resetState(),e.prototype.unsubscribe.call(this)},t}(ke.u);var Ie=r(52638),Ve=r(25058),Me=r(91152);const Ae=function(e){if(!(0,Me.Z)(e))throw TypeError("Invalid UUID");var t,r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=255&t,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=255&t,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=255&t,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=255&t,r[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=t/4294967296&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=255&t,r};function We(e,t,r,a){switch(e){case 0:return t&r^~t&a;case 1:case 3:return t^r^a;case 2:return t&r^t&a^r&a}}function Ye(e,t){return e<<t|e>>>32-t}const Ge=function(e,t,r){function a(e,a,n,s){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}(e)),"string"==typeof a&&(a=Ae(a)),16!==a.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var i=new Uint8Array(16+e.length);if(i.set(a),i.set(e,a.length),(i=r(i))[6]=15&i[6]|t,i[8]=63&i[8]|128,n){s=s||0;for(var o=0;o<16;++o)n[s+o]=i[o];return n}return(0,Ve.Z)(i)}try{a.name=e}catch(e){}return a.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",a.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",a}("v5",80,(function(e){var t=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var a=unescape(encodeURIComponent(e));e=[];for(var n=0;n<a.length;++n)e.push(a.charCodeAt(n))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var s=e.length/4+2,i=Math.ceil(s/16),o=new Array(i),l=0;l<i;++l){for(var u=new Uint32Array(16),c=0;c<16;++c)u[c]=e[64*l+4*c]<<24|e[64*l+4*c+1]<<16|e[64*l+4*c+2]<<8|e[64*l+4*c+3];o[l]=u}o[i-1][14]=8*(e.length-1)/Math.pow(2,32),o[i-1][14]=Math.floor(o[i-1][14]),o[i-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<i;++d){for(var p=new Uint32Array(80),m=0;m<16;++m)p[m]=o[d][m];for(var O=16;O<80;++O)p[O]=Ye(p[O-3]^p[O-8]^p[O-14]^p[O-16],1);for(var g=r[0],h=r[1],f=r[2],v=r[3],b=r[4],y=0;y<80;++y){var x=Math.floor(y/20),Q=Ye(g,5)+We(x,h,f,v)+b+t[x]+p[y]>>>0;b=v,v=f,f=Ye(h,30)>>>0,h=g,g=Q}r[0]=r[0]+g>>>0,r[1]=r[1]+h>>>0,r[2]=r[2]+f>>>0,r[3]=r[3]+v>>>0,r[4]=r[4]+b>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,255&r[0],r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,255&r[1],r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,255&r[2],r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,255&r[3],r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,255&r[4]]}));function ze(e,t,r,a,n){let s=Ge(`${e}_${t}_${r}`,"6ec946da-0f49-47a8-983a-1d76d17e7c92");if(s in a){const e=a[s]+1;a[s]=e,s=`${s}_${e}`}else a[s]=0;return n?`${s}_${n}`:s}class Ke{constructor(){var e,t,r;r={},(t="streams")in(e=this)?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}getStream(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,r=this.streams[e.url];if(r)return r;const a=new Ie.a({capacity:e.size});var n;return a.addField({name:"Time",type:H.fS.time,config:{}}),a.addField({name:"Line",type:H.fS.string}),a.addField({name:"id",type:H.fS.string}),a.meta=Object.assign({},a.meta,{preferredVisualisationType:"logs"}),a.refId=e.refId,r=(n=e.url,new De(n)).pipe((0,G.U)((e=>(function(e,t){const r=e.streams;if(!r||!r.length)return;const a=t.fields[0],n=t.fields[1],s=t.fields[2],i={};for(const e of r){const r=Object.entries(e.stream).map((e=>{let[t,r]=e;return`${t}="${r}"`})).sort().join("");for(const[o,l]of e.values)a.values.add(new Date(parseInt(o.slice(0,-6),10)).toISOString()),n.values.add(l),s.values.add(ze(o,r,l,i,t.refId))}}(e,a),[a]))),(0,$e.a)((e=>e.pipe((0,Se.z)(((e,r)=>{const a=r+1;return 1006===e.code&&a<30?(a>10&&console.warn(`Websocket connection is being disrupted. We keep reconnecting but consider starting new live tailing again. Error: ${e.reason}`),(0,we.H)(t)):(0,M._)(e)}))))),(0,Te.x)((()=>{delete this.streams[e.url]}))),this.streams[e.url]=r,r}}var Be=r(81351),Ze=r(75560),He=r(7501);function Je(e){const t=(0,He.F)(),r=e.reduce(((e,r)=>{if(r.datasourceUid){var a;const n=t.getInstanceSettings(r.datasourceUid);e.push({title:r.urlDisplayLabel||"",url:"",internal:{query:{query:r.url},datasourceUid:r.datasourceUid,datasourceName:null!==(a=null==n?void 0:n.name)&&void 0!==a?a:"Data source not found"}})}else r.url&&e.push({title:r.urlDisplayLabel||"",url:r.url});return e}),[]);return{name:e[0].name,type:H.fS.string,config:{links:r},values:new Ze.G([])}}function et(e){const t=e.filter((e=>void 0!==e.refId)),r=(0,m.groupBy)(t,(e=>e.refId));return Object.entries(r).map((e=>{let[t,r]=e;return function(e,t){const r={name:"Time",config:{},values:new Ze.G,type:H.fS.time},a={name:`Value #${t}`,config:{},values:new Ze.G,type:H.fS.number},n=new Set(e.map((e=>e.fields.map((e=>{var t;return Object.keys(null!==(t=e.labels)&&void 0!==t?t:{})})).flat())).flat()),s=Array.from(n).sort().map((e=>({name:e,config:{filterable:!0},values:new Ze.G,type:H.fS.string})));return e.forEach((e=>{var t;const n=e.fields.find((e=>e.type===H.fS.time)),i=e.fields.find((e=>e.type===H.fS.number));if(null==n||null==i)return;const o=n.values.toArray(),l=i.values.toArray();for(let e of o)r.values.add(e);for(let e of l)a.values.add(e);const u=null!==(t=i.labels)&&void 0!==t?t:{};for(let e of s){var c;const t=null!==(c=u[e.name])&&void 0!==c?c:"";for(let r=0;r<l.length;r++)e.values.add(t)}})),{fields:[r,...s,a],refId:t,meta:{preferredVisualisationType:"table"},length:r.values.length}}(r,t)}))}var tt=r(26048);const rt={json:1,logfmt:2,unpack:3,pattern:4,regexp:5,ip:7,label_format:8,line_format:9,label_replace:10,offset:11,bool:12,on:13,ignoring:14,group_left:15,group_right:16,unwrap:6},at=(e,t)=>rt[e.toLowerCase()]||-1,nt={by:17,without:18,and:19,or:20,unless:21,sum:22,avg:23,count:24,max:25,min:26,stddev:27,stdvar:28,bottomk:29,topk:30},st=(e,t)=>nt[e.toLowerCase()]||-1,it={__proto__:null,count_over_time:255,rate:257,bytes_over_time:259,bytes_rate:261,avg_over_time:263,sum_over_time:265,min_over_time:267,max_over_time:269,stddev_over_time:271,stdvar_over_time:273,quantile_over_time:275,first_over_time:277,last_over_time:279,absent_over_time:281,bytes:287,duration:289,duration_seconds:291},ot=tt.WQ.deserialize({version:14,states:"ASOYQPOOO#VQPO'#DPO$fQPO'#DOOYQPO'#DOOOQO'#D{'#D{O$sQPO'#DzOOQO'#Eg'#EgO$xQPO'#EfQ%TQPOOOOQO'#Eu'#EuO&UQPO'#EuO&ZQPO'#EvOOQO'#Dy'#DyOOQO'#C}'#C}OOQO'#D|'#D|OOQO'#D}'#D}OOQO'#EO'#EOOOQO'#EP'#EPOOQO'#EQ'#EQOOQO'#ER'#EROOQO'#ES'#ESOOQO'#ET'#ETOOQO'#EU'#EUOOQO'#EV'#EVOOQO'#EW'#EWOOQO'#EX'#EXOOQO'#EY'#EYOOQO'#EZ'#EZO&`QPO'#DROOQO'#DQ'#DQO&nQPO,59kOOQO'#D^'#D^O&vQPO'#D]OOQO'#D['#D[O'OQPO'#DZO(iQPO'#DZOOQO'#DY'#DYO*bQPO,59jO+pQPO,59jO+wQPO,5:eO,OQPO,5:fO,ZQPO'#EdO.YQPO,5;QO.aQPO,5;QO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SOOQO,5;a,5;aOYQPO,5;bO0lQPO,59mO0qQPO1G/VOOQO1G/V1G/VOOQO'#Da'#DaOOQO,59w,59wO0yQPO,59wOOQO,59v,59vO1OQPO'#DRO1mQPO'#DcOOQO'#Dc'#DcO3ZQPO'#DcOOQO'#Di'#DiOOQO'#Dg'#DgO)OQPO'#DgO3`QPO,59uO4yQPO'#DuO5OQPO'#DvOOQO,59u,59uOOQO,59t,59tOOQO1G/U1G/UOOQO1G0P1G0PO5TQPO'#E[O,RQPO'#E[O5iQPO1G0QO5nQPO1G0QO5sQPO,5;OO5{QPO1G0lO7WQPO1G0lO7_QPO1G0lO7fQPO'#EjO9hQPO'#EiO9rQPO'#EiOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nO9|QPO1G0|OOQO1G/X1G/XOOQO1G/W1G/WOOQO7+$q7+$qO:TQPO1G/cO:YQPO,59mO:`QPO,5:UO:kQPO'#DfOOQO'#De'#DeO:pQPO,5:OOOQO,59},59}O<ZQPO,5:RO)OQPO,5:RO)OQPO,5:ROOQO,5:a,5:aO<iQPO'#DxOOQO'#Dw'#DwO<nQPO,5:bO>XQPO'#DZO5TQPO,5:vO>`QPO'#E]O>eQPO,5:vO?OQPO,5:vO?YQPO,5:vO?aQPO,5:vO?fQPO7+%lO,RQPO7+%lOOQO'#Ee'#EeO@vQPO1G0jOOQO1G0j1G0jOAOQPO7+&WOYQPO7+&WOB`QPO7+&WOBgQPO7+&WOBnQQO'#EkOOQO,5;U,5;UODpQPO,5;TODwQPO,5;TOFYQPO7+&YOFaQPO7+&YOOQO7+&Y7+&YOFnQPO7+&YOFuQPO7+&YOGzQPO7+&YOH[QPO7+&hOHaQPO7+$}OHfQPO1G/nOOQO1G/p1G/pOOQO1G/w1G/wOOQO1G/y1G/yOHkQPO,5:QOHpQPO,5:POOQO1G/m1G/mOHuQPO1G/mOJ`QPO,5:dO5OQPO,5:cOJhQPO,5:yO>eQPO1G0bOJvQPO1G0bOKOQPO,5:wO)OQPO,5:yOKTQPO1G0bOK[QPO'#E^OKaQPO1G0bOKTQPO1G0bOKiQPO1G0bOKpQPO1G0bO5dQPO1G0bOOQO1G0b1G0bOOQO<<IW<<IWOK{QPO<<IWOLQQPO,5;POOQO7+&U7+&UOOQO<<Ir<<IrOLVQPO<<IrOYQPO<<IrOOQO'#Em'#EmOL^QPO,5;VOOQO'#El'#ElOOQO,5;V,5;VOOQO1G0o1G0oOLfQPO1G0oONcQPO<<JSOOQO<<Hi<<HiONhQPO7+%YOOQO1G/l1G/lOOQO1G/k1G/kOOQO1G0O1G0OOOQO1G/}1G/}OOQO'#E`'#E`OOQO1G0e1G0eONmQPO1G0eOOQO'#Ea'#EaOOQO'#Eb'#EbOOQO'#Ec'#EcOOQO7+%|7+%|OOQO1G0c1G0cONrQPO1G0eO! WQPO7+%|OOQO,5:x,5:xO! `QPO7+%|O5dQPO7+%|O! gQPO7+%|O! rQPOAN>rOOQO1G0k1G0kO!#SQPOAN?^O!$dQPOAN?^O!$kQQO1G0qOOQO1G0q1G0qOOQO7+&Z7+&ZO!$sQPOAN?nO!$xQPO<<HtO!$}QPO7+&PO!%SQPO<<IhO!%[QPO<<IhO!%dQPO<<IhO!%lQPO'#E_OOQO<<Ih<<IhOOQOG24^G24^OOQOG24xG24xOOQO1G0r1G0rOOQO7+&]7+&]O!%qQPOG25YOOQOAN>`AN>`O!%vQPO<<IkOOQOAN?SAN?SO!%{QPOAN?SO!&TQPOLD*tOOQOAN?VAN?VOOQO,5:b,5:bO!&YQPO!$'N`O!&_QPO!)9CzO!&dQPO!.K9fOOQO!4//Q!4//QO5OQPO'#DvO!&iQPO'#DZO!'WQPO,59jO!'bQPO'#DOOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO!(mQPO7+&YO!(tQPO7+&YO!)RQPO7+&YO!*ZQPO7+&YO!*bQPO7+&YO!)YQPO'#Eh",stateData:"!*o~O#mOSoOS~OYZOfUOgUOhUOiUOjUOkUOlUOmUOnUO!hXO#cYO#dYO#nPO#qRO#s^O#t_O#u`O#vaO#wbO#xcO#ydO#zeO#{fO#|gO#}hO$OiO$PjO$QkO~OvlO~OyoO{oO!RoO!SoOcrXdrXerX!_rX!arX!brX!crX!drX#crX#drX#erX#frX#grX#hrX~O!UsO#krX#rrX~P#[O#qxO~OayObyO#qzO~Oc}Od|Oe}Oy!RO!_!RO!a!RO!b!RO!c!RO!d!RO#c!OO#d!OO#e!PO#f!PO#g!PO#h!QO~O!h!SO~O#q!TO~Ow!UOy!UOz!UO{!UO~O#o!VO#p!WO~OV!XOx!YO~OyoO{oO!RoO!SoOc}Xd}Xe}X!U}X!_}X!a}X!b}X!c}X!d}X#c}X#d}X#e}X#f}X#g}X#h}X#k}X#r}X$R}X#o}X~OP!^OQ!_OR!_OS!`OT!`OW!fOX!eOv!]O#q!cO~OyoO{oO!RoO!SoOcradraera!_ra!ara!bra!cra!dra#cra#dra#era#fra#gra#hra~O!UsO#kra#rra~P)WOcqXdqXeqXyqX!_qX!aqX!bqX!cqX!dqX#cqX#dqX#eqX#fqX#gqX#hqX~O#r!iO~P*oO#r!jO~P*oO!h!nO#nPO#q!lO~O#q!oO~OYZOfUOgUOhUOiUOjUOkUOlUOmUOnUO#cYO#dYO#nPO#qRO#s^O#t_O#u`O#vaO#wbO#xcO#ydO#zeO#{fO#|gO#}hO$OiO$PjO$QkO~O!h!qO~P,`O#q!rO~O[!uO]!sO^!sOY#]Pf#]Pg#]Ph#]Pi#]Pj#]Pk#]Pl#]Pm#]Pn#]P!h#]P#c#]P#d#]P#n#]P#q#]P#s#]P#t#]P#u#]P#v#]P#w#]P#x#]P#y#]P#z#]P#{#]P#|#]P#}#]P$O#]P$P#]P$Q#]P~Ox!}O~OvlO#p#PO~O#q#QO~Ow#ROy#ROz!UO{!UO!_#SO!a#SO!b#SO!c#SO!d#SO~Ov#TOc!VXd!VXe!VXy!VX{!VX!R!VX!S!VX!U!VX!_!VX!a!VX!b!VX!c!VX!d!VX#c!VX#d!VX#e!VX#f!VX#g!VX#h!VX#k!VX#r!VX$R!VX#o!VX~Ox#WO~Oc#YOd#ZO#o#YOe}ay}a{}a!R}a!S}a!U}a!_}a!a}a!b}a!c}a!d}a#c}a#d}a#e}a#f}a#g}a#h}a#k}a#r}a$R}a~Ox#[O~Ov#]O~OyoO{oO!RoO!SoO!U#`O$R#bO~O#r#gO~O#o#hO~Ov#iO#r#kO~O#r#lO~P*oOc#iXd#iXe#iXy#iX!_#iX!a#iX!b#iX!c#iX!d#iX#c#iX#d#iX#e#iX#f#iX#g#iX#h#iX#r#iX~O#o#mO~P6SO!h#oO~P,`O#q#pO~OY#]Xf#]Xg#]Xh#]Xi#]Xj#]Xk#]Xl#]Xm#]Xn#]X!h#]X#c#]X#d#]X#n#]X#q#]X#s#]X#t#]X#u#]X#v#]X#w#]X#x#]X#y#]X#z#]X#{#]X#|#]X#}#]X$O#]X$P#]X$Q#]X~O_#rO`#rO~P7kO]!sO^!sO~P7kO#o#zO~P*oOx#{O~OV#|Ox!}O!`#}O!f$OO!h$PO~Ow$QO~O#o$ROc!Wad!Wae!Way!Wa{!Wa!R!Wa!S!Wa!U!Wa!_!Wa!a!Wa!b!Wa!c!Wa!d!Wa#c!Wa#d!Wa#e!Wa#f!Wa#g!Wa#h!Wa#k!Wa#r!Wa$R!Wa~Oc#YOd#ZO#o#YO#r$SO~Ow$UO~O#o$VOc!jad!jae!jay!ja{!ja!R!ja!S!ja!U!ja!_!ja!a!ja!b!ja!c!ja!d!ja#c!ja#d!ja#e!ja#f!ja#g!ja#h!ja#k!ja#r!ja$R!ja~OU$WO~P(iO!`$ZO~O!U$[O$R#bO~OyoO{oO!RoO!SoO!U#`O~OZ$^O#r#Oa~P>mO#r$cO~P5TO#r$dO~OayObyOc!nqd!nqe!nqy!nq!_!nq!a!nq!b!nq!c!nq!d!nq#c!nq#d!nq#e!nq#f!nq#g!nq#h!nq#k!nq#r!nq#o!nq~O#o$gO#r$hO~OayObyOc#Yqd#Yqe#Yqy#Yq!_#Yq!a#Yq!b#Yq!c#Yq!d#Yq#c#Yq#d#Yq#e#Yq#f#Yq#g#Yq#h#Yq#k#Yq#r#Yq#o#Yq~O#r$iO~P*oO#o$kO~P6SO#b$lO#r$oO~OY#]af#]ag#]ah#]ai#]aj#]ak#]al#]am#]an#]a!h#]a#c#]a#d#]a#n#]a#s#]a#t#]a#u#]a#v#]a#w#]a#x#]a#y#]a#z#]a#{#]a#|#]a#}#]a$O#]a$P#]a$Q#]a~O#q#pO~PBvO_$qO`$qO#q#]a~PBvOc}Oe}Oy!RO!_!RO!a!RO!b!RO!c!RO!d!RO#c!OO#d!OO#e#[q#f#[q#g#[q#h#[q#k#[q#r#[q~Od#[q~PEUOc#[qd#[qe#[q~PE[Od|O~PEUO#k#[q#r#[q~P%TOc#[qd#[qe#[qy#[q!_#[q!a#[q!b#[q!c#[q!d#[q#e#[q#f#[q#g#[q#h#[q~O#c!OO#d!OO#k#[q#r#[q~PGPOx$rO~O#r$sO~O#q$tO~Ox$uO~Ov#TO~Oc#YO#o#YOd!Zie!Ziy!Zi{!Zi!R!Zi!S!Zi!U!Zi!_!Zi!a!Zi!b!Zi!c!Zi!d!Zi#c!Zi#d!Zi#e!Zi#f!Zi#g!Zi#h!Zi#k!Zi#r!Zi$R!Zi~Ov$wOx$wO~Ov$zO$T$|O$U$}O$V%OO~OZ$^O#r#Oi~O$S%QO~O#r#Oi~P>mO!`%TO~O!U$[O#r#Oi~O#r%VO~P5TO!U$[O#r%VO$R#bO~O#r%XO~Ov%YO~O#r%ZO~P*oO#o%]O#r%^O~O#q#pOY#]if#]ig#]ih#]ii#]ij#]ik#]il#]im#]in#]i!h#]i#c#]i#d#]i#n#]i#s#]i#t#]i#u#]i#v#]i#w#]i#x#]i#y#]i#z#]i#{#]i#|#]i#}#]i$O#]i$P#]i$Q#]i~O#o%`O~Ox%aO~O#q%bO~Oc#YOd#ZO#o#YO!U#Ri$R#Ri#r#Ri~O!U$[O#r#Oq~O#r#Oq~P>mOZ%eO!U%fO#r#Oq~OayObyOc!n!Rd!n!Re!n!Ry!n!R!_!n!R!a!n!R!b!n!R!c!n!R!d!n!R#c!n!R#d!n!R#e!n!R#f!n!R#g!n!R#h!n!R#k!n!R#r!n!R#o!n!R~OayObyOc#Y!Rd#Y!Re#Y!Ry#Y!R!_#Y!R!a#Y!R!b#Y!R!c#Y!R!d#Y!R#c#Y!R#d#Y!R#e#Y!R#f#Y!R#g#Y!R#h#Y!R#k#Y!R#r#Y!R#o#Y!R~O#r%iO~P*oO#b$lO#r%kO~Ox%lO~O#r%mO~Ov%nO~O!U$[O#r#Oy~OZ$^O#r#Oy~O!U%fO!`%TO~OU$WO~O#o%qO~O#r%rO~O!U$[O#r#O!R~Ox%tO~O#o%uO~Ox%vO~O#r%wO~OP!^OQ!_OR!_OS!`OT!`OW%xOX!eOv!]O#q!cO~O!U%yO#ora~P)WO!U%yO#orX~P#[Oc&TOe&TOy&XO!_&XO!a&XO!b&XO!c&XO!d&XO#c&UO#d&UO#e#[q#f#[q#g#[q#h#[q#o#[q~Od#[q~P!'lOc#[qd#[qe#[q~P!'rOd&SO~P!'lOc&TOd&SOe&TOy&XO!_&XO!a&XO!b&XO!c&XO!d&XO#c&UO#d&UO#e&VO#f&VO#g&VO#h&WO~O#o#[q~P!)YO#c&UO#d&UO#o#[q~PGPO",goto:"/]#kPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP#l$k%S%r%uPPPPPP&U&h&x'W'iPP'xP'{'{(Q(T(Z(l(l(uPPPPPP(uP(lP'{'{)O)U)]*O*e*z*z*z*z*z*z*z*z*z*z*z*z*z*z+a+j+},Z,s,v,v,v,y-Y*O-]*O-r.h.y/S/VPPPPPPP*O*O[WORz!r#m$kQ#t!vQ#u!wS#v!x&OQ#w!yQ#x!zQ#y!{Q&Y%|Q&Z%}Q&[&PQ&]&QQ&^&RR&_!Tt]Oz!T!r!v!w!x!y!z!{#m$k%|%}&O&P&Q&RRvRjQORz!T!r!v!w!x!y!z!{#m$kS!kx#hQ#e!l]%{%|%}&O&P&Q&RRnPQmP^!bs!c#Y#Z#`$[%yR#O!VQuQQ#a!kQ$]#dQ$a#eQ%U$`R%z%{[tQ!k#d#e$`%{]!hu#a$]$a%U%zirQu!k#a#d#e$]$`$a%U%z%{hqQu!k#a#d#e$]$`$a%U%z%{R![rkpQru!k#a#d#e$]$`$a%U%z%{R!ZpV!gs#`%yR#V!^Q#U!^R$v$RU!ds#`%yQ#X!cQ$S#YQ$T#ZR%R$[_!bs!c#Y#Z#`$[%y_!as!c#Y#Z#`$[%yQ#_!fR%s%xS#^!f%xR$x$Vj]O!v!w!x!y!z!{%|%}&O&P&Q&RQwRQ!pzQ!|!TQ#n!rQ$j#mR%[$kw[ORz!T!r!v!w!x!y!z!{#m$k%|%}&O&P&Q&RwTORz!T!r!v!w!x!y!z!{#m$k%|%}&O&P&Q&RwSORz!T!r!v!w!x!y!z!{#m$k%|%}&O&P&Q&RQ!mxQ#f!lR$f#hS#d!k#eW$Y#a#c$a$bQ%P$XQ%W$cR%d%VQ$`#dQ%P$YQ%g%WR%o%dQ#c!kS$X#a$aQ$_#dQ$b#eS%S$]$`S%c%U%WR%p%eR${$WR$y$WQ{VQ$e#gQ$i#lQ%h%XR%i%ZR#j!owVORz!T!r!v!w!x!y!z!{#m$k%|%}&O&P&Q&RQ!v|Q!w}Q!x!OQ!y!PQ!z!QQ!{!RQ%|&SQ%}&TQ&O&UQ&P&VQ&Q&WR&R&Xh!t|}!O!P!Q!R&S&T&U&V&W&XR#s!uQ#q!sQ$p#rR%_$qR$m#pQ$n#pR%j%]",nodeNames:"⚠ Json Logfmt Unpack Pattern Regexp Unwrap Ip LabelFormat LineFormat LabelReplace Offset Bool On Ignoring GroupLeft GroupRight By Without And Or Unless Sum Avg Count Max Min Stddev Stdvar Bottomk Topk LineComment LogQL Expr LogExpr Selector Matchers Matcher Identifier Eq String Neq Re Nre PipelineExpr PipelineStage LineFilters LineFilter Filter PipeExact PipeMatch FilterOp Pipe LabelParser JsonExpressionParser JsonExpressionList JsonExpression LabelFilter IpLabelFilter UnitFilter DurationFilter Gtr Duration Gte Lss Lte Eql BytesFilter Bytes NumberFilter Number LineFormatExpr LabelFormatExpr LabelsFormat LabelFormatMatcher MetricExpr RangeAggregationExpr RangeOp CountOverTime Rate BytesOverTime BytesRate AvgOverTime SumOverTime MinOverTime MaxOverTime StddevOverTime StdvarOverTime QuantileOverTime FirstOverTime LastOverTime AbsentOverTime LogRangeExpr Range OffsetExpr UnwrapExpr ConvOp BytesConv DurationConv DurationSecondsConv Grouping Labels VectorAggregationExpr VectorOp BinOpExpr BinOpModifier OnOrIgnoringModifier GroupingLabels GroupingLabelList GroupingLabel LabelName Add Sub Mul Div Mod Pow LiteralExpr LabelReplaceExpr",maxTerm:145,skippedNodes:[0,31],repeatNodeCount:0,tokenData:"3X~RvX^#ipq#iqr$^rs$qst%cuv%nxy%syz%xz{%}{|&S|}&X}!O&^!O!P&c!P!Q'c!Q!R'h!R![)O![!]0O!^!_0d!_!`0q!`!a1W!c!}1e!}#O1{#P#Q2Q#Q#R2V#R#S1e#S#T2[#T#o1e#o#p2h#p#q2m#q#r3S#y#z#i$f$g#i#BY#BZ#i$IS$I_#i$I|$JO#i$JT$JU#i$KV$KW#i&FU&FV#i~#nY#m~X^#ipq#i#y#z#i$f$g#i#BY#BZ#i$IS$I_#i$I|$JO#i$JT$JU#i$KV$KW#i&FU&FV#i~$aQ!_!`$g#r#s$l~$lOy~~$qO{~~$tUOY$qZr$qrs%Ws#O$q#O#P%]#P~$q~%]Ox~~%`PO~$q~%hQo~OY%cZ~%c~%sO#g~~%xO#q~~%}O#r~~&SO#e~~&XO#c~~&^O#o~~&cO#d~~&fP!Q![&i~&nR!h~!Q![&i!g!h&w#X#Y&w~&zR{|'T}!O'T!Q!['Z~'WP!Q!['Z~'`P!h~!Q!['Z~'hO#f~~'me!h~!O!P&i!Q![)O!g!h*c!i!j+Q!m!n+Q!o!p+Q!r!s+Q!v!w+Q#U#V*u#W#X+Z#X#Y-]#Z#[-o#[#]+r#_#`-o#a#b-x#d#e-o#g#h,z#h#i-o#k#l.Z#l#m/d#m#n.u~)Td!h~!O!P&i!Q![)O!g!h*c!i!j+Q!m!n+Q!o!p+Q!r!s+Q!v!w+Q#U#V*u#W#X+Z#X#Y-]#Z#[-o#[#]+r#_#`-o#a#b-x#d#e-o#g#h,z#h#i-o#k#l.Z#m#n.u~*fT{|'T}!O'T!Q!['Z!d!e*u#]#^*z~*zO!f~~*}P#U#V*u~+TQ!d!e*u#]#^*z~+`P!`~!Q![+c~+fS!Q![+c#[#]+r#a#b,W#g#h,z~+wP!`~!Q![+z~+}R!Q![+z#a#b,W#g#h,z~,]Q!`~!Q![,c#g#h,u~,fR!Q![,c#a#b,o#g#h,z~,rP#g#h,u~,zO!`~~-PP!`~!Q![-S~-VQ!Q![-S#a#b,o~-`T{|'T}!O'T!Q!['Z#U#V*u#]#^*z~-rQ#U#V*u#]#^*z~-}S!`~!Q![,c#U#V*u#]#^*z#g#h,u~.`P!`~!Q![.c~.fT!Q![.c#W#X+Z#[#]+r#a#b,W#g#h,z~.zP!`~!Q![.}~/QU!Q![.}#W#X+Z#[#]+r#a#b,W#g#h,z#k#l.Z~/gR!Q![/p!c!i/p#T#Z/p~/uR!h~!Q![/p!c!i/p#T#Z/pP0TTvP!Q![0O![!]0O!c!}0O#R#S0O#T#o0O~0iP!b~!_!`0l~0qO!c~~0vQw~!_!`0|#r#s1R~1RO!d~~1WOz~~1]P!_~!_!`1`~1eO!a~R1lTvP#bQ!Q![1e![!]0O!c!}1e#R#S1e#T#o1e~2QO$R~~2VO$S~~2[O#h~~2_RO#S2[#S#T%W#T~2[~2mO#n~~2rQ!U~!_!`2x#r#s2}~2}O!R~~3SO!S~~3XO#p~",tokenizers:[0,1],topRules:{LogQL:[0,32]},specialized:[{term:38,get:(e,t)=>at(e)<<1,external:at},{term:38,get:(e,t)=>st(e)<<1|1,external:st,extend:!0},{term:38,get:e=>it[e]||-1}],tokenPrec:0}),lt=35,ut=38,ct=40,dt=57,pt=["instant","range"],mt=["instant","range"],Ot=["instant","range"];function gt(e,t){if(null==e)return{};var r,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}function ht(e){const t=[],r=ot.parse(e),a=[];r.iterate({enter:e=>{let{type:t,node:r}=e;47===t.id&&a.push(r)}});for(let r of a){var n,s;const a=null===(n=r.getChild(48))||void 0===n?void 0:n.getChild(49),i=null===(s=r.getChild(48))||void 0===s?void 0:s.getChild(50),o=r.getChild(ct);if(!a&&!i||!o)continue;const l=e.substring(o.from,o.to).trim(),u="`"===l[0],c=l.substring(1,l.length-1);if(!c)continue;let d="";d=i?u?c:c.replace(/\\\\/g,"\\"):(0,m.escapeRegExp)(c),d&&t.push(d)}return t}function ft(e){const{queryType:t}=e;if(t===ye.Range||t===ye.Instant||t===ye.Stream){return gt(e,pt)}if(!0===e.instant){const t=gt(e,mt);return Object.assign({},t,{queryType:ye.Instant})}const r=gt(e,Ot);return Object.assign({},r,{queryType:ye.Range})}function vt(e){let t=!0;return ot.parse(e).iterate({enter:e=>{let{type:r}=e;r.id===pe._A&&(t=!1)}}),t}function bt(e){let t=!0;return ot.parse(e).iterate({enter:e=>{let{type:r}=e;75===r.id&&(t=!1)}}),t}const yt=["meta"],xt=["data","error"];function Qt(e,t){if(null==e)return{};var r,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}function Pt(e,t){const{meta:r}=e,a=Qt(e,yt),n=Object.assign({},r,t);return Object.assign({},a,{meta:n})}function _t(e,t,r){var a;const n=Object.assign({},null===(a=e.meta)||void 0===a?void 0:a.custom,{lokiQueryStatKey:"Summary: total bytes processed"});(function(e){var t,r;const a=null!==(t=null===(r=e.fields.find((e=>"labels"===e.name)))||void 0===r?void 0:r.values.toArray())&&void 0!==t?t:[];return a.some((e=>void 0!==e.__error__))})(e)&&(n.error="Error when parsing some of the logs");var s;const i=Pt(e,{preferredVisualisationType:"logs",limit:null==t?void 0:t.maxLines,searchWords:void 0!==t?ht((s=t.expr,`${s||""}`.trim())):void 0,custom:n}),o=function(e,t){if(!t.length)return[];const r=(0,m.groupBy)(t,"name"),a=Object.values(r).map(Je),n=e.fields.find((e=>e.type===H.fS.string));if(void 0===n)throw new Error("invalid logs-dataframe, string-field missing");return n.values.toArray().forEach((e=>{for(const t of a){const a=e.match(r[t.name][0].matcherRegex);t.values.add(a&&a[1])}})),a}(i,r);return Object.assign({},i,{fields:[...i.fields,...o]})}function Lt(e,t,r){return e.map((e=>_t(e,void 0!==e.refId?t.get(e.refId):void 0,r)))}function Rt(e){const t={preferredVisualisationType:"graph"};return e.map((e=>Pt(e,t)))}function jt(e,t){const r=[],a=[],n=[];return e.forEach((e=>{if(function(e){return e.fields.every((e=>e.type===H.fS.time||e.type===H.fS.number))}(e)){var s;null!=e.refId&&(null===(s=t.get(e.refId))||void 0===s?void 0:s.queryType)===ye.Instant?a.push(e):n.push(e)}else r.push(e)})),{streamsFrames:r,metricInstantFrames:a,metricRangeFrames:n}}function qt(e,t){if(void 0===e)return e;const{refId:r,message:a}=e;if(void 0===r||void 0===a)return e;const n=t.get(r);return void 0===n?e:a.includes("escape")&&n.expr.includes("\\")?Object.assign({},e,{message:`${a}. Make sure that all special characters are escaped with \\. For more information on escaping of special characters visit LogQL documentation at https://grafana.com/docs/loki/latest/logql/.`}):e}var wt,$t=r(1652),St=r(27549),Tt=r(97833),Ft=r(96380),kt=r(24643);const Ct=["instant","range"];const Et=[{value:ye.Range,label:"Range",description:"Run query over a range of time."},{value:ye.Instant,label:"Instant",description:'Run query against a single point in time. For this query, the "To" time is used.'}];P.v.featureToggles.lokiLive&&Et.push({value:ye.Stream,label:"Stream",description:"Run a query and keep sending results on an interval"});const Nt=[{value:1,label:"1/1"}].concat((0,m.map)([2,3,4,5,10],(e=>({value:e,label:"1/"+e}))));function Ut(e){var t,r;const{lineLimitValue:a,resolution:n,onRunQuery:s,runOnBlur:i,onChange:o}=e,l=null!==(t=e.query)&&void 0!==t?t:{};let u=null!==(r=l.queryType)&&void 0!==r?r:l.instant?ye.Instant:ye.Range;function c(e){const t=function(e,t){if(null==e)return{};var r,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(l,Ct);o(Object.assign({},t,{queryType:e}))}return(0,h.jsxs)("div",{"aria-label":"Loki extra field",className:"gf-form-inline",children:[(0,h.jsxs)("div",{"data-testid":"queryTypeField",className:(0,St.cx)("gf-form explore-input-margin",St.css`
            flex-wrap: nowrap;
          `),"aria-label":"Query type field",children:[wt||(wt=(0,h.jsx)(Tt.c,{width:"auto",children:"Query type"})),(0,h.jsx)(Ft.S,{options:Et,value:u,onChange:e=>{c(e),i&&s()}})]}),(0,h.jsxs)("div",{"data-testid":"lineLimitField",className:(0,St.cx)("gf-form",St.css`
            flex-wrap: nowrap;
          `),"aria-label":"Line limit field",children:[(0,h.jsx)(kt._,{label:"Line limit",tooltip:"Upper limit for number of log lines returned by query.",children:(0,h.jsx)($t.I,{className:"width-4",placeholder:"auto",type:"number",min:0,onChange:function(e){l.maxLines!==Xt(e.currentTarget.value)&&function(e){const t=Object.assign({},l,{maxLines:Xt(e)});o(t)}(e.currentTarget.value)},onKeyDown:function(e){"Enter"===e.key&&s()},value:a,onBlur:()=>{i&&s()}})}),(0,h.jsx)(kt._,{label:"Resolution",tooltip:"Resolution 1/1 sets step parameter of Loki metrics range queries such that each pixel corresponds to one data point. For better performance, lower resolutions can be picked. 1/2 only retrieves a data point for every other pixel, and 1/10 retrieves one data point per 10 pixels.",children:(0,h.jsx)(V.Ph,{isSearchable:!1,onChange:function(e){const t=Object.assign({},l,{resolution:e.value});o(t)},options:Nt,value:n,"aria-label":"Select resolution"})})]})]})}function Xt(e){return 0===e.length?NaN:e.length>0&&(isNaN(+e)||+e<0)?0:+e}var Dt=r(11410);const It=(0,O.memo)((function(e){var t;const{annotation:r,onAnnotationChange:a}=e;if(void 0===r||void 0===a)return null;const n=e=>{const t=ft(e).queryType===ye.Instant;a(Object.assign({},r,{expr:e.expr,maxLines:e.maxLines,instant:t}))},s={refId:"",expr:r.expr,maxLines:r.maxLines,instant:r.instant,queryType:r.queryType};return(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)("div",{className:"gf-form-group",children:(0,h.jsx)(Dt.n,{datasource:e.datasource,query:s,onChange:n,onRunQuery:()=>{},onBlur:()=>{},history:[],ExtraFieldElement:(0,h.jsx)(Ut,{lineLimitValue:(null==s||null===(t=s.maxLines)||void 0===t?void 0:t.toString())||"",resolution:s.resolution||1,query:s,onRunQuery:()=>{},onChange:n})})}),(0,h.jsxs)(R.EditorRow,{children:[(0,h.jsx)(R.EditorField,{label:"Title",tooltip:"Use either the name or a pattern. For example, {{instance}} is replaced with label value for the label instance.",children:(0,h.jsx)($t.I,{type:"text",placeholder:"alertname",value:r.titleFormat,onChange:e=>{a(Object.assign({},r,{titleFormat:e.currentTarget.value}))}})}),(0,h.jsx)(R.EditorField,{label:"Tags",children:(0,h.jsx)($t.I,{type:"text",placeholder:"label1,label2",value:r.tagKeys,onChange:e=>{a(Object.assign({},r,{tagKeys:e.currentTarget.value}))}})}),(0,h.jsx)(R.EditorField,{label:"Text",tooltip:"Use either the name or a pattern. For example, {{instance}} is replaced with label value for the label instance.",children:(0,h.jsx)($t.I,{type:"text",placeholder:"instance",value:r.textFormat,onChange:e=>{a(Object.assign({},r,{textFormat:e.currentTarget.value}))}})})]})]})}));var Vt=r(34316);const Mt=/^label_names\(\)\s*$/,At=/^label_values\((?:(.+),\s*)?([a-zA-Z_][a-zA-Z0-9_]*)\)\s*$/;var Wt=r(60699);function Yt(e){const t=(0,pe.bU)(e),r=ot.parse(t).topNode,a={query:{labels:[],operations:[]},errors:[]};try{Gt(t,r,a)}catch(e){console.error(e),e instanceof Error&&a.errors.push({text:e.message})}return function(e){if(0===e.labels.length&&0===e.operations.length)return!0;return!1}(a.query)&&(a.errors=[]),a}function Gt(e,t,r){const a=r.query;switch(t.type.id){case 37:{a.labels.push(function(e,t){const r=t.getChild(ut),a=(0,pe.KF)(e,r),n=(0,pe.KF)(e,r.nextSibling),s=(0,pe.KF)(e,t.getChild(ct)).replace(/"/g,"");return{label:a,op:n,value:s}}(e,t));const n=t.getChild(pe._A);n&&r.errors.push((0,pe.wf)(e,n));break}case 47:{const{operation:n,error:s}=function(e,t){var r;const a=(0,pe.KF)(e,t.getChild(48)),n=Kt((0,pe.KF)(e,t.getChild(ct)));if(null===(r=t.getChild(51))||void 0===r?void 0:r.getChild(7))return{operation:{id:E.LineFilterIpMatches,params:[a,n]}};return{operation:{id:{"|=":E.LineContains,"!=":E.LineContainsNot,"|~":E.LineMatchesRegex,"!~":E.LineMatchesRegexNot}[a],params:[n]}}}(e,t);n&&a.operations.push(n),s&&r.errors.push(Zt(e,t,s));break}case 53:a.operations.push(function(e,t){const r=t.firstChild,a=(0,pe.KF)(e,r),n=Kt((0,pe.KF)(e,t.getChild(ct)));return{id:a,params:n?[n]:[]}}(e,t));break;case 57:{const{operation:n,error:s}=function(e,t){if(t.getChild(20)||t.getChild(19)||t.getChild("Comma"))return{error:'Label filter with comma, "and", "or" not supported in query builder'};if(58===t.firstChild.type.id){const r=t.firstChild,a=null==r?void 0:r.getChild(ut),n=null==a?void 0:a.nextSibling,s=null==r?void 0:r.getChild(ct),i=Kt((0,pe.KF)(e,s));return{operation:{id:E.LabelFilterIpMatches,params:[(0,pe.KF)(e,a),(0,pe.KF)(e,n),i]}}}const r=E.LabelFilter;if(59===t.firstChild.type.id){const a=t.firstChild.firstChild.firstChild,n=a.nextSibling,s=n.nextSibling,i=Kt((0,pe.KF)(e,s));return{operation:{id:r,params:[(0,pe.KF)(e,a),(0,pe.KF)(e,n),i]}}}const a=t.firstChild.firstChild,n=a.nextSibling,s=n.nextSibling,i=[(0,pe.KF)(e,a),(0,pe.KF)(e,n),Kt((0,pe.KF)(e,s))];if("__error__="===i.join(""))return{operation:{id:E.LabelFilterNoErrors,params:[]}};return{operation:{id:r,params:i}}}(e,t);n&&a.operations.push(n),s&&r.errors.push(Zt(e,t,s));break}case 54:a.operations.push(function(e,t){const r=t.getChild(1),a=(0,pe.KF)(e,r),n=[...(0,pe.ff)(e,t,56)];return{id:a,params:n}}(e,t));break;case 71:a.operations.push(function(e,t){const r=E.LineFormat,a=Kt((0,pe.KF)(e,t.getChild(ct)));return{id:r,params:[a]}}(e,t));break;case 74:a.operations.push(function(e,t){const r=E.LabelFormat,a=t.getChild(ut),n=a.nextSibling.nextSibling;return{id:r,params:[(0,pe.KF)(e,n),Kt((0,pe.KF)(e,a))]}}(e,t));break;case 95:{const{operation:n,error:s}=function(e,t,r){const a=t.getChild(95),n=t.getChild(57),s=t.getChild(6);a&&Gt(e,a,r);n&&Gt(e,n,r);if(s){var i;if(96===(null===(i=s.nextSibling)||void 0===i?void 0:i.type.id)){const t=s.nextSibling,r=t.nextSibling;return{operation:{id:E.Unwrap,params:[(0,pe.KF)(e,r),(0,pe.KF)(e,t)]}}}return{operation:{id:E.Unwrap,params:[(0,pe.KF)(e,null==s?void 0:s.nextSibling),""]}}}return{}}(e,t,r);n&&a.operations.push(n),s&&r.errors.push(Zt(e,t,s));break}case 76:a.operations.push(function(e,t,r){const a=t.getChild(77),n=(0,pe.KF)(e,a),s=t.getChild(70),i=t.getChild(92),o=null!=s?[(0,pe.KF)(e,s)]:[];let l=(0,pe.KF)(e,t).match(/\[(.+)\]/);null!=l&&l[1]&&o.unshift(l[1]);const u={id:n,params:o};i&&Gt(e,i,r);return u}(e,t,r));break;case 102:a.operations.push(function(e,t,r){const a=t.getChild(103);let n=(0,pe.KF)(e,a);const s=t.getChild(100),i=[],o=t.getChild(70);o&&i.push(Number((0,pe.KF)(e,o)));if(s){s.getChild(17)&&n&&(n=`__${n}_by`);s.getChild(18)&&(n=`__${n}_without`),i.push(...(0,pe.ff)(e,s,ut))}const l=t.getChild(75),u={id:n,params:i};l&&Gt(e,l,r);return u}(e,t,r));break;case 104:!function(e,t,r){const a=r.query,n=t.firstChild,s=(0,pe.KF)(e,n.nextSibling),i=function(e,t){if(!t)return;if(t.getChild(12))return{isBool:!0,isMatcher:!1};{var r;const a=t.getChild(Wt.Wc);if(!a)return;return{isMatcher:!0,isBool:!1,matches:(0,pe.KF)(e,null===(r=a.getChild(107))||void 0===r?void 0:r.getChild(108)),matchType:a.getChild(13)?"on":"ignoring"}}}(e,t.getChild(Wt.v3)),o=t.lastChild,l=zt[s],u=Bt(n,"MetricExpr.LiteralExpr.Number"),c=Bt(o,"MetricExpr.LiteralExpr.Number"),d=o.getChild(104);u||Gt(e,n,r);if(c)a.operations.push((0,pe.Es)(l,e,o,!(null==i||!i.isBool)));else if(d){const t=(0,pe.ge)(o);"Number"===(null==t?void 0:t.name)&&a.operations.push((0,pe.Es)(l,e,t,!(null==i||!i.isBool))),Gt(e,o,r)}else{a.binaryQueries=a.binaryQueries||[];const t={operator:s,query:{labels:[],operations:[]}};null!=i&&i.isMatcher&&(t.vectorMatchesType=i.matchType,t.vectorMatches=i.matches),a.binaryQueries.push(t),Gt(e,o,{query:t.query,errors:r.errors})}}(e,t,r);break;case pe._A:if(function(e){var t;return 93===(null==e||null===(t=e.parent)||void 0===t?void 0:t.type.id)}(t))break;r.errors.push((0,pe.wf)(e,t));break;default:{let a=t.firstChild;for(;a;)Gt(e,a,r),a=a.nextSibling}}}const zt=U.reduce(((e,t)=>(e[t.sign]={id:t.id,comparison:t.comparison},e)),{});function Kt(e){return'"'===e[0]&&'"'===e[e.length-1]?e.replace(/"/g,"").replace(/\\\\/g,"\\"):e.replace(/`/g,"")}function Bt(e,t){let r=e;const a=t.split(".");for(const e of a)if(r=r.getChild(e),!r)return null;return r}function Zt(e,t,r){const a=(0,pe.wf)(e,t);return a.text=`${r}: ${a.text}`,a}function Ht(e,t,r,a){if(!t||!a)throw new Error("Need label to add to query.");const n=rr(e),s=function(e){const t=ot.parse(e),r=[];return t.iterate({enter:t=>{let{node:a}=t;35===a.type.id&&r.push(...ur(e,a,37))}}),r}(e).length>0,i=ar(e),o=function(e){const t=ot.parse(e),r=[];return t.iterate({enter:e=>{let{type:t,from:a,to:n}=e;if(t.id===dt)return r.push({from:a,to:n}),!1}}),r}(e);if(!n.length)return e;const l=sr(t,a,r);if(s&&(o.length||i.length)){return ir(e,[[...o,...i].reduce(((e,t)=>e.to>t.to?e:t))],l)}return function(e,t,r){const a=new Gr;let n="",s=0;for(let i=0;i<t.length;i++){const o=t[i],l=i===t.length-1,u=e.substring(s,o.from),c=l?e.substring(o.to):"",d=Yt(e.substring(o.from,o.to));lr(d.query.labels,r)||d.query.labels.push(r);n+=u+a.renderQuery(d.query)+c,s=o.to}return n}(e,n,l)}function Jt(e,t){const r=nr(e);if(r.length)return or(e,r,t);return or(e,rr(e),t)}function er(e,t){const r=function(e){const t=ot.parse(e),r=[];return t.iterate({enter:e=>{let{type:t,from:a,to:n,node:s}=e;if(34===t.id)return r.push({from:a,to:n}),!1;if(92===t.id){const e=[],t=s.getChild(lt);t&&e.push({from:t.from,to:t.to});const a=s.getChild(44);a&&e.push({from:a.from,to:a.to});const n=s.getChild(95);n&&e.push({from:n.from,to:n.to});const i=(0,m.sortBy)(e,(e=>e.to));return r.push({from:i[0].from,to:i[i.length-1].to}),!1}}}),r}(e);return function(e,t,r){let a="",n=0;for(let s=0;s<t.length;s++){const i=t[s],o=s===t.length-1,l=e.substring(n,i.to),u=o?e.substring(i.to):"";a+=l+` | label_format ${r.renameTo}=${r.originalLabel}`+u,n=i.to}return a}(e,r,t)}function tr(e){const t=function(e){const t=ot.parse(e),r=[];return t.iterate({enter:e=>{let{type:t,from:a,to:n}=e;if(31===t.id)return r.push({from:a,to:n}),!1}}),r}(e);if(!t.length)return e;let r="",a=0;for(let n of t){r+=e.substring(a,n.from)+e.substring(n.to),a=n.to}return r}function rr(e){const t=ot.parse(e),r=[];return t.iterate({enter:e=>{let{type:t,from:a,to:n}=e;if(t.id===lt)return r.push({from:a,to:n}),!1}}),r}function ar(e){const t=ot.parse(e),r=[];return t.iterate({enter:e=>{let{type:t,from:a,to:n}=e;if(53===t.id||54===t.id)return r.push({from:a,to:n}),!1}}),r}function nr(e){const t=ot.parse(e),r=[];return t.iterate({enter:e=>{let{type:t,node:a}=e;if(46===t.id)return r.push({from:a.from,to:a.to}),!1}}),r}function sr(e,t,r){return{label:e,op:r,value:t}}function ir(e,t,r){let a="",n=0;for(let s=0;s<t.length;s++){const i=t[s],o=s===t.length-1,l=e.substring(n,i.to),u=o?e.substring(i.to):"";a+=l+` | ${r.label}${r.op}\`${r.value}\``+u,n=i.to}return a}function or(e,t,r){let a="",n=0;for(let s=0;s<t.length;s++){const i=t[s],o=s===t.length-1;a+=e.substring(n,i.to)+` | ${r}`+(o?e.substring(i.to):""),n=i.to}return a}function lr(e,t){return e.find((e=>e.label===t.label&&e.value===t.value))}function ur(e,t,r){if(t.type.id===r)return[{from:t.from,to:t.to}];const a=[];let n=0,s=t.childAfter(n);for(;s;)a.push(...ur(e,s,r)),n=s.to,s=t.childAfter(n);return a}function cr(e,t){if(0===t.length)return[];const r=[],{queryWithParser:a,parserCount:n}=function(e){let t=0;return ot.parse(e).iterate({enter:e=>{let{type:r}=e;53!==r.id&&54!==r.id||t++}}),{queryWithParser:t>0,parserCount:t}}(e);if(!a){const{hasLogfmt:a,hasJSON:n}=function(e){const t=e.fields.find((e=>e.type===H.fS.string));if(null==t)return{hasJSON:!1,hasLogfmt:!1};const r=t.values.toArray();let a=!1,n=!1;return r.forEach((e=>{const t=(0,ne.MT)(e);t===ne.bA.JSON&&(a=!0),t===ne.bA.logfmt&&(n=!0)})),{hasLogfmt:n,hasJSON:a}}(t[0]);n&&r.push({type:"ADD_JSON_PARSER",label:"Selected log stream selector has JSON formatted logs.",fix:{label:"Consider using JSON parser.",action:{type:"ADD_JSON_PARSER",query:e}}}),a&&r.push({type:"ADD_LOGFMT_PARSER",label:"Selected log stream selector has logfmt formatted logs.",fix:{label:"Consider using logfmt parser to turn key-value pairs in your log lines to labels.",action:{type:"ADD_LOGFMT_PARSER",query:e}}})}if(a&&1===n){const a=function(e){let t=!1;return ot.parse(e).iterate({enter:r=>{let{type:a,node:n}=r;if(57===a.id){var s;const r=null===(s=n.getChild(37))||void 0===s?void 0:s.getChild(38);r&&"__error__"===e.substring(r.from,r.to)&&(t=!0)}}}),t}(e);(function(e){const t=e.fields.find((e=>"labels"===e.name&&e.type===H.fS.other));return null!=t&&t.values.toArray().some((e=>e.__error__))})(t[0])&&!a&&r.push({type:"ADD_NO_PIPELINE_ERROR",label:"Some logs in your selected log streams have parsing error.",fix:{label:"Consider filtering out logs with parsing errors.",action:{type:"ADD_NO_PIPELINE_ERROR",query:e}}})}const s=function(e){let t=!1;return ot.parse(e).iterate({enter:e=>{let{type:r}=e;72===r.id&&(t=!0)}}),t}(e);if(!s){const a=function(e){var t,r;const a=null!==(t=null===(r=e.fields.find((e=>"labels"===e.name)))||void 0===r?void 0:r.values.toArray())&&void 0!==t?t:[];return a.some((e=>void 0!==e.level))}(t[0]),n=function(e){const t=e.fields.find((e=>"labels"===e.name&&e.type===H.fS.other));if(null==t)return null;const r=t.values.toArray().slice(0,2);let a=null;for(let e of r){const t=Object.keys(e).find((e=>"lvl"===e||e.includes("level")));if(t){a=t;break}}return a}(t[0]);!a&&n&&r.push({type:"ADD_LEVEL_LABEL_FORMAT",label:`Some logs in your selected log stream have "${n}" label.`,fix:{label:`If ${n} label has level values, consider using label_format to rename it to "level". Level label can be then visualized in log volumes.`,action:{type:"ADD_LEVEL_LABEL_FORMAT",query:e,options:{renameTo:"level",originalLabel:n}}}})}return r}var dr=r(35124);const pr=["fields"];function mr(e,t){const{fields:r}=e,a=function(e,t){if(null==e)return{};var r,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,pr),n=r.find((e=>"tsNs"===e.name));if(void 0===n)throw new Error("missing nanosecond-timestamp field. should never happen");const s=function(e,t){const r=e.values.toArray(),a=Array(r.length);for(let e=0;e<a.length;e++)a[e]=e;const n="ASCENDING"===t;return a.sort(((e,t)=>{const a=r[e],s=r[t];return a<s?n?-1:1:a>s?n?1:-1:0})),a}(n,t);return Object.assign({},a,{fields:r.map((e=>Object.assign({},e,{values:new dr.o(e.values,s)})))})}var Or=r(2364),gr=r(11979),hr=r(93016),fr=r(19323);function vr(e,t,r){var a;const n=r.range,s=n.to.valueOf()-n.from.valueOf()+1e3;let i,o=null!==(a=r.maxDataPoints)&&void 0!==a?a:1e3;o>100&&(o*=2);const l=t=>{if(null!=t&&t.message){const r=t.message;i?i.push(r):i=fr.Av.fromDataFrameJSON(r,{maxLength:o,maxDelta:s,displayNameFormat:e.legendFormat})}return i};return(0,Or.P)((()=>async function(e){const t=JSON.stringify({expr:e.expr}),r=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-1",r);return Array.from(new Uint8Array(a.slice(0,8))).map((e=>e.toString(16).padStart(2,"0"))).join("")}(e))).pipe((0,Se.z)((r=>(0,hr.gj)().getStream({scope:gr.z.DataSource,namespace:t.uid,path:`tail/${r}`,data:Object.assign({},e,{timeRange:{from:n.from.valueOf().toString(),to:n.to.valueOf().toString()}})}).pipe((0,G.U)((e=>{const t=l(e);return{data:t?[t]:[],state:_.Gu.Streaming}}))))))}var br,yr=r(94396),xr=r(74184),Qr=r(78454);const Pr=[{label:"Label names",value:Qe.LabelNames},{label:"Label values",value:Qe.LabelValues}],_r=e=>{let{onChange:t,query:r,datasource:a}=e;const[n,s]=(0,O.useState)(void 0),[i,o]=(0,O.useState)(""),[l,u]=(0,O.useState)([]),[c,d]=(0,O.useState)("");(0,O.useEffect)((()=>{if(!r)return;const e="string"==typeof r?function(e){if("string"!=typeof e)return e;const t={refId:"LokiVariableQueryEditor-VariableQuery",type:Qe.LabelNames};if(e.match(Mt))return Object.assign({},t,{type:Qe.LabelNames});const r=e.match(At);return r?Object.assign({},t,{type:Qe.LabelValues,label:r[2]?r[2]:r[1],stream:r[2]?r[1]:void 0}):t}(r):r;s(e.type),o(e.label||""),d(e.stream||""),e.label&&u([{label:e.label,value:e.label}])}),[r]),(0,O.useEffect)((()=>{n===Qe.LabelValues&&a.labelNamesQuery().then((e=>{u(e.map((e=>{let{text:t}=e;return{label:t,value:t}})))}))}),[a,n]);const p=()=>{void 0!==n&&t({type:n,label:i,stream:c,refId:"LokiVariableQueryEditor-VariableQuery"})};return(0,h.jsxs)(Qr.Z,{children:[(0,h.jsx)(kt._,{label:"Query type",labelWidth:20,children:(0,h.jsx)(V.Ph,{"aria-label":"Query type",onChange:e=>{s(e.value),void 0!==e.value&&t({type:e.value,label:i,stream:c,refId:"LokiVariableQueryEditor-VariableQuery"})},onBlur:p,value:n,options:Pr,width:16})}),n===Qe.LabelValues&&(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(kt._,{label:"Label",labelWidth:20,children:(0,h.jsx)(V.Ph,{"aria-label":"Label",onChange:e=>{o(e.value||"")},onBlur:p,value:i,options:l,width:16,allowCustomValue:!0})}),(0,h.jsx)(kt._,{label:"Stream selector",labelWidth:20,tooltip:br||(br=(0,h.jsx)("div",{children:"Optional. If defined, a list of values for the label in the specified log stream selector is returned."})),children:(0,h.jsx)($t.I,{type:"text","aria-label":"Stream selector",placeholder:"Optional stream selector",value:c,onChange:e=>{d(e.currentTarget.value)},onBlur:p,width:22})})]})]})};class Lr extends xr.Mg{constructor(e){var t,r,a;super(),a=_r,(r="editor")in(t=this)?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,this.datasource=e,this.query=this.query.bind(this)}async execute(e){return this.datasource.metricFindQuery(e)}query(e){const t=this.execute(e.targets[0]);return(0,yr.D)(t).pipe((0,G.U)((e=>({data:e}))))}}const Rr=["__interval","__interval_ms"];function jr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const qr=1e6;function wr(e,t,r,a,n){const s=B.calculateInterval(t,1);return{targets:[e],requestId:a,interval:s.interval,intervalMs:s.intervalMs,range:t,scopedVars:{},timezone:"UTC",app:r,startTime:Date.now(),hideFromInspector:n}}class $r extends se.CK{constructor(e){var t;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,ue.J)(),a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,le.$t)();super(e),jr(this,"streams",new Ke),jr(this,"languageProvider",void 0),jr(this,"maxLines",void 0),jr(this,"runLiveQuery",((e,t)=>{const r=this.createLiveTarget(e,t);return this.streams.getStream(r).pipe((0,G.U)((e=>({data:e||[],key:`loki-${r.refId}`,state:_.Gu.Streaming}))),(0,z.K)((e=>(0,M._)((()=>`Live tailing was stopped due to following error: ${e.reason}`)))))})),jr(this,"getLogRowContext",(async(e,t)=>{const r=t&&t.direction||"BACKWARD",a=t&&t.limit||10,{query:n,range:s}=await this.prepareLogRowContextQueryTarget(e,a,r),i=e=>{const t=e.data.map((e=>mr(e,"DESCENDING"))).map((e=>(e=>{const t=new Z.N(e),r=t.getFirstFieldOfType(H.fS.time),a=t.getFirstFieldOfType(H.fS.string),n=t.getFieldByName("id");return void 0===r||void 0===a||void 0===n?Object.assign({},e,{fields:[]}):Object.assign({},e,{fields:[Object.assign({},r,{name:"ts"}),Object.assign({},a,{name:"line"}),Object.assign({},n,{name:"id"})]})})(e)));return Object.assign({},e,{data:t})},o=Q.zj.Explore;return(0,A.n)(this.query(wr(n,s,o,`log-row-context-query-${r}`)).pipe((0,z.K)((e=>{throw{message:"Error during context query. Please check JS console logs.",status:e.status,statusText:e.statusText}})),(0,K.w)((e=>(0,W.of)(i(e))))))})),jr(this,"prepareLogRowContextQueryTarget",(async(e,t,r)=>{var a;await this.languageProvider.start();const n=this.languageProvider.getLabelKeys(),s=Object.keys(e.labels).map((t=>n.includes(t)?`${t}="${(0,Vt.U9)(e.labels[t])}"`:"")).filter((e=>!!e)).join(","),i=72e5,o="FORWARD"===r?xe.Forward:xe.Backward,l={expr:`{${s}}`,queryType:ye.Range,refId:null!==(a=e.dataFrame.refId)&&void 0!==a?a:"",maxLines:t,direction:o},u=new Z.N(e.dataFrame).getFirstFieldOfType(H.fS.time);if(void 0===u)throw new Error("loki: dataframe missing time-field, should never happen");const c=u.values.get(e.rowIndex),d=(0,J.zh)(c),p=o===xe.Forward?{from:d,to:(0,J.zh)(e.timeEpochMs+i)}:{from:(0,J.zh)(e.timeEpochMs-i),to:d};return{query:l,range:{from:p.from,to:p.to,raw:p}}})),this.instanceSettings=e,this.templateSrv=r,this.timeSrv=a,this.languageProvider=new qe(this);const n=e.jsonData||{};this.maxLines=parseInt(null!==(t=n.maxLines)&&void 0!==t?t:"0",10)||1e3,this.annotations={QueryEditor:It},this.variables=new Lr(this)}getLogsVolumeDataProvider(e){const t=e=>{const t=ft(e),{expr:r}=t;return r&&bt(r)&&t.queryType===ye.Range};if(!e.targets.some(t))return;const r=(0,m.cloneDeep)(e);return r.targets=r.targets.filter(t).map((e=>{const t=tr(e.expr);return Object.assign({},e,{instant:!1,volumeQuery:!0,expr:`sum by (level) (count_over_time(${t}[$__interval]))`})})),(0,ie.Bz)(this,r,{extractLevel:Fr,range:e.range,targets:e.targets})}query(e){var t;const r=e.targets.map(ft).map((e=>Object.assign({},e,{maxLines:e.maxLines||this.maxLines}))),a=Object.assign({},e,{targets:r}),n=a.targets.filter((e=>e.queryType===ye.Stream));if(P.v.featureToggles.lokiLive&&n.length>0&&"now"===(null===(t=a.rangeRaw)||void 0===t?void 0:t.to)){const t=Object.assign({},a,{targets:n});return(0,Y.T)(...n.map((r=>vr(this.applyTemplateVariables(r,e.scopedVars),this,t))))}return a.liveStreaming?this.runLiveQueryThroughBackend(a):super.query(a).pipe((0,G.U)((e=>{var t;return function(e,t,r){const{data:a,error:n}=e,s=Qt(e,xt),i=a.map((e=>{if(!(0,Be.aY)(e))throw new Error("transformation only supports dataframe responses");return e})),o=new Map(t.map((e=>[e.refId,e]))),{streamsFrames:l,metricInstantFrames:u,metricRangeFrames:c}=jt(i,o);return Object.assign({},s,{error:qt(n,o),data:[...Rt(c),...(d=u,d.length>0?et(d):[]),...Lt(l,o,r)]});var d}(e,a.targets,null!==(t=this.instanceSettings.jsonData.derivedFields)&&void 0!==t?t:[])})))}runLiveQueryThroughBackend(e){const t=e.targets.filter((e=>""!==e.expr&&bt(e.expr)));if(0===t.length)return(0,W.of)({data:[],state:_.Gu.Done});const r=t.map((e=>{const t=e.maxLines||this.maxLines;return this.runLiveQuery(e,t)}));return(0,Y.T)(...r)}createLiveTarget(e,t){const r=e.expr,a=this.instanceSettings.url,n=(0,ce.tW)({query:r});return{query:r,url:(0,oe.F3)(`${a}/loki/api/v1/tail?${n}`),refId:e.refId,size:t}}getRangeScopedVars(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeSrv.timeRange();const t=e.to.diff(e.from),r=Math.round(t/1e3);return{__range_ms:{text:t,value:t},__range_s:{text:r,value:r},__range:{text:r+"s",value:r+"s"}}}interpolateVariablesInQueries(e,t){let r=e;return e&&e.length&&(r=e.map((e=>Object.assign({},e,{datasource:this.getRef(),expr:this.addAdHocFilters(this.templateSrv.replace(e.expr,t,this.interpolateQueryExpr))})))),r}getQueryDisplayText(e){return e.expr}getTimeRangeParams(){const e=this.timeSrv.timeRange();return{start:e.from.valueOf()*qr,end:e.to.valueOf()*qr}}async importFromAbstractQueries(e){await this.languageProvider.start();const t=this.languageProvider.labelKeys;return t&&t.length&&(e=e.map((e=>(e.labelMatchers=e.labelMatchers.filter((e=>t.includes(e.name))),e)))),e.map((e=>this.languageProvider.importFromAbstractQuery(e)))}async exportToAbstractQueries(e){return e.map((e=>this.languageProvider.exportToAbstractQuery(e)))}async metadataRequest(e,t){if(e.startsWith("/"))throw new Error(`invalid metadata request url: ${e}`);return(await this.getResource(e,t)).data||[]}async metricFindQuery(e){if(!e)return Promise.resolve([]);if("string"==typeof e){const t=this.interpolateString(e);return await this.legacyProcessMetricFindQuery(t)}const t=Object.assign({},e,{label:this.interpolateString(e.label||""),stream:this.interpolateString(e.stream||"")});return await this.processMetricFindQuery(t)}async processMetricFindQuery(e){return e.type===Qe.LabelNames?this.labelNamesQuery():e.label?e.stream?this.labelValuesSeriesQuery(e.stream,e.label):this.labelValuesQuery(e.label):[]}async legacyProcessMetricFindQuery(e){if(e.match(Mt))return await this.labelNamesQuery();const t=e.match(At);return t?t[1]?await this.labelValuesSeriesQuery(t[1],t[2]):await this.labelValuesQuery(t[2]):Promise.resolve([])}async labelNamesQuery(){const e=this.getTimeRangeParams();return(await this.metadataRequest("labels",e)).map((e=>({text:e})))}async labelValuesQuery(e){const t=this.getTimeRangeParams(),r=`label/${e}/values`;return(await this.metadataRequest(r,t)).map((e=>({text:e})))}async labelValuesSeriesQuery(e,t){const r=this.getTimeRangeParams(),a=Object.assign({},r,{"match[]":e}),n=new Set;return(await this.metadataRequest("series",a)).forEach((e=>{e[t]&&n.add({text:e[t]})})),Array.from(n)}async getDataSamples(e){if(!vt(e.expr)||!bt(e.expr))return[];const t=wr({expr:e.expr,queryType:ye.Range,refId:"log-samples",maxLines:10},(0,ee.JK)(),Q.zj.Explore,"log-samples",!0);return await(0,A.n)(this.query(t).pipe((0,K.w)((e=>(0,W.of)(e.data)))))}async getTagKeys(){return await this.labelNamesQuery()}async getTagValues(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return await this.labelValuesQuery(e.key)}interpolateQueryExpr(e,t){if(!t.multi&&!t.includeAll)return Sr(e);if("string"==typeof e)return Tr(e);return(0,m.map)(e,Tr).join("|")}modifyQuery(e,t){var r;let a=null!==(r=e.expr)&&void 0!==r?r:"";switch(t.type){case"ADD_FILTER":var n,s;if(null!==(n=t.options)&&void 0!==n&&n.key&&null!==(s=t.options)&&void 0!==s&&s.value){const e=(0,Vt.Hk)(t.options.value);a=Ht(a,t.options.key,"=",e)}break;case"ADD_FILTER_OUT":var i,o;if(null!==(i=t.options)&&void 0!==i&&i.key&&null!==(o=t.options)&&void 0!==o&&o.value){const e=(0,Vt.Hk)(t.options.value);a=Ht(a,t.options.key,"!=",e)}break;case"ADD_LOGFMT_PARSER":a=Jt(a,"logfmt");break;case"ADD_JSON_PARSER":a=Jt(a,"json");break;case"ADD_NO_PIPELINE_ERROR":a=function(e){const t=ar(e);return t.length?ir(e,t,sr("__error__","","=")):e}(a);break;case"ADD_LEVEL_LABEL_FORMAT":var l,u;null!==(l=t.options)&&void 0!==l&&l.originalLabel&&null!==(u=t.options)&&void 0!==u&&u.renameTo&&(a=er(a,{renameTo:t.options.renameTo,originalLabel:t.options.originalLabel}))}return Object.assign({},e,{expr:a})}getTime(e,t){return"string"==typeof e&&(e=te.parse(e,t)),Math.ceil(1e6*e.valueOf())}testDatasource(){const e=Date.now(),t={start:(e-6e5)*qr,end:e*qr};return this.metadataRequest("labels",t).then((e=>e.length>0?{status:"success",message:"Data source connected and labels found."}:{status:"error",message:"Data source connected, but no labels received. Verify that Loki and Promtail is configured properly."}),(e=>{var t,r;const a=null!==(t=null==e||null===(r=e.data)||void 0===r?void 0:r.message)&&void 0!==t?t:"";return{status:"error",message:`Unable to fetch labels from Loki${""!==a?` (${a})`:""}, please check the server logs for more details`}}))}async annotationQuery(e){const{expr:t,maxLines:r,instant:a,tagKeys:n="",titleFormat:s="",textFormat:i=""}=e.annotation;if(!t)return[];const o=`annotation-${e.annotation.name}`,l=wr({refId:o,expr:t,maxLines:r,instant:a,queryType:a?ye.Instant:ye.Range},e.range,Q.zj.Dashboard,o),{data:u}=await(0,A.n)(this.query(l)),c=[],d=n.split(",").filter((e=>""!==e));for(const e of u){new re.U(e).forEach((e=>{const{labels:t}=e,r=Object.entries(t).map((e=>{let[t,r]=e;return[t,r.trim()]})).filter((e=>{let[t,r]=e;return""!==r&&!(d.length&&!d.includes(t))})).map((e=>{let[t,r]=e;return r})),a=Array.from(new Set(r));c.push({time:new Date(e.Time).valueOf(),title:(0,de.W)(s,t),text:(0,de.W)(i,t)||e.Line,tags:a})}))}return c}showContextToggle(e){return!0===(e&&e.searchWords&&e.searchWords.length>0)}processError(e,t){let r=(0,m.cloneDeep)(e);return r.refId=t.refId,r.data&&e.data.message.includes("escape")&&t.expr.includes("\\")&&(r.data.message=`Error: ${e.data.message}. Make sure that all special characters are escaped with \\. For more information on escaping of special characters visit LogQL documentation at https://grafana.com/docs/loki/latest/logql/.`),r}addAdHocFilters(e){const t=this.templateSrv.getAdhocFilters(this.name);let r=(0,pe.bU)(e);return r=t.reduce(((e,t)=>{const{key:r,operator:a}=t;let{value:n}=t;return n=(0,Vt._z)(a)?Sr(n):(0,Vt.Hk)(n,a),Ht(e,r,a,n)}),r),(0,pe.Tt)(r)}filterQuery(e){return!e.hide&&""!==e.expr}applyTemplateVariables(e,t){const r=function(e,t){if(null==e)return{};var r,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(t,Rr),a=this.addAdHocFilters(e.expr);return Object.assign({},e,{legendFormat:this.templateSrv.replace(e.legendFormat,r),expr:this.templateSrv.replace(a,r,this.interpolateQueryExpr)})}interpolateString(e){return this.templateSrv.replace(e,void 0,this.interpolateQueryExpr)}getVariables(){return this.templateSrv.getVariables().map((e=>`$${e.name}`))}getQueryHints(e,t){return cr(e.expr,t)}}function Sr(e){return"string"==typeof e?e.replace(/'/g,"\\\\'"):e}function Tr(e){return"string"==typeof e?Sr(e.replace(/\\/g,"\\\\\\\\").replace(/[$^*{}\[\]+?.()|]/g,"\\\\$&")):e}function Fr(e){var t;let r;try{r=new Z.N(e).getFirstFieldOfType(H.fS.number)}catch{}return null!==(t=r)&&void 0!==t&&t.labels?function(e){const t=["level","lvl","loglevel"];let r;for(let a of t)if(a in e){r=a;break}return r?(0,ne.jx)(e[r]):ae.in.unknown}(r.labels):ae.in.unknown}function kr(e){let{onChange:t,index:r,operationIndex:a,value:n,query:s,datasource:i}=e;const[o,l]=(0,O.useState)({});return(0,h.jsx)(V.Ph,{inputId:(0,k.i1)(a,r),onOpenMenu:async()=>{if(i instanceof $r){l({isLoading:!0});const e=await async function(e,t){var r,a,n,s;const i=function(e){if(bt(e))return e;const t=ot.parse(e);let r="";t.iterate({enter:t=>{let{type:a,from:n,to:s}=t;if(35===a.id)return r=e.substring(n,s),!1}});let a="";return t.iterate({enter:t=>{let{type:r,from:n,to:s}=t;if(44===r.id)return a=e.substring(n,s),!1}}),r+a}(zr.renderQuery(e));if(!vt(i))return[];const o=await t.getDataSamples({expr:i,refId:"unwrap_samples"}),l=null!==(r=null===(a=o[0])||void 0===a||null===(n=a.fields)||void 0===n||null===(s=n.find((e=>"labels"===e.name)))||void 0===s?void 0:s.values.toArray())&&void 0!==r?r:[];if(!l||0===l.length)return[];const u=Object.keys(l[0]).filter((e=>{const t=l[0][e];return!!t&&(!(0,m.isNaN)(Number(t))||(0,I.IA)(t)||(0,Vt.aC)(t))})),c=[];for(const e of u)l.every((t=>t[e]))&&c.push(e);return c.map((e=>({label:e,value:e})))}(s,i);l({options:e,isLoading:void 0})}},isLoading:o.isLoading,allowCustomValue:!0,noOptionsMessage:"No labels found",loadingMessage:"Loading labels",options:o.options,value:n?(0,D.E)(n.toString()):null,onChange:e=>{e.value&&t(r,e.value)}})}var Cr=r(47908);function Er(e,t){const r=[{name:"Range",type:"string",options:["$__interval","$__range","1m","5m","10m","1h","24h"]}],a=["$__interval"];let n;return e===E.QuantileOverTime&&(a.push("0.95"),r.push({name:"Quantile",type:"number"})),t&&(r.push({name:"By label",type:"string",restParam:!0,optional:!0}),n=(0,k.ZI)(`__${e}_by`)),{id:e,name:(0,k.t7)(e),params:r,defaultParams:a,alternativesKey:"range function",category:C.RangeFunctions,orderRank:N.RangeVectorFunction,renderer:Xr,addOperationHandler:Mr,paramChangedHandler:n,explainHandler:(e,t)=>{var r,a;let n=null!==(r=null===(a=ve.r8.find((t=>t.insertText===e.id)))||void 0===a?void 0:a.documentation)&&void 0!==r?r:"";return"$__interval"===e.params[0]?`${n} \`$__interval\` is a variable that will be replaced with the [calculated interval](https://grafana.com/docs/grafana/latest/dashboards/variables/add-template-variables/#__interval) based on the time range and width of the graph. In Dashboards, you can affect the interval variable using **Max data points** and **Min interval**. You can find these options under **Query options** right of the data source select dropdown.`:`${n} The [range vector](https://grafana.com/docs/loki/latest/logql/metric_queries/#range-vector-aggregation) is set to \`${e.params[0]}\`.`}}}function Nr(e){const t=Er(e,!0),r=t.params.slice(0,-1);return[t,{id:`__${e}_by`,name:`${(0,k.t7)(e)} by`,params:[...r,{name:"Label",type:"string",restParam:!0,optional:!0,editor:Cr.g}],defaultParams:[...t.defaultParams,""],alternativesKey:"range function with grouping",category:C.RangeFunctions,renderer:Ur(e,"by"),paramChangedHandler:(0,k.j8)(e),explainHandler:(0,k.Sp)(e,"by"),addOperationHandler:Mr,hideFromList:!0},{id:`__${e}_without`,name:`${(0,k.t7)(e)} without`,params:[...r,{name:"Label",type:"string",restParam:!0,optional:!0,editor:Cr.g}],defaultParams:[...t.defaultParams,""],alternativesKey:"range function with grouping",category:C.RangeFunctions,renderer:Ur(e,"without"),paramChangedHandler:(0,k.j8)(e),explainHandler:(0,k.Sp)(e,"without"),addOperationHandler:Mr,hideFromList:!0}]}function Ur(e,t){return function(r,a,n){const s=a.params.findIndex((e=>e.restParam)),i=r.params.slice(0,s),o=r.params.slice(s);return 2===i.length&&e===E.QuantileOverTime?`${e}(${i[1]}, ${n} [${i[0]}]) ${t} (${o.join(", ")})`:`${e}(${n} [${i[0]}]) ${t} (${o.join(", ")})`}}function Xr(e,t,r){var a,n,s;const i=null!==(a=e.params)&&void 0!==a?a:[],o=null!==(n=i[0])&&void 0!==n?n:"$__interval";if(2===i.length&&e.id===E.QuantileOverTime){const t=i[1];return`${e.id}(${t}, ${r} [${o}])`}return`${e.id}(${r} [${null!==(s=i[0])&&void 0!==s?s:"$__interval"}])`}function Dr(e,t,r){return""===e.params[0]?r:"<"===e.params[1]||">"===e.params[1]?`${r} | ${e.params[0]} ${e.params[1]} ${e.params[2]}`:`${r} | ${e.params[0]} ${e.params[1]} \`${e.params[2]}\``}function Ir(e,t,r){return`${r} | ${e.id}`}function Vr(e,t,r){const a=e.findIndex((e=>{const a=t.getOperationDef(e.id);return!!a&&r(a)}));return-1===a?e.length:a}function Mr(e,t,r){const a={id:e.id,params:e.defaultParams},n=[...t.operations],s=n.find((e=>{const t=r.getOperationDef(e.id);return!!t&&function(e){return e.category===C.RangeFunctions}(t)}));switch(e.category){case C.Aggregations:case C.Functions:if(!s){const e=Vr(n,r,(e=>e.category===C.Functions));n.splice(e,0,{id:E.Rate,params:["$__interval"]})}n.push(a);break;case C.RangeFunctions:if(s){const e=n.indexOf(s);n[e]=a;break}default:const t=Vr(n,r,(t=>{var r,a;return(null!==(r=e.orderRank)&&void 0!==r?r:100)<(null!==(a=t.orderRank)&&void 0!==a?a:100)}));n.splice(t,0,a)}return Object.assign({},t,{operations:n})}function Ar(e,t){var r;return Object.assign({},t,{binaryQueries:[...null!==(r=t.binaryQueries)&&void 0!==r?r:[],{operator:"/",query:t}]})}function Wr(e){return function(t,r,a){return`${a} ${e} \`${t.params[0]}\``}}function Yr(){return[...[E.Sum,E.Min,E.Max,E.Avg,E.Stddev,E.Stdvar,E.Count].flatMap((e=>(0,k.IT)(e,{addOperationHandler:Mr,orderRank:N.Last}))),...[E.TopK,E.BottomK].flatMap((e=>(0,k.Z3)(e,{params:[{name:"K-value",type:"number"}],defaultParams:[5]},{addOperationHandler:Mr,orderRank:N.Last}))),...[Er(E.Rate),Er(E.CountOverTime),Er(E.SumOverTime),Er(E.BytesRate),Er(E.BytesOverTime),Er(E.AbsentOverTime)],...[...Nr(E.AvgOverTime),...Nr(E.MaxOverTime),...Nr(E.MinOverTime),...Nr(E.FirstOverTime),...Nr(E.LastOverTime),...Nr(E.StdvarOverTime),...Nr(E.StddevOverTime),...Nr(E.QuantileOverTime)],{id:E.Json,name:"Json",params:[{name:"Expression",type:"string",restParam:!0,optional:!0,minWidth:18,placeholder:'server="servers[0]"',description:"Using expressions with your json parser will extract only the specified json fields to labels. You can specify one or more expressions in this way. All expressions must be quoted."}],defaultParams:[],alternativesKey:"format",category:C.Formats,orderRank:N.LineFormats,renderer:(e,t,r)=>`${r} | json ${e.params.join(", ")}`.trim(),addOperationHandler:Mr,explainHandler:()=>"This will extract keys and values from a [json](https://grafana.com/docs/loki/latest/logql/log_queries/#json) formatted log line as labels. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation."},{id:E.Logfmt,name:"Logfmt",params:[],defaultParams:[],alternativesKey:"format",category:C.Formats,orderRank:N.LineFormats,renderer:Ir,addOperationHandler:Mr,explainHandler:()=>"This will extract all keys and values from a [logfmt](https://grafana.com/docs/loki/latest/logql/log_queries/#logfmt) formatted log line as labels. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation."},{id:E.Regexp,name:"Regexp",params:[{name:"String",type:"string",hideName:!0,placeholder:"<re>",description:"The regexp expression that matches the structure of a log line.",minWidth:20}],defaultParams:[""],alternativesKey:"format",category:C.Formats,orderRank:N.LineFormats,renderer:(e,t,r)=>`${r} | regexp \`${e.params[0]}\``,addOperationHandler:Mr,explainHandler:()=>'The [regexp parser](https://grafana.com/docs/loki/latest/logql/log_queries/#regular-expression) takes a single parameter | regexp "<re>" which is the regular expression using the Golang RE2 syntax. The regular expression must contain a least one named sub-match (e.g (?P<name>re)), each sub-match will extract a different label. The expression matches the structure of a log line. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation.'},{id:E.Pattern,name:"Pattern",params:[{name:"String",type:"string",hideName:!0,placeholder:"<pattern-expression>",description:"The expression that matches the structure of a log line.",minWidth:20}],defaultParams:[""],alternativesKey:"format",category:C.Formats,orderRank:N.LineFormats,renderer:(e,t,r)=>`${r} | pattern \`${e.params[0]}\``,addOperationHandler:Mr,explainHandler:()=>"The [pattern parser](https://grafana.com/docs/loki/latest/logql/log_queries/#pattern) allows the explicit extraction of fields from log lines by defining a pattern expression (| pattern `<pattern-expression>`). The expression matches the structure of a log line. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation."},{id:E.Unpack,name:"Unpack",params:[],defaultParams:[],alternativesKey:"format",category:C.Formats,orderRank:N.LineFormats,renderer:Ir,addOperationHandler:Mr,explainHandler:()=>"This will extract all keys and values from a JSON log line, [unpacking](https://grafana.com/docs/loki/latest/logql/log_queries/#unpack) all embedded labels in the pack stage. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation."},{id:E.LineFormat,name:"Line format",params:[{name:"String",type:"string",hideName:!0,placeholder:"{{.status_code}}",description:"A line template that can refer to stream labels and extracted labels.",minWidth:20}],defaultParams:[""],alternativesKey:"format",category:C.Formats,orderRank:N.LineFormats,renderer:(e,t,r)=>`${r} | line_format \`${e.params[0]}\``,addOperationHandler:Mr,explainHandler:()=>"This will replace log line using a specified template. The template can refer to stream labels and extracted labels.\n\nExample: `{{.status_code}} - {{.message}}`\n\n[Read the docs](https://grafana.com/docs/loki/latest/logql/log_queries/#line-format-expression) for more.\n        "},{id:E.LabelFormat,name:"Label format",params:[{name:"Label",type:"string"},{name:"Rename to",type:"string"}],defaultParams:["",""],alternativesKey:"format",category:C.Formats,orderRank:N.LineFormats,renderer:(e,t,r)=>`${r} | label_format ${e.params[1]}=${e.params[0]}`,addOperationHandler:Mr,explainHandler:()=>'This will change name of label to desired new label. In the example below, label "error_level" will be renamed to "level".\n\nExample: ``error_level=`level` ``\n\n[Read the docs](https://grafana.com/docs/loki/latest/logql/log_queries/#labels-format-expression) for more.\n        '},{id:E.LineContains,name:"Line contains",params:[{name:"String",type:"string",hideName:!0,placeholder:"Text to find",description:"Find log lines that contains this text",minWidth:20,runQueryOnEnter:!0}],defaultParams:[""],alternativesKey:"line filter",category:C.LineFilters,orderRank:N.LineFilters,renderer:Wr("|="),addOperationHandler:Mr,explainHandler:e=>`Return log lines that contain string \`${e.params[0]}\`.`},{id:E.LineContainsNot,name:"Line does not contain",params:[{name:"String",type:"string",hideName:!0,placeholder:"Text to exclude",description:"Find log lines that does not contain this text",minWidth:26,runQueryOnEnter:!0}],defaultParams:[""],alternativesKey:"line filter",category:C.LineFilters,orderRank:N.LineFilters,renderer:Wr("!="),addOperationHandler:Mr,explainHandler:e=>`Return log lines that does not contain string \`${e.params[0]}\`.`},{id:E.LineMatchesRegex,name:"Line contains regex match",params:[{name:"Regex",type:"string",hideName:!0,placeholder:"Pattern to match",description:"Find log lines that match this regex pattern",minWidth:30,runQueryOnEnter:!0}],defaultParams:[""],alternativesKey:"line filter",category:C.LineFilters,orderRank:N.LineFilters,renderer:Wr("|~"),addOperationHandler:Mr,explainHandler:e=>`Return log lines that match regex \`${e.params[0]}\`.`},{id:E.LineMatchesRegexNot,name:"Line does not match regex",params:[{name:"Regex",type:"string",hideName:!0,placeholder:"Pattern to exclude",description:"Find log lines that does not match this regex pattern",minWidth:30,runQueryOnEnter:!0}],defaultParams:[""],alternativesKey:"line filter",category:C.LineFilters,orderRank:N.LineFilters,renderer:Wr("!~"),addOperationHandler:Mr,explainHandler:e=>`Return log lines that does not match regex \`${e.params[0]}\`.`},{id:E.LineFilterIpMatches,name:"IP line filter expression",params:[{name:"Operator",type:"string",options:["|=","!="]},{name:"Pattern",type:"string",placeholder:"<pattern>",minWidth:16,runQueryOnEnter:!0}],defaultParams:["|=",""],alternativesKey:"line filter",category:C.LineFilters,orderRank:N.LineFilters,renderer:(e,t,r)=>`${r} ${e.params[0]} ip(\`${e.params[1]}\`)`,addOperationHandler:Mr,explainHandler:e=>`Return log lines using IP matching of \`${e.params[1]}\``},{id:E.LabelFilter,name:"Label filter expression",params:[{name:"Label",type:"string"},{name:"Operator",type:"string",options:["=","!="," =~","!~",">","<",">=","<="]},{name:"Value",type:"string"}],defaultParams:["","=",""],alternativesKey:"label filter",category:C.LabelFilters,orderRank:N.LabelFilters,renderer:Dr,addOperationHandler:Mr,explainHandler:()=>"Label expression filter allows filtering using original and extracted labels."},{id:E.LabelFilterIpMatches,name:"IP label filter expression",params:[{name:"Label",type:"string"},{name:"Operator",type:"string",options:["=","!="]},{name:"Value",type:"string"}],defaultParams:["","=",""],alternativesKey:"label filter",category:C.LabelFilters,orderRank:N.LabelFilters,renderer:(e,t,r)=>`${r} | ${e.params[0]} ${e.params[1]} ip(\`${e.params[2]}\`)`,addOperationHandler:Mr,explainHandler:e=>`Return log lines using IP matching of \`${e.params[2]}\` for \`${e.params[0]}\` label`},{id:E.LabelFilterNoErrors,name:"No pipeline errors",params:[],defaultParams:[],alternativesKey:"label filter",category:C.LabelFilters,orderRank:N.NoErrors,renderer:(e,t,r)=>`${r} | __error__=\`\``,addOperationHandler:Mr,explainHandler:()=>"Filter out all formatting and parsing errors."},{id:E.Unwrap,name:"Unwrap",params:[{name:"Identifier",type:"string",hideName:!0,minWidth:16,placeholder:"Label key",editor:kr},{name:"Conversion function",hideName:!0,type:"string",options:["duration","duration_seconds","bytes"],optional:!0}],defaultParams:["",""],alternativesKey:"format",category:C.Formats,orderRank:N.Unwrap,renderer:(e,t,r)=>`${r} | unwrap ${e.params[1]?`${e.params[1]}(${e.params[0]})`:e.params[0]}`,addOperationHandler:Mr,explainHandler:e=>{let t=String(e.params[0]).length>0?e.params[0]:"<label>";return`Use the extracted label \`${t}\` as sample values instead of log lines for the subsequent range aggregation.${e.params[1]?` Conversion function \`${e.params[1]}\` wrapping \`${t}\` will attempt to convert this label from a specific format (e.g. 3k, 500ms).`:""}`}},...X,{id:E.NestedQuery,name:"Binary operation with query",params:[],defaultParams:[],category:C.BinaryOps,renderer:(e,t,r)=>r,addOperationHandler:Ar}]}class Gr extends F.x{constructor(){super(Yr),this.setOperationCategories([C.Aggregations,C.RangeFunctions,C.Formats,C.BinaryOps,C.LabelFilters,C.LineFilters])}renderLabels(e){return 0===e.length?"{}":super.renderLabels(e)}getQueryPatterns(){return[{name:"Log query with parsing",operations:[{id:E.Logfmt,params:[]},{id:E.LabelFilterNoErrors,params:[]}]},{name:"Log query with filtering and parsing",operations:[{id:E.LineContains,params:[""]},{id:E.Logfmt,params:[]},{id:E.LabelFilterNoErrors,params:[]}]},{name:"Log query with parsing and label filter",operations:[{id:E.LineContains,params:[""]},{id:E.Logfmt,params:[]},{id:E.LabelFilterNoErrors,params:[]},{id:E.LabelFilter,params:["label","=","value"]}]},{name:"Log query with parsing of nested json",operations:[{id:E.LineContains,params:[""]},{id:E.Json,params:[]},{id:E.LabelFilterNoErrors,params:[]},{id:E.LineFormat,params:["{{.message}}"]},{id:E.Json,params:[]},{id:E.LabelFilterNoErrors,params:[]}]},{name:"Log query with reformatted log line",operations:[{id:E.LineContains,params:[""]},{id:E.Logfmt,params:[]},{id:E.LabelFilterNoErrors,params:[]},{id:E.LineFormat,params:["{{.message}}"]}]},{name:"Log query with mapped log level",operations:[{id:E.LineContains,params:[""]},{id:E.Logfmt,params:[]},{id:E.LabelFilterNoErrors,params:[]},{id:E.LabelFormat,params:["lvl","level"]}]},{name:"Metrics query on value inside log line",operations:[{id:E.LineContains,params:[""]},{id:E.Logfmt,params:[]},{id:E.LabelFilterNoErrors,params:[]},{id:E.Unwrap,params:[""]},{id:E.LabelFilterNoErrors,params:[]},{id:E.SumOverTime,params:["$__interval"]},{id:E.Sum,params:[]}]},{name:"Metrics query for total requests per label of streams",operations:[{id:E.LineContains,params:[""]},{id:E.CountOverTime,params:["$__interval"]},{id:E.Sum,params:[]}]},{name:"Metrics query for total requests per parsed label or label of streams",operations:[{id:E.LineContains,params:[""]},{id:E.Logfmt,params:[]},{id:E.LabelFilterNoErrors,params:[]},{id:E.CountOverTime,params:["$__interval"]},{id:E.Sum,params:[]}]},{name:"Metrics query for bytes used by log stream",operations:[{id:E.LineContains,params:[""]},{id:E.BytesOverTime,params:["$__interval"]}]},{name:"Metrics query for count of log lines per stream",operations:[{id:E.LineContains,params:[""]},{id:E.CountOverTime,params:["$__interval"]}]},{name:"Metrics query for top n results by label or parsed label",operations:[{id:E.Logfmt,params:[]},{id:E.LabelFilterNoErrors,params:[]},{id:E.CountOverTime,params:["$__interval"]},{id:E.Sum,params:[]},{id:E.TopK,params:[10]}]},{name:"Metrics query for extracted quantile",operations:[{id:E.Logfmt,params:[]},{id:E.LabelFilterNoErrors,params:[]},{id:E.Unwrap,params:["latency"]},{id:E.LabelFilterNoErrors,params:[]},{id:E.QuantileOverTime,params:["$__interval",.5]},{id:E.Sum,params:[]}]}]}}const zr=new Gr;var Kr=r(17421);const Br="LokiQueryEditorModeDefault";function Zr(e){if(null!=e&&""!==e)return S.c.Code;const t=Kr.Z.get(Br);switch(t){case S.c.Builder:case S.c.Code:return t;default:return S.c.Builder}}var Hr=r(14066),Jr=r(71358),ea=r(22142),ta=r(92448),ra=r(74929),aa=r(2398),na=r(47352),sa=r(3690);const ia="Fetch all log lines matching label filters.",oa=O.memo((e=>{let{query:t}=e;const r=Yt(t||"").query,a={grammar:ve.xY,name:"lokiql"};return(0,h.jsxs)(R.Stack,{gap:0,direction:"column",children:[(0,h.jsx)(ea.B,{stepNumber:1,title:(0,h.jsx)(sa.U,{query:`${zr.renderLabels(r.labels)}`,lang:a}),children:ia}),(0,h.jsx)(ra.V,{stepNumber:2,queryModeller:zr,query:r,lang:a})]})}));oa.displayName="LokiQueryBuilderExplained";var la,ua=r(9617),ca=r(82038),da=r(85965);const pa=O.memo((e=>{let{nestedQuery:t,index:r,datasource:a,onChange:n,onRemove:s,onRunQuery:i,showExplain:o}=e;const l=(0,ua.wW)(Oa);return(0,h.jsxs)("div",{className:l.card,children:[(0,h.jsxs)("div",{className:l.header,children:[(0,h.jsx)("div",{className:l.name,children:"Operator"}),(0,h.jsx)(V.Ph,{width:"auto",options:ma,value:(0,D.E)(t.operator),onChange:e=>{n(r,Object.assign({},t,{operator:e.value}))}}),(0,h.jsx)("div",{className:l.name,children:"Vector matches"}),(0,h.jsxs)("div",{className:l.vectorMatchWrapper,children:[(0,h.jsx)(V.Ph,{width:"auto",value:t.vectorMatchesType||"on",allowCustomValue:!0,options:[{value:"on",label:"on"},{value:"ignoring",label:"ignoring"}],onChange:e=>{n(r,Object.assign({},t,{vectorMatchesType:e.value}))}}),(0,h.jsx)(ca.H,{className:l.vectorMatchInput,minWidth:20,defaultValue:t.vectorMatches,onCommitChange:e=>{n(r,Object.assign({},t,{vectorMatches:e.currentTarget.value,vectorMatchesType:t.vectorMatchesType||"on"}))}})]}),la||(la=(0,h.jsx)(R.FlexItem,{grow:1})),(0,h.jsx)(da.h,{name:"times",size:"sm",onClick:()=>s(r)})]}),(0,h.jsx)("div",{className:l.body,children:(0,h.jsx)(R.EditorRows,{children:(0,h.jsx)(ha,{showExplain:o,query:t.query,datasource:a,onRunQuery:i,onChange:e=>{n(r,Object.assign({},t,{query:e}))}})})})]})})),ma=U.map((e=>({label:e.sign,value:e.sign})));pa.displayName="NestedQuery";const Oa=e=>({card:(0,St.css)({label:"card",display:"flex",flexDirection:"column",gap:e.spacing(.5)}),header:(0,St.css)({label:"header",padding:e.spacing(.5,.5,.5,1),gap:e.spacing(1),display:"flex",alignItems:"center"}),name:(0,St.css)({label:"name",whiteSpace:"nowrap"}),body:(0,St.css)({label:"body",paddingLeft:e.spacing(2)}),vectorMatchInput:(0,St.css)({label:"vectorMatchInput",marginLeft:-1}),vectorMatchWrapper:(0,St.css)({label:"vectorMatchWrapper",display:"flex"})});function ga(e){var t;let{query:r,datasource:a,onChange:n,onRunQuery:s,showExplain:i}=e;const o=null!==(t=r.binaryQueries)&&void 0!==t?t:[],l=(e,t)=>{const a=[...o];a.splice(e,1,t),n(Object.assign({},r,{binaryQueries:a}))},u=e=>{const t=[...o.slice(0,e),...o.slice(e+1)];n(Object.assign({},r,{binaryQueries:t}))};return(0,h.jsx)(R.Stack,{direction:"column",gap:1,children:o.map(((e,t)=>(0,h.jsx)(pa,{nestedQuery:e,index:t,onChange:l,datasource:a,onRemove:u,onRunQuery:s,showExplain:i},t.toString())))})}const ha=O.memo((e=>{let{datasource:t,query:r,onChange:a,onRunQuery:n,showExplain:s}=e;const[i,o]=(0,O.useState)(),[l,u]=(0,O.useState)(void 0),c=async e=>{const r=await e;return[...t.getVariables(),...r].map((e=>({label:e,value:e})))},d=(0,O.useMemo)((()=>{const{labels:e,operations:t}=r;if(!e.length&&t.length){if(1===t.length&&t[0].id===E.LineContains&&""===t[0].params[0])return;return"Select at least 1 label filter (label and value)"}}),[r]);(0,O.useEffect)((()=>{(async()=>{const e={expr:zr.renderQuery(r),refId:"data-samples"},a={series:await t.getDataSamples(e),state:_.Gu.Done,timeRange:(0,ee.JK)()};o(a)})().catch(console.error)}),[t,r]);const p={grammar:ve.ZP,name:"logql"};return(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(R.EditorRow,{children:(0,h.jsx)(Jr.P,{onGetLabelNames:e=>c((async e=>{const a=r.labels.filter((t=>t!==e));if(0===a.length)return await t.languageProvider.refreshLogLabels(),t.languageProvider.getLabelKeys();const n=zr.renderLabels(a),s=await t.languageProvider.fetchSeriesLabels(n),i=a.map((e=>e.label));return Object.keys(s).filter((e=>!i.includes(e))).sort()})(e)),onGetLabelValues:e=>c((async e=>{if(!e.label)return[];let a;const n=r.labels.filter((t=>t!==e));if(0===n.length)a=await t.languageProvider.fetchLabelValues(e.label);else{const r=zr.renderLabels(n);a=(await t.languageProvider.fetchSeriesLabels(r))[t.interpolateString(e.label)]}return a?a.map((t=>(0,Vt.Hk)(t,e.op))):[]})(e)),labelsFilters:r.labels,onChange:e=>{a(Object.assign({},r,{labels:e}))},error:d})}),s&&(0,h.jsx)(ea.B,{stepNumber:1,title:(0,h.jsx)(sa.U,{query:`${zr.renderLabels(r.labels)}`,lang:p}),children:ia}),(0,h.jsxs)(aa.B,{children:[(0,h.jsx)(ta.P,{queryModeller:zr,query:r,onChange:a,onRunQuery:n,datasource:t,highlightedOp:l}),(0,h.jsx)(na.L,{datasource:t,query:r,onChange:a,data:i,queryModeller:zr,buildVisualQueryFromString:Yt})]}),s&&(0,h.jsx)(ra.V,{stepNumber:2,queryModeller:zr,query:r,lang:p,onMouseEnter:e=>{u(e)},onMouseLeave:()=>{u(void 0)}}),r.binaryQueries&&r.binaryQueries.length>0&&(0,h.jsx)(ga,{query:r,datasource:t,onChange:a,onRunQuery:n,showExplain:s})]})}));function fa(e){let{query:t}=e;return(0,h.jsx)(R.EditorRow,{children:(0,h.jsx)(R.EditorFieldGroup,{children:(0,h.jsx)(R.EditorField,{label:"Raw query",children:(0,h.jsx)(sa.U,{query:t,lang:{grammar:ve.xY,name:"lokiql"}})})})})}function va(e){const{query:t,onChange:r,onRunQuery:a,datasource:n,showRawQuery:s,showExplain:i}=e,[o,l]=(0,O.useReducer)(ba.reducer,{expr:t.expr,visQuery:""===t.expr?{labels:[],operations:[{id:"__line_contains",params:[""]}]}:void 0});(0,O.useEffect)((()=>{l(xa(t.expr))}),[t.expr]);return o.visQuery?(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(ha,{query:o.visQuery,datasource:n,onChange:t=>{const a=zr.renderQuery(t);l(ya({visQuery:t,expr:a})),r(Object.assign({},e.query,{expr:a}))},onRunQuery:a,showExplain:i}),s&&(0,h.jsx)(fa,{query:t.expr})]}):null}ha.displayName="LokiQueryBuilder";const ba=(0,Hr.oM)({name:"loki-builder-container",initialState:{expr:""},reducers:{visualQueryChange:(e,t)=>{e.expr=t.payload.expr,e.visQuery=t.payload.visQuery},exprChanged:(e,t)=>{if(!e.visQuery||e.expr!==t.payload){e.expr=t.payload;const r=Yt(t.payload);e.visQuery=r.query}}}}),{visualQueryChange:ya,exprChanged:xa}=ba.actions;var Qa=r(68374);const Pa=O.memo((e=>{var t,r,a;let{app:n,query:s,onChange:i,onRunQuery:o}=e;let l=null!==(t=s.queryType)&&void 0!==t?t:s.instant?ye.Instant:ye.Range,u=bt(s.expr);return(0,h.jsx)(R.EditorRow,{children:(0,h.jsxs)(Qa.d,{title:"Options",collapsedInfo:_a(s,l,u),children:[(0,h.jsx)(R.EditorField,{label:"Legend",tooltip:"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname.",children:(0,h.jsx)(ca.H,{placeholder:"{{label}}",id:"loki-query-editor-legend-format",type:"string",minWidth:14,defaultValue:s.legendFormat,onCommitChange:e=>{i(Object.assign({},s,{legendFormat:e.currentTarget.value})),o()}})}),(0,h.jsx)(R.EditorField,{label:"Type",children:(0,h.jsx)(Ft.S,{options:Et,value:l,onChange:e=>{i(Object.assign({},s,{queryType:e})),o()}})}),u&&(0,h.jsx)(R.EditorField,{label:"Line limit",tooltip:"Upper limit for number of log lines returned by query.",children:(0,h.jsx)(ca.H,{className:"width-4",placeholder:"auto",type:"number",min:0,defaultValue:null!==(r=null===(a=s.maxLines)||void 0===a?void 0:a.toString())&&void 0!==r?r:"",onCommitChange:function(e){const t=Xt(e.currentTarget.value);s.maxLines!==t&&(i(Object.assign({},s,{maxLines:t})),o())}})}),(0,h.jsx)(R.EditorField,{label:"Resolution",children:(0,h.jsx)(V.Ph,{isSearchable:!1,onChange:e=>{(0,g.ff)("grafana_loki_resolution_clicked",{app:n,resolution:e.value}),i(Object.assign({},s,{resolution:e.value})),o()},options:Nt,value:s.resolution||1,"aria-label":"Select resolution"})})]})})}));function _a(e,t,r){const a=Et.find((e=>e.value===t)),n=Nt.find((t=>{var r;return t.value===(null!==(r=e.resolution)&&void 0!==r?r:1)})),s=[];return e.legendFormat&&s.push(`Legend: ${e.legendFormat}`),e.resolution&&s.push(`Resolution: ${null==n?void 0:n.label}`),s.push(`Type: ${null==a?void 0:a.label}`),r&&e.maxLines&&s.push(`Line limit: ${e.maxLines}`),s}var La;function Ra(e){var t;const{query:r,data:a,datasource:n,onChange:s,onRunQuery:i,range:o}=e,l=(0,h.jsx)("div",{className:"gf-form-inline",children:(0,h.jsxs)("div",{className:"gf-form",children:[La||(La=(0,h.jsx)(Tt.c,{width:6,tooltip:"Controls the name of the time series, using name or pattern. For example {{hostname}} will be replaced with label value for the label hostname. The legend only applies to metric queries.",children:"Legend"})),(0,h.jsx)("input",{type:"text",className:"gf-form-input",placeholder:"legend format",value:r.legendFormat||"",onChange:e=>{const t=Object.assign({},r,{legendFormat:e.currentTarget.value});s(t)},onBlur:i})]})});return(0,h.jsx)(Dt.n,{datasource:n,query:r,onChange:s,onRunQuery:i,onBlur:i,history:[],data:a,"data-testid":ja.editor,range:o,ExtraFieldElement:(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(Ut,{lineLimitValue:(null==r||null===(t=r.maxLines)||void 0===t?void 0:t.toString())||"",resolution:(null==r?void 0:r.resolution)||1,query:r,onRunQuery:i,onChange:s,runOnBlur:!0}),l]})})}Pa.displayName="LokiQueryBuilderOptions";const ja={editor:"loki-editor"};function qa(e){let{query:t,datasource:r,range:a,onRunQuery:n,onChange:s,data:i,app:o,showExplain:l}=e;const u=(0,ua.wW)(wa),c=o===Q.zj.Explore?()=>{}:void 0;return(0,h.jsxs)("div",{className:u.wrapper,children:[(0,h.jsx)(Dt.n,{datasource:r,query:t,range:a,onRunQuery:n,onChange:s,onBlur:c,history:[],data:i,"data-testid":ja.editor,app:o}),l&&(0,h.jsx)(oa,{query:t.expr})]})}const wa=e=>({wrapper:St.css`
      .gf-form {
        margin-bottom: 0.5;
      }
    `});var $a,Sa;const Ta=O.memo((e=>{const{onChange:t,onRunQuery:r,data:a,app:n}=e,[s,i]=(0,O.useState)(!1),[o,l]=(0,O.useState)(!1),{flag:u,setFlag:c}=(0,T.P5)(T.iS),{flag:d,setFlag:p}=(0,T.P5)(T.J$,!0),m=function(e){let t=e;return e.editorMode||(t=Object.assign({},e,{editorMode:Zr(e.expr)})),null==e.expr&&(t=Object.assign({},t,{expr:""})),null==e.queryType&&(t=Object.assign({},t,{queryType:ye.Range})),t}(e.query),f=m.editorMode,v=(0,O.useCallback)((e=>{var r;if((0,g.ff)("grafana_loki_editor_mode_clicked",{newEditor:e,previousEditor:null!==(r=m.editorMode)&&void 0!==r?r:"",newQuery:!m.expr,app:null!=n?n:""}),e===S.c.Builder){if(Yt(m.expr||"").errors.length)return void i(!0)}!function(e,t,r){""===e.expr&&Kr.Z.set(Br,t),r(Object.assign({},e,{editorMode:t}))}(m,e,t)}),[t,m,n]);(0,O.useEffect)((()=>{l(!1)}),[a]);const b=e=>{l(!0),t(e)};return(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(j.s,{isOpen:s,title:"Query parsing",body:"There were errors while trying to parse the query. Continuing to visual builder may lose some parts of the query.",confirmText:"Continue",onConfirm:()=>{t(Object.assign({},m,{editorMode:S.c.Builder})),i(!1)},onDismiss:()=>i(!1)}),(0,h.jsxs)(R.EditorHeader,{children:[(0,h.jsx)(R.InlineSelect,{value:null,onOpenMenu:()=>{const e=Yt(m.expr||"");(0,g.ff)("grafana_loki_query_patterns_opened",{version:"v1",app:null!=n?n:"",editorMode:m.editorMode,preSelectedOperationsCount:e.query.operations.length,preSelectedLabelsCount:e.query.labels.length})},placeholder:"Query patterns","aria-label":L.wl.components.QueryBuilder.queryPatterns,allowCustomValue:!0,onChange:e=>{let{value:r}=e;const a=Yt(m.expr||"");(0,g.ff)("grafana_loki_query_patterns_selected",{version:"v1",app:null!=n?n:"",editorMode:m.editorMode,selectedPattern:null==r?void 0:r.name,preSelectedOperationsCount:a.query.operations.length,preSelectedLabelsCount:a.query.labels.length}),a.query.operations=null==r?void 0:r.operations,t(Object.assign({},m,{expr:zr.renderQuery(a.query)}))},options:zr.getQueryPatterns().map((e=>({label:e.name,value:e})))}),(0,h.jsx)($.n,{label:"Explain",value:u,onChange:e=>{c(e.currentTarget.checked)}}),f===S.c.Builder&&(0,h.jsx)(h.Fragment,{children:(0,h.jsx)($.n,{label:"Raw query",value:d,onChange:e=>{const t=e.currentTarget.checked;p(t)}})}),$a||($a=(0,h.jsx)(R.FlexItem,{grow:1})),n!==Q.zj.Explore&&(0,h.jsx)(q.zx,{variant:o?"primary":"secondary",size:"sm",onClick:r,icon:(null==a?void 0:a.state)===_.Gu.Loading?"fa fa-spinner":void 0,disabled:(null==a?void 0:a.state)===_.Gu.Loading,children:"Run queries"}),(0,h.jsx)(w.k,{mode:f,onChange:v})]}),Sa||(Sa=(0,h.jsx)(R.Space,{v:.5})),(0,h.jsxs)(R.EditorRows,{children:[f===S.c.Code&&(0,h.jsx)(qa,Object.assign({},e,{query:m,onChange:b,showExplain:u})),f===S.c.Builder&&(0,h.jsx)(va,{datasource:e.datasource,query:m,onChange:b,onRunQuery:e.onRunQuery,showRawQuery:d,showExplain:u}),(0,h.jsx)(Pa,{query:m,onChange:t,onRunQuery:r,app:n})]})]})}));Ta.displayName="LokiQueryEditorSelector";const Fa=(0,O.memo)((e=>{var t;const{query:r,data:a,datasource:n,history:s,onChange:i,onRunQuery:o,range:l}=e;return(0,h.jsx)(Dt.n,{datasource:n,query:r,onChange:i,onBlur:()=>{},onRunQuery:o,history:s,data:a,range:l,"data-testid":ka.editor,ExtraFieldElement:(0,h.jsx)(Ut,{lineLimitValue:(null==r||null===(t=r.maxLines)||void 0===t?void 0:t.toString())||"",resolution:r.resolution||1,query:r,onRunQuery:o,onChange:i})})}));Fa.displayName="LokiExploreQueryEditor";const ka={editor:"loki-editor-explore"};function Ca(e){const{query:t,data:r,datasource:a,onChange:n,onRunQuery:s}=e;return(0,h.jsx)(Dt.n,{datasource:a,query:t,onChange:n,onRunQuery:s,onBlur:s,history:[],data:r,placeholder:"Enter a Loki query","data-testid":Ea.editor})}const Ea={editor:"loki-editor-cloud-alerting"};function Na(e){const{app:t}=e;switch(t){case Q.zj.CloudAlerting:return(0,h.jsx)(Ca,Object.assign({},e));case Q.zj.Explore:return P.v.featureToggles.lokiQueryBuilder?(0,h.jsx)(Ta,Object.assign({},e)):(0,h.jsx)(Fa,Object.assign({},e));default:return P.v.featureToggles.lokiQueryBuilder?(0,h.jsx)(Ta,Object.assign({},e)):(0,h.jsx)(Ra,Object.assign({},e))}}const Ua=(0,O.memo)(Na);var Xa,Da=r(6251),Ia=r(99897),Va=r(82139),Ma=r(7356),Aa=r(69721),Wa=r(23019),Ya=r.n(Wa),Ga=r(42528),za=r(67892);const{FormField:Ka}=Ga.vw6,Ba=e=>{const{derivedFields:t,className:r}=e,[a,n]=(0,O.useState)("");let s=[];return a&&t&&(s=function(e,t){return e.filter((e=>e.name&&e.matcherRegex)).map((e=>{try{const r=t.match(e.matcherRegex),a=r&&r[1];let n=null;e.url&&a&&(n=(0,za.a)({field:{name:"",type:H.fS.string,values:new Ze.G([a]),config:{links:[{title:"",url:e.url}]}},rowIndex:0,range:{}})[0]);return{name:e.name,value:a||"<no match>",href:n?n.href:void 0}}catch(t){return{name:e.name,error:t}}}))}(t,a)),(0,h.jsxs)("div",{className:r,children:[(0,h.jsx)(Ka,{labelWidth:12,label:"Debug log message",inputEl:(0,h.jsx)("textarea",{placeholder:"Paste an example log line here to test the regular expressions of your derived fields",className:Ya()("gf-form-input gf-form-textarea",St.css`
                width: 100%;
              `),value:a,onChange:e=>n(e.currentTarget.value)})}),!!s.length&&(0,h.jsx)(Za,{fields:s})]})},Za=e=>{let{fields:t}=e;return(0,h.jsxs)("table",{className:"filter-table",children:[Xa||(Xa=(0,h.jsx)("thead",{children:(0,h.jsxs)("tr",{children:[(0,h.jsx)("th",{children:"Name"}),(0,h.jsx)("th",{children:"Value"}),(0,h.jsx)("th",{children:"Url"})]})})),(0,h.jsx)("tbody",{children:t.map((e=>{let t=e.value;return e.error&&e.error instanceof Error?t=e.error.message:e.href&&(t=(0,h.jsx)("a",{href:e.href,children:t})),(0,h.jsxs)("tr",{children:[(0,h.jsx)("td",{children:e.name}),(0,h.jsx)("td",{children:t}),(0,h.jsx)("td",{children:e.href?(0,h.jsx)("a",{href:e.href,children:e.href}):""})]},`${e.name}=${e.value}`)}))})]})};var Ha=r(36345),Ja=r(63672),en=r(40882),tn=r(46587);const{Switch:rn,FormField:an}=Ga.vw6,nn=(0,en.B)((()=>({row:St.css`
    display: flex;
    align-items: baseline;
  `,nameField:St.css`
    flex: 2;
  `,regexField:St.css`
    flex: 3;
  `,urlField:St.css`
    flex: 1;
  `,urlDisplayLabelField:St.css`
    flex: 1;
  `}))),sn=e=>{const{value:t,onChange:r,onDelete:a,suggestions:n,className:s}=e,i=nn(),[o,l]=(0,O.useState)(!!t.datasourceUid),u=(0,Ha.Z)(t.datasourceUid);(0,O.useEffect)((()=>{u||!t.datasourceUid||o||l(!0),u&&!t.datasourceUid&&o&&l(!1)}),[u,t.datasourceUid,o]);const c=e=>a=>{r(Object.assign({},t,{[e]:a.currentTarget.value}))};return(0,h.jsxs)("div",{className:s,"data-testid":"derived-field",children:[(0,h.jsxs)("div",{className:i.row,children:[(0,h.jsx)(an,{className:i.nameField,labelWidth:5,inputWidth:null,label:"Name",type:"text",value:t.name,onChange:c("name")}),(0,h.jsx)(an,{className:i.regexField,inputWidth:null,label:"Regex",type:"text",value:t.matcherRegex,onChange:c("matcherRegex"),tooltip:"Use to parse and capture some part of the log message. You can use the captured groups in the template."}),(0,h.jsx)(q.zx,{variant:"destructive",title:"Remove field",icon:"times",onClick:e=>{e.preventDefault(),a()},className:St.css`
            margin-left: 8px;
          `})]}),(0,h.jsxs)("div",{className:i.row,children:[(0,h.jsx)(an,{label:o?"Query":"URL",inputEl:(0,h.jsx)(tn.v,{placeholder:o?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:e=>r(Object.assign({},t,{url:e})),suggestions:n}),className:i.urlField}),(0,h.jsx)(an,{className:i.urlDisplayLabelField,inputWidth:null,label:"URL Label",type:"text",value:t.urlDisplayLabel,onChange:c("urlDisplayLabel"),tooltip:"Use to override the button label when this derived field is found in a log."})]}),(0,h.jsxs)("div",{className:i.row,children:[(0,h.jsx)(rn,{label:"Internal link",checked:o,onChange:()=>{o&&r(Object.assign({},t,{datasourceUid:void 0})),l(!o)}}),o&&(0,h.jsx)(Ja.q,{tracing:!0,onChange:e=>r(Object.assign({},t,{datasourceUid:e.uid})),current:t.datasourceUid})]})]})};var on;const ln=e=>{let{value:t=[],onChange:r}=e;const a=(e=>({infoText:St.css`
    padding-bottom: ${e.spacing(2)};
    color: ${e.colors.text.secondary};
  `,derivedField:St.css`
    margin-bottom: ${e.spacing(1)};
  `}))((0,ua.l4)()),[n,s]=(0,O.useState)(!1);return(0,h.jsxs)(h.Fragment,{children:[on||(on=(0,h.jsx)("h3",{className:"page-heading",children:"Derived fields"})),(0,h.jsx)("div",{className:a.infoText,children:"Derived fields can be used to extract new fields from a log message and create a link from its value."}),(0,h.jsxs)("div",{className:"gf-form-group",children:[t.map(((e,n)=>(0,h.jsx)(sn,{className:a.derivedField,value:e,onChange:e=>{const a=[...t];a.splice(n,1,e),r(a)},onDelete:()=>{const e=[...t];e.splice(n,1),r(e)},suggestions:[{value:Ma.W.valueRaw,label:"Raw value",documentation:"Exact string captured by the regular expression",origin:Aa.L.Value}]},n))),(0,h.jsxs)("div",{children:[(0,h.jsx)(q.zx,{variant:"secondary",className:St.css`
              margin-right: 10px;
            `,icon:"plus",onClick:e=>{e.preventDefault();const a=[...t,{name:"",matcherRegex:""}];r(a)},children:"Add"}),t.length>0&&(0,h.jsx)(q.zx,{variant:"secondary",type:"button",onClick:()=>s(!n),children:n?"Hide example log message":"Show example log message"})]})]}),n&&(0,h.jsx)("div",{className:"gf-form-group",children:(0,h.jsx)(Ba,{className:St.css`
              margin-bottom: 10px;
            `,derivedFields:t})})]})},{FormField:un}=Ga.vw6,cn=e=>{const{value:t,onChange:r}=e;return(0,h.jsx)(un,{label:"Maximum lines",labelWidth:11,inputWidth:20,inputEl:(0,h.jsx)("input",{type:"number",className:"gf-form-input width-8 gf-form-input--has-help-icon",value:t,onChange:e=>r(e.currentTarget.value),spellCheck:!1,placeholder:"1000"}),tooltip:(0,h.jsx)(h.Fragment,{children:"Loki queries must contain a limit of the maximum number of lines returned (default: 1000). Increase this limit to have a bigger result set for ad-hoc analysis. Decrease this limit if your browser becomes sluggish when displaying the log results."})})},dn=e=>(t,r)=>Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:r})}),pn=dn("maxLines"),mn=dn("derivedFields"),On=new p.hf($r).setQueryEditor(Ua).setConfigEditor((e=>{const{options:t,onOptionsChange:r}=e,a=(0,Va.Tc)();return(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(Da.E,{defaultUrl:"http://localhost:3100",dataSourceConfig:t,showAccessOptions:!1,onChange:r}),(0,h.jsx)(Ia.O,{alertmanagerDataSources:a,options:t,onOptionsChange:r}),(0,h.jsx)("div",{className:"gf-form-group",children:(0,h.jsx)("div",{className:"gf-form-inline",children:(0,h.jsx)("div",{className:"gf-form",children:(0,h.jsx)(cn,{value:t.jsonData.maxLines||"",onChange:e=>r(pn(t,e))})})})}),(0,h.jsx)(ln,{value:t.jsonData.derivedFields,onChange:e=>r(mn(t,e))})]})})).setQueryEditorHelp(x)}}]);
//# sourceMappingURL=lokiPlugin.2c4b4d94e4d7cafc862a.js.map