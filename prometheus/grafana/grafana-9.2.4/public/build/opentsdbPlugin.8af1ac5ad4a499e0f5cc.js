"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3168],{63773:(t,e,s)=>{s.d(e,{O:()=>o});var r=s(49198),i=s(87982),a=s(98712);const n={http:80,https:443,ftp:21};class o{constructor(){this.absUrl=this.wrapInDeprecationWarning(this.absUrl),this.hash=this.wrapInDeprecationWarning(this.hash),this.host=this.wrapInDeprecationWarning(this.host),this.path=this.wrapInDeprecationWarning(this.path),this.port=this.wrapInDeprecationWarning(this.port,"window.location"),this.protocol=this.wrapInDeprecationWarning(this.protocol,"window.location"),this.replace=this.wrapInDeprecationWarning(this.replace),this.search=this.wrapInDeprecationWarning(this.search),this.state=this.wrapInDeprecationWarning(this.state),this.url=this.wrapInDeprecationWarning(this.url)}wrapInDeprecationWarning(t,e){let s=this;return function(){return(0,r.d)("$location",t.name,e||"locationService"),t.apply(s,arguments)}}absUrl(){return`${window.location.origin}${this.url()}`}hash(t){if((0,a.GQ)("AngularLocationWrapper",!1,"Angular compat layer: hash"),t)throw new Error("AngularLocationWrapper method not implemented.");return a.E1.getLocation().hash.slice(1)}host(){return new URL(window.location.href).hostname}path(t){(0,a.GQ)("AngularLocationWrapper",!1,"Angular compat layer: path");const e=a.E1.getLocation();if(null!=t){let s=String(t);s=s.startsWith("/")?s:`/${s}`;const r=new URL(`${window.location.origin}${s}`);return a.E1.push({pathname:r.pathname,search:r.search.length>0?r.search:e.search,hash:r.hash.length>0?r.hash:e.hash}),this}return null===t?(a.E1.push("/"),this):e.pathname}port(){const t=new URL(window.location.href);return parseInt(t.port,10)||n[t.protocol]||null}protocol(){return new URL(window.location.href).protocol.slice(0,-1)}replace(){throw new Error("AngularLocationWrapper method not implemented.")}search(t,e){if((0,a.GQ)("AngularLocationWrapper",!1,"Angular compat layer: search"),!t)return a.E1.getSearchObject();if(t&&arguments.length>1)return a.E1.partial({[t]:e}),this;if(t){let e;e="object"==typeof t?Object.assign({},t):(0,a.Ox)(t);for(const t of Object.keys(e))null!==e[t]&&void 0!==e[t]||delete e[t];const s=i.Cj.renderUrl(a.E1.getLocation().pathname,e);a.E1.push(s)}return this}state(t){throw(0,a.GQ)("AngularLocationWrapper",!1,"Angular compat layer: state"),new Error("AngularLocationWrapper method not implemented.")}url(t){if((0,a.GQ)("AngularLocationWrapper",!1,"Angular compat layer: url"),void 0!==t)return t.startsWith("#")?a.E1.push(Object.assign({},a.E1.getLocation(),{hash:t})):t.startsWith("?")?a.E1.push(Object.assign({},a.E1.getLocation(),{search:t})):0===t.trim().length?a.E1.push("/"):a.E1.push(t),a.E1;const e=a.E1.getLocation();return`${e.pathname}${e.search}${e.hash}`}}},15866:(t,e,s)=>{s.d(e,{k:()=>u});var r=s(82897),i=s(5937),a=s(81351),n=s(19383),o=s(91082),l=s(60301);function h(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class u extends o.q{constructor(t,e){super(t,e),h(this,"contextSrv",void 0),h(this,"datasourceSrv",void 0),h(this,"timeSrv",void 0),h(this,"templateSrv",void 0),h(this,"interval",void 0),h(this,"intervalMs",void 0),h(this,"resolution",void 0),h(this,"timeInfo",void 0),h(this,"skipDataOnInit",!1),h(this,"dataList",[]),h(this,"querySubscription",void 0),h(this,"useDataFrames",!1),h(this,"panelData",void 0),h(this,"panelDataObserver",{next:t=>{if(this.panelData=t,t.state===i.Gu.Error&&(this.loading=!1,this.processDataError(t.error)),t.state===i.Gu.Loading)return this.loading=!0,void this.angularDirtyCheck();if(t.request){const{timeInfo:e}=t.request;e&&(this.timeInfo=e)}if(t.timeRange&&(this.range=t.timeRange),this.useDataFrames)this.handleDataFrames(t.series);else{const e=t.series.map((t=>(0,a.Zr)(t)));this.handleQueryResult({data:e})}this.angularDirtyCheck()}}),this.contextSrv=e.get("contextSrv"),this.datasourceSrv=e.get("datasourceSrv"),this.timeSrv=e.get("timeSrv"),this.templateSrv=e.get("templateSrv"),this.panel.datasource=this.panel.datasource||null,this.events.on(n.Kh.refresh,this.onMetricsPanelRefresh.bind(this)),this.events.on(n.Kh.panelTeardown,this.onPanelTearDown.bind(this)),this.events.on(n.Kh.componentDidMount,this.onMetricsPanelMounted.bind(this))}onMetricsPanelMounted(){const t=this.panel.getQueryRunner();this.querySubscription=t.getData({withTransforms:!0,withFieldConfig:!0}).subscribe(this.panelDataObserver)}onPanelTearDown(){this.querySubscription&&(this.querySubscription.unsubscribe(),this.querySubscription=null)}onMetricsPanelRefresh(){if(!this.otherPanelInFullscreenMode()){if(this.panel.snapshotData){this.updateTimeRange();let t=this.panel.snapshotData;return(0,r.isArray)(t)||(t=t.data),this.panelData={state:i.Gu.Done,series:t,timeRange:this.range},this.$timeout((()=>{this.events.emit(n.Kh.dataSnapshotLoad,t)}))}return delete this.error,this.loading=!0,this.datasourceSrv.get(this.panel.datasource,this.panel.scopedVars).then(this.issueQueries.bind(this)).catch((t=>{this.processDataError(t)}))}}processDataError(t){t.cancelled?console.log("Panel request cancelled",t):(this.error=t.message||"Request Error",t.data&&(t.data.message?this.error=t.data.message:t.data.error&&(this.error=t.data.error)),this.angularDirtyCheck())}angularDirtyCheck(){this.$scope.$root.$$phase||this.$scope.$digest()}updateTimeRange(t){this.datasource=t||this.datasource,this.range=this.timeSrv.timeRange();const e=(0,l.W1)(this.panel,this.range);this.timeInfo=e.timeInfo,this.range=e.timeRange}issueQueries(t){this.updateTimeRange(t),this.datasource=t;const e=this.panel;return e.getQueryRunner().run({datasource:e.datasource,queries:e.targets,panelId:e.id,dashboardId:this.dashboard.id,timezone:this.dashboard.getTimezone(),timeInfo:this.timeInfo,timeRange:this.range,maxDataPoints:e.maxDataPoints||this.width,minInterval:e.interval,scopedVars:e.scopedVars,cacheTimeout:e.cacheTimeout,transformations:e.transformations})}handleDataFrames(t){this.loading=!1,this.dashboard&&this.dashboard.snapshot&&(this.panel.snapshotData=t.map((t=>(0,a.og)(t))));try{this.events.emit(n.Kh.dataFramesReceived,t)}catch(t){this.processDataError(t)}}handleQueryResult(t){this.loading=!1,this.dashboard.snapshot&&(this.panel.snapshotData=t.data),t&&t.data||(console.log("Data source query result invalid, missing data field:",t),t={data:[]});try{this.events.emit(n.Kh.dataReceived,t.data)}catch(t){this.processDataError(t)}}}},91082:(t,e,s)=>{s.d(e,{q:()=>u});var r=s(82897),i=s(97437),a=s(19383),n=s(63773),o=s(78837),l=s(98163);function h(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class u{constructor(t,e){var s,r;h(this,"panel",void 0),h(this,"error",void 0),h(this,"pluginName",""),h(this,"pluginId",""),h(this,"editorTabs",void 0),h(this,"$scope",void 0),h(this,"$injector",void 0),h(this,"$timeout",void 0),h(this,"editModeInitiated",!1),h(this,"containerHeight",void 0),h(this,"events",void 0),h(this,"loading",!1),h(this,"timing",void 0),h(this,"$location",void 0),h(this,"onPluginTypeChange",(t=>{})),this.panel=null!==(s=this.panel)&&void 0!==s?s:t.$parent.panel,this.dashboard=null!==(r=this.dashboard)&&void 0!==r?r:t.$parent.dashboard,this.$injector=e,this.$scope=t,this.$timeout=e.get("$timeout"),this.editorTabs=[],this.$location=new n.O,this.events=new i.F,this.timing={};const l=o.ZP.panels[this.panel.type];l&&(this.pluginId=l.id,this.pluginName=l.name),t.$on(a.Kh.componentDidMount.name,(()=>this.panelDidMount()))}panelDidMount(){this.events.emit(a.Kh.componentDidMount),this.events.emit(a.Kh.initialized),this.dashboard.panelInitialized(this.panel)}renderingCompleted(){l.rv.renderingCompleted()}refresh(){this.panel.refresh()}publishAppEvent(t,e){this.$scope.$root.appEvent(t,e)}initEditMode(){this.editModeInitiated||(this.editModeInitiated=!0,this.events.emit(a.Kh.editModeInitialized))}addEditorTab(t,e,s,i){const a={title:t,directiveFn:e,icon:i};(0,r.isString)(e)&&(a.directiveFn=()=>({templateUrl:e})),s?this.editorTabs.splice(s,0,a):this.editorTabs.push(a)}getExtendedMenu(){const t=[];return this.events.emit(a.Kh.initPanelActions,t),t}async getAdditionalMenuItems(){return[]}otherPanelInFullscreenMode(){return this.dashboard.otherPanelInFullscreen(this.panel)}render(t){this.events.emit(a.Kh.render,t)}}},88643:(t,e,s)=>{s.d(e,{G:()=>a});var r=s(82897);function i(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class a{constructor(t,e){var s,a,n,o,l;i(this,"target",void 0),i(this,"datasource",void 0),i(this,"panelCtrl",void 0),i(this,"panel",void 0),i(this,"hasRawMode",void 0),i(this,"error",void 0),i(this,"isLastQuery",void 0),this.$scope=t,this.$injector=e,this.panelCtrl=null!==(s=this.panelCtrl)&&void 0!==s?s:t.ctrl.panelCtrl,this.target=null!==(a=this.target)&&void 0!==a?a:t.ctrl.target,this.datasource=null!==(n=this.datasource)&&void 0!==n?n:t.ctrl.datasource,this.panel=null!==(o=null===(l=this.panelCtrl)||void 0===l?void 0:l.panel)&&void 0!==o?o:t.ctrl.panelCtrl.panel,this.isLastQuery=(0,r.indexOf)(this.panel.targets,this.target)===this.panel.targets.length-1}refresh(){this.panelCtrl.refresh()}}},35875:(t,e,s)=>{s.r(e),s.d(e,{plugin:()=>W});var r,i=s(12822),a=s(68404),n=s(6251),o=s(42528),l=s(97833),h=s(68366),u=s(45916);const{Select:c,Input:g}=o.vw6,d=[{label:"<=2.1",value:1},{label:"==2.2",value:2},{label:"==2.3",value:3}],p=[{label:"second",value:1},{label:"millisecond",value:2}],m=t=>{var e,s,i;const{onChange:a,value:n}=t,o=(0,h.L)();return(0,u.jsxs)(u.Fragment,{children:[r||(r=(0,u.jsx)("h5",{children:"OpenTSDB settings"})),(0,u.jsxs)("div",{className:"gf-form",children:[(0,u.jsx)(l.c,{width:7,htmlFor:`select-version-${o}`,children:"Version"}),(0,u.jsx)(c,{inputId:`select-version-${o}`,options:d,value:null!==(e=d.find((t=>t.value===n.jsonData.tsdbVersion)))&&void 0!==e?e:d[0],onChange:v("tsdbVersion",n,a)})]}),(0,u.jsxs)("div",{className:"gf-form",children:[(0,u.jsx)(l.c,{width:7,htmlFor:`select-resolution-${o}`,children:"Resolution"}),(0,u.jsx)(c,{inputId:`select-resolution-${o}`,options:p,value:null!==(s=p.find((t=>t.value===n.jsonData.tsdbResolution)))&&void 0!==s?s:p[0],onChange:v("tsdbResolution",n,a)})]}),(0,u.jsxs)("div",{className:"gf-form",children:[(0,u.jsx)(l.c,{width:7,htmlFor:`lookup-input-${o}`,children:"Lookup limit"}),(0,u.jsx)(g,{id:`lookup-input-${o}`,type:"number",value:null!==(i=n.jsonData.lookupLimit)&&void 0!==i?i:1e3,onChange:f("lookupLimit",n,a)})]})]})},v=(t,e,s)=>r=>{s(Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{[t]:r.value})}))},f=(t,e,s)=>r=>{s(Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{[t]:r.currentTarget.value})}))};var y,b,T=s(93964),w=s.n(T),D=s(82897),j=s(16976),x=s(3321),F=s(71808),S=s(58799),M=s(14444),I=s(35778),P=s(81351),C=s(35089),O=s(6932),E=s(7166),$=s(1652),A=s(72786);const V=t=>{var e,s;const{query:r,onChange:i}=t,[n,o]=(0,a.useState)(null!==(e=r.target)&&void 0!==e?e:""),[h,c]=(0,a.useState)(null!==(s=r.isGlobal)&&void 0!==s&&s),g=(t,e)=>{i(Object.assign({},r,{[t]:e,fromAnnotations:!0}))};return(0,u.jsxs)("div",{className:"gf-form-group",children:[(0,u.jsxs)("div",{className:"gf-form",children:[y||(y=(0,u.jsx)(l.c,{width:12,children:"OpenTSDB metrics query"})),(0,u.jsx)($.I,{value:n,onChange:t=>{var e;return o(null!==(e=t.currentTarget.value)&&void 0!==e?e:"")},onBlur:()=>g("target",n),placeholder:"events.eventname"})]}),(0,u.jsxs)("div",{className:"gf-form",children:[b||(b=(0,u.jsx)(l.c,{width:12,children:"Show Global Annotations?"})),(0,u.jsx)(A.x,{value:h,onChange:t=>(t=>{c(t=!t),g("isGlobal",t)})(h)})]})]})},R=t=>{const e=t.target&&"string"!=typeof t.target?t.target:(t=>{var e,s,r;return{fromAnnotations:!0,target:null!==(e=t.target)&&void 0!==e?e:"",name:null!==(s=t.name)&&void 0!==s?s:"",isGlobal:null!==(r=t.isGlobal)&&void 0!==r&&r}})(t);return t.target=e,t};function k(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class L extends i.MF{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,E.J)();super(t),k(this,"type",void 0),k(this,"url",void 0),k(this,"name",void 0),k(this,"withCredentials",void 0),k(this,"basicAuth",void 0),k(this,"tsdbVersion",void 0),k(this,"tsdbResolution",void 0),k(this,"lookupLimit",void 0),k(this,"tagKeys",void 0),k(this,"aggregatorsPromise",void 0),k(this,"filterTypesPromise",void 0),this.templateSrv=e,this.type="opentsdb",this.url=t.url,this.name=t.name,this.withCredentials=t.withCredentials,this.basicAuth=t.basicAuth,t.jsonData=t.jsonData||{},this.tsdbVersion=t.jsonData.tsdbVersion||1,this.tsdbResolution=t.jsonData.tsdbResolution||1,this.lookupLimit=t.jsonData.lookupLimit||1e3,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null,this.annotations={QueryEditor:V,prepareAnnotation:R}}query(t){if(t.targets.some((t=>t.fromAnnotations))){const e=[];for(const s of t.targets)s.target&&e.push(new j.y((e=>{this.annotationEvent(t,s).then((t=>e.next({data:[(0,P.g0)(t)]}))).catch((t=>e.next({data:[(0,P.g0)([])]}))).finally((()=>e.complete()))})));return(0,x.T)(...e)}const e=this.convertToTSDBTime(t.range.raw.from,!1,t.timezone),s=this.convertToTSDBTime(t.range.raw.to,!0,t.timezone),r=[];(0,D.each)(t.targets,(e=>{e.metric&&r.push(this.convertTargetToQuery(e,t,this.tsdbVersion))}));const i=(0,D.compact)(r);if((0,D.isEmpty)(i))return(0,F.of)({data:[]});const a={};return(0,D.each)(i,(t=>{t.filters&&t.filters.length>0?(0,D.each)(t.filters,(t=>{a[t.tagk]=!0})):(0,D.each)(t.tags,((t,e)=>{a[e]=!0}))})),t.targets=(0,D.filter)(t.targets,(t=>!0!==t.hide)),this.performTimeSeriesQuery(i,e,s).pipe((0,M.K)((t=>{var e,s;throw(null==t||null===(e=t.data)||void 0===e||null===(s=e.error)||void 0===s?void 0:s.message)||"Error performing time series query."})),(0,I.U)((e=>{const s=this.mapMetricsToTargets(e.data,t,this.tsdbVersion);return{data:(0,D.map)(e.data,((e,r)=>(-1===(r=s[r])&&(r=0),this._saveTagKeys(e),this.transformMetricData(e,a,t.targets[r],t,this.tsdbResolution))))}})))}annotationEvent(t,e){const s=this.convertToTSDBTime(t.range.raw.from,!1,t.timezone),r=this.convertToTSDBTime(t.range.raw.to,!0,t.timezone),i=[],a=[];i.push({aggregator:"sum",metric:e.target});const n=(0,D.compact)(i);return(0,S.n)(this.performTimeSeriesQuery(n,s,r).pipe((0,I.U)((t=>{if(t.data[0]){let s=t.data[0].annotations;e.isGlobal&&(s=t.data[0].globalAnnotations),s&&(0,D.each)(s,(t=>{const s={text:t.description,time:1e3*Math.floor(t.startTime),annotation:e};a.push(s)}))}return a}))))}targetContainsTemplate(t){if(t.filters&&t.filters.length>0)for(let e=0;e<t.filters.length;e++)if(this.templateSrv.containsTemplate(t.filters[e].filter))return!0;if(t.tags&&Object.keys(t.tags).length>0)for(const e in t.tags)if(this.templateSrv.containsTemplate(t.tags[e]))return!0;return!1}performTimeSeriesQuery(t,e,s){let r=!1;2===this.tsdbResolution&&(r=!0);const i={start:e,queries:t,msResolution:r,globalAnnotations:!0};3===this.tsdbVersion&&(i.showQuery=!0),s&&(i.end=s);const a={method:"POST",url:this.url+"/api/query",data:i};return this._addCredentialOptions(a),(0,O.i)().fetch(a)}suggestTagKeys(t){return Promise.resolve(this.tagKeys[t]||[])}_saveTagKeys(t){const e=Object.keys(t.tags);(0,D.each)(t.aggregateTags,(t=>{e.push(t)})),this.tagKeys[t.metric]=e}_performSuggestQuery(t,e){return this._get("/api/suggest",{type:e,q:t,max:this.lookupLimit}).pipe((0,I.U)((t=>t.data)))}_performMetricKeyValueLookup(t,e){if(!t||!e)return(0,F.of)([]);const s=e.split(",").map((t=>t.trim())),r=s[0];let i=r+"=*";s.length>1&&(i+=","+s.splice(1).join(","));const a=t+"{"+i+"}";return this._get("/api/search/lookup",{m:a,limit:this.lookupLimit}).pipe((0,I.U)((t=>{t=t.data.results;const e=[];return(0,D.each)(t,(t=>{-1===e.indexOf(t.tags[r])&&e.push(t.tags[r])})),e})))}_performMetricKeyLookup(t){return t?this._get("/api/search/lookup",{m:t,limit:1e3}).pipe((0,I.U)((t=>{t=t.data.results;const e=[];return(0,D.each)(t,(t=>{(0,D.each)(t.tags,((t,s)=>{-1===e.indexOf(s)&&e.push(s)}))})),e}))):(0,F.of)([])}_get(t,e){const s={method:"GET",url:this.url+t,params:e};return this._addCredentialOptions(s),(0,O.i)().fetch(s)}_addCredentialOptions(t){(this.basicAuth||this.withCredentials)&&(t.withCredentials=!0),this.basicAuth&&(t.headers={Authorization:this.basicAuth})}metricFindQuery(t){if(!t)return Promise.resolve([]);let e;try{e=this.templateSrv.replace(t,{},"distributed")}catch(t){return Promise.reject(t)}const s=t=>(0,D.map)(t,(t=>({text:t}))),r=e.match(/metrics\((.*)\)/);if(r)return(0,S.n)(this._performSuggestQuery(r[1],"metrics").pipe((0,I.U)(s)));const i=e.match(/tag_names\((.*)\)/);if(i)return(0,S.n)(this._performMetricKeyLookup(i[1]).pipe((0,I.U)(s)));const a=e.match(/tag_values\((.*?),\s?(.*)\)/);if(a)return(0,S.n)(this._performMetricKeyValueLookup(a[1],a[2]).pipe((0,I.U)(s)));const n=e.match(/suggest_tagk\((.*)\)/);if(n)return(0,S.n)(this._performSuggestQuery(n[1],"tagk").pipe((0,I.U)(s)));const o=e.match(/suggest_tagv\((.*)\)/);return o?(0,S.n)(this._performSuggestQuery(o[1],"tagv").pipe((0,I.U)(s))):Promise.resolve([])}testDatasource(){return(0,S.n)(this._performSuggestQuery("cpu","metrics").pipe((0,I.U)((()=>({status:"success",message:"Data source is working"})))))}getAggregators(){return this.aggregatorsPromise||(this.aggregatorsPromise=(0,S.n)(this._get("/api/aggregators").pipe((0,I.U)((t=>t.data&&(0,D.isArray)(t.data)?t.data.sort():[]))))),this.aggregatorsPromise}getFilterTypes(){return this.filterTypesPromise||(this.filterTypesPromise=(0,S.n)(this._get("/api/config/filters").pipe((0,I.U)((t=>t.data?Object.keys(t.data).sort():[]))))),this.filterTypesPromise}transformMetricData(t,e,s,r,i){const a=this.createMetricLabel(t,s,e,r),n=[];return(0,D.each)(t.dps,((t,e)=>{2===i?n.push([t,1*e]):n.push([t,1e3*e])})),{target:a,datapoints:n}}createMetricLabel(t,e,s,r){if(e.alias){const s=(0,D.clone)(r.scopedVars||{});return(0,D.each)(t.tags,((t,e)=>{s["tag_"+e]={value:t}})),this.templateSrv.replace(e.alias,s)}let i=t.metric;const a=[];return(0,D.isEmpty)(t.tags)||(0,D.each)((0,D.toPairs)(t.tags),(t=>{(0,D.has)(s,t[0])&&a.push(t[0]+"="+t[1])})),(0,D.isEmpty)(a)||(i+="{"+a.join(", ")+"}"),i}convertTargetToQuery(t,e,s){if(!t.metric||t.hide)return null;const r={metric:this.templateSrv.replace(t.metric,e.scopedVars,"pipe"),aggregator:"avg"};if(t.aggregator&&(r.aggregator=this.templateSrv.replace(t.aggregator)),t.shouldComputeRate&&(r.rate=!0,r.rateOptions={counter:!!t.isCounter},t.counterMax&&t.counterMax.length&&(r.rateOptions.counterMax=parseInt(t.counterMax,10)),t.counterResetValue&&t.counterResetValue.length&&(r.rateOptions.resetValue=parseInt(t.counterResetValue,10)),s>=2&&(r.rateOptions.dropResets=!(r.rateOptions.counterMax||r.rateOptions.ResetValue&&0!==r.rateOptions.ResetValue))),!t.disableDownsampling){let s=this.templateSrv.replace(t.downsampleInterval||e.interval);s.match(/\.[0-9]+s/)&&(s=1e3*parseFloat(s)+"ms"),r.downsample=s+"-"+t.downsampleAggregator,t.downsampleFillPolicy&&"none"!==t.downsampleFillPolicy&&(r.downsample+="-"+t.downsampleFillPolicy)}if(t.filters&&t.filters.length>0){if(r.filters=w().copy(t.filters),r.filters)for(const t in r.filters)r.filters[t].filter=this.templateSrv.replace(r.filters[t].filter,e.scopedVars,"pipe")}else if(r.tags=w().copy(t.tags),r.tags)for(const t in r.tags)r.tags[t]=this.templateSrv.replace(r.tags[t],e.scopedVars,"pipe");return t.explicitTags&&(r.explicitTags=!0),r}mapMetricsToTargets(t,e,s){let r,i;return(0,D.map)(t,(t=>3===s?t.query.index:(0,D.findIndex)(e.targets,(s=>s.filters&&s.filters.length>0?s.metric===t.metric:s.metric===t.metric&&(0,D.every)(s.tags,((s,a)=>(r=this.templateSrv.replace(s,e.scopedVars,"pipe"),i=r.split("|"),(0,D.includes)(i,t.tags[a])||"*"===r)))))))}interpolateVariablesInQueries(t,e){return t.length?t.map((t=>Object.assign({},t,{metric:this.templateSrv.replace(t.metric,e)}))):t}convertToTSDBTime(t,e,s){return"now"===t?null:(t=C.parse(t,e,s)).valueOf()}}var K=s(79638),_=s(23541),Q=s(60974);function U(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class q extends Q.QueryCtrl{constructor(t,e){super(t,e),U(this,"aggregators",void 0),U(this,"fillPolicies",void 0),U(this,"filterTypes",void 0),U(this,"tsdbVersion",void 0),U(this,"aggregator",void 0),U(this,"downsampleInterval",void 0),U(this,"downsampleAggregator",void 0),U(this,"downsampleFillPolicy",void 0),U(this,"errors",void 0),U(this,"suggestMetrics",void 0),U(this,"suggestTagKeys",void 0),U(this,"suggestTagValues",void 0),U(this,"addTagMode",!1),U(this,"addFilterMode",!1),this.errors=this.validateTarget(),this.aggregators=["avg","sum","min","max","dev","zimsum","mimmin","mimmax"],this.fillPolicies=["none","nan","null","zero"],this.filterTypes=["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"],this.tsdbVersion=this.datasource.tsdbVersion,this.target.aggregator||(this.target.aggregator="sum"),this.target.downsampleAggregator||(this.target.downsampleAggregator="avg"),this.target.downsampleFillPolicy||(this.target.downsampleFillPolicy="none"),this.datasource.getAggregators().then((t=>{0!==t.length&&(this.aggregators=t)})),this.datasource.getFilterTypes().then((t=>{0!==t.length&&(this.filterTypes=t)})),this.suggestMetrics=(t,e)=>{this.datasource.metricFindQuery("metrics("+t+")").then(this.getTextValues).then(e)},this.suggestTagKeys=(t,e)=>{this.datasource.suggestTagKeys(this.target.metric).then(e)},this.suggestTagValues=(t,e)=>{this.datasource.metricFindQuery("suggest_tagv("+t+")").then(this.getTextValues).then(e)}}targetBlur(){this.errors=this.validateTarget(),this.refresh()}getTextValues(t){return(0,D.map)(t,(t=>K.QX.escapeHtml(t.text)))}addTag(){this.target.filters&&this.target.filters.length>0&&(this.errors.tags="Please remove filters to use tags, tags and filters are mutually exclusive."),this.addTagMode?(this.target.tags||(this.target.tags={}),this.errors=this.validateTarget(),this.errors.tags||(this.target.tags[this.target.currentTagKey]=this.target.currentTagValue,this.target.currentTagKey="",this.target.currentTagValue="",this.targetBlur()),this.addTagMode=!1):this.addTagMode=!0}removeTag(t){delete this.target.tags[t],this.targetBlur()}editTag(t,e){this.removeTag(t),this.target.currentTagKey=t,this.target.currentTagValue=e,this.addTag()}closeAddTagMode(){this.addTagMode=!1}addFilter(){if(this.target.tags&&(0,D.size)(this.target.tags)>0&&(this.errors.filters="Please remove tags to use filters, tags and filters are mutually exclusive."),this.addFilterMode){if(this.target.filters||(this.target.filters=[]),this.target.currentFilterType||(this.target.currentFilterType="iliteral_or"),this.target.currentFilterGroupBy||(this.target.currentFilterGroupBy=!1),this.errors=this.validateTarget(),!this.errors.filters){const t={type:this.target.currentFilterType,tagk:this.target.currentFilterKey,filter:this.target.currentFilterValue,groupBy:this.target.currentFilterGroupBy};this.target.filters.push(t),this.target.currentFilterType="literal_or",this.target.currentFilterKey="",this.target.currentFilterValue="",this.target.currentFilterGroupBy=!1,this.targetBlur()}this.addFilterMode=!1}else this.addFilterMode=!0}removeFilter(t){this.target.filters.splice(t,1),this.targetBlur()}editFilter(t,e){this.removeFilter(e),this.target.currentFilterKey=t.tagk,this.target.currentFilterValue=t.filter,this.target.currentFilterType=t.type,this.target.currentFilterGroupBy=t.groupBy,this.addFilter()}closeAddFilterMode(){this.addFilterMode=!1}validateTarget(){const t={};if(this.target.shouldDownsample)try{this.target.downsampleInterval?_.describeInterval(this.target.downsampleInterval):t.downsampleInterval="You must supply a downsample interval (e.g. '1m' or '1h')."}catch(e){e instanceof Error&&(t.downsampleInterval=e.message)}return this.target.tags&&(0,D.has)(this.target.tags,this.target.currentTagKey)&&(t.tags="Duplicate tag key '"+this.target.currentTagKey+"'."),t}}q.$inject=["$scope","$injector"],U(q,"templateUrl","partials/query.editor.html");const W=new i.hf(L).setQueryCtrl(q).setConfigEditor((t=>{const{options:e,onOptionsChange:s}=t;return(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(n.E,{defaultUrl:"http://localhost:4242",dataSourceConfig:e,onChange:s}),(0,u.jsx)(m,{value:e,onChange:s})]})}))},60974:(t,e,s)=>{s.r(e),s.d(e,{MetricsPanelCtrl:()=>h,PanelCtrl:()=>l,QueryCtrl:()=>u,loadPluginCss:()=>i.Y});var r=s(86623),i=s(15895),a=s(15866),n=s(91082),o=s(88643);const l=(0,r.s)(n.q),h=(0,r.s)(a.k),u=(0,r.s)(o.G)}}]);
//# sourceMappingURL=opentsdbPlugin.8af1ac5ad4a499e0f5cc.js.map