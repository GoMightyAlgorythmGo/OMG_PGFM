(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8250],{1762:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AND:()=>f,ASC:()=>c,BY:()=>l,COMPARISON_OPERATORS:()=>x,DESC:()=>u,EQUALS:()=>y,FROM:()=>i,GROUP:()=>s,KEYWORDS:()=>h,LIMIT:()=>d,LOGICAL_OPERATORS:()=>v,NOT_EQUALS:()=>b,ORDER:()=>o,SCHEMA:()=>m,SELECT:()=>r,STATISTICS:()=>g,WHERE:()=>a,WITH:()=>p,conf:()=>S,language:()=>w});const r="SELECT",i="FROM",a="WHERE",s="GROUP",o="ORDER",l="BY",u="DESC",c="ASC",d="LIMIT",p="WITH",m="SCHEMA",h=[r,i,a,s,o,l,u,c,d,p,m],g=["AVG","COUNT","MAX","MIN","SUM"],f="AND",v=[f],y="=",b="!=",x=[y,b],w={defaultToken:"",tokenPostfix:".sql",ignoreCase:!0,brackets:[{open:"[",close:"]",token:"delimiter.square"},{open:"(",close:")",token:"delimiter.parenthesis"}],keywords:h,operators:v,builtinFunctions:g,tokenizer:{root:[[/\$[a-zA-Z0-9-_]+/,"variable"],{include:"@comments"},{include:"@whitespace"},{include:"@numbers"},{include:"@strings"},{include:"@complexIdentifiers"},[/[;,.]/,"delimiter"],[/[()]/,"@brackets"],[/[\w@#$]+/,{cases:{"@keywords":"keyword","@operators":"operator","@builtinFunctions":"predefined","@default":"identifier"}}],[/[=!%&+\-*/|~^]/,"operator"]],whitespace:[[/\s+/,"white"]],comments:[[/--+.*/,"comment"]],comment:[[/[^*/]+/,"comment"],[/./,"comment"]],numbers:[[/0[xX][0-9a-fA-F]*/,"number"],[/[$][+-]*\d*(\.\d*)?/,"number"],[/((\d+(\.\d*)?)|(\.\d+))([eE][\-+]?\d+)?/,"number"]],strings:[[/N'/,{token:"string",next:"@string"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],string:[[/[^']+/,"string"],[/''/,"string"],[/'/,{token:"string",next:"@pop"}]],string_double:[[/[^\\"]+/,"type"],[/"/,"type","@pop"]],complexIdentifiers:[[/\[/,{token:"identifier.quote",next:"@bracketedIdentifier"}],[/"/,{token:"identifier.quote",next:"@quotedIdentifier"}]],bracketedIdentifier:[[/[^\]]+/,"identifier"],[/]]/,"identifier"],[/]/,{token:"identifier.quote",next:"@pop"}]],quotedIdentifier:[[/[^"]+/,"identifier"],[/""/,"identifier"],[/"/,{token:"identifier.quote",next:"@pop"}]]}},S={comments:{lineComment:"--",blockComment:["/*","*/"]},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}]}},48284:(e,t,n)=>{"use strict";n.r(t),n.d(t,{DYNAMIC_LABEL_PATTERNS:()=>r,conf:()=>a,language:()=>i});const r=["${DATAPOINT_COUNT}","${FIRST}","${FIRST_LAST_RANGE}","${FIRST_LAST_TIME_RANGE}","${FIRST_TIME}","${FIRST_TIME_RELATIVE}","${LABEL}","${LAST}","${LAST_TIME}","${LAST_TIME_RELATIVE}","${MAX}","${MAX_TIME}","${MAX_TIME_RELATIVE}","${MIN}","${MIN_MAX_RANGE}","${MIN_MAX_TIME_RANGE}","${MIN_TIME}","${MIN_TIME_RELATIVE}","${PROP('AccountId')}","${PROP('MetricName')}","${PROP('Namespace')}","${PROP('Period')}","${PROP('Region')}","${PROP('Stat')}","${SUM}"],i={id:"dynamicLabels",ignoreCase:!1,tokenizer:{root:[{include:"@whitespace"},{include:"@builtInFunctions"},{include:"@string"},[/\$\{PROP\('Dim.[a-zA-Z0-9-_]?.*'\)\}+/,"predefined"]],builtInFunctions:[[r.map((function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})).join("|"),"predefined"]],whitespace:[[/\s+/,"white"]],string:[]}},a={}},67929:(e,t,n)=>{"use strict";n.r(t),n.d(t,{METRIC_MATH_FNS:()=>r,METRIC_MATH_KEYWORDS:()=>a,METRIC_MATH_OPERATORS:()=>s,METRIC_MATH_PERIODS:()=>o,METRIC_MATH_STATISTIC_KEYWORD_STRINGS:()=>i,conf:()=>u,language:()=>l});const r=["ABS","ANOMALY_DETECTION_BAND","AVG","CEIL","DATAPOINT_COUNT","DIFF","DIFF_TIME","FILL","FIRST","LAST","FLOOR","IF","INSIGHT_RULE_METRIC","LOG","LOG10","MAX","METRIC_COUNT","METRICS","MIN","MINUTE","HOUR","DAY","DATE","MONTH","YEAR","EPOCH","PERIOD","RATE","REMOVE_EMPTY","RUNNING_SUM","SEARCH","SERVICE_QUOTA","SLICE","SORT","STDDEV","SUM","TIME_SERIES"],i=["Average","Maximum","Minimum","Sum","SampleCount"],a=["REPEAT","LINEAR","ASC","DSC"],s=["+","-","*","/","^","==","!=","<=",">=","<",">","AND","&&","OR","||"],o=[10,60,300,900,3e3,21600,86400],l={id:"metricMath",ignoreCase:!1,brackets:[{open:"[",close:"]",token:"delimiter.square"},{open:"(",close:")",token:"delimiter.parenthesis"},{open:"{",close:"}",token:"delimiter.curly"}],tokenizer:{root:[{include:"@nonNestableStates"},{include:"@strings"}],nonNestableStates:[{include:"@variables"},{include:"@whitespace"},{include:"@numbers"},{include:"@assignment"},{include:"@keywords"},{include:"@operators"},{include:"@builtInFunctions"},[/[;,.]/,"delimiter"],[/[(){}\[\]]/,"@brackets"]],keywords:[[a.map(c).join("|"),"keyword"]],operators:[[s.map(c).join("|"),"operator"]],builtInFunctions:[[r.map(c).join("|"),"predefined"]],variables:[[/\$[a-zA-Z0-9-_]+/,"variable"]],whitespace:[[/\s+/,"white"]],assignment:[[/=/,"tag"]],numbers:[[/0[xX][0-9a-fA-F]*/,"number"],[/[$][+-]*\d*(\.\d*)?/,"number"],[/((\d+(\.\d*)?)|(\.\d+))([eE][\-+]?\d+)?/,"number"]],strings:[[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],string:[[/{/,{token:"delimiter.curly",next:"@nestedCurly"}],[/\(/,{token:"delimiter.parenthesis",next:"@nestedParens"}],[/"/,{token:"type",next:"@string_double"}],[/'/,{token:"string",next:"@pop"}],{include:"@nonNestableStates"},[/[^']/,"string"]],string_double:[[/[^"]/,"type"],[/"/,{token:"type",next:"@pop"}]],nestedCurly:[[/}/,{token:"delimiter.curly",next:"@pop"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],nestedParens:[[/\)/,{token:"delimiter.parenthesis",next:"@pop"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]]}},u={brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}]};function c(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},88250:(e,t,n)=>{"use strict";n.r(t),n.d(t,{plugin:()=>Xr});var r=n(12822),i=n(23485),a=n(3965),s=n(68404),o=n(94255),l=n(16538),u=n(81391),c=n(23541),d=n(6932),p=n(24643),m=n(1652),h=n(36537),g=n(58257),f=n(67436),v=n(56340),y=n(82897),b=n(46196),x=n(61884),w=n(93889);const S=e=>({label:e,value:e}),C=(e,t)=>[...t,{label:"Template Variables",options:e.getVariables().map(S)}],E=e=>{const{region:t,metricQueryType:n,metricEditorMode:r,expression:i,metricName:a,namespace:s,sqlExpression:o,statistic:l}=e;return!!t&&(n===w.$5.Search&&r===w.MQ.Builder?!!s&&!!a&&!!l:n===w.$5.Search&&r===w.MQ.Code?!!i:n===w.$5.Query&&!!o)};var I=n(45916);const A=e=>{let{region:t,selectedLogGroups:n,onChange:r,datasource:i,onRunQuery:a,onOpenMenu:o,refId:l,width:u,saved:c=!0}=e;const[d,p]=(0,s.useState)(!1),[m,f]=(0,s.useState)([]),w=(0,s.useMemo)((()=>(0,y.unionBy)(m,null==n?void 0:n.map(b.E),"value")),[m,n]),S=(0,s.useCallback)((async(e,t)=>{if(!i)return[];try{return await i.api.describeLogGroups({refId:l,region:e,logGroupNamePrefix:t})}catch(e){return(0,v.WI)((0,h.$l)((0,g.t_)("string"==typeof e?e:JSON.stringify(e)))),[]}}),[i,l]);(0,s.useEffect)((()=>{c&&async function(){if(i&&i.getActualRegion(t))return p(!0),S(i.getActualRegion(t)).then((e=>{f(e)})).finally((()=>{p(!1)}));f([])}()}),[i,t,c]);const E=(0,y.debounce)((async(e,t,n)=>{if("input-change"!==n.action||!i)return;if(!/^[\.\-_/#A-Za-z0-9]+$/.test(e))return void(""!==e&&(0,v.WI)((0,h.$l)((0,g.t_)("Invalid Log Group name: "+e))));p(!0);const r=await S(t,e);f((0,y.unionBy)(m,r,"value")),p(!1)}),300);return(0,I.jsx)(x.NU,{inputId:"default-log-groups","aria-label":"Log Groups",allowCustomValue:!0,options:i?C(i,w):w,value:n,onChange:e=>r(e.filter((e=>{let{value:t}=e;return t})).map((e=>{let{value:t}=e;return t}))),onBlur:a,closeMenuOnSelect:!1,isClearable:!0,isOptionDisabled:()=>n.length>=20,placeholder:"Choose Log Groups",maxVisibleValues:4,noOptionsMessage:"No log groups available",isLoading:d,onOpenMenu:async()=>{o&&await o()},onInputChange:(e,n)=>{E(e,t,n)},width:u})};var j,R,T=n(27549),O=n(63672),M=n(9617),F=n(8771);const D=e=>({infoText:T.css`
    padding-bottom: ${e.spacing(2)};
    color: ${e.colors.text.secondary};
  `}),k="grafana-x-ray-datasource";function q(e){let{datasourceUid:t,onChange:n}=e;const r=Boolean((0,f.ak)().getList({pluginId:k}).length),i=(0,M.wW)(D);return(0,I.jsxs)(I.Fragment,{children:[j||(j=(0,I.jsx)("h3",{className:"page-heading",children:"X-ray trace link"})),(0,I.jsx)("div",{className:i.infoText,children:"Grafana will automatically create a link to a trace in X-ray data source if logs contain @xrayTraceId field"}),!r&&(R||(R=(0,I.jsx)(F.b,{title:"There is no X-ray datasource to link to. First add an X-ray data source and then link it to Cloud Watch. ",severity:"info"}))),(0,I.jsx)("div",{className:"gf-form-group",children:(0,I.jsx)(p._,{htmlFor:"data-source-picker",label:"Data source",labelWidth:28,tooltip:"X-ray data source containing traces",children:(0,I.jsx)(O.q,{pluginId:k,onChange:e=>n(e.uid),current:t,noDefault:!0})})})]})}var P;var N,L,K=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_=(N=["",""],L=["",""],Object.freeze(Object.defineProperties(N,{raw:{value:Object.freeze(L)}})));function $(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var V=function(){function e(){for(var t=this,n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];return $(this,e),this.tag=function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return"function"==typeof e?t.interimTag.bind(t,e):"string"==typeof e?t.transformEndResult(e):(e=e.map(t.transformString.bind(t)),t.transformEndResult(e.reduce(t.processSubstitutions.bind(t,r))))},r.length>0&&Array.isArray(r[0])&&(r=r[0]),this.transformers=r.map((function(e){return"function"==typeof e?e():e})),this.tag}return K(e,[{key:"interimTag",value:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return this.tag(_,e.apply(void 0,[t].concat(r)))}},{key:"processSubstitutions",value:function(e,t,n){var r=this.transformSubstitution(e.shift(),t);return"".concat(t,r,n)}},{key:"transformString",value:function(e){return this.transformers.reduce((function(e,t){return t.onString?t.onString(e):e}),e)}},{key:"transformSubstitution",value:function(e,t){return this.transformers.reduce((function(e,n){return n.onSubstitution?n.onSubstitution(e,t):e}),e)}},{key:"transformEndResult",value:function(e){return this.transformers.reduce((function(e,t){return t.onEndResult?t.onEndResult(e):e}),e)}}]),e}();const Q=V;var B={separator:"",conjunction:"",serial:!1};const W=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:B;return{onSubstitution:function(t,n){if(Array.isArray(t)){var r=t.length,i=e.separator,a=e.conjunction,s=e.serial,o=n.match(/(\n?[^\S\n]+)$/);if(t=o?t.join(i+o[1]):t.join(i+" "),a&&r>1){var l=t.lastIndexOf(i);t=t.slice(0,l)+(s?i:"")+" "+a+t.slice(l+1)}}return t}}};function G(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}const U=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"initial";return{onEndResult:function(t){if("initial"===e){var n=t.match(/^[^\S\n]*(?=\S)/gm),r=n&&Math.min.apply(Math,G(n.map((function(e){return e.length}))));if(r){var i=new RegExp("^.{"+r+"}","gm");return t.replace(i,"")}return t}if("all"===e)return t.replace(/^[^\S\n]+/gm,"");throw new Error("Unknown type: "+e)}}};const H=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return{onEndResult:function(t){if(""===e)return t.trim();if("start"===(e=e.toLowerCase())||"left"===e)return t.replace(/^\s*/,"");if("end"===e||"right"===e)return t.replace(/\s*$/,"");throw new Error("Side not supported: "+e)}}};new Q(W({separator:","}),U,H);new Q(W({separator:",",conjunction:"and"}),U,H);new Q(W({separator:",",conjunction:"or"}),U,H);const z=function(e){return{onSubstitution:function(t,n){if(null==e||"string"!=typeof e)throw new Error("You need to specify a string character to split by.");return"string"==typeof t&&t.includes(e)&&(t=t.split(e)),t}}};var J=function(e){return null!=e&&!Number.isNaN(e)&&"boolean"!=typeof e};const X=function(){return{onSubstitution:function(e){return Array.isArray(e)?e.filter(J):J(e)?e:""}}};new Q(z("\n"),X,W,U,H);const Y=function(e,t){return{onSubstitution:function(n,r){if(null==e||null==t)throw new Error("replaceSubstitutionTransformer requires at least 2 arguments.");return null==n?n:n.toString().replace(e,t)}}};new Q(z("\n"),W,U,H,Y(/&/g,"&amp;"),Y(/</g,"&lt;"),Y(/>/g,"&gt;"),Y(/"/g,"&quot;"),Y(/'/g,"&#x27;"),Y(/`/g,"&#x60;"));const Z=function(e,t){return{onEndResult:function(n){if(null==e||null==t)throw new Error("replaceResultTransformer requires at least 2 arguments.");return n.replace(e,t)}}};new Q(Z(/(?:\n(?:\s*))+/g," "),H);new Q(Z(/(?:\n\s*)/g,""),H);new Q(W({separator:","}),Z(/(?:\s+)/g," "),H);new Q(W({separator:",",conjunction:"or"}),Z(/(?:\s+)/g," "),H);new Q(W({separator:",",conjunction:"and"}),Z(/(?:\s+)/g," "),H);new Q(W,U,H);new Q(W,Z(/(?:\s+)/g," "),H);const ee=new Q(U,H);const te=new Q(U("all"),H);var ne=n(57706),re=n.n(ne),ie=n(13093);const ae=[{label:"fields",documentation:"Retrieves the specified fields from log events"},{label:"display",documentation:"Specifies which fields to display in the query results"},{label:"filter",documentation:"Filters the results of a query based on one or more conditions"},{label:"stats",documentation:"Calculates aggregate statistics based on the values of log fields"},{label:"sort",documentation:"Sorts the retrieved log events"},{label:"limit",documentation:"Specifies the number of log events returned by the query"},{label:"parse",documentation:"Extracts data from a log field, creating one or more ephemeral fields that you can process further in the query"}],se=[{label:"abs",detail:"abs(a)",documentation:"Absolute value."},{label:"ceil",detail:"ceil(a)",documentation:"Round to ceiling (the smallest integer that is greater than the value of a)."},{label:"floor",detail:"floor(a)",documentation:"Round to floor (the largest integer that is smaller than the value of a)."},{label:"greatest",detail:"greatest(a,b, ... z)",documentation:"Returns the largest value."},{label:"least",detail:"least(a, b, ... z)",documentation:"Returns the smallest value."},{label:"log",detail:"log(a)",documentation:"Natural logarithm."},{label:"sqrt",detail:"sqrt(a)",documentation:"Square root."}],oe=[{label:"isempty",detail:"isempty(fieldname)",documentation:"Returns true if the field is missing or is an empty string."},{label:"isblank",detail:"isblank(fieldname)",documentation:"Returns true if the field is missing, an empty string, or contains only white space."},{label:"concat",detail:"concat(string1, string2, ... stringz)",documentation:"Concatenates the strings."},{label:"ltrim",detail:"ltrim(string) or ltrim(string1, string2)",documentation:"Remove white space from the left of the string. If the function has a second string argument, it removes the characters of string2 from the left of string1."},{label:"rtrim",detail:"rtrim(string) or rtrim(string1, string2)",documentation:"Remove white space from the right of the string. If the function has a second string argument, it removes the characters of string2 from the right of string1."},{label:"trim",detail:"trim(string) or trim(string1, string2)",documentation:"Remove white space from both ends of the string. If the function has a second string argument, it removes the characters of string2 from both sides of string1."},{label:"strlen",detail:"strlen(string)",documentation:"Returns the length of the string in Unicode code points."},{label:"toupper",detail:"toupper(string)",documentation:"Converts the string to uppercase."},{label:"tolower",detail:"tolower(string)",documentation:"Converts the string to lowercase."},{label:"substr",detail:"substr(string1, x), or substr(string1, x, y)",documentation:"Returns a substring from the index specified by the number argument to the end of the string. If the function has a second number argument, it contains the length of the substring to be retrieved."},{label:"replace",detail:"replace(string1, string2, string3)",documentation:"Replaces all instances of string2 in string1 with string3."},{label:"strcontains",detail:"strcontains(string1, string2)",documentation:"Returns 1 if string1 contains string2 and 0 otherwise."}],le=[{label:"bin",detail:"bin(period)",documentation:"Rounds the value of @timestamp to the given period and then truncates."},{label:"datefloor",detail:"datefloor(a, period)",documentation:"Truncates the timestamp to the given period."},{label:"dateceil",detail:"dateceil(a, period)",documentation:"Rounds up the timestamp to the given period and then truncates."},{label:"fromMillis",detail:"fromMillis(fieldname)",documentation:"Interprets the input field as the number of milliseconds since the Unix epoch and converts it to a timestamp."},{label:"toMillis",detail:"toMillis(fieldname)",documentation:"Converts the timestamp found in the named field into a number representing the milliseconds since the Unix epoch."}],ue=[{label:"isValidIp",detail:"isValidIp(fieldname)",documentation:"Returns true if the field is a valid v4 or v6 IP address."},{label:"isValidIpV4",detail:"isValidIpV4(fieldname)",documentation:"Returns true if the field is a valid v4 IP address."},{label:"isValidIpV6",detail:"isValidIpV6(fieldname)",documentation:"Returns true if the field is a valid v6 IP address."},{label:"isIpInSubnet",detail:"isIpInSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v4 or v6 IP address within the specified v4 or v6 subnet."},{label:"isIpv4InSubnet",detail:"isIpv4InSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v4 IP address within the specified v4 subnet."},{label:"isIpv6InSubnet",detail:"isIpv6InSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v6 IP address within the specified v6 subnet."}],ce=[{label:"ispresent",detail:"ispresent(fieldname)",documentation:"Returns true if the field exists."},{label:"isempty",detail:"isempty(fieldname)",documentation:"Returns true if the field is missing or is an empty string."},{label:"isblank",detail:"isblank(fieldname)",documentation:"Returns true if the field is missing, an empty string, or contains only white space."},{label:"strcontains",detail:"strcontains(string1, string2)",documentation:"Returns 1 if string1 contains string2 and 0 otherwise."},...ue],de=[{label:"avg",detail:"avg(NumericFieldname)",documentation:"The average of the values in the specified field."},{label:"count",detail:"count(fieldname) or count(*)",documentation:"Counts the log records."},{label:"count_distinct",detail:"count_distinct(fieldname)",documentation:"Returns the number of unique values for the field."},{label:"max",detail:"max(fieldname)",documentation:"The maximum of the values for this log field in the queried logs."},{label:"min",detail:"min(fieldname)",documentation:"The minimum of the values for this log field in the queried logs."},{label:"pct",detail:"pct(fieldname, value)",documentation:"A percentile indicates the relative standing of a value in a datas."},{label:"stddev",detail:"stddev(NumericFieldname)",documentation:"The standard deviation of the values in the specified field."},{label:"sum",detail:"sum(NumericFieldname)",documentation:"The sum of the values in the specified field."}],pe=[...de,{label:"earliest",detail:"earliest(fieldname)",documentation:"Returns the value of fieldName from the log event that has the earliest time stamp in the queried logs."},{label:"latest",detail:"latest(fieldname)",documentation:"Returns the value of fieldName from the log event that has the latest time stamp in the queried logs."},{label:"sortsFirst",detail:"sortsFirst(fieldname)",documentation:"Returns the value of fieldName that sorts first in the queried logs."},{label:"sortsLast",detail:"sortsLast(fieldname)",documentation:"Returns the value of fieldName that sorts last in the queried logs."}],me=[...se,{label:"ispresent",detail:"ispresent(fieldname)",documentation:"Returns true if the field exists."},{label:"coalesce",detail:"coalesce(fieldname1, fieldname2, ... fieldnamex)",documentation:"Returns the first non-null value from the list."},...oe,...le,...ue],he=[...me,...pe],ge={comment:{pattern:/^#.*/,greedy:!0},backticks:{pattern:/`.*?`/,alias:"string",greedy:!0},quote:{pattern:/".*?"/,alias:"string",greedy:!0},regex:{pattern:/\/.*?\/(?=\||\s*$|,)/,greedy:!0},"query-command":{pattern:new RegExp(`\\b(?:${ae.map((e=>e.label)).join("|")})\\b`,"i"),alias:"function"},function:{pattern:new RegExp(`\\b(?:${he.map((e=>e.label)).join("|")})\\b`,"i")},keyword:{pattern:new RegExp(`(\\s+)(${["as","like","by","in","desc","asc"].join("|")})(?=\\s+)`,"i"),lookbehind:!0},"field-name":{pattern:/(@?[_a-zA-Z]+[_.0-9a-zA-Z]*)|(`((\\`)|([^`]))*?`)/,greedy:!0},number:/\b-?\d+((\.\d*)?([eE][+-]?\d+)?)?\b/,"command-separator":{pattern:/\|/,alias:"punctuation"},"comparison-operator":{pattern:/([<>]=?)|(!?=)/},punctuation:/[{}()`,.]/,whitespace:/\s+/};var fe,ve;const ye=[{category:"Lambda",examples:[{title:"View latency statistics for 5-minute intervals",expr:te`filter @type = "REPORT" |
                           stats avg(@duration), max(@duration), min(@duration) by bin(5m)`},{title:"Determine the amount of overprovisioned memory",expr:ee`
        filter @type = "REPORT" |
        stats max(@memorySize / 1024 / 1024) as provisonedMemoryMB,
              min(@maxMemoryUsed / 1024 / 1024) as smallestMemoryRequestMB,
              avg(@maxMemoryUsed / 1024 / 1024) as avgMemoryUsedMB,
              max(@maxMemoryUsed / 1024 / 1024) as maxMemoryUsedMB,
              provisonedMemoryMB - maxMemoryUsedMB as overProvisionedMB`},{title:"Find the most expensive requests",expr:te`filter @type = "REPORT" |
                           fields @requestId, @billedDuration |
                           sort by @billedDuration desc`}]},{category:"VPC Flow Logs",examples:[{title:"Average, min, and max byte transfers by source and destination IP addresses",expr:"stats avg(bytes), min(bytes), max(bytes) by srcAddr, dstAddr"},{title:"IP addresses using UDP transfer protocol",expr:"filter protocol=17 | stats count(*) by srcAddr"},{title:"Top 10 byte transfers by source and destination IP addresses",expr:te`stats sum(bytes) as bytesTransferred by srcAddr, dstAddr |
                           sort bytesTransferred desc |
                           limit 10`},{title:"Top 20 source IP addresses with highest number of rejected requests",expr:te`filter action="REJECT" |
                           stats count(*) as numRejections by srcAddr |
                           sort numRejections desc |
                           limit 20`}]},{category:"CloudTrail",examples:[{title:"Number of log entries by service, event type, and region",expr:"stats count(*) by eventSource, eventName, awsRegion"},{title:"Number of log entries by region and EC2 event type",expr:te`filter eventSource="ec2.amazonaws.com" |
                           stats count(*) as eventCount by eventName, awsRegion |
                           sort eventCount desc`},{title:"Regions, usernames, and ARNs of newly created IAM users",expr:te`filter eventName="CreateUser" |
                           fields awsRegion, requestParameters.userName, responseElements.user.arn`}]},{category:"Common Queries",examples:[{title:"25 most recently added log events",expr:te`fields @timestamp, @message |
                           sort @timestamp desc |
                           limit 25`},{title:"Number of exceptions logged every 5 minutes",expr:te`filter @message like /Exception/ |
                           stats count(*) as exceptionCount by bin(5m) |
                           sort exceptionCount desc`},{title:"List of log events that are not exceptions",expr:"fields @message | filter @message not like /Exception/"}]},{category:"Route 53",examples:[{title:"Number of requests received every 10  minutes by edge location",expr:"stats count(*) by queryType, bin(10m)"},{title:"Number of unsuccessful requests by domain",expr:'filter responseCode="SERVFAIL" | stats count(*) by queryName'},{title:"Number of requests received every 10  minutes by edge location",expr:"stats count(*) as numRequests by resolverIp | sort numRequests desc | limit 10"}]},{category:"AWS AppSync",examples:[{title:"Number of unique HTTP status codes",expr:te`fields ispresent(graphQLAPIId) as isApi |
                           filter isApi |
                           filter logType = "RequestSummary" |
                           stats count() as statusCount by statusCode |
                           sort statusCount desc`},{title:"Top 10 resolvers with maximum latency",expr:te`fields resolverArn, duration |
                           filter logType = "Tracing" |
                           sort duration desc |
                           limit 10`},{title:"Most frequently invoked resolvers",expr:te`fields ispresent(resolverArn) as isRes |
                           stats count() as invocationCount by resolverArn |
                           filter isRes |
                           filter logType = "Tracing" |
                           sort invocationCount desc |
                           limit 10`},{title:"Resolvers with most errors in mapping templates",expr:te`fields ispresent(resolverArn) as isRes |
                           stats count() as errorCount by resolverArn, logType |
                           filter isRes and (logType = "RequestMapping" or logType = "ResponseMapping") and fieldInError |
                           sort errorCount desc |
                           limit 10`},{title:"Field latency statistics",expr:te`fields requestId, latency |
                           filter logType = "RequestSummary" |
                           sort latency desc |
                           limit 10`},{title:"Resolver latency statistics",expr:te`fields ispresent(resolverArn) as isRes |
                           filter isRes |
                           filter logType = "Tracing" |
                           stats min(duration), max(duration), avg(duration) as avgDur by resolverArn |
                           sort avgDur desc |
                           limit 10`},{title:"Top 10 requests with maximum latency",expr:te`fields requestId, latency |
                           filter logType = "RequestSummary" |
                           sort latency desc |
                           limit 10`}]}];function be(e,t){const n=ge,r=(0,ie.a)(re().tokenize(e,n)).filter((e=>"string"!=typeof e)).map(((e,n)=>(0,I.jsx)("span",{className:`prism-token token ${e.types.join(" ")} ${e.aliases.join(" ")}`,children:e.content},`${t}-token-${n}`)));return(0,I.jsx)("div",{className:"slate-query-field",children:r})}const xe=T.css`
  margin-top: 5px;
`;class we extends s.PureComponent{onClickExample(e){this.props.onClickExample(e)}renderExpression(e,t){return(0,I.jsx)("div",{className:"cheat-sheet-item__example",onClick:()=>{var t,n;return this.onClickExample({refId:null!==(t=this.props.query.refId)&&void 0!==t?t:"A",expression:e,queryMode:"Logs",region:this.props.query.region,id:null!==(n=this.props.query.refId)&&void 0!==n?n:"A",logGroupNames:"logGroupNames"in this.props.query?this.props.query.logGroupNames:[]})},children:(0,I.jsx)("pre",{children:be(e,t)})},e)}renderLogsCheatSheet(){return(0,I.jsxs)("div",{children:[fe||(fe=(0,I.jsx)("h2",{children:"CloudWatch Logs Cheat Sheet"})),ye.map(((e,t)=>(0,I.jsxs)("div",{children:[(0,I.jsx)("div",{className:`cheat-sheet-item__title ${(0,T.cx)(xe)}`,children:e.category}),e.examples.map(((e,t)=>(0,I.jsxs)("div",{className:"cheat-sheet-item",children:[(0,I.jsx)("h4",{children:e.title}),this.renderExpression(e.expr,`item-${t}`)]},`item-${t}`)))]},`${e.category}-${t}`)))]})}render(){return(0,I.jsxs)("div",{children:[ve||(ve=(0,I.jsx)("h3",{children:"CloudWatch Logs cheat sheet"})),ye.map(((e,t)=>(0,I.jsxs)("div",{children:[(0,I.jsx)("div",{className:`cheat-sheet-item__title ${(0,T.cx)(xe)}`,children:e.category}),e.examples.map(((e,t)=>(0,I.jsxs)("div",{className:"cheat-sheet-item",children:[(0,I.jsx)("h4",{children:e.title}),this.renderExpression(e.expr,`item-${t}`)]},`item-${t}`)))]},`cat-${t}`)))]})}}var Se;const Ce=e=>"Logs"===e.queryMode,Ee=e=>"Metrics"===e.queryMode||!e.hasOwnProperty("queryMode"),Ie=e=>"Annotations"===e.queryMode;var Ae=n(68522),je=n(48147),Re=n(7197),Te=n(40882);const Oe={value:"*",label:"*"},Me=e=>{let{filter:t,metricStat:{region:n,namespace:r,metricName:i,dimensions:a},datasource:o,dimensionKeys:l,disableExpressions:u,onChange:c,onDelete:d}=e;const p=(0,s.useMemo)((()=>((e,t)=>Object.entries(null!=e?e:{}).reduce(((e,n)=>{let[r,i]=n;return r!==t?Object.assign({},e,{[r]:i}):e}),{}))(null!=a?a:{},t.key)),[a,t]),[m,h]=(0,Re.Z)((async()=>t.key?o.api.getDimensionValues(n,r,i,t.key,p).then((e=>(e.length&&!u&&e.unshift(Oe),C(o,e)))):[]),[t.key,a]),g=(0,M.l4)(),f=Fe(g);return(0,I.jsx)("div",{"data-testid":"cloudwatch-dimensions-filter-item",children:(0,I.jsxs)(Ae.InputGroup,{children:[(0,I.jsx)(x.Ph,{"aria-label":"Dimensions filter key",inputId:"cloudwatch-dimensions-filter-item-key",width:"auto",value:t.key?(0,b.E)(t.key):null,allowCustomValue:!0,options:l,onChange:e=>{e.label&&c({key:e.label,value:void 0})}}),(0,I.jsx)("span",{className:(0,T.cx)(f.root),children:"="}),(0,I.jsx)(x.Ph,{"aria-label":"Dimensions filter value",inputId:"cloudwatch-dimensions-filter-item-value",onOpenMenu:h,width:"auto",value:t.value?(0,b.E)(t.value):null,allowCustomValue:!0,isLoading:m.loading,options:m.value,onChange:e=>{e.value&&c(Object.assign({},t,{value:e.value}))}}),(0,I.jsx)(Ae.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:d,type:"button"})]})})},Fe=(0,Te.B)((e=>({root:(0,T.css)({padding:e.spacing(0,1),alignSelf:"center"})}))),De=e=>{let{metricStat:t,datasource:n,dimensionKeys:r,disableExpressions:i,onChange:a}=e;const o=(0,s.useMemo)((()=>{return e=t.dimensions,Object.entries(null!=e?e:{}).reduce(((e,t)=>{let[n,r]=t;if(r&&"string"==typeof r){const t={key:n,value:r,operator:"="};return[...e,t]}return e}),[]);var e}),[t.dimensions]),[l,u]=(0,s.useState)(o);return(0,I.jsx)(Ae.EditorList,{items:l,onChange:e=>{u(e);const n=e.reduce(((e,t)=>{let{key:n,value:r}=t;return n&&r?Object.assign({},e,{[n]:r}):e}),{});(0,y.isEqual)(n,t.dimensions)||a(n)},renderItem:ke(n,t,r,i)})};function ke(e,t,n,r){return function(i,a,s){return(0,I.jsx)(Me,{filter:i,onChange:e=>a(e),datasource:e,metricStat:t,disableExpressions:r,dimensionKeys:n,onDelete:s})}}var qe=n(97833),Pe=n(24085);const Ne=n(36993);function Le(e,t){return`https://${t}.console.aws.amazon.com/cloudwatch/home?region=${t}#logs-insights:queryDetail=${Ne.stringify(e)}`}var Ke;class _e extends s.Component{constructor(){var e,t,n;super(...arguments),n={href:""},(t="state")in(e=this)?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}async componentDidUpdate(e){const{panelData:t}=this.props,{panelData:n}=e;if(n!==t&&null!=t&&t.request){const e=this.getExternalLink();this.setState({href:e})}}getExternalLink(){var e,t,n;const{query:r,panelData:i,datasource:a}=this.props,s=null==i||null===(e=i.request)||void 0===e?void 0:e.range;if(!s)return"";const o=s.from.toISOString();return Le({end:s.to.toISOString(),start:o,timeType:"ABSOLUTE",tz:"UTC",editorString:null!==(t=r.expression)&&void 0!==t?t:"",isLiveTail:!1,source:null!==(n=r.logGroupNames)&&void 0!==n?n:[]},a.api.getActualRegion(r.region))}render(){const{href:e}=this.state;return(0,I.jsxs)("a",{href:e,target:"_blank",rel:"noopener noreferrer",children:[Ke||(Ke=(0,I.jsx)(Pe.J,{name:"share-alt"}))," CloudWatch Logs Insights"]})}}var $e=n(32607),Ve=n(42528),Qe=n(54416);const Be=/\s+by\s+/im,We=/([\w$@().]+)(?:(\s+as\s+)([\w$]+))?\s*,?\s*/iy;function Ge(e){let t,n=[];if(t=e.match(Be)){let r;for(We.lastIndex=t.index+t[0].length;r=We.exec(e);)n.push(r[2]?r[3]:r[1]),We.lastIndex=r.index+r[0].length}return n}var Ue=n(56491);const He=e=>{const[t,n]=(0,s.useState)(!1),[r,i]=(0,s.useState)([{label:"default",value:"default"}]);return(0,s.useEffect)((()=>{n(!0);const t={label:"Template Variables",options:e.getVariables().map(b.E)};e.api.getRegions().then((e=>i([...e,t]))).finally((()=>n(!1)))}),[e]),[r,t]},ze=e=>{const[t,n]=(0,s.useState)([]);return(0,s.useEffect)((()=>{e.api.getNamespaces().then((t=>{n(C(e,t))}))}),[e]),t},Je=(e,t,n)=>{const[r,i]=(0,s.useState)([]);return(0,s.useEffect)((()=>{e.api.getMetrics(n,t).then((t=>{i(C(e,t))}))}),[e,t,n]),r},Xe=(e,t,n,r,i)=>{const[a,o]=(0,s.useState)([]);return(0,Ue.Z)((()=>{e.api.getDimensionKeys(n,t,i,r).then((t=>{o(C(e,t))}))}),[e,t,n,r,i]),a};var Ye,Ze=n(96380),et=n(40920),tt=n(95378);const nt=[{label:"Metric Search",value:w.$5.Search},{label:"Metric Query",value:w.$5.Query}],rt=[{label:"Builder",value:w.MQ.Builder},{label:"Code",value:w.MQ.Code}],it=e=>{let{query:t,sqlCodeEditorIsDirty:n,onChange:r,onRunQuery:i}=e;const{metricEditorMode:a,metricQueryType:o}=t,[l,u]=(0,s.useState)(!1),c=(0,s.useCallback)((e=>{n&&o===w.$5.Query&&a===w.MQ.Code?u(!0):r(Object.assign({},t,{metricEditorMode:e}))}),[u,r,n,t,a,o]);return(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(Ae.InlineSelect,{"aria-label":"Metric editor mode",value:nt.find((e=>e.value===o)),options:nt,onChange:e=>{let{value:n}=e;r(Object.assign({},t,{metricQueryType:n}))}}),Ye||(Ye=(0,I.jsx)(Ae.FlexItem,{grow:1})),(0,I.jsx)(Ze.S,{options:rt,size:"sm",value:a,onChange:c}),t.metricQueryType===w.$5.Query&&t.metricEditorMode===w.MQ.Code&&(0,I.jsx)(et.zx,{variant:"secondary",size:"sm",onClick:()=>i(),children:"Run query"}),(0,I.jsx)(tt.s,{isOpen:l,title:"Are you sure?",body:"You will lose manual changes done to the query if you go back to the visual builder.",confirmText:"Yes, I am sure.",dismissText:"No, continue editing the query manually.",icon:"exclamation-triangle",onConfirm:()=>{u(!1),r(Object.assign({},t,{metricEditorMode:w.MQ.Builder}))},onDismiss:()=>u(!1)})]})},at=[{label:"CloudWatch Metrics",value:"Metrics"},{label:"CloudWatch Logs",value:"Logs"}],st=e=>{let{query:t,sqlCodeEditorIsDirty:n,datasource:i,onChange:a,onRunQuery:s}=e;const{queryMode:o,region:l}=t,[u,c]=He(i);return(0,I.jsxs)(Ae.EditorHeader,{children:[(0,I.jsx)(Ae.InlineSelect,{label:"Region",value:l,placeholder:"Select region",allowCustomValue:!0,onChange:e=>{let{value:n}=e;return n&&(async e=>{let{value:n}=e;a(Object.assign({},t,{region:n}))})({value:n})},options:u,isLoading:c}),(0,I.jsx)(Ae.InlineSelect,{"aria-label":"Query mode",value:o,options:at,onChange:e=>{let{value:n}=e;if(n!==o){const e=(0,y.pick)(t,"id","region","namespace","refId","hide","key","queryType","datasource");a(Object.assign({},e,{queryMode:n}))}}}),o===r.Ru.Metrics&&(0,I.jsx)(it,{query:t,datasource:i,onChange:a,onRunQuery:s,sqlCodeEditorIsDirty:n})]})};function ot(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const lt=T.css`
  gap: 3px;
`;class ut extends s.PureComponent{constructor(e,t){super(e,t),ot(this,"state",{hint:void 0}),ot(this,"plugins",void 0),ot(this,"componentDidMount",(()=>{const{query:e,datasource:t,onChange:n}=this.props;var r;n&&n(Object.assign({},e,{logGroupNames:null!==(r=e.logGroupNames)&&void 0!==r?r:t.logsQueryRunner.defaultLogGroups}))})),ot(this,"onChangeQuery",(e=>{const{query:t,onChange:n}=this.props;if(n){n(Object.assign({},t,{expression:e,statsGroups:Ge(e)}))}})),ot(this,"onTypeahead",(async e=>{const{datasource:t,query:n}=this.props,{logGroupNames:r}=n;if(!t.languageProvider)return{suggestions:[]};const i=t.languageProvider,{history:a,absoluteRange:s}=this.props,{prefix:o,text:l,value:u,wrapperClasses:c,labelKey:d,editor:p}=e;return await i.provideCompletionItems({text:l,value:u,prefix:o,wrapperClasses:c,labelKey:d,editor:p},{history:a,absoluteRange:s,logGroupNames:r,region:n.region})})),this.plugins=[(0,$e.h)(),(0,ie.Z)({onlyIn:e=>"block"===e.object&&"code_block"===e.type,getSyntax:e=>"cloudwatch"},Object.assign({},ne.languages,{cloudwatch:ge}))]}render(){var e;const{onRunQuery:t,onChange:n,ExtraFieldElement:r,data:i,query:a,datasource:s}=this.props,{region:o,refId:l,expression:u,logGroupNames:c}=a,{hint:d}=this.state,p=i&&i.error&&i.error.refId===a.refId,m=s.languageProvider?s.languageProvider.cleanText:void 0;return(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(st,{query:a,onRunQuery:t,datasource:s,onChange:n,sqlCodeEditorIsDirty:!1}),(0,I.jsx)("div",{className:`gf-form gf-form--grow flex-grow-1 ${lt}`,children:(0,I.jsx)(Ve.vw6.FormField,{label:"Log Groups",labelWidth:6,className:"flex-grow-1",inputEl:(0,I.jsx)(A,{region:o,selectedLogGroups:null!=c?c:s.logsQueryRunner.defaultLogGroups,datasource:s,onChange:function(e){n(Object.assign({},a,{logGroupNames:e}))},onRunQuery:t,refId:l})})}),(0,I.jsxs)("div",{className:"gf-form-inline gf-form-inline--nowrap flex-grow-1",children:[(0,I.jsx)("div",{className:"gf-form gf-form--grow flex-shrink-1",children:(0,I.jsx)(Qe.q,{additionalPlugins:this.plugins,query:null!=u?u:"",onChange:this.onChangeQuery,onRunQuery:this.props.onRunQuery,onTypeahead:this.onTypeahead,cleanText:m,placeholder:"Enter a CloudWatch Logs Insights query (run with Shift+Enter)",portalOrigin:"cloudwatch",disabled:!c||0===c.length})}),r]}),d&&(0,I.jsx)("div",{className:"query-row-break",children:(0,I.jsxs)("div",{className:"text-warning",children:[d.message,(0,I.jsx)("a",{className:"text-link muted",onClick:d.fix.action,children:d.fix.label})]})}),p?(0,I.jsx)("div",{className:"query-row-break",children:(0,I.jsx)("div",{className:"prom-query-field-info text-error",children:null==i||null===(e=i.error)||void 0===e?void 0:e.message})}):null]})}}const ct=T.css`
  margin-left: 3px;
  flex-grow: 0;
`,dt=(0,s.memo)((function(e){var t,n;const{query:r,data:i,datasource:a,onRunQuery:s,onChange:o,exploreId:l}=e;let u;if(null!=i&&null!==(t=i.request)&&void 0!==t&&null!==(n=t.range)&&void 0!==n&&n.from){const{range:e}=i.request;u={from:e.from.valueOf(),to:e.to.valueOf()}}else u={from:Date.now()-1e4,to:Date.now()};return(0,I.jsx)(ut,{exploreId:l,datasource:a,query:r,onChange:o,onRunQuery:s,history:[],data:i,absoluteRange:u,ExtraFieldElement:(0,I.jsx)(qe.c,{className:`gf-form-label--btn ${ct}`,width:"auto",tooltip:"Link to Graph in AWS",children:(0,I.jsx)(_e,{query:r,panelData:i,datasource:a})})})})),pt=dt,mt=["Average","Maximum","Minimum","Sum","SampleCount"];function ht(e){var t;let{refId:n,metricStat:r,datasource:i,disableExpressions:a=!1,onChange:s,onRunQuery:o}=e;const{region:l,namespace:u,metricName:c,dimensions:d}=r,p=ze(i),m=Je(i,l,u),h=Xe(i,l,u,c,null!=d?d:{}),g=e=>{s(e),o()},f=async e=>{let{metricName:t,namespace:n,region:r}=e;return t?(await i.api.getMetrics(n,r).then((e=>{e.find((e=>e.value===t))||(t="")})),Object.assign({},e,{metricName:t})):e};return(0,I.jsxs)(Ae.EditorRows,{children:[(0,I.jsx)(Ae.EditorRow,{children:(0,I.jsxs)(Ae.EditorFieldGroup,{children:[(0,I.jsx)(Ae.EditorField,{label:"Namespace",width:26,children:(0,I.jsx)(x.Ph,{"aria-label":"Namespace",value:(null==r?void 0:r.namespace)&&S(r.namespace),allowCustomValue:!0,options:p,onChange:e=>{let{value:t}=e;t&&(async e=>{const t=await f(e);g(t)})(Object.assign({},r,{namespace:t}))}})}),(0,I.jsx)(Ae.EditorField,{label:"Metric name",width:16,children:(0,I.jsx)(x.Ph,{"aria-label":"Metric name",value:(null==r?void 0:r.metricName)&&S(r.metricName),allowCustomValue:!0,options:m,onChange:e=>{let{value:t}=e;t&&g(Object.assign({},r,{metricName:t}))}})}),(0,I.jsx)(Ae.EditorField,{label:"Statistic",width:16,children:(0,I.jsx)(x.Ph,{inputId:`${n}-metric-stat-editor-select-statistic`,allowCustomValue:!0,value:S(null!==(t=r.statistic)&&void 0!==t?t:mt[0]),options:C(i,mt.filter((e=>e!==r.statistic)).map(S)),onChange:e=>{let{value:t}=e;t&&(mt.includes(t)||/^p\d{2}(?:\.\d{1,2})?$/.test(t)||t.startsWith("$"))&&g(Object.assign({},r,{statistic:t}))}})})]})}),(0,I.jsx)(Ae.EditorRow,{children:(0,I.jsx)(Ae.EditorField,{label:"Dimensions",children:(0,I.jsx)(De,{metricStat:r,onChange:e=>g(Object.assign({},r,{dimensions:e})),dimensionKeys:h,disableExpressions:a,datasource:i})})}),!a&&(0,I.jsx)(Ae.EditorRow,{children:(0,I.jsx)(Ae.EditorField,{label:"Match exact",optional:!0,tooltip:"Only show metrics that exactly match all defined dimension names.",children:(0,I.jsx)(Ae.EditorSwitch,{id:`${n}-cloudwatch-match-exact`,value:!!r.matchExact,onChange:e=>{g(Object.assign({},r,{matchExact:e.currentTarget.checked}))}})})})]})}var gt=n(7166);let ft,vt;!function(e){e.String="string"}(ft||(ft={})),function(e){e.Property="property",e.Operator="operator",e.Or="or",e.And="and",e.GroupBy="groupBy",e.Function="function",e.FunctionParameter="functionParameter"}(vt||(vt={}));class yt{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,gt.J)();this.templateSrv=e}expressionToSqlQuery(e){var t,n,r;let{select:i,from:a,where:s,groupBy:o,orderBy:l,orderByDirection:u,limit:c}=e;if(!a||null==i||!i.name||null==i||null===(t=i.parameters)||void 0===t||!t.length)return;let d=[];return this.appendSelect(i,d),this.appendFrom(a,d),this.appendWhere(s,d,!0,null!==(n=null==s||null===(r=s.expressions)||void 0===r?void 0:r.length)&&void 0!==n?n:0),this.appendGroupBy(o,d),this.appendOrderBy(l,u,d),this.appendLimit(c,d),d.join(" ")}appendSelect(e,t){t.push("SELECT"),this.appendFunction(e,t)}appendFrom(e,t){var n,r;t.push("FROM"),(null==e?void 0:e.type)===vt.Function?this.appendFunction(e,t):t.push(this.formatValue(null!==(n=null==e||null===(r=e.property)||void 0===r?void 0:r.name)&&void 0!==n?n:""))}appendWhere(e,t,n,r){if(!e)return;const i="expressions"in e&&e.expressions.length>0;if(n&&i&&t.push("WHERE"),e.type===vt.And){const i=[];if(e.expressions.map((e=>this.appendWhere(e,i,!1,r))),0===i.length)return;const a=i.join(" AND "),s=!n&&r>1&&i.length>1;return t.push(s?`(${a})`:a)}if(e.type!==vt.Or)return e.type===vt.Operator?this.appendOperator(e,t):void 0;{const i=[];if(e.expressions.map((e=>this.appendWhere(e,i,!1,r))),0===i.length)return;const a=i.join(" OR "),s=!n&&r>1&&i.length>1;t.push(s?`(${a})`:a)}}appendGroupBy(e,t){const n=[];for(const t of null!==(r=null==e?void 0:e.expressions)&&void 0!==r?r:[]){var r;(null==t?void 0:t.type)===vt.GroupBy&&t.property.name&&n.push(this.formatValue(t.property.name))}n.length>0&&t.push(`GROUP BY ${n.join(", ")}`)}appendOrderBy(e,t,n){e&&(n.push("ORDER BY"),this.appendFunction(e,n),n.push(null!=t?t:"ASC"))}appendLimit(e,t){e&&t.push(`LIMIT ${e}`)}appendOperator(e,t,n){const{property:r,operator:i}=e;r.name&&i.name&&i.value&&t.push(`${this.formatValue(r.name)} ${i.name} '${i.value}'`)}appendFunction(e,t){var n;if(null==e||!e.name)return;const r=(null!==(n=e.parameters)&&void 0!==n?n:[]).map((e=>e.name&&this.formatValue(e.name))).filter(Boolean).join(", ");t.push(`${e.name}(${r})`)}formatValue(e){const t=this.templateSrv.replace(e,{},"raw");return/[/\s\.-]/.test(t)?`"${e}"`:e}}var bt=n(1762);function xt(e){var t;return null==e||null===(t=e.parameters)||void 0===t?void 0:t[0].name}function wt(e){return(null==e?void 0:e.type)===vt.Property?e.property.name:(null==e?void 0:e.type)===vt.Function?null===(t=e.parameters)||void 0===t?void 0:t[0].name:void 0;var t}function St(e){var t,n,r;const i=null===(t=e.property)||void 0===t?void 0:t.name,a=null===(n=e.operator)||void 0===n?void 0:n.value,s=null===(r=e.operator)||void 0===r?void 0:r.name;if(i&&a&&s)return{type:vt.Operator,property:{type:ft.String,name:i},operator:{value:a,name:s}}}function Ct(e){return e.flatMap((e=>e.type===vt.Operator?e:e.type===vt.And||e.type===vt.Or?Ct(e.expressions):[]))}function Et(e){var t;const n=e.where;return Ct(null!==(t=null==n?void 0:n.expressions)&&void 0!==t?t:[])}function It(e){var t;const n=e.groupBy;return(null!==(t=null==n?void 0:n.expressions)&&void 0!==t?t:[]).flatMap((e=>e.type===vt.GroupBy?e:[]))}function At(e,t){var n;return Object.assign({},e,{sql:Object.assign({},null!==(n=e.sql)&&void 0!==n?n:{},t)})}function jt(e,t){var n,r;return At(e,{select:Object.assign({type:vt.Function},null!==(n=null===(r=e.sql)||void 0===r?void 0:r.select)&&void 0!==n?n:{},{name:t})})}const Rt=bt.STATISTICS.map(b.E),Tt=e=>{var t,n;let{datasource:r,query:i,onQueryChange:a}=e;const o=null!==(t=i.sql)&&void 0!==t?t:{},l=null===(n=o.select)||void 0===n?void 0:n.name;(0,s.useEffect)((()=>{l||a(jt(i,bt.STATISTICS[0]))}),[l,a,i]);const u=xt(o.select),c=wt(o.from),d=function(e){var t;if((null==e?void 0:e.type)===vt.Function&&null!=e&&null!==(t=e.parameters)&&void 0!==t&&t.length){var n;return(null==e||null===(n=e.parameters)||void 0===n?void 0:n.length)<=1?[]:(null==e?void 0:e.parameters.slice(1)).reduce(((e,t)=>t.name?[...e,t.name]:e),[])}}(o.from),p=(null==(m=o.from)?void 0:m.type)===vt.Function&&m.name===bt.SCHEMA;var m;const h=ze(r),g=Je(r,i.region,c),f=(0,s.useMemo)((()=>(null!=d?d:[]).reduce(((e,t)=>t?Object.assign({},e,{[t]:null}):e),{})),[d]),v=Xe(r,i.region,c,u,f),y=(0,s.useMemo)((()=>null!=d&&d.length?[...v,...d.map(b.E)]:v),[v,d]),w=async e=>{let{region:t,sql:n}=e;return await r.api.getMetrics(e.namespace,t).then((t=>{t.some((e=>e.value===u))||(n=function(e){var t,n;const r=Object.assign({},e);return null===(t=r.sql)||void 0===t||null===(n=t.select)||void 0===n||delete n.parameters,r}(e).sql)})),Object.assign({},e,{sql:n})};return(0,I.jsxs)(I.Fragment,{children:[(0,I.jsxs)(Ae.EditorFieldGroup,{children:[(0,I.jsx)(Ae.EditorField,{label:"Namespace",width:16,children:(0,I.jsx)(x.Ph,{"aria-label":"Namespace",value:c?(0,b.E)(c):null,inputId:`${i.refId}-cloudwatch-sql-namespace`,options:h,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&(async e=>{const t=await w(e);a(t)})(function(e,t){var n;const r=null!==(n=e.sql)&&void 0!==n?n:{};if(e.namespace=t||"",void 0===t)return At(e,{from:void 0});if(!r.from||r.from.type===vt.Property)return At(e,{from:{type:vt.Property,property:{type:ft.String,name:t}}});if(r.from.type===vt.Function){var i;const n={type:vt.FunctionParameter,name:t},a=(null!==(i=r.from.parameters)&&void 0!==i?i:[]).slice(1);return At(e,{from:{type:vt.Function,name:bt.SCHEMA,parameters:[n,...a]}})}return e}(i,t))}})}),(0,I.jsx)(Ae.EditorField,{label:"With schema",children:(0,I.jsx)(Ae.EditorSwitch,{id:`${i.refId}-cloudwatch-sql-withSchema`,value:p,onChange:e=>e.target instanceof HTMLInputElement&&a(function(e,t){var n;const r=wt((null!==(n=e.sql)&&void 0!==n?n:{}).from);if(t){const t={type:vt.FunctionParameter,name:r};return At(e,{from:{type:vt.Function,name:bt.SCHEMA,parameters:[t]}})}return At(e,{from:{type:vt.Property,property:{type:ft.String,name:r}}})}(i,e.target.checked))})}),p&&(0,I.jsx)(Ae.EditorField,{label:"Schema labels",disabled:!c,children:(0,I.jsx)(x.Ph,{id:`${i.refId}-cloudwatch-sql-schema-label-keys`,width:"auto",isMulti:!0,value:d?d.map(b.E):null,options:y,allowCustomValue:!0,onChange:e=>e&&a(function(e,t){var n,r,i;const a=null!==(n=e.sql)&&void 0!==n?n:{};if(t=Array.isArray(t)?t.map((e=>e.value)):[t.value],(null===(r=a.from)||void 0===r?void 0:r.type)===vt.Function&&null!==(i=a.from.parameters)&&void 0!==i&&i.length){var s,o;const n=(null!==(s=t)&&void 0!==s?s:[]).map((e=>({type:vt.FunctionParameter,name:e}))),r=(null!==(o=a.from.parameters)&&void 0!==o?o:[])[0];return At(e,{from:{type:vt.Function,name:bt.SCHEMA,parameters:[r,...n]}})}return e}(i,e))})})]}),(0,I.jsxs)(Ae.EditorFieldGroup,{children:[(0,I.jsx)(Ae.EditorField,{label:"Metric name",width:16,children:(0,I.jsx)(x.Ph,{"aria-label":"Metric name",value:u?(0,b.E)(u):null,options:g,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&a(function(e,t){var n,r;const i={type:vt.FunctionParameter,name:t};return At(e,{select:Object.assign({type:vt.Function},null!==(n=null===(r=e.sql)||void 0===r?void 0:r.select)&&void 0!==n?n:{},{parameters:[i]})})}(i,t))}})}),(0,I.jsx)(Ae.EditorField,{label:"Aggregation",width:16,children:(0,I.jsx)(x.Ph,{"aria-label":"Aggregation",value:l?(0,b.E)(l):null,options:C(r,Rt),onChange:e=>{let{value:t}=e;return t&&a(jt(i,t))}})})]})]})},Ot=bt.COMPARISON_OPERATORS.map(b.E);function Mt(e,t){return function(n,r,i){return(0,I.jsx)(Dt,{datasource:e,query:t,filter:n,onChange:r,onDelete:i})}}const Ft=e=>{let{query:t,onQueryChange:n,datasource:r}=e;const i=(0,s.useMemo)((()=>{var e;return Et(null!==(e=t.sql)&&void 0!==e?e:{})}),[t.sql]),[a,o]=(0,s.useState)(i);return(0,I.jsx)(Ae.EditorList,{items:a,onChange:e=>{const r=e.map((e=>{var t,n;return{type:vt.Operator,property:null!==(t=e.property)&&void 0!==t?t:{type:ft.String},operator:null!==(n=e.operator)&&void 0!==n?n:{name:bt.EQUALS}}}));o(r);const i=[];for(const e of r){const t=St(e);t&&i.push(t)}const a=i.length?{type:vt.And,expressions:i}:void 0;n(At(t,{where:a}))},renderItem:Mt(r,t)})},Dt=e=>{var t,n,r,i,a,s,o,l;const{datasource:u,query:c,filter:d,onChange:p,onDelete:m}=e,h=null!==(t=c.sql)&&void 0!==t?t:{},g=wt(h.from),f=xt(h.select),v=Xe(u,c.region,g,f),[y,w]=(0,Re.Z)((async()=>{var e;return null!==(e=d.property)&&void 0!==e&&e.name?u.api.getDimensionValues(c.region,g,f,d.property.name,{}).then((e=>C(u,e))):[]}),[c.region,g,f,null===(n=d.property)||void 0===n?void 0:n.name]);return(0,I.jsxs)(Ae.InputGroup,{children:[(0,I.jsx)(x.Ph,{width:"auto",value:null!==(r=d.property)&&void 0!==r&&r.name?(0,b.E)(null===(i=d.property)||void 0===i?void 0:i.name):null,options:v,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&p((n=d,r=t,{type:vt.Operator,property:{type:ft.String,name:r},operator:null!==(i=n.operator)&&void 0!==i?i:{}}));var n,r,i}}),(0,I.jsx)(x.Ph,{width:"auto",value:(null===(a=d.operator)||void 0===a?void 0:a.name)&&(0,b.E)(d.operator.name),options:Ot,onChange:e=>{let{value:t}=e;return t&&p((n=d,r=t,{type:vt.Operator,property:null!==(i=n.property)&&void 0!==i?i:{type:ft.String},operator:Object.assign({},n.operator,{name:r})}));var n,r,i}}),(0,I.jsx)(x.Ph,{width:"auto",isLoading:y.loading,value:null!==(s=d.operator)&&void 0!==s&&s.value&&"string"==typeof(null===(o=d.operator)||void 0===o?void 0:o.value)?(0,b.E)(null===(l=d.operator)||void 0===l?void 0:l.value):null,options:y.value,allowCustomValue:!0,onOpenMenu:w,onChange:e=>{let{value:t}=e;return t&&p(function(e,t){var n;return{type:vt.Operator,property:null!==(n=e.property)&&void 0!==n?n:{type:ft.String},operator:Object.assign({},e.operator,{value:t})}}(d,t))}}),(0,I.jsx)(Ae.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:m})]})};function kt(e){return function(t,n,r){return(0,I.jsx)(qt,{options:e,item:t,onChange:n,onDelete:r})}}const qt=e=>{var t;const{options:n,item:r,onChange:i,onDelete:a}=e,s=null===(t=r.property)||void 0===t?void 0:t.name;return(0,I.jsxs)(Ae.InputGroup,{children:[(0,I.jsx)(x.Ph,{"aria-label":`Group by ${null!=s?s:"filter key"}`,width:"auto",value:s?(0,b.E)(s):null,options:n,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&i((n=t,{type:vt.GroupBy,property:{type:ft.String,name:n}}));var n}}),(0,I.jsx)(Ae.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:a})]})},Pt=e=>{var t;let{query:n,datasource:r,onQueryChange:i}=e;const a=null!==(t=n.sql)&&void 0!==t?t:{},o=(0,s.useMemo)((()=>{var e;return It(null!==(e=n.sql)&&void 0!==e?e:{})}),[n.sql]),[l,u]=(0,s.useState)(o),c=wt(a.from),d=xt(a.select),p=Xe(r,n.region,c,d),m=(0,s.useMemo)((()=>p.filter((e=>!o.some((t=>t.property.name===e.value))))),[p,o]);return(0,I.jsx)(Ae.EditorList,{items:l,onChange:e=>{const t=e.map((e=>{var t;return{type:vt.GroupBy,property:{type:ft.String,name:null===(t=e.property)||void 0===t?void 0:t.name}}}));u(t);const r=t.filter((e=>{var t;return null===(t=e.property)||void 0===t?void 0:t.name})),a=r.length?{type:vt.And,expressions:r}:void 0;i(At(n,{groupBy:a}))},renderItem:kt(m)})},Nt=[{label:bt.ASC,value:bt.ASC},{label:bt.DESC,value:bt.DESC}],Lt=e=>{var t,n;let{query:r,onQueryChange:i,datasource:a}=e;const s=null!==(t=r.sql)&&void 0!==t?t:{},o=null===(n=s.orderBy)||void 0===n?void 0:n.name,l=s.orderByDirection;return(0,I.jsxs)(Ae.EditorFieldGroup,{children:[(0,I.jsx)(Ae.EditorField,{label:"Order by",optional:!0,width:16,children:(0,I.jsxs)(Ae.InputGroup,{children:[(0,I.jsx)(x.Ph,{"aria-label":"Order by",onChange:e=>{let{value:t}=e;return t&&i(function(e,t){return At(e,{orderBy:{type:vt.Function,name:t}})}(r,t))},options:C(a,bt.STATISTICS.map(b.E)),value:o?(0,b.E)(o):null}),o&&(0,I.jsx)(Ae.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>i(At(r,{orderBy:void 0}))})]})}),(0,I.jsx)(Ae.EditorField,{label:"Direction",disabled:!o,width:16,children:(0,I.jsx)(x.Ph,{"aria-label":"Direction",inputId:"cloudwatch-sql-order-by-direction",value:l?(0,b.E)(l):Nt[0],options:C(a,Nt),onChange:e=>e&&i(At(r,{orderByDirection:e.value}))})})]})};function Kt(e){var t;let{query:n,datasource:r,onChange:i,onRunQuery:a}=e;const o=null!==(t=n.sql)&&void 0!==t?t:{},l=(0,s.useCallback)((e=>{var t;const n=(new yt).expressionToSqlQuery(null!==(t=e.sql)&&void 0!==t?t:{}),r=Object.assign({},e,{sqlExpression:n});i(r),a()}),[i,a]),[u,c]=(0,s.useState)();return(0,s.useEffect)((()=>{var e;const t=(new yt).expressionToSqlQuery(null!==(e=n.sql)&&void 0!==e?e:{});u!==t&&c(t)}),[n,u,c]),(0,I.jsxs)(Ae.EditorRows,{children:[(0,I.jsx)(Ae.EditorRow,{children:(0,I.jsx)(Tt,{query:n,onQueryChange:l,datasource:r})}),(0,I.jsx)(Ae.EditorRow,{children:(0,I.jsx)(Ae.EditorField,{label:"Filter",optional:!0,children:(0,I.jsx)(Ft,{query:n,onQueryChange:l,datasource:r})})}),(0,I.jsxs)(Ae.EditorRow,{children:[(0,I.jsx)(Ae.EditorField,{label:"Group by",optional:!0,children:(0,I.jsx)(Pt,{query:n,onQueryChange:l,datasource:r})}),(0,I.jsx)(Lt,{query:n,onQueryChange:l,datasource:r}),(0,I.jsx)(Ae.EditorField,{label:"Limit",optional:!0,children:(0,I.jsx)(m.I,{id:`${n.refId}-cloudwatch-sql-builder-editor-limit`,value:o.limit,onChange:e=>{const t=e.currentTarget.valueAsNumber;l(At(n,{limit:isNaN(t)?void 0:t}))},type:"number",min:1})})]}),u&&(0,I.jsxs)(Ae.EditorRow,{children:[!1,(0,I.jsx)("pre",{children:null!=u?u:""})]})]})}var _t=n(38465);const $t={id:"cloudwatch-MetricMath",extensions:[],aliases:[],mimetypes:[],loader:()=>Promise.resolve().then(n.bind(n,67929))},Vt={id:"editor.action.triggerSuggest",title:""},Qt=(e,t,n)=>{const{id:r,loader:i}=t;e.languages.getLanguages().find((e=>e.id===r))||(e.languages.register({id:r}),i().then((i=>{e.languages.setMonarchTokensProvider(r,i.language),e.languages.setLanguageConfiguration(r,i.conf),e.languages.registerCompletionItemProvider(r,n.getCompletionProvider(e,t))})))};function Bt(e){let{expression:t,onChange:n,onRunQuery:r,datasource:i}=e;const a=(0,s.useRef)(null),o=(0,s.useCallback)(((e,t)=>{e.onDidFocusEditorText((()=>e.trigger(Vt.id,Vt.id,{}))),e.addCommand(t.KeyMod.Shift|t.KeyCode.Enter,(()=>{const t=e.getValue();n(t),r()}));const i=()=>{const t=a.current;if(null!==t&&e.getContentHeight()<200){const n=Math.max(32,e.getContentHeight());t.style.height=`${n}px`,t.style.width="100%";const r=t.clientWidth;e.layout({width:r,height:n})}};e.onDidContentSizeChange(i),i()}),[n,r]);return(0,I.jsx)("div",{ref:a,children:(0,I.jsx)(_t.p,{monacoOptions:{scrollBeyondLastLine:!1,fontSize:14,lineNumbers:"off",renderLineHighlight:"none",scrollbar:{vertical:"hidden",horizontal:"hidden"},suggestFontSize:12,wordWrap:"on",padding:{top:6}},language:$t.id,value:t,onBlur:e=>{e!==t&&(n(e),r())},onBeforeEditorMount:e=>Qt(e,$t,i.metricMathCompletionItemProvider),onEditorDidMount:o})})}const Wt={id:"cloudwatch-sql",extensions:[".cloudwatchSql"],aliases:["CloudWatch","cloudwatch","CloudWatchSQL"],mimetypes:[],loader:()=>Promise.resolve().then(n.bind(n,1762))},Gt=e=>{let{region:t,sql:n,onChange:r,onRunQuery:i,datasource:a}=e;(0,s.useEffect)((()=>{a.sqlCompletionItemProvider.setRegion(t)}),[t,a]);const o=(0,s.useCallback)(((e,t)=>{e.onDidFocusEditorText((()=>e.trigger(Vt.id,Vt.id,{}))),e.addCommand(t.KeyMod.Shift|t.KeyCode.Enter,(()=>{const t=e.getValue();r(t),i()}))}),[r,i]);return(0,I.jsx)(_t.p,{height:"150px",language:Wt.id,value:n,onBlur:e=>{e!==n&&r(e)},showMiniMap:!1,showLineNumbers:!0,onBeforeEditorMount:e=>Qt(e,Wt,a.sqlCompletionItemProvider),onEditorDidMount:o})};class Ut{constructor(e,t,n,r,i,a){this.type=e,this.value=t,this.range=n,this.previous=r,this.next=i,this.tokenTypes=a}isKeyword(){return this.type===this.tokenTypes.Keyword}isWhiteSpace(){return this.type===this.tokenTypes.Whitespace}isParenthesis(){return this.type===this.tokenTypes.Parenthesis}isIdentifier(){return this.type===this.tokenTypes.Identifier}isString(){return this.type===this.tokenTypes.String}isDoubleQuotedString(){return this.type===this.tokenTypes.Type}isVariable(){return this.type===this.tokenTypes.Variable}isFunction(){return this.type===this.tokenTypes.Function}isNumber(){return this.type===this.tokenTypes.Number}is(e,t){const n=this.type===e;return void 0!==t?n&&this.value===t:n}endsWith(e){return this.value===e||this.value[this.value.length-1]===e}getPreviousNonWhiteSpaceToken(){let e=this.previous;for(;null!=e;){if(!e.isWhiteSpace())return e;e=e.previous}return null}getPreviousOfType(e,t){let n=this.previous;for(;null!=n;){const r=n.type===e;if(void 0!==t?r&&n.value===t:r)return n;n=n.previous}return null}getPreviousUntil(e,t,n){let r=[],i=this.previous;for(;null!=i;){if(t.some((e=>{var t;return e===(null===(t=i)||void 0===t?void 0:t.type)}))){i=i.previous;continue}const a=i.type===e;if(void 0!==n?a&&i.value===n:a)return r;i.isWhiteSpace()||r.push(i),i=i.previous}return r}getNextUntil(e,t,n){let r=[],i=this.next;for(;null!=i;){if(t.some((e=>{var t;return e===(null===(t=i)||void 0===t?void 0:t.type)}))){i=i.next;continue}const a=i.type===e;if(void 0!==n?a&&i.value===n:a)return r;i.isWhiteSpace()||r.push(i),i=i.next}return r}getPreviousKeyword(){let e=this.previous;for(;null!=e;){if(e.isKeyword())return e;e=e.previous}return null}getNextNonWhiteSpaceToken(){let e=this.next;for(;null!=e;){if(!e.isWhiteSpace())return e;e=e.next}return null}getNextOfType(e,t){let n=this.next;for(;null!=n;){const r=n.type===e;if(void 0!==t?r&&n.value===t:r)return n;n=n.next}return null}}function Ht(e,t,n,r,i){var a;let s=null,o=null;const l=e.editor.tokenize(null!==(a=n.getValue())&&void 0!==a?a:"",t.id);for(let a=0;a<l.length;a++){const u=l[a];if(!u.length&&o){const e={offset:0,type:i.Whitespace,language:t.id,_tokenBrand:void 0};u.push(e)}for(let t=0;t<u.length;t++){const l=u[t];let c=u.length>t+1?u[t+1].offset+1:n.getLineLength(a+1)+1;const d={startLineNumber:a+1,startColumn:0===l.offset?0:l.offset+1,endLineNumber:a+1,endColumn:c},p=n.getValueInRange(d),m=new Ut(l.type,p,d,o,null,i);e.Range.containsPosition(d,r)&&(s=m),o&&(o.next=m),o=m}}return s}let zt,Jt,Xt;!function(e){e[e.Unknown=0]="Unknown",e[e.SelectKeyword=1]="SelectKeyword",e[e.AfterSelectKeyword=2]="AfterSelectKeyword",e[e.AfterSelectFuncFirstArgument=3]="AfterSelectFuncFirstArgument",e[e.AfterFromKeyword=4]="AfterFromKeyword",e[e.SchemaFuncFirstArgument=5]="SchemaFuncFirstArgument",e[e.SchemaFuncExtraArgument=6]="SchemaFuncExtraArgument",e[e.FromKeyword=7]="FromKeyword",e[e.AfterFrom=8]="AfterFrom",e[e.WhereKey=9]="WhereKey",e[e.WhereComparisonOperator=10]="WhereComparisonOperator",e[e.WhereValue=11]="WhereValue",e[e.AfterWhereValue=12]="AfterWhereValue",e[e.AfterGroupByKeywords=13]="AfterGroupByKeywords",e[e.AfterGroupBy=14]="AfterGroupBy",e[e.AfterOrderByKeywords=15]="AfterOrderByKeywords",e[e.AfterOrderByFunction=16]="AfterOrderByFunction",e[e.AfterOrderByDirection=17]="AfterOrderByDirection",e[e.PredefinedFunction=18]="PredefinedFunction",e[e.SearchFuncSecondArg=19]="SearchFuncSecondArg",e[e.SearchFuncThirdArg=20]="SearchFuncThirdArg",e[e.PredefinedFuncSecondArg=21]="PredefinedFuncSecondArg",e[e.AfterFunction=22]="AfterFunction",e[e.WithinString=23]="WithinString"}(zt||(zt={})),function(e){e[e.SelectKeyword=0]="SelectKeyword",e[e.FunctionsWithArguments=1]="FunctionsWithArguments",e[e.Metrics=2]="Metrics",e[e.FromKeyword=3]="FromKeyword",e[e.SchemaKeyword=4]="SchemaKeyword",e[e.Namespaces=5]="Namespaces",e[e.LabelKeys=6]="LabelKeys",e[e.WhereKeyword=7]="WhereKeyword",e[e.GroupByKeywords=8]="GroupByKeywords",e[e.OrderByKeywords=9]="OrderByKeywords",e[e.FunctionsWithoutArguments=10]="FunctionsWithoutArguments",e[e.LimitKeyword=11]="LimitKeyword",e[e.SortOrderDirectionKeyword=12]="SortOrderDirectionKeyword",e[e.ComparisonOperators=13]="ComparisonOperators",e[e.LabelValues=14]="LabelValues",e[e.LogicalOperators=15]="LogicalOperators",e[e.KeywordArguments=16]="KeywordArguments",e[e.Operators=17]="Operators",e[e.Statistic=18]="Statistic",e[e.Period=19]="Period"}(Jt||(Jt={})),function(e){e.High="a",e.MediumHigh="d",e.Medium="g",e.MediumLow="k",e.Low="q"}(Xt||(Xt={}));var Yt=n(48284);const Zt={id:"cloudwatch-dynamicLabels",extensions:[],aliases:[],mimetypes:[],loader:()=>Promise.resolve().then(n.bind(n,48284))},en=new class{constructor(){var e,t,n;n=void 0,(t="tokenTypes")in(e=this)?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,this.tokenTypes={Parenthesis:"delimiter.parenthesis.cloudwatch-dynamicLabels",Whitespace:"white.cloudwatch-dynamicLabels",Keyword:"keyword.cloudwatch-dynamicLabels",Delimiter:"delimiter.cloudwatch-dynamicLabels",Operator:"operator.cloudwatch-dynamicLabels",Identifier:"identifier.cloudwatch-dynamicLabels",Type:"type.cloudwatch-dynamicLabels",Function:"predefined.cloudwatch-dynamicLabels",Number:"number.cloudwatch-dynamicLabels",String:"string.cloudwatch-dynamicLabels",Variable:"variable.cloudwatch-dynamicLabels"}}getCompletionProvider(e,t){return{triggerCharacters:[" ","$",",","(","'"],provideCompletionItems:async(n,r)=>{const i=Ht(e,t,n,r,this.tokenTypes),a=(null==i?void 0:i.isWhiteSpace())||(null==i?void 0:i.isParenthesis())||null==i||!i.range?e.Range.fromPositions(r):null==i?void 0:i.range,s=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=Object.assign({label:t,insertText:t,kind:e.languages.CompletionItemKind.Field,range:a,sortText:Xt.Medium},n);return r};let o=[];const l=null==i?void 0:i.next;return null!=i&&i.isFunction()||l&&!l.isWhiteSpace()||(o=Yt.DYNAMIC_LABEL_PATTERNS.map((e=>s(e))),o.push(s("${PROP('Dim.')}",{sortText:Xt.High,insertText:"${PROP('Dim.$0')} ",insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet}))),{suggestions:o}}}}};function tn(e){let{label:t,width:n,onChange:r,onRunQuery:i}=e;const a=(0,M.l4)(),o=(0,m.H)({theme:a,width:n}),l=(0,s.useRef)(null),u=(0,s.useCallback)(((e,t)=>{e.onDidFocusEditorText((()=>e.trigger(Vt.id,Vt.id,{}))),e.addCommand(t.KeyMod.Shift|t.KeyCode.Enter,(()=>{const t=e.getValue();r(t),i()}));const n=l.current;null!==n&&e.layout({width:n.clientWidth,height:n.clientHeight})}),[r,i]);return(0,I.jsx)("div",{ref:l,className:(0,T.cx)(o.wrapper),children:(0,I.jsx)(_t.p,{containerStyles:T.css`
          border: 1px solid ${a.colors.action.disabledBackground};
          &:hover {
            border-color: ${a.components.input.borderColor};
          }
        `,monacoOptions:{scrollBeyondLastLine:!1,fontSize:14,lineNumbers:"off",renderLineHighlight:"none",overviewRulerLanes:0,scrollbar:{vertical:"hidden",horizontal:"hidden"},suggestFontSize:12,padding:{top:6}},language:Zt.id,value:t,onBlur:e=>{e!==t&&(r(e),i())},onBeforeEditorMount:e=>Qt(e,Zt,en),onEditorDidMount:u})})}const nn=e=>{let{value:t="",onChange:n,id:r}=e;const[i,a]=(0,s.useState)(t),o=(0,y.debounce)(n,1500);return n=e=>{a(e.target.value),o(e.target.value)},(0,I.jsx)(m.I,{id:r,type:"text",value:i,onChange:n,"aria-label":"Optional alias"})};var rn=n(10322),an=n.n(rn);function sn(e){const t=function(e){if(je.v.featureToggles.cloudWatchDynamicLabels&&!e.hasOwnProperty("label")){var t,n;const r=/{{\s*(.+?)\s*}}/g;e.label=null!==(t=null===(n=e.alias)||void 0===n?void 0:n.replace(r,((e,t)=>on.hasOwnProperty(t)?`\${${on[t]}}`:`\${PROP('Dim.${t}')}`)))&&void 0!==t?t:""}return e}(e);return t}const on={metric:"PROP('MetricName')",namespace:"PROP('Namespace')",period:"PROP('Period')",region:"PROP('Region')",stat:"PROP('Stat')",label:"LABEL"};const ln={queryMode:"Metrics",namespace:"",metricName:"",expression:"",dimensions:{},region:"default",id:"",statistic:"Average",period:"",metricQueryType:w.$5.Search,metricEditorMode:w.MQ.Builder,sqlExpression:"",matchExact:!0},un=(e,t)=>{const n=(0,s.useMemo)((()=>(e=>{const t=sn(Object.assign({},ln,e));return an()(t,e)?e:t})(e)),[e]);return(0,s.useEffect)((()=>{n!==e&&t(n)}),[n,e,t]),n};var cn,dn;const pn=e=>{var t,n,r,i;const{query:a,onRunQuery:o,datasource:l}=e,[u,c]=(0,s.useState)(!1),d=un(a,e.onChange),p=t=>{const{onChange:n,onRunQuery:r}=e;n(t),r()};return(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(st,{query:a,onRunQuery:o,datasource:l,onChange:e=>{Ee(e)&&e.metricEditorMode!==a.metricEditorMode&&c(!1),p(e)},sqlCodeEditorIsDirty:u}),cn||(cn=(0,I.jsx)(Ae.Space,{v:.5})),a.metricQueryType===w.$5.Search&&(0,I.jsxs)(I.Fragment,{children:[a.metricEditorMode===w.MQ.Builder&&(0,I.jsx)(ht,Object.assign({},e,{refId:a.refId,metricStat:a,onChange:t=>e.onChange(Object.assign({},a,t))})),a.metricEditorMode===w.MQ.Code&&(0,I.jsx)(Bt,{onRunQuery:o,expression:null!==(t=a.expression)&&void 0!==t?t:"",onChange:t=>e.onChange(Object.assign({},a,{expression:t})),datasource:l})]}),a.metricQueryType===w.$5.Query&&(0,I.jsxs)(I.Fragment,{children:[a.metricEditorMode===w.MQ.Code&&(0,I.jsx)(Gt,{region:a.region,sql:null!==(n=a.sqlExpression)&&void 0!==n?n:"",onChange:t=>{u||c(!0),e.onChange(Object.assign({},d,{sqlExpression:t}))},onRunQuery:o,datasource:l}),a.metricEditorMode===w.MQ.Builder&&(0,I.jsx)(I.Fragment,{children:(0,I.jsx)(Kt,{query:a,onChange:e.onChange,onRunQuery:o,datasource:l})})]}),dn||(dn=(0,I.jsx)(Ae.Space,{v:.5})),(0,I.jsxs)(Ae.EditorRow,{children:[(0,I.jsx)(Ae.EditorField,{label:"ID",width:26,optional:!0,tooltip:"ID can be used to reference other queries in math expressions. The ID can include numbers, letters, and underscore, and must start with a lowercase letter.",invalid:!!a.id&&!/^$|^[a-z][a-zA-Z0-9_]*$/.test(a.id),children:(0,I.jsx)(m.I,{id:`${a.refId}-cloudwatch-metric-query-editor-id`,onBlur:o,onChange:e=>p(Object.assign({},d,{id:e.target.value})),type:"text",value:a.id})}),(0,I.jsx)(Ae.EditorField,{label:"Period",width:26,tooltip:"Minimum interval between points in seconds.",children:(0,I.jsx)(m.I,{id:`${a.refId}-cloudwatch-metric-query-editor-period`,value:a.period||"",placeholder:"auto",onBlur:o,onChange:e=>p(Object.assign({},d,{period:e.target.value}))})}),je.v.featureToggles.cloudWatchDynamicLabels?(0,I.jsx)(Ae.EditorField,{label:"Label",width:26,optional:!0,tooltip:"Change time series legend name using Dynamic labels. See documentation for details.",children:(0,I.jsx)(tn,{width:52,onRunQuery:o,label:null!==(r=d.label)&&void 0!==r?r:"",onChange:t=>e.onChange(Object.assign({},a,{label:t}))})}):(0,I.jsx)(Ae.EditorField,{label:"Alias",width:26,optional:!0,tooltip:"Change time series legend name using this field. See documentation for replacement variable formats.",children:(0,I.jsx)(nn,{id:`${a.refId}-cloudwatch-metric-query-editor-alias`,value:null!==(i=d.alias)&&void 0!==i?i:"",onChange:e=>p(Object.assign({},d,{alias:e}))})})]})]})};class mn extends s.PureComponent{render(){const{query:e}=this.props;return(0,I.jsxs)(I.Fragment,{children:[Ee(e)&&(0,I.jsx)(pn,Object.assign({},this.props,{query:e})),Ce(e)&&(0,I.jsx)(pt,Object.assign({},this.props,{query:e}))]})}}var hn,gn,fn=n(71808),vn=n(3321),yn=n(5937),bn=n(13924),xn=n(75478);const wn={prepareAnnotation:e=>(e=>{var t;return"Annotations"===(null===(t=e.target)||void 0===t?void 0:t.queryMode)})(e)?e:{datasource:e.datasource,enable:e.enable,iconColor:e.iconColor,name:e.name,builtIn:e.builtIn,hide:e.hide,target:Object.assign({},e.target,e,{statistic:e.statistic||"Average",region:e.region||"default",queryMode:"Annotations",refId:e.refId||"annotationQuery"})},prepareQuery:e=>{if(!e.target)return;const{prefixMatching:t,actionPrefix:n,alarmNamePrefix:r,statistic:i,namespace:a,metricName:s,dimensions:o={}}=e.target,l=!!t&&!!n&&!!r,u=!(t||!a||!s||!i||!Object.values(o).length);return l||u?e.target:void 0},QueryEditor:e=>{const{query:t,onChange:n,datasource:r}=e,[i,a]=He(r);return Ie(t)?(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(Ae.EditorHeader,{children:(0,I.jsx)(Ae.InlineSelect,{label:"Region",value:i.find((e=>e.value===t.region)),placeholder:"Select region",allowCustomValue:!0,onChange:e=>{let{value:r}=e;return r&&n(Object.assign({},t,{region:r}))},options:i,isLoading:a})}),hn||(hn=(0,I.jsx)(Ae.Space,{v:.5})),(0,I.jsx)(ht,Object.assign({},e,{refId:t.refId,metricStat:t,disableExpressions:!0,onChange:e=>n(Object.assign({},t,e)),onRunQuery:()=>{}})),gn||(gn=(0,I.jsx)(Ae.Space,{v:.5})),(0,I.jsxs)(Ae.EditorRow,{children:[(0,I.jsx)(Ae.EditorField,{label:"Period",width:26,tooltip:"Minimum interval between points in seconds.",children:(0,I.jsx)(m.I,{value:t.period||"",placeholder:"auto",onChange:e=>n(Object.assign({},t,{period:e.target.value}))})}),(0,I.jsx)(Ae.EditorField,{label:"Enable Prefix Matching",optional:!0,children:(0,I.jsx)(Ae.EditorSwitch,{value:t.prefixMatching,onChange:e=>{n(Object.assign({},t,{prefixMatching:e.currentTarget.checked}))}})}),(0,I.jsx)(Ae.EditorField,{label:"Action",optional:!0,disabled:!t.prefixMatching,children:(0,I.jsx)(m.I,{value:t.actionPrefix||"",onChange:e=>n(Object.assign({},t,{actionPrefix:e.target.value}))})}),(0,I.jsx)(Ae.EditorField,{label:"Alarm Name",optional:!0,disabled:!t.prefixMatching,children:(0,I.jsx)(m.I,{value:t.alarmNamePrefix||"",onChange:e=>n(Object.assign({},t,{alarmNamePrefix:e.target.value}))})})]})]}):(0,I.jsx)(F.b,{severity:"error",title:"Invalid annotation query",topSpacing:2,children:JSON.stringify(t,null,4)})}};var Sn=n(35778),Cn=n(47570);const En=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7e3;const n=(0,y.memoize)((function(){return(0,y.debounce)(e,t,{leading:!0})}),(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return JSON.stringify(t)}));return function(){return n(...arguments)(...arguments)}};function In(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class An{constructor(e,t){In(this,"templateSrv",void 0),In(this,"ref",void 0),In(this,"dsQueryEndpoint","/api/ds/query"),In(this,"debouncedCustomAlert",En(jn,Cn.bd.Error)),this.instanceSettings=e,this.templateSrv=t,this.ref=(0,u.iU)(e)}awsRequest(e,t){const n={method:"POST",url:e,data:t,headers:arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}};return(0,d.i)().fetch(n).pipe((0,Sn.U)((e=>e.data)))}convertDimensionFormat(e,t){return Object.entries(e).reduce(((e,n)=>{let[r,i]=n;if(r=this.replaceVariableAndDisplayWarningIfMulti(r,t,!0,"dimension keys"),Array.isArray(i))return Object.assign({},e,{[r]:i});if(!i)return Object.assign({},e,{[r]:null});const a=this.expandVariableToArray(i,t);return Object.assign({},e,{[r]:a})}),{})}expandVariableToArray(e,t){const n=this.templateSrv.getVariableName(e),r=this.templateSrv.getVariables().find((e=>{let{name:t}=e;return t===n}));if(n&&r){return("custom"===(null==r?void 0:r.type)||"query"===(null==r?void 0:r.type)||"datasource"===(null==r?void 0:r.type))&&r.multi?this.templateSrv.replace(e,t,"pipe").split("|"):[this.templateSrv.replace(e,t)]}return[e]}convertMultiFilterFormat(e,t){return Object.entries(e).reduce(((e,n)=>{let[r,i]=n;const a=this.replaceVariableAndDisplayWarningIfMulti(r,{},!0,t);if(!i)return Object.assign({},e,{[a]:null});const s=i.reduce(((e,t)=>[...e,...this.expandVariableToArray(t,{})]),[]);return Object.assign({},e,{[a]:s})}),{})}replaceVariableAndDisplayWarningIfMulti(e,t,n,r){if(n&&e){const t=this.templateSrv.getVariables().find((t=>{let{name:n}=t;return n===this.templateSrv.getVariableName(e)}));("custom"===(null==t?void 0:t.type)||"query"===(null==t?void 0:t.type)||"datasource"===(null==t?void 0:t.type))&&t.multi&&this.debouncedCustomAlert("CloudWatch templating error",`Multi template variables are not supported for ${r||e}`)}return this.templateSrv.replace(e,t)}getActualRegion(e){var t;return"default"===e||void 0===e||""===e?null!==(t=this.instanceSettings.jsonData.defaultRegion)&&void 0!==t?t:"":e}}const jn=(e,t)=>v.h.dispatch((0,h.$l)((0,g.t_)(e,t)));class Rn extends An{constructor(e,t){super(e,t)}resourceRequest(e,t){return(0,d.i)().get(`/api/datasources/${this.instanceSettings.id}/resources/${e}`,t)}getRegions(){return this.resourceRequest("regions").then((e=>[{label:"default",value:"default",text:"default"},...e.filter((e=>e.value))]))}getNamespaces(){return this.resourceRequest("namespaces")}async describeLogGroups(e){return this.resourceRequest("log-groups",Object.assign({},e,{region:this.templateSrv.replace(this.getActualRegion(e.region))}))}async describeAllLogGroups(e){return this.resourceRequest("all-log-groups",Object.assign({},e,{region:this.templateSrv.replace(this.getActualRegion(e.region))}))}async getMetrics(e,t){return e?this.resourceRequest("metrics",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e)}):[]}async getAllMetrics(e){return(await this.resourceRequest("all-metrics",{region:this.templateSrv.replace(this.getActualRegion(e))})).map((e=>({metricName:e.value,namespace:e.text})))}async getDimensionKeys(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return e?this.resourceRequest("dimension-keys",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e),dimensionFilters:JSON.stringify(this.convertDimensionFormat(n,{})),metricName:r}):[]}async getDimensionValues(e,t,n,r,i){if(!t||!n)return[];return await this.resourceRequest("dimension-values",{region:this.templateSrv.replace(this.getActualRegion(e)),namespace:this.templateSrv.replace(t),metricName:this.templateSrv.replace(n.trim()),dimensionKey:this.templateSrv.replace(r),dimensions:JSON.stringify(this.convertDimensionFormat(i,{}))})}getEbsVolumeIds(e,t){return this.resourceRequest("ebs-volume-ids",{region:this.templateSrv.replace(this.getActualRegion(e)),instanceId:this.templateSrv.replace(t)})}getEc2InstanceAttribute(e,t,n){return this.resourceRequest("ec2-instance-attribute",{region:this.templateSrv.replace(this.getActualRegion(e)),attributeName:this.templateSrv.replace(t),filters:JSON.stringify(this.convertMultiFilterFormat(n,"filter key"))})}getResourceARNs(e,t,n){return this.resourceRequest("resource-arns",{region:this.templateSrv.replace(this.getActualRegion(e)),resourceType:this.templateSrv.replace(t),tags:JSON.stringify(this.convertMultiFilterFormat(n,"tag name"))})}}var Tn=n(93921);function On(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Mn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,Tn.J)();On(this,"api",void 0),On(this,"templateSrv",void 0),On(this,"tokenTypes",void 0),this.api=e,this.templateSrv=t,this.templateSrv=t,this.tokenTypes={Parenthesis:"delimiter.parenthesis",Whitespace:"white",Keyword:"keyword",Delimiter:"delimiter",Operator:"operator",Identifier:"identifier",Type:"type",Function:"predefined",Number:"number",String:"string",Variable:"variable"}}getStatementPosition(e){return zt.Unknown}getSuggestionKinds(e){return[]}getSuggestions(e,t,n,r,i){return Promise.reject([])}getCompletionProvider(e,t){return{triggerCharacters:[" ","$",",","(","'"],provideCompletionItems:async(n,r)=>{const i=Ht(e,t,n,r,this.tokenTypes),a=this.getStatementPosition(i),s=this.getSuggestionKinds(a);return{suggestions:await this.getSuggestions(e,i,s,a,r)}}}}}const Fn={Parenthesis:"delimiter.parenthesis.sql",Whitespace:"white.sql",Keyword:"keyword.sql",Delimiter:"delimiter.sql",Operator:"operator.sql",Identifier:"identifier.sql",Type:"type.sql",Function:"predefined.sql",Number:"number.sql",String:"string.sql",Variable:"variable.sql"};function Dn(e){var t,n,r,i,a,s;const o=null==e?void 0:e.getPreviousNonWhiteSpaceToken(),l=null==e?void 0:e.getPreviousKeyword(),u=null==e||null===(t=e.getPreviousNonWhiteSpaceToken())||void 0===t?void 0:t.is(Fn.Operator,"/");return null===e||e.isWhiteSpace()&&null===e.previous||e.is(Fn.Keyword,bt.SELECT)&&null===e.previous||u||e.isIdentifier()&&(u||null===(null==e?void 0:e.previous))?zt.SelectKeyword:(null==o?void 0:o.value)===bt.SELECT?zt.AfterSelectKeyword:(null!=o&&o.is(Fn.Parenthesis,"(")||null!=e&&e.is(Fn.Parenthesis,"()"))&&(null==l?void 0:l.value)===bt.SELECT?zt.AfterSelectFuncFirstArgument:(null==l?void 0:l.value)===bt.SELECT&&null!=o&&o.isParenthesis()?zt.FromKeyword:(null==o?void 0:o.value)===bt.FROM?zt.AfterFromKeyword:(null!=o&&o.is(Fn.Parenthesis,"(")||null!=e&&e.is(Fn.Parenthesis,"()"))&&(null==l?void 0:l.value)===bt.SCHEMA?zt.SchemaFuncFirstArgument:(null==l?void 0:l.value)===bt.SCHEMA&&null!=o&&o.is(Fn.Delimiter,",")?zt.SchemaFuncExtraArgument:(null==l?void 0:l.value)===bt.FROM&&null!=o&&o.isDoubleQuotedString()||(null==l?void 0:l.value)===bt.FROM&&null!=o&&o.isVariable()||(null==l?void 0:l.value)===bt.SCHEMA&&null!=o&&o.is(Fn.Parenthesis,")")?zt.AfterFrom:(null==l?void 0:l.value)===bt.WHERE&&(null!=o&&o.isKeyword()||null!=o&&o.is(Fn.Parenthesis,"(")||null!=o&&o.is(Fn.Operator,bt.AND))?zt.WhereKey:(null==l?void 0:l.value)===bt.WHERE&&(null!=o&&o.isIdentifier()||null!=o&&o.isDoubleQuotedString())?zt.WhereComparisonOperator:(null==l?void 0:l.value)===bt.WHERE&&(null!=o&&o.is(Fn.Operator,bt.EQUALS)||null!=o&&o.is(Fn.Operator,bt.NOT_EQUALS))?zt.WhereValue:(null==l?void 0:l.value)===bt.WHERE&&(null!=o&&o.isString()||null!=o&&o.is(Fn.Parenthesis,")"))?zt.AfterWhereValue:null!=l&&l.is(Fn.Keyword,bt.BY)&&null!=l&&null!==(n=l.getPreviousKeyword())&&void 0!==n&&n.is(Fn.Keyword,bt.GROUP)&&(null!=o&&o.is(Fn.Keyword,bt.BY)||null!=o&&o.is(Fn.Delimiter,","))?zt.AfterGroupByKeywords:null!=l&&l.is(Fn.Keyword,bt.BY)&&null!=l&&null!==(r=l.getPreviousKeyword())&&void 0!==r&&r.is(Fn.Keyword,bt.GROUP)&&(null!=o&&o.isIdentifier()||null!=o&&o.isDoubleQuotedString())?zt.AfterGroupBy:null!=o&&o.is(Fn.Keyword,bt.BY)&&null!=o&&null!==(i=o.getPreviousKeyword())&&void 0!==i&&i.is(Fn.Keyword,bt.ORDER)?zt.AfterOrderByKeywords:null!=l&&l.is(Fn.Keyword,bt.BY)&&null!=l&&null!==(a=l.getPreviousKeyword())&&void 0!==a&&a.is(Fn.Keyword,bt.ORDER)&&null!=o&&o.is(Fn.Parenthesis)&&null!=o&&null!==(s=o.getPreviousNonWhiteSpaceToken())&&void 0!==s&&s.is(Fn.Function)?zt.AfterOrderByFunction:null!=l&&l.is(Fn.Keyword,bt.DESC)||null!=l&&l.is(Fn.Keyword,bt.ASC)?zt.AfterOrderByDirection:zt.Unknown}function kn(e){switch(e){case zt.SelectKeyword:return[Jt.SelectKeyword];case zt.AfterSelectKeyword:return[Jt.FunctionsWithArguments];case zt.AfterSelectFuncFirstArgument:return[Jt.Metrics];case zt.AfterFromKeyword:return[Jt.Namespaces,Jt.SchemaKeyword];case zt.SchemaFuncFirstArgument:return[Jt.Namespaces];case zt.SchemaFuncExtraArgument:return[Jt.LabelKeys];case zt.FromKeyword:return[Jt.FromKeyword];case zt.AfterFrom:return[Jt.WhereKeyword,Jt.GroupByKeywords,Jt.OrderByKeywords,Jt.LimitKeyword];case zt.WhereKey:return[Jt.LabelKeys];case zt.WhereComparisonOperator:return[Jt.ComparisonOperators];case zt.WhereValue:return[Jt.LabelValues];case zt.AfterWhereValue:return[Jt.LogicalOperators,Jt.GroupByKeywords,Jt.OrderByKeywords,Jt.LimitKeyword];case zt.AfterGroupByKeywords:return[Jt.LabelKeys];case zt.AfterGroupBy:return[Jt.OrderByKeywords,Jt.LimitKeyword];case zt.AfterOrderByKeywords:return[Jt.FunctionsWithoutArguments];case zt.AfterOrderByFunction:return[Jt.SortOrderDirectionKeyword,Jt.LimitKeyword];case zt.AfterOrderByDirection:return[Jt.LimitKeyword]}return[]}const qn=e=>{var t;return null!==(t=null==e?void 0:e.getPreviousOfType(Fn.Keyword,bt.SELECT))&&void 0!==t?t:null},Pn=e=>{var t,n;const r=null===(t=(e=>{var t;const n=null===(t=qn(e))||void 0===t?void 0:t.getNextNonWhiteSpaceToken();return null!=n&&n.isVariable()||null!=n&&n.isFunction()?n:null})(e))||void 0===t||null===(n=t.next)||void 0===n?void 0:n.next;return null!=r&&r.isVariable()||null!=r&&r.isIdentifier()?r:null},Nn=e=>{var t;const n=(e=>{const t=qn(e);return null==t?void 0:t.getNextOfType(Fn.Keyword,bt.FROM)})(e),r=null==n?void 0:n.getNextNonWhiteSpaceToken();if(null!=r&&r.isDoubleQuotedString()||null!=r&&r.isVariable()&&(null==r?void 0:r.value.toUpperCase())!==bt.SCHEMA)return r;if(null!=r&&r.isKeyword()&&null!==(t=r.next)&&void 0!==t&&t.is(Fn.Parenthesis,"(")){var i;const e=null===(i=r.next)||void 0===i?void 0:i.next;if(null!=e&&e.isDoubleQuotedString()||null!=e&&e.isVariable())return e}return null};class Ln extends Mn{constructor(e){var t;var n,r,i;super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,Tn.J)()),i=void 0,(r="region")in(n=this)?Object.defineProperty(n,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[r]=i,this.region=null!==(t=e.getActualRegion())&&void 0!==t?t:"",this.getStatementPosition=Dn,this.getSuggestionKinds=kn,this.tokenTypes=Fn}setRegion(e){this.region=e}async getSuggestions(e,t,n,r,i){let a=[];const s=(null==t?void 0:t.isWhiteSpace())||(null==t?void 0:t.isParenthesis())||null==t||!t.range?e.Range.fromPositions(i):null==t?void 0:t.range,o=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=Object.assign({label:t,insertText:t,kind:e.languages.CompletionItemKind.Field,range:s,sortText:Xt.Medium},n);return r};function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};a=[...a,o(e,t)]}for(const i of n)switch(i){case Jt.SelectKeyword:l(bt.SELECT,{insertText:`${bt.SELECT} $0`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,kind:e.languages.CompletionItemKind.Keyword,command:Vt});break;case Jt.FunctionsWithArguments:bt.STATISTICS.map((t=>l(t,{insertText:`${t}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:Vt,kind:e.languages.CompletionItemKind.Function})));break;case Jt.FunctionsWithoutArguments:bt.STATISTICS.map((t=>l(t,{insertText:`${t}() `,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:Vt,kind:e.languages.CompletionItemKind.Function})));break;case Jt.Metrics:{const e=Nn(t);if(null!=e&&e.value){(await this.api.getMetrics(this.templateSrv.replace(null==e?void 0:e.value.replace(/\"/g,"")),this.templateSrv.replace(this.region))).forEach((e=>e.value&&l(e.value)))}else{const e=await this.api.getAllMetrics(this.templateSrv.replace(this.region));(0,y.uniq)(e.map((e=>e.metricName))).forEach((e=>e&&l(e,{insertText:e})))}}break;case Jt.FromKeyword:l(bt.FROM,{insertText:`${bt.FROM} `,command:Vt});break;case Jt.SchemaKeyword:l(bt.SCHEMA,{sortText:Xt.High,insertText:`${bt.SCHEMA}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:Vt,kind:e.languages.CompletionItemKind.Function});break;case Jt.Namespaces:const n=Pn(t);let i=[];if(null!=n&&n.value){const e=await this.api.getAllMetrics(this.region),t=this.templateSrv.replace(n.value);i=e.filter((e=>e.metricName===t)).map((e=>e.namespace))}else{i=(await this.api.getNamespaces()).map((e=>e.value))}i.map((e=>l(`"${e}"`,{insertText:`"${e}"`})));break;case Jt.LabelKeys:{const e=Pn(t),n=Nn(t);if(null!=n&&n.value){var u;let i,a={};r===zt.SchemaFuncExtraArgument?i=null==n?void 0:n.getNextUntil(this.tokenTypes.Parenthesis,[this.tokenTypes.Delimiter,this.tokenTypes.Whitespace]):r===zt.AfterGroupByKeywords&&(i=null==t?void 0:t.getPreviousUntil(this.tokenTypes.Keyword,[this.tokenTypes.Delimiter,this.tokenTypes.Whitespace])),a=(i||[]).reduce(((e,t)=>Object.assign({},e,{[t.value]:null})),{});(await this.api.getDimensionKeys(this.templateSrv.replace(n.value.replace(/\"/g,"")),this.templateSrv.replace(this.region),a,null!==(u=null==e?void 0:e.value)&&void 0!==u?u:"")).map((e=>{var t;const n=/[\s\.-]/.test(null!==(t=e.value)&&void 0!==t?t:"")?`"${e.value}"`:e.value;n&&l(n)}))}}break;case Jt.LabelValues:{var c;const e=Nn(t),n=Pn(t),r=null==t||null===(c=t.getPreviousNonWhiteSpaceToken())||void 0===c?void 0:c.getPreviousNonWhiteSpaceToken();if(null!=e&&e.value&&null!=r&&r.value&&null!=n&&n.value){(await this.api.getDimensionValues(this.templateSrv.replace(this.region),this.templateSrv.replace(e.value.replace(/\"/g,"")),this.templateSrv.replace(n.value),this.templateSrv.replace(r.value),{})).map((e=>l(`'${e.value}'`,{insertText:`'${e.value}' `,command:Vt})))}}break;case Jt.LogicalOperators:bt.LOGICAL_OPERATORS.map((e=>l(`${e}`,{insertText:`${e} `,command:Vt,sortText:Xt.MediumHigh})));break;case Jt.WhereKeyword:l(`${bt.WHERE}`,{insertText:`${bt.WHERE} `,command:Vt,sortText:Xt.High});break;case Jt.ComparisonOperators:bt.COMPARISON_OPERATORS.map((e=>l(`${e}`,{insertText:`${e} `,command:Vt})));break;case Jt.GroupByKeywords:l(`${bt.GROUP} ${bt.BY}`,{insertText:`${bt.GROUP} ${bt.BY} `,command:Vt,sortText:Xt.MediumHigh});break;case Jt.OrderByKeywords:l(`${bt.ORDER} ${bt.BY}`,{insertText:`${bt.ORDER} ${bt.BY} `,command:Vt,sortText:Xt.Medium});break;case Jt.LimitKeyword:l(bt.LIMIT,{insertText:`${bt.LIMIT} `,sortText:Xt.MediumLow});break;case Jt.SortOrderDirectionKeyword:[bt.ASC,bt.DESC].map((e=>l(e,{insertText:`${e} `,command:Vt})))}return this.templateSrv.getVariables().map((t=>{const n=`$${t.name}`;l(n,{range:s,label:n,insertText:n,kind:e.languages.CompletionItemKind.Variable,sortText:Xt.Low})})),a}}var Kn=n(58799),_n=n(39405);function $n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Vn extends r.iL{constructor(e,t){super(),$n(this,"started",!1),$n(this,"datasource",void 0),$n(this,"cleanText",(e=>e.replace(/[()]/g,"").trim())),$n(this,"request",((e,t)=>(0,Kn.n)(this.datasource.logsQueryRunner.awsRequest(e,t)))),$n(this,"start",(()=>(this.startTask||(this.startTask=Promise.resolve().then((()=>(this.started=!0,[])))),this.startTask))),$n(this,"fetchedFieldsCache",void 0),$n(this,"fetchFields",(async(e,t)=>{if(this.fetchedFieldsCache&&Date.now()-this.fetchedFieldsCache.time<3e4&&(0,y.sortedUniq)(this.fetchedFieldsCache.logGroups).join("|")===(0,y.sortedUniq)(e).join("|"))return this.fetchedFieldsCache.fields;const n=await Promise.all(e.map((e=>this.datasource.logsQueryRunner.getLogGroupFields({logGroupName:e,region:t})))),r=[...new Set(n.reduce(((e,t)=>{var n;return e.concat(null===(n=t.logGroupFields)||void 0===n?void 0:n.map((e=>e.name)))}),[])).values()];return this.fetchedFieldsCache={time:Date.now(),logGroups:e,fields:r},r})),$n(this,"handleKeyword",(async e=>{var t;const n=await this.getFieldCompletionItems(null!==(t=null==e?void 0:e.logGroupNames)&&void 0!==t?t:[],(null==e?void 0:e.region)||"default"),r=[{searchFunctionType:_n.Z.Prefix,label:"Functions",items:oe.concat(le,ue)}];return n.suggestions.push(...r),n})),$n(this,"handleCommand",(async(e,t,n)=>{var r;const i=e.content.toLowerCase(),a=Qn(t),s=a===e;if("sort"===i)return this.handleSortCommand(s,t,n);var o;if("parse"===i&&s)return await this.getFieldCompletionItems(null!==(o=null==n?void 0:n.logGroupNames)&&void 0!==o?o:[],(null==n?void 0:n.region)||"default");const l=Wn(e.next,"whitespace")&&!(null!==(r=e.next)&&void 0!==r&&r.next),u=l||function(e){let t=e;for(;t.next;){if(!t.next.types.includes("whitespace"))return t.next;t=t.next}return null}(e)===t,c=Wn(t,"punctuation",","),d=c||Wn(a,"punctuation",",");if(!u&&!d)return{suggestions:[]};if(["display","fields"].includes(i)){var p;const e=await this.getFieldCompletionItems(null!==(p=null==n?void 0:n.logGroupNames)&&void 0!==p?p:[],(null==n?void 0:n.region)||"default");return e.suggestions.push(...this.getFieldAndFilterFunctionCompletionItems().suggestions),e}if("stats"===i){const e=this.getStatsAggCompletionItems();return(c||l)&&(null==e||e.suggestions.forEach((e=>{e.skipFilter=!0}))),e}if("filter"===i&&s){var m;const e=await this.getFieldCompletionItems(null!==(m=null==n?void 0:n.logGroupNames)&&void 0!==m?m:[],(null==n?void 0:n.region)||"default"),t=this.getBoolFuncCompletionItems();return e.suggestions.push(...t.suggestions),e}return{suggestions:[]}})),$n(this,"handleComparison",(async e=>{var t;const n=await this.getFieldCompletionItems(null!==(t=null==e?void 0:e.logGroupNames)&&void 0!==t?t:[],(null==e?void 0:e.region)||"default"),r=this.getComparisonCompletionItems();return n.suggestions.push(...r.suggestions),n})),$n(this,"getCommandCompletionItems",(()=>({suggestions:[{searchFunctionType:_n.Z.Prefix,label:"Commands",items:ae}]}))),$n(this,"getFieldAndFilterFunctionCompletionItems",(()=>({suggestions:[{searchFunctionType:_n.Z.Prefix,label:"Functions",items:me}]}))),$n(this,"getStatsAggCompletionItems",(()=>({suggestions:[{searchFunctionType:_n.Z.Prefix,label:"Functions",items:de}]}))),$n(this,"getBoolFuncCompletionItems",(()=>({suggestions:[{searchFunctionType:_n.Z.Prefix,label:"Functions",items:ce}]}))),$n(this,"getComparisonCompletionItems",(()=>({suggestions:[{searchFunctionType:_n.Z.Prefix,label:"Functions",items:se.concat(ce)}]}))),$n(this,"getFieldCompletionItems",(async(e,t)=>({suggestions:[{label:"Fields",items:(await this.fetchFields(e,t)).map((e=>({label:e,insertText:e.match(/@?[_a-zA-Z]+[_.0-9a-zA-Z]*/)?void 0:`\`${e}\``})))}]}))),this.datasource=e,Object.assign(this,t)}getSyntax(){return ge}isStatsQuery(e){var t;const n=this.getSyntax();return!!(null!==(t=re().tokenize(e,n))&&void 0!==t?t:[]).find((e=>"string"!=typeof e&&"stats"===e.content.toString().toLowerCase()&&"query-command"===e.type))}async provideCompletionItems(e,t){const{value:n}=e,r=null==n?void 0:n.data.get("tokens");if(!r||!r.length)return{suggestions:[]};const i=r.filter((e=>{var t,r,i,a;return e.offsets.start<=(null===(t=n.selection)||void 0===t||null===(r=t.start)||void 0===r?void 0:r.offset)&&e.offsets.end>=(null===(i=n.selection)||void 0===i||null===(a=i.start)||void 0===a?void 0:a.offset)}))[0],a=!i.prev,s=Qn(i);if(a||!a&&(null==s?void 0:s.types.includes("command-separator")))return this.getCommandCompletionItems();var o;if(function(e){const t=Qn(e);if(!t)return!1;const n="("===e.content?e:"("===t.content?t:void 0;if(n){const e=Qn(n);if(e)return Bn.includes(e.content.toLowerCase())&&e.types.includes("function")}return!1}(i))return await this.getFieldCompletionItems(null!==(o=null==t?void 0:t.logGroupNames)&&void 0!==o?o:[],(null==t?void 0:t.region)||"default");if(function(e,t){const n=Gn(t,["whitespace","function","punctuation","field-name","number"]);if(Wn(n,"keyword","by")){const e=Gn(t,["whitespace"]);if(e===n||Wn(e,"punctuation",","))return!0}return!1}(0,i))return this.handleKeyword(t);if(null!=s&&s.types.includes("comparison-operator"))return this.handleComparison(t);const l=function(e){let t=e;for(;t.prev;)if(t=t.prev,t.types.includes("query-command")&&(!t.prev||Wn(Qn(t),"command-separator")))return t;return null}(i);return l?await this.handleCommand(l,i,t):{suggestions:[]}}async handleSortCommand(e,t,n){var r;return e?await this.getFieldCompletionItems(null!==(r=null==n?void 0:n.logGroupNames)&&void 0!==r?r:[],(null==n?void 0:n.region)||"default"):Wn(Qn(t),"field-name")?{suggestions:[{searchFunctionType:_n.Z.Prefix,label:"Sort Order",items:[{label:"asc"},{label:"desc"}]}]}:{suggestions:[]}}}function Qn(e){let t=e;for(;t.prev;){if(!Wn(t.prev,"whitespace"))return t.prev;t=t.prev}return null}const Bn=["avg","count","count_distinct","earliest","latest","sortsFirst","sortsLast","max","min","pct","stddev","ispresent","fromMillis","toMillis","isempty","isblank","isValidIp","isValidIpV4","isValidIpV6","isIpInSubnet","isIpv4InSubnet","isIpv6InSubnet"].map((e=>e.toLowerCase()));function Wn(e,t,n){return!(null==e||!e.types.includes(t))&&(!n||(null==e?void 0:e.content.toLowerCase())===n)}function Gn(e,t){let n=e.prev;e:for(;n;){for(const e of t)if("string"==typeof e){if(n.types.includes(e)){n=n.prev;continue e}}else if(n.types.includes(e.type)&&n.content.toLowerCase()===e.value){n=n.prev;continue e}break}return n}var Un=n(67929);const Hn={Parenthesis:"delimiter.parenthesis.cloudwatch-MetricMath",Whitespace:"white.cloudwatch-MetricMath",Keyword:"keyword.cloudwatch-MetricMath",Delimiter:"delimiter.cloudwatch-MetricMath",Operator:"operator.cloudwatch-MetricMath",Identifier:"identifier.cloudwatch-MetricMath",Type:"type.cloudwatch-MetricMath",Function:"predefined.cloudwatch-MetricMath",Number:"number.cloudwatch-MetricMath",String:"string.cloudwatch-MetricMath",Variable:"variable.cloudwatch-MetricMath"};function zn(e){const t=null==e?void 0:e.getPreviousNonWhiteSpaceToken();if(e&&e.isString())return zt.WithinString;if(e&&t){const n=e.getPreviousOfType(Hn.Function),r=t.is(Hn.Delimiter,","),i=n&&"SEARCH"===n.value,a=e.getPreviousUntil(Hn.Function,[],"SEARCH")||[];if(i){if(1===a.filter((e=>{let{value:t}=e;return"'"===t})).length)return zt.WithinString;const e=t.getPreviousOfType(Hn.Delimiter,",");if(e){if(e.range.startColumn>n.range.startColumn&&e.range.startLineNumber>=n.range.startLineNumber)return zt.SearchFuncThirdArg}return zt.SearchFuncSecondArg}if(!i&&r)return zt.PredefinedFuncSecondArg}return null!=t&&t.endsWith(")")?zt.AfterFunction:e&&e.isString()?zt.Unknown:zt.PredefinedFunction}function Jn(e){switch(e){case zt.PredefinedFunction:return[Jt.FunctionsWithArguments];case zt.PredefinedFuncSecondArg:return[Jt.FunctionsWithArguments,Jt.KeywordArguments];case zt.AfterFunction:return[Jt.Operators];case zt.SearchFuncSecondArg:return[Jt.Statistic];case zt.SearchFuncThirdArg:return[Jt.Period]}return[]}class Xn extends Mn{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,Tn.J)()),this.getStatementPosition=zn,this.getSuggestionKinds=Jn,this.tokenTypes=Hn}async getSuggestions(e,t,n,r,i){let a=[];const s=(null==t?void 0:t.isWhiteSpace())||(null==t?void 0:t.isParenthesis())||null==t||!t.range?e.Range.fromPositions(i):null==t?void 0:t.range,o=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=Object.assign({label:t,insertText:t,kind:e.languages.CompletionItemKind.Field,range:s,sortText:Xt.Medium},n);return r};function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};a=[...a,o(e,t)]}for(const t of n)switch(t){case Jt.FunctionsWithArguments:Un.METRIC_MATH_FNS.map((t=>l(t,{insertText:"SEARCH"===t?`${t}('$0')`:`${t}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:Vt,kind:e.languages.CompletionItemKind.Function})));break;case Jt.KeywordArguments:Un.METRIC_MATH_KEYWORDS.map((t=>l(t,{insertText:t,command:Vt,kind:e.languages.CompletionItemKind.Keyword,sortText:Xt.MediumHigh})));break;case Jt.Statistic:Un.METRIC_MATH_STATISTIC_KEYWORD_STRINGS.map((e=>l(e,{insertText:`'${e}', `,command:Vt})));break;case Jt.Operators:Un.METRIC_MATH_OPERATORS.map((e=>l(e,{insertText:`${e} `,command:Vt})));break;case Jt.Period:Un.METRIC_MATH_PERIODS.map(((t,n)=>l(t.toString(),{kind:e.languages.CompletionItemKind.Value,sortText:String.fromCharCode(97+n)})))}return this.templateSrv.getVariables().map((t=>{const n=`$${t.name}`;l(n,{range:s,label:n,insertText:n,kind:e.languages.CompletionItemKind.Variable,sortText:Xt.Low})})),a}}var Yn=n(45753);class Zn extends An{constructor(e,t){super(e,t)}handleAnnotationQuery(e,t){return this.awsRequest(this.dsQueryEndpoint,{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:e.map((e=>{var t,n,r,i;return Object.assign({},e,{statistic:this.templateSrv.replace(e.statistic),region:this.templateSrv.replace(this.getActualRegion(e.region)),namespace:this.templateSrv.replace(e.namespace),metricName:this.templateSrv.replace(e.metricName),dimensions:this.convertDimensionFormat(null!==(t=e.dimensions)&&void 0!==t?t:{},{}),period:null!==(n=e.period)&&void 0!==n?n:"",actionPrefix:null!==(r=e.actionPrefix)&&void 0!==r?r:"",alarmNamePrefix:null!==(i=e.alarmNamePrefix)&&void 0!==i?i:"",type:"annotationQuery",datasource:this.ref})}))}).pipe((0,Sn.U)((e=>({data:(0,Yn.z1)({data:e}).data}))))}}var er=n(71114),tr=n(94396),nr=n(76747),rr=n(87067),ir=n(2027),ar=n(20746),sr=n(59366),or=n(39419),lr=n(63758),ur=n(24298),cr=n(14444),dr=n(16976),pr=n(7501);async function mr(e,t){let n;try{n=await(0,pr.F)().get(e)}catch(e){return void console.error("Could not load linked xray data source, it was probably deleted after it was linked",e)}return{title:n.name,url:"",internal:{query:{query:"${__value.raw}",queryType:"getTrace",region:t},datasourceUid:e,datasourceName:n.name}}}function hr(e,t,n,r,i){var a,s;const o=e.expression?r(e.expression):"",l=null!==(a=null===(s=e.logGroupNames)||void 0===s?void 0:s.flatMap(i))&&void 0!==a?a:[];return{url:Le({end:t.to.toISOString(),start:t.from.toISOString(),timeType:"ABSOLUTE",tz:"UTC",editorString:o,isLiveTail:!1,source:l},n),title:"View in CloudWatch console",targetBlank:!0}}function gr(e,t,n){const r=new Date;let i,a,s=0,o={};return new dr.y((l=>(function t(u){a=e(u).subscribe({next(e){const t=(0,Yn.z1)({data:{results:o}}).data||[];l.next({frames:[...t,...e]}),l.complete()},error(e){if("string"==typeof e)return void l.error(e);const a=function(e){var t;const n=null===(t=e.data)||void 0===t?void 0:t.results;if(!n)return;return Object.keys(n).reduce(((t,r)=>{var i;return null!==(i=n[r].error)&&void 0!==i&&i.startsWith("LimitExceededException")?(t.errorMessage=n[r].error,t.errors.push(e.config.data.queries.find((e=>e.refId===r)))):t.good[r]=n[r],t}),{errors:[],good:{},errorMessage:""})}(e);var u;if(a)if(a.errors.length)if(n(s,r.valueOf()))if(Object.keys(o).length||Object.keys(a.good).length){var c,d,p;const e=(0,Yn.z1)({data:{results:Object.assign({},null!==(c=a.good)&&void 0!==c?c:{},null!==(d=o)&&void 0!==d?d:{})}});e.error=Object.assign({},null!==(p=e.error)&&void 0!==p?p:{},{message:`Some queries timed out: ${a.errorMessage}`}),l.next({error:e.error,frames:e.data}),l.complete()}else{var m,h;const t=(0,Yn.z1)({data:{results:null!==(m=null===(h=e.data)||void 0===h?void 0:h.results)&&void 0!==m?m:{}}});l.error(t.error)}else o=Object.assign({},o,a.good),i=setTimeout((()=>{s++,t(a.errors)}),(u=s+1,1e3*Math.pow(2,u)+100*Math.random()));else l.error(e);else l.error(e)}})}(t),()=>{clearTimeout(i),a.unsubscribe()})))}var fr=n(56861);function vr(e){if(!e)return;const{subscriber:t,counter:n,period:r,step:i,endPeriod:a}=e;t.next(n);const s=Math.min(r+i,a);this.schedule({subscriber:t,counter:n+1,period:s,step:i,endPeriod:a},s)}function yr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const br="__log__grafana_internal__",xr="__logstream__grafana_internal__";class wr extends An{constructor(e,t,n){var r;super(e,t),r=this,yr(this,"logsTimeout",void 0),yr(this,"defaultLogGroups",void 0),yr(this,"logQueries",{}),yr(this,"tracingDataSourceUid",void 0),yr(this,"handleLogQueries",((e,t)=>{const n=e.map((e=>({queryString:e.expression||"",refId:e.refId,logGroupNames:e.logGroupNames||this.defaultLogGroups,region:super.replaceVariableAndDisplayWarningIfMulti(this.getActualRegion(e.region),t.scopedVars,!0,"region")}))),r=n.filter((e=>{var t;return null===(t=e.logGroupNames)||void 0===t?void 0:t.length}));if(e.length>r.length)return(0,fn.of)({data:[],error:{message:"Log group is required"}});if((0,y.isEmpty)(r))return(0,fn.of)({data:[],state:yn.Gu.Done});const i=new Date,a=()=>Date.now()>=i.valueOf()+c.intervalToMs(this.logsTimeout);return gr((e=>this.makeLogActionRequest("StartQuery",e,{makeReplacements:!0,scopedVars:t.scopedVars,skipCache:!0})),n,a).pipe((0,er.z)((t=>{let{frames:n,error:r}=t;return this.logsQuery(n.map((t=>{var n,r,i,a;return{queryId:t.fields[0].values.get(0),region:null!==(n=null===(r=t.meta)||void 0===r||null===(i=r.custom)||void 0===i?void 0:i.Region)&&void 0!==n?n:"default",refId:t.refId,statsGroups:null===(a=e.find((e=>e.refId===t.refId)))||void 0===a?void 0:a.statsGroups}})),a).pipe((0,Sn.U)((e=>(!e.error&&r&&(e.error=r),e))))})),(0,er.z)((e=>(0,tr.D)((async()=>(await async function(e,t,n,r,i,a,s){const o=(e,n)=>r(e,t.scopedVars,!0,n),l=e=>i(e,t.scopedVars);for(const r of e.data){var u;const e=t.targets.find((e=>e.refId===r.refId)),i=a(o(null!==(u=e.region)&&void 0!==u?u:"","region"));for(const t of r.fields)if("@xrayTraceId"===t.name&&s){var c;a(o(null!==(c=e.region)&&void 0!==c?c:"","region"));const n=await mr(s,i);n&&(t.config.links=[n])}else t.config.links=[hr(e,n,i,o,l)]}}(e,t,this.timeSrv.timeRange(),this.replaceVariableAndDisplayWarningIfMulti.bind(this),this.expandVariableToArray.bind(this),this.getActualRegion.bind(this),this.tracingDataSourceUid),e))()))))})),yr(this,"getLogRowContext",(async function(e){let{limit:t=10,direction:n="BACKWARD"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0,a=null,s=null;for(const t of e.dataFrame.fields)if(t.name===xr){if(a=t,null!==s)break}else if(t.name===br&&(s=t,null!==a))break;const o={limit:t,startFromHead:"BACKWARD"!==n,region:null==i?void 0:i.region,logGroupName:Sr(s.values.get(e.rowIndex)),logStreamName:a.values.get(e.rowIndex)};"BACKWARD"===n?o.endTime=e.timeEpochMs:o.startTime=e.timeEpochMs;const l=await(0,Kn.n)(r.makeLogActionRequest("GetLogEvents",[o]));return{data:l}})),this.timeSrv=n,this.tracingDataSourceUid=e.jsonData.tracingDatasourceUid,this.logsTimeout=e.jsonData.logsTimeout||"15m",this.defaultLogGroups=e.jsonData.defaultLogGroups||[]}logsQuery(e,t){this.logQueries={},e.forEach((e=>{var t,n,r;this.logQueries[e.refId]={id:e.queryId,region:e.region,statsQuery:null!==(t=(null!==(n=null===(r=e.statsGroups)||void 0===r?void 0:r.length)&&void 0!==n?n:0)>0)&&void 0!==t&&t}}));const n=function(e){let{startPeriod:t=0,endPeriod:n=5e3,step:r=1e3}=e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fr.z;return new dr.y((e=>{const a={subscriber:e,counter:0,period:t,step:r,endPeriod:n};return e.add(i.schedule(vr,t,a)),e}))}({startPeriod:100,endPeriod:1e3,step:300}).pipe((0,nr.b)((t=>this.makeLogActionRequest("GetQueryResults",e,{skipCache:!0}))),(0,rr.r)(),(0,ir.B)()),i=n.pipe((0,ar.R)(((e,t)=>{let{failures:n,prevRecordsMatched:r}=e;n++;for(const e of t){var i,a,s,o;const t=null===(i=e.meta)||void 0===i||null===(a=i.stats)||void 0===a||null===(s=a.find((e=>"Records scanned"===e.displayName)))||void 0===s?void 0:s.value;t>(null!==(o=r[e.refId])&&void 0!==o?o:0)&&(n=0),r[e.refId]=t}return{failures:n,prevRecordsMatched:r}}),{failures:0,prevRecordsMatched:{}}),(0,Sn.U)((e=>{let{failures:t}=e;return t})),(0,ir.B)()),a=(0,sr.$)(n,i).pipe((0,or.b)((e=>{let[t]=e;for(const e of t){var n,r;[w.KB.Complete,w.KB.Cancelled,w.KB.Failed].includes(null===(n=e.meta)||void 0===n||null===(r=n.custom)||void 0===r?void 0:r.Status)&&this.logQueries.hasOwnProperty(e.refId)&&delete this.logQueries[e.refId]}})),(0,Sn.U)((e=>{let[n,i]=e;if(t())for(const e of n)(0,y.set)(e,"meta.custom.Status",w.KB.Cancelled);return{data:n,key:"test-key",state:n.every((e=>{var t,n;return[w.KB.Complete,w.KB.Cancelled,w.KB.Failed].includes(null===(t=e.meta)||void 0===t||null===(n=t.custom)||void 0===n?void 0:n.Status)}))?yn.Gu.Done:yn.Gu.Loading,error:t()?{message:`error: query timed out after ${i} attempts`,type:r.eA.Timeout}:void 0}})),(0,lr.o)((e=>{let{state:t}=e;return t!==yn.Gu.Error&&t!==yn.Gu.Done}),!0));return s=a,o=()=>this.stopQueries(),new dr.y((e=>{const t=s.subscribe({next:t=>e.next(t),error:t=>e.next(t),complete:()=>e.complete()});return()=>{t.unsubscribe(),o()}}));var s,o}stopQueries(){Object.keys(this.logQueries).length>0&&this.makeLogActionRequest("StopQuery",Object.values(this.logQueries).map((e=>({queryId:e.id,region:e.region}))),{makeReplacements:!1,skipCache:!0}).pipe((0,ur.x)((()=>{this.logQueries={}})))}makeLogActionRequest(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{makeReplacements:!0,skipCache:!1};const r=this.timeSrv.timeRange(),i={from:r.from.valueOf().toString(),to:r.to.valueOf().toString(),queries:t.map((t=>Object.assign({refId:t.refId||"A",intervalMs:1,maxDataPoints:1,datasource:this.ref,type:"logAction",subtype:e},t)))};n.makeReplacements&&i.queries.forEach((e=>{const t=["queryString","logGroupNames","logGroupName","logGroupNamePrefix"],r=e;for(const i of t)e.hasOwnProperty(i)&&(Array.isArray(r[i])?r[i]=r[i].flatMap((e=>"logGroupNames"===i?this.expandVariableToArray(e,n.scopedVars||{}):this.replaceVariableAndDisplayWarningIfMulti(e,n.scopedVars,!0,i))):r[i]=this.replaceVariableAndDisplayWarningIfMulti(r[i],n.scopedVars,!0,i));r.region&&(r.region=this.replaceVariableAndDisplayWarningIfMulti(r.region,n.scopedVars,!0,"region"),r.region=this.getActualRegion(r.region))}));let a={};return n.skipCache&&(a={"X-Cache-Skip":!0}),this.awsRequest(this.dsQueryEndpoint,i,a).pipe((0,Sn.U)((e=>{return t={data:e},(0,Yn.z1)(t).data||[];var t})),(0,cr.K)((e=>{var t,n;if(je.v.featureToggles.datasourceQueryMultiStatus&&207===e.status)throw e;if(400===e.status)throw e;if(null!==(t=e.data)&&void 0!==t&&t.error)throw e.data.error;if(null!==(n=e.data)&&void 0!==n&&n.message)throw e.data.message;throw e})))}async getLogGroupFields(e){var t;const n=await(0,Kn.n)(this.makeLogActionRequest("GetLogGroupFields",[e])),r=n[0].fields[0].values.toArray(),i=n[0].fields[1].values.toArray();return{logGroupFields:null!==(t=r.map(((e,t)=>({name:e,percent:i[t]}))))&&void 0!==t?t:[]}}}function Sr(e){const t=e.lastIndexOf(":");return e.slice(t+1)}var Cr,Er=n(86558),Ir=n(27494),Ar=n(32025);const jr=e=>{let{region:t}=e;return(0,I.jsxs)("p",{children:["Please visit the ",(0,I.jsx)("a",{target:"_blank",rel:"noreferrer",className:"text-link",href:`https://${t}.console.aws.amazon.com/servicequotas/home?region=${t}#!/services/monitoring/quotas/L-5E141212`,children:"AWS Service Quotas console"})," to request a quota increase or see our ",Cr||(Cr=(0,I.jsx)("a",{target:"_blank",rel:"noreferrer",className:"text-link",href:"https://grafana.com/docs/grafana/latest/datasources/cloudwatch/#service-quotas",children:"documentation"}))," to learn more."]})};function Rr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Tr=(e,t)=>v.h.dispatch((0,h.$l)((0,g.t_)(`CloudWatch request limit reached in ${t} for data source ${e}`,"",void 0,s.createElement(jr,{region:t},null))));class Or extends An{constructor(e,t){super(e,t),Rr(this,"debouncedAlert",En(Tr,Cn.bd.Error)),Rr(this,"handleMetricQueries",((e,t)=>{var n,r;const i=(0,Ir.dq)(Date.now(),{timeZone:t.timezone,format:"Z"}).replace(":",""),a=e.filter(this.filterMetricQuery).map((e=>{const n=sn(e),r=this.replaceMetricQueryVars(n,t);return Object.assign({timezoneUTCOffset:i,intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints},r,{type:"timeSeriesQuery",datasource:this.ref})}));if((0,y.isEmpty)(a))return(0,fn.of)({data:[]});const s={from:null==t||null===(n=t.range)||void 0===n?void 0:n.from.valueOf().toString(),to:null==t||null===(r=t.range)||void 0===r?void 0:r.to.valueOf().toString(),queries:a};return this.performTimeSeriesQuery(s,t.range)}))}interpolateMetricsQueryVariables(e,t){var n;return{alias:this.replaceVariableAndDisplayWarningIfMulti(e.alias,t),metricName:this.replaceVariableAndDisplayWarningIfMulti(e.metricName,t),namespace:this.replaceVariableAndDisplayWarningIfMulti(e.namespace,t),period:this.replaceVariableAndDisplayWarningIfMulti(e.period,t),sqlExpression:this.replaceVariableAndDisplayWarningIfMulti(e.sqlExpression,t),dimensions:this.convertDimensionFormat(null!==(n=e.dimensions)&&void 0!==n?n:{},t)}}performTimeSeriesQuery(e,t){let{from:n,to:r}=t;return this.awsRequest(this.dsQueryEndpoint,e).pipe((0,Sn.U)((e=>{const t=(0,Yn.z1)({data:e}).data;if(!t||t.length<=0)return{data:[]};const n=(0,y.findLast)(e.results,(e=>!!e.error));return t.forEach((e=>{e.fields.forEach((t=>{var n,r;t.type===Ar.fS.time&&(t.config.interval=1e3*(null===(n=e.meta)||void 0===n||null===(r=n.custom)||void 0===r?void 0:r.period))}))})),{data:t,error:n?{message:n.error}:void 0}})),(0,cr.K)((t=>{var n,r,i;if(!(null===(n=t.data)||void 0===n?void 0:n.results)&&t.data&&"Metric request error"===t.data.message&&t.data.error)return t.message=t.data.error,(0,Er._)((()=>t));const a=Object.values(null!==(r=null===(i=t.data)||void 0===i?void 0:i.results)&&void 0!==r?r:{}),s=a.find((e=>e.error));if(s&&(t.message=s.error),a.some((e=>e.error&&/^Throttling:.*/.test(e.error)))){var o,l;const n=Object.keys(null!==(o=null===(l=t.data)||void 0===l?void 0:l.results)&&void 0!==o?o:{});Object.values(e.queries).reduce(((e,t)=>{let{refId:r,region:i}=t;return r&&!n.includes(r)||e.includes(i)?e:[...e,i]}),[]).forEach((e=>{const t=this.getActualRegion(e);t&&this.debouncedAlert(this.instanceSettings.name,t)}))}return(0,Er._)((()=>t))})))}filterMetricQuery(e){return E(e)}replaceMetricQueryVars(e,t){var n;return e.region=this.templateSrv.replace(this.getActualRegion(e.region),t.scopedVars),e.namespace=this.replaceVariableAndDisplayWarningIfMulti(e.namespace,t.scopedVars,!0,"namespace"),e.metricName=this.replaceVariableAndDisplayWarningIfMulti(e.metricName,t.scopedVars,!0,"metric name"),e.dimensions=this.convertDimensionFormat(null!==(n=e.dimensions)&&void 0!==n?n:{},t.scopedVars),e.statistic=this.templateSrv.replace(e.statistic,t.scopedVars),e.period=String(this.getPeriod(e,t)),e.id=this.templateSrv.replace(e.id,t.scopedVars),e.expression=this.templateSrv.replace(e.expression,t.scopedVars),e.sqlExpression=this.templateSrv.replace(e.sqlExpression,t.scopedVars,"raw"),e}getPeriod(e,t){let n=this.templateSrv.replace(e.period,t.scopedVars);if(n&&"auto"!==n.toLowerCase()){let e;return e=/^\d+$/.test(n)?parseInt(n,10):c.intervalToSeconds(n),e<1&&(e=1),String(e)}return n}}var Mr=n(74184);const Fr=/\${(\w+):json}/g;function Dr(e){const t=e.replace(Fr,'"$$$1"'),n=JSON.parse(t),r={};return Object.keys(n).forEach((e=>{const t=n[e];"string"==typeof t?r[e]=[t]:void 0!==t&&(r[e]=t)})),r}function kr(e){if(function(e){return"string"!=typeof e&&"string"!=typeof e.ec2Filters&&"string"!=typeof e.tags}(e))return e;if("string"!=typeof e){const t=(0,y.omit)(e,["dimensionFilters","ec2Filters","tags"]);if(t.dimensionFilters={},t.ec2Filters={},t.tags={},""!==e.dimensionFilters&&"[]"!==e.ec2Filters){const n=e.dimensionFilters.replace(Fr,'"$$$1"');try{t.dimensionFilters=JSON.parse(n)}catch{throw new Error(`unable to migrate poorly formed filters: ${e.dimensionFilters}`)}}if(""!==e.ec2Filters&&"[]"!==e.ec2Filters)try{t.ec2Filters=Dr(e.ec2Filters)}catch{throw new Error(`unable to migrate poorly formed filters: ${e.ec2Filters}`)}if(""!==e.tags&&"[]"!==e.tags)try{t.tags=Dr(e.tags)}catch{throw new Error(`unable to migrate poorly formed filters: ${e.tags}`)}return t}const t={refId:"CloudWatchVariableQueryEditor-VariableQuery",queryType:w.wf.Regions,namespace:"",region:"",metricName:"",dimensionKey:"",dimensionFilters:{},ec2Filters:{},instanceID:"",attributeName:"",resourceType:"",tags:{}};if(""===e)return t;if(e.match(/^regions\(\)/))return t;if(e.match(/^namespaces\(\)/))return t.queryType=w.wf.Namespaces,t;const n=e.match(/^metrics\(([^\)]+?)(,\s?([^,]+?))?\)/);if(n)return t.queryType=w.wf.Metrics,t.namespace=n[1],t.region=n[3]||"",t;const r=e.match(/^dimension_keys\(([^\)]+?)(,\s?([^,]+?))?\)/);if(r)return t.queryType=w.wf.DimensionKeys,t.namespace=r[1],t.region=r[3]||"",t;const i=e.match(/^dimension_values\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)(,\s?(.+))?\)/);if(i){if(t.queryType=w.wf.DimensionValues,t.region=i[1],t.namespace=i[2],t.metricName=i[3],t.dimensionKey=i[4],t.dimensionFilters={},i[6]&&"[]"!==i[6]){const e=i[6].replace(Fr,'"$$$1"');try{t.dimensionFilters=JSON.parse(e)}catch{throw new Error(`unable to migrate poorly formed filters: ${i[6]}`)}}return t}const a=e.match(/^ebs_volume_ids\(([^,]+?),\s?([^,]+?)\)/);if(a)return t.queryType=w.wf.EBSVolumeIDs,t.region=a[1],t.instanceID=a[2],t;const s=e.match(/^ec2_instance_attribute\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(s){if(t.queryType=w.wf.EC2InstanceAttributes,t.region=s[1],t.attributeName=s[2],s[3]&&"[]"!==s[3])try{t.ec2Filters=Dr(s[3])}catch{throw new Error(`unable to migrate poorly formed filters: ${s[3]}`)}return t}const o=e.match(/^resource_arns\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(o){if(t.queryType=w.wf.ResourceArns,t.region=o[1],t.resourceType=o[2],o[3]&&"[]"!==o[3])try{t.tags=Dr(o[3])}catch{throw new Error(`unable to migrate poorly formed filters: ${o[3]}`)}return t}if(e.match(/^statistics\(\)/))return t.queryType=w.wf.Statistics,t;throw new Error("unable to parse old variable query")}const qr=e=>{var t;let{filter:n,onChange:r,onDelete:i,keyPlaceholder:a}=e;const[o,l]=(0,s.useState)(n.key||""),[u,c]=(0,s.useState)((null===(t=n.value)||void 0===t?void 0:t.join(", "))||""),d=(0,M.l4)(),p=Pr(d);return(0,I.jsx)("div",{"data-testid":"cloudwatch-multifilter-item",children:(0,I.jsxs)(Ae.InputGroup,{children:[(0,I.jsx)(m.I,{"data-testid":"cloudwatch-multifilter-item-key","aria-label":"Filter key",value:o,placeholder:null!=a?a:"key",onChange:e=>l(e.currentTarget.value),onBlur:()=>{o&&o!==n.key&&r(Object.assign({},n,{key:o}))}}),(0,I.jsx)("span",{className:(0,T.cx)(p.root),children:"="}),(0,I.jsx)(m.I,{"data-testid":"cloudwatch-multifilter-item-value","aria-label":"Filter value",value:u,placeholder:"value1, value2,...",onChange:e=>c(e.currentTarget.value),onBlur:()=>{const e=u.split(",").map((e=>e.trim()));u&&e!==n.value&&r(Object.assign({},n,{value:e})),c(e.join(", "))}}),(0,I.jsx)(Ae.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:i,type:"button"})]})})},Pr=(0,Te.B)((e=>({root:(0,T.css)({padding:e.spacing(0,1),alignSelf:"center"})}))),Nr=e=>{let{filters:t,onChange:n,keyPlaceholder:r}=e;const[i,a]=(0,s.useState)([]);(0,s.useEffect)((()=>a(t?(e=>Object.keys(e).map((t=>({key:t,value:e[t],operator:"="}))))(t):[])),[t]);return(0,I.jsx)(Ae.EditorList,{items:i,onChange:e=>{a(e);const r=(e=>{const t={};return e.forEach((e=>{let{key:n,value:r}=e;n&&r&&(t[n]=r)})),t})(e);(0,y.isEqual)(r,t)||n(r)},renderItem:Lr(r)})};function Lr(e){return function(t,n,r){return(0,I.jsx)(qr,{filter:t,onChange:e=>n(e),onDelete:r,keyPlaceholder:e})}}const Kr=e=>{let{label:t,onChange:n,value:r,options:i,allowCustomValue:a=!1,isLoading:s=!1,inputId:o=t}=e;return(0,I.jsx)(p._,{label:t,labelWidth:20,htmlFor:o,children:(0,I.jsx)(x.Ph,{"aria-label":t,width:25,allowCustomValue:a,value:r,onChange:e=>{let{value:t}=e;return n(t)},options:i,isLoading:s,inputId:o})})},_r=e=>{let{interactive:t,label:n,onBlur:r,placeholder:i,value:a,tooltip:o}=e;const[l,u]=(0,s.useState)(a);return(0,I.jsx)(p._,{interactive:t,label:n,labelWidth:20,tooltip:o,grow:!0,children:(0,I.jsx)(m.I,{"aria-label":n,placeholder:i,value:l,onChange:e=>u(e.currentTarget.value),onBlur:()=>r(l)})})};var $r,Vr;const Qr=[{value:w.wf.Regions,label:"Regions"},{value:w.wf.Namespaces,label:"Namespaces"},{value:w.wf.Metrics,label:"Metrics"},{value:w.wf.DimensionKeys,label:"Dimension Keys"},{value:w.wf.DimensionValues,label:"Dimension Values"},{value:w.wf.EBSVolumeIDs,label:"EBS Volume IDs"},{value:w.wf.EC2InstanceAttributes,label:"EC2 Instance Attributes"},{value:w.wf.ResourceArns,label:"Resource ARNs"},{value:w.wf.Statistics,label:"Statistics"},{value:w.wf.LogGroups,label:"Log Groups"}],Br=e=>{var t;let{query:n,datasource:r,onChange:i}=e;const a=kr(n),{region:s,namespace:o,metricName:l,dimensionKey:u,dimensionFilters:c}=a,[d,m]=He(r),h=ze(r),g=Je(r,s,o),f=Xe(r,s,o,l),v=Xe(r,s,o,l,null!=c?c:{}),y=e=>{i(Object.assign({},e,{refId:"CloudWatchVariableQueryEditor-VariableQuery"}))},b=async e=>{let{metricName:t,dimensionKey:n,dimensionFilters:i,namespace:a,region:s}=e;return t&&await r.api.getMetrics(a,s).then((e=>{e.find((e=>e.value===t))||(t="")})),n&&await r.api.getDimensionKeys(a,s).then((e=>{e.find((e=>e.value===n))||(n="",i={})})),Object.assign({},e,{metricName:t,dimensionKey:n,dimensionFilters:i})},x=[w.wf.Metrics,w.wf.DimensionKeys,w.wf.DimensionValues,w.wf.EBSVolumeIDs,w.wf.EC2InstanceAttributes,w.wf.ResourceArns,w.wf.LogGroups].includes(a.queryType),S=[w.wf.Metrics,w.wf.DimensionKeys,w.wf.DimensionValues].includes(a.queryType);return(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(Kr,{value:a.queryType,options:Qr,onChange:e=>y(Object.assign({},a,{queryType:e})),label:"Query type",inputId:`variable-query-type-${n.refId}`}),x&&(0,I.jsx)(Kr,{value:s,options:d,onChange:e=>(async e=>{const t=await b(Object.assign({},a,{region:e}));y(t)})(e),label:"Region",isLoading:m,inputId:`variable-query-region-${n.refId}`}),S&&(0,I.jsx)(Kr,{value:o,options:h,onChange:e=>(async e=>{const t=await b(Object.assign({},a,{namespace:e}));y(t)})(e),label:"Namespace",inputId:`variable-query-namespace-${n.refId}`,allowCustomValue:!0}),a.queryType===w.wf.DimensionValues&&(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(Kr,{value:l||null,options:g,onChange:e=>y(Object.assign({},a,{metricName:e})),label:"Metric",inputId:`variable-query-metric-${n.refId}`,allowCustomValue:!0}),(0,I.jsx)(Kr,{value:u||null,options:f,onChange:e=>y(Object.assign({},a,{dimensionKey:e})),label:"Dimension key",inputId:`variable-query-dimension-key-${n.refId}`,allowCustomValue:!0}),(0,I.jsx)(p._,{label:"Dimensions",labelWidth:20,tooltip:"Dimensions to filter the returned values on",children:(0,I.jsx)(De,{metricStat:Object.assign({},a,{dimensions:a.dimensionFilters}),onChange:e=>{i(Object.assign({},a,{dimensionFilters:e}))},dimensionKeys:v,disableExpressions:!0,datasource:r})})]}),a.queryType===w.wf.EBSVolumeIDs&&(0,I.jsx)(_r,{value:n.instanceID,placeholder:"i-XXXXXXXXXXXXXXXXX",onBlur:e=>y(Object.assign({},a,{instanceID:e})),label:"Instance ID"}),a.queryType===w.wf.EC2InstanceAttributes&&(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(_r,{value:a.attributeName,onBlur:e=>y(Object.assign({},a,{attributeName:e})),label:"Attribute name",interactive:!0,tooltip:(0,I.jsxs)(I.Fragment,{children:['Attribute or tag to query on. Tags should be formatted "Tags.<name>". ',$r||($r=(0,I.jsx)("a",{href:"https://grafana.com/docs/grafana/latest/datasources/aws-cloudwatch/template-queries-cloudwatch/#selecting-attributes",target:"_blank",rel:"noreferrer",children:"See the documentation for more details"}))]})}),(0,I.jsx)(p._,{label:"Filters",labelWidth:20,tooltip:(0,I.jsxs)(I.Fragment,{children:[Vr||(Vr=(0,I.jsx)("a",{href:"https://grafana.com/docs/grafana/latest/datasources/aws-cloudwatch/template-queries-cloudwatch/#selecting-attributes",target:"_blank",rel:"noreferrer",children:"Pre-defined ec2:DescribeInstances filters/tags"}))," and the values to filter on. Tags should be formatted tag:<name>."]}),children:(0,I.jsx)(Nr,{filters:a.ec2Filters,onChange:e=>{i(Object.assign({},a,{ec2Filters:e}))},keyPlaceholder:"filter/tag"})})]}),a.queryType===w.wf.ResourceArns&&(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(_r,{value:a.resourceType,onBlur:e=>y(Object.assign({},a,{resourceType:e})),label:"Resource type"}),(0,I.jsx)(p._,{label:"Tags",labelWidth:20,tooltip:"Tags to filter the returned values on.",children:(0,I.jsx)(Nr,{filters:a.tags,onChange:e=>{i(Object.assign({},a,{tags:e}))},keyPlaceholder:"tag"})})]}),a.queryType===w.wf.LogGroups&&(0,I.jsx)(_r,{value:null!==(t=n.logGroupPrefix)&&void 0!==t?t:"",onBlur:e=>y(Object.assign({},a,{logGroupPrefix:e})),label:"Log group prefix"})]})};class Wr extends Mr.Mg{constructor(e){var t,n,r;super(),r=Br,(n="editor")in(t=this)?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,this.api=e,this.query=this.query.bind(this)}query(e){const t=kr(e.targets[0]);return(0,tr.D)(this.execute(t)).pipe((0,Sn.U)((e=>({data:e}))))}async execute(e){try{switch(e.queryType){case w.wf.Regions:return this.handleRegionsQuery();case w.wf.Namespaces:return this.handleNamespacesQuery();case w.wf.Metrics:return this.handleMetricsQuery(e);case w.wf.DimensionKeys:return this.handleDimensionKeysQuery(e);case w.wf.DimensionValues:return this.handleDimensionValuesQuery(e);case w.wf.EBSVolumeIDs:return this.handleEbsVolumeIdsQuery(e);case w.wf.EC2InstanceAttributes:return this.handleEc2InstanceAttributeQuery(e);case w.wf.ResourceArns:return this.handleResourceARNsQuery(e);case w.wf.Statistics:return this.handleStatisticsQuery();case w.wf.LogGroups:return this.handleLogGroupsQuery(e)}}catch(t){return console.error(`Could not run CloudWatchMetricFindQuery ${e}`,t),[]}}async handleLogGroupsQuery(e){let{region:t,logGroupPrefix:n}=e;return(await this.api.describeAllLogGroups({region:t,logGroupNamePrefix:n})).map((e=>({text:e.value,value:e.value,expandable:!0})))}async handleRegionsQuery(){return(await this.api.getRegions()).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleNamespacesQuery(){return(await this.api.getNamespaces()).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleMetricsQuery(e){let{namespace:t,region:n}=e;return(await this.api.getMetrics(t,n)).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleDimensionKeysQuery(e){let{namespace:t,region:n}=e;return(await this.api.getDimensionKeys(t,n)).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleDimensionValuesQuery(e){let{namespace:t,region:n,dimensionKey:r,metricName:i,dimensionFilters:a}=e;if(!r||!i)return[];return(await this.api.getDimensionValues(n,t,i,r,null!=a?a:{})).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleEbsVolumeIdsQuery(e){let{region:t,instanceID:n}=e;if(!n)return[];return(await this.api.getEbsVolumeIds(t,n)).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleEc2InstanceAttributeQuery(e){let{region:t,attributeName:n,ec2Filters:r}=e;if(!n)return[];return(await this.api.getEc2InstanceAttribute(t,n,null!=r?r:{})).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleResourceARNsQuery(e){let{region:t,resourceType:n,tags:r}=e;if(!n)return[];return(await this.api.getResourceARNs(t,n,null!=r?r:{})).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleStatisticsQuery(){return mt.map((e=>({text:e,value:e,expandable:!0})))}}function Gr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Ur extends bn.CK{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,gt.J)(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,xn.$t)();super(e),Gr(this,"defaultRegion",void 0),Gr(this,"languageProvider",void 0),Gr(this,"sqlCompletionItemProvider",void 0),Gr(this,"metricMathCompletionItemProvider",void 0),Gr(this,"type","cloudwatch"),Gr(this,"metricsQueryRunner",void 0),Gr(this,"annotationQueryRunner",void 0),Gr(this,"logsQueryRunner",void 0),Gr(this,"api",void 0),Gr(this,"getLogRowContext",(async(e,t,n)=>this.logsQueryRunner.getLogRowContext(e,t,n))),this.templateSrv=t,this.defaultRegion=e.jsonData.defaultRegion,this.api=new Rn(e,t),this.languageProvider=new Vn(this),this.sqlCompletionItemProvider=new Ln(this.api,this.templateSrv),this.metricMathCompletionItemProvider=new Xn(this.api,this.templateSrv),this.metricsQueryRunner=new Or(e,t),this.logsQueryRunner=new wr(e,t,n),this.annotationQueryRunner=new Zn(e,t),this.variables=new Wr(this.api),this.annotations=wn}filterQuery(e){return!0!==e.hide||Ee(e)&&""!==e.id}query(e){let t=(e=(0,y.cloneDeep)(e)).targets.filter(this.filterQuery);const n=[],r=[],i=[];t.forEach((e=>{Ie(e)?i.push(e):Ce(e)?n.push(e):r.push(e)}));const a=[];return n.length&&a.push(this.logsQueryRunner.handleLogQueries(n,e)),r.length&&a.push(this.metricsQueryRunner.handleMetricQueries(r,e)),i.length&&a.push(this.annotationQueryRunner.handleAnnotationQuery(i,e)),(0,y.isEmpty)(a)?(0,fn.of)({data:[],state:yn.Gu.Done}):(0,vn.T)(...a)}interpolateVariablesInQueries(e,t){return e.length?e.map((e=>Object.assign({},e,{region:this.metricsQueryRunner.replaceVariableAndDisplayWarningIfMulti(this.getActualRegion(e.region),t)},Ee(e)&&this.metricsQueryRunner.interpolateMetricsQueryVariables(e,t)))):e}targetContainsTemplate(e){var t;return this.templateSrv.containsTemplate(e.region)||this.templateSrv.containsTemplate(e.namespace)||this.templateSrv.containsTemplate(e.metricName)||this.templateSrv.containsTemplate(e.expression)||(null===(t=e.logGroupNames)||void 0===t?void 0:t.some((e=>this.templateSrv.containsTemplate(e))))||(0,y.find)(e.dimensions,((e,t)=>this.templateSrv.containsTemplate(t)||this.templateSrv.containsTemplate(e)))}showContextToggle(){return!0}getQueryDisplayText(e){var t;return"Logs"===e.queryMode?null!==(t=e.expression)&&void 0!==t?t:"":JSON.stringify(e)}getVariables(){return this.templateSrv.getVariables().map((e=>`$${e.name}`))}getActualRegion(e){var t;return"default"===e||void 0===e||""===e?null!==(t=this.defaultRegion)&&void 0!==t?t:"":e}}var Hr=n(21295),zr=n(92949);const Jr=e=>Boolean(e.metricQueryType===w.$5.Search&&e.metricEditorMode===w.MQ.Builder),Xr=new r.hf(Ur).setQueryEditorHelp(we).setConfigEditor((e=>{var t,n;const{options:r}=e,{defaultLogGroups:i,logsTimeout:a,defaultRegion:y}=r.jsonData,[b,x]=(0,s.useState)(!!r.version&&r.version>1),w=function(e,t){const[n,r]=(0,s.useState)();return(0,s.useEffect)((()=>{t&&(0,f.ak)().loadDatasource(e).then((e=>{r(e)}))}),[e,t]),n}(r.name,b);!function(e){const t=e=>{v.h.dispatch((0,h.$l)((0,g.ZR)("CloudWatch Authentication",e)))};(0,s.useEffect)((()=>{"arn"===e.authType?t('Since grafana 7.3 authentication type "arn" is deprecated, falling back to default SDK provider'):"credentials"!==e.authType||e.profile||e.database||t('As of grafana 7.3 authentication type "credentials" should be used only for shared file credentials.              If you don\'t have a credentials file, switch to the default SDK provider for extracting credentials              from environment variables or IAM roles')}),[e.authType,e.database,e.profile])}(r.jsonData);const S=function(e){const[t,n]=(0,s.useState)(void 0);return(0,o.Z)((()=>{if(e)try{c.describeInterval(e),n(void 0)}catch(e){e instanceof Error&&n(e.toString())}else n(void 0)}),350,[e]),t}(a);(0,s.useEffect)((()=>{x(!1)}),[e.options.jsonData.assumeRoleArn,e.options.jsonData.authType,e.options.jsonData.defaultRegion,e.options.jsonData.endpoint,e.options.jsonData.externalId,e.options.jsonData.profile,null===(t=e.options.secureJsonData)||void 0===t?void 0:t.accessKey,null===(n=e.options.secureJsonData)||void 0===n?void 0:n.secretKey]);return(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(l.ConnectionConfig,Object.assign({},e,{loadRegions:w&&(async()=>w.api.getRegions().then((e=>e.reduce(((e,t)=>t.value?[...e,t.value]:e),[])))),children:(0,I.jsx)(p._,{label:"Namespaces of Custom Metrics",labelWidth:28,tooltip:"Namespaces of Custom Metrics.",children:(0,I.jsx)(m.I,{width:60,placeholder:"Namespace1,Namespace2",value:r.jsonData.customMetricsNamespaces||"",onChange:(0,u._R)(e,"customMetricsNamespaces")})})})),P||(P=(0,I.jsx)("h3",{className:"page-heading",children:"CloudWatch Logs"})),(0,I.jsxs)("div",{className:"gf-form-group",children:[(0,I.jsx)(p._,{label:"Timeout",labelWidth:28,tooltip:'Custom timeout for CloudWatch Logs insights queries which have max concurrency limits. Default is 15 minutes. Must be a valid duration string, such as "15m" "30s" "2000ms" etc.',invalid:Boolean(S),children:(0,I.jsx)(m.I,{width:60,placeholder:"15m",value:r.jsonData.logsTimeout||"",onChange:(0,u._R)(e,"logsTimeout"),title:'The timeout must be a valid duration string, such as "15m" "30s" "2000ms" etc.'})}),(0,I.jsx)(p._,{label:"Default Log Groups",labelWidth:28,tooltip:"Optionally, specify default log groups for CloudWatch Logs queries.",children:(0,I.jsx)(A,{region:null!=y?y:"",selectedLogGroups:null!=i?i:[],datasource:w,onChange:t=>{(0,u.tp)(e,"defaultLogGroups",t)},onOpenMenu:async()=>{b||(await(0,d.i)().put(`/api/datasources/${r.id}`,r).then((t=>{(0,u.fd)(e,"version",t.datasource.version)})),x(!0))},width:60,saved:b})})]}),(0,I.jsx)(q,{onChange:t=>(0,u.tp)(e,"tracingDatasourceUid",t),datasourceUid:r.jsonData.tracingDatasourceUid})]})})).setQueryEditor(mn).setMetadataInspector((function(e){let{data:t=[]}=e;const n=(0,s.useMemo)((()=>(0,y.groupBy)(t,"refId")),[t]);return(0,I.jsx)(I.Fragment,{children:(0,I.jsxs)("table",{className:"filter-table form-inline",children:[Se||(Se=(0,I.jsx)("thead",{children:(0,I.jsxs)("tr",{children:[(0,I.jsx)("th",{children:"RefId"}),(0,I.jsx)("th",{children:"Metric Data Query ID"}),(0,I.jsx)("th",{children:"Metric Data Query Expression"}),(0,I.jsx)("th",{children:"Period"}),(0,I.jsx)("th",{})]})})),Object.entries(n).map(((e,t)=>{var n,r;let[i,a]=e;if(!a.length)return null;const s=a[0],o=null===(n=s.meta)||void 0===n?void 0:n.custom;return o?(0,I.jsx)("tbody",{children:(0,I.jsxs)("tr",{children:[(0,I.jsx)("td",{children:i}),(0,I.jsx)("td",{children:o.id}),(0,I.jsx)("td",{children:null===(r=s.meta)||void 0===r?void 0:r.executedQueryString}),(0,I.jsx)("td",{children:o.period})]})},t):null}))]})})}));(0,a.N$)().subscribe(i.Pl,(e=>{let{payload:{dashboardId:t,orgId:n,grafanaVersion:r,queries:i}}=e;try{const e=i[zr.id];if(null==e||!e.length)return;let s=[],o=[];for(const t of e){var a;if(!t.hide)if(Ce(t))(null===(a=t.logGroupNames)||void 0===a?void 0:a.length)&&s.push(t);else if(Ee(t)){const e=sn(t);E(e)&&o.push(t)}}const l={grafana_version:r,dashboard_id:t,org_id:n,logs_queries_count:null==s?void 0:s.length,metrics_queries_count:null==o?void 0:o.length,metrics_search_count:0,metrics_search_builder_count:0,metrics_search_code_count:0,metrics_search_match_exact_count:0,metrics_query_count:0,metrics_query_builder_count:0,metrics_query_code_count:0};for(const e of o)l.metrics_search_count+=+Boolean(e.metricQueryType===w.$5.Search),l.metrics_search_builder_count+=+Jr(e),l.metrics_search_code_count+=+Boolean(e.metricQueryType===w.$5.Search&&e.metricEditorMode===w.MQ.Code),l.metrics_search_match_exact_count+=+Boolean(Jr(e)&&e.matchExact),l.metrics_query_count+=+Boolean(e.metricQueryType===w.$5.Query),l.metrics_query_builder_count+=+Boolean(e.metricQueryType===w.$5.Query&&e.metricEditorMode===w.MQ.Builder),l.metrics_query_code_count+=+Boolean(e.metricQueryType===w.$5.Query&&e.metricEditorMode===w.MQ.Code);(0,Hr.ff)("grafana_ds_cloudwatch_dashboard_loaded",l)}catch(e){console.error("error in cloudwatch tracking handler",e)}}))},56491:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var r=n(68404);const i=function(e,t,n){var i=(0,r.useRef)(void 0);i.current&&n(t,i.current)||(i.current=t),(0,r.useEffect)(e,i.current)};var a=n(48322);const s=n.n(a)();const o=function(e,t){i(e,t,s)}},61933:(e,t,n)=>{var r,i=n(68404),a=(r=i)&&"object"==typeof r&&"default"in r?r.default:r,s=n(15521),o=n(29152),l=n(82897),u=function(){return(u=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function c(e,t,n,r){return new(n||(n=Promise))((function(i,a){function s(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}l((r=r.apply(e,t||[])).next())}))}function d(e,t){var n,r,i,a,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}}function p(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,a=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}return s}var m,h=["af-south-1","ap-east-1","ap-northeast-1","ap-northeast-2","ap-northeast-3","ap-south-1","ap-southeast-1","ap-southeast-2","ca-central-1","cn-north-1","cn-northwest-1","eu-central-1","eu-north-1","eu-west-1","eu-west-2","eu-west-3","me-south-1","sa-east-1","us-east-1","us-east-2","us-gov-east-1","us-gov-west-1","us-iso-east-1","us-isob-east-1","us-west-1","us-west-2"];(m=t._e||(t._e={})).Keys="keys",m.Credentials="credentials",m.Default="default",m.EC2IAMRole="ec2_iam_role",m.ARN="arn";var g,f=[{label:"Workspace IAM Role",value:t._e.EC2IAMRole},{label:"AWS SDK Default",value:t._e.Default},{label:"Access & secret key",value:t._e.Keys},{label:"Credentials file",value:t._e.Credentials}],v=function(e){return{value:e,label:e}},y=function(e){var n,r,l,c,d,m,g,y,b,x=p(i.useState((e.standardRegions||h).map(v)),2),w=x[0],S=x[1],C=e.loadRegions,E=e.onOptionsChange,I=e.skipHeader,A=void 0!==I&&I,j=e.skipEndpoint,R=void 0!==j&&j,T=e.options,O=T.jsonData.profile;void 0===O&&(O=T.database);var M=window.grafanaBootData.settings,F=null!==(n=M.awsAllowedAuthProviders)&&void 0!==n?n:[t._e.Default,t._e.Keys,t._e.Credentials],D=null===(r=M.awsAssumeRoleEnabled)||void 0===r||r,k=f.find((function(e){return e.value===T.jsonData.authType}));return i.useEffect((function(){!k&&F.length&&E(u(u({},T),{jsonData:u(u({},T.jsonData),{authType:F[0]})}))}),[k,T,E]),i.useEffect((function(){C&&C().then((function(e){return S(e.map(v))}))}),[C]),a.createElement(s.FieldSet,{label:A?"":"Connection Details","data-testid":"connection-config"},a.createElement(s.InlineField,{label:"Authentication Provider",labelWidth:28,tooltip:"Specify which AWS credentials chain to use."},a.createElement(s.Select,{"aria-label":"Authentication Provider",className:"width-30",value:k,options:f.filter((function(e){return F.includes(e.value)})),defaultValue:T.jsonData.authType,onChange:function(t){o.onUpdateDatasourceJsonDataOptionSelect(e,"authType")(t)},menuShouldPortal:!0})),"credentials"===T.jsonData.authType&&a.createElement(s.InlineField,{label:"Credentials Profile Name",labelWidth:28,tooltip:"Credentials profile name, as specified in ~/.aws/credentials, leave blank for default."},a.createElement(s.Input,{"aria-label":"Credentials Profile Name",className:"width-30",placeholder:"default",value:O,onChange:o.onUpdateDatasourceJsonDataOption(e,"profile")})),"keys"===T.jsonData.authType&&a.createElement(a.Fragment,null,a.createElement(s.InlineField,{label:"Access Key ID",labelWidth:28},(null===(l=e.options.secureJsonFields)||void 0===l?void 0:l.accessKey)?a.createElement(s.ButtonGroup,{className:"width-30"},a.createElement(s.Input,{disabled:!0,placeholder:"Configured"}),a.createElement(s.ToolbarButton,{icon:"edit",tooltip:"Edit Access Key ID",type:"button",onClick:o.onUpdateDatasourceResetOption(e,"accessKey")})):a.createElement(s.Input,{"aria-label":"Access Key ID",className:"width-30",value:null!==(d=null===(c=T.secureJsonData)||void 0===c?void 0:c.accessKey)&&void 0!==d?d:"",onChange:o.onUpdateDatasourceSecureJsonDataOption(e,"accessKey")})),a.createElement(s.InlineField,{label:"Secret Access Key",labelWidth:28},(null===(m=e.options.secureJsonFields)||void 0===m?void 0:m.secretKey)?a.createElement(s.ButtonGroup,{className:"width-30"},a.createElement(s.Input,{disabled:!0,placeholder:"Configured"}),a.createElement(s.ToolbarButton,{icon:"edit",type:"button",tooltip:"Edit Secret Access Key",onClick:o.onUpdateDatasourceResetOption(e,"secretKey")})):a.createElement(s.Input,{"aria-label":"Secret Access Key",className:"width-30",value:null!==(y=null===(g=T.secureJsonData)||void 0===g?void 0:g.secretKey)&&void 0!==y?y:"",onChange:o.onUpdateDatasourceSecureJsonDataOption(e,"secretKey")}))),D&&a.createElement(a.Fragment,null,a.createElement(s.InlineField,{label:"Assume Role ARN",labelWidth:28,tooltip:"Optionally, specify the ARN of a role to assume. Specifying a role here will ensure that the selected authentication provider is used to assume the specified role rather than using the credentials directly. Leave blank if you don't need to assume a role at all"},a.createElement(s.Input,{"aria-label":"Assume Role ARN",className:"width-30",placeholder:"arn:aws:iam:*",value:T.jsonData.assumeRoleArn||"",onChange:o.onUpdateDatasourceJsonDataOption(e,"assumeRoleArn")})),a.createElement(s.InlineField,{label:"External ID",labelWidth:28,tooltip:"If you are assuming a role in another account, that has been created with an external ID, specify the external ID here."},a.createElement(s.Input,{"aria-label":"External ID",className:"width-30",placeholder:"External ID",value:T.jsonData.externalId||"",onChange:o.onUpdateDatasourceJsonDataOption(e,"externalId")}))),!R&&a.createElement(s.InlineField,{label:"Endpoint",labelWidth:28,tooltip:"Optionally, specify a custom endpoint for the service"},a.createElement(s.Input,{"aria-label":"Endpoint",className:"width-30",placeholder:null!==(b=e.defaultEndpoint)&&void 0!==b?b:"https://{service}.{region}.amazonaws.com",value:T.jsonData.endpoint||"",onChange:o.onUpdateDatasourceJsonDataOption(e,"endpoint")})),a.createElement(s.InlineField,{label:"Default Region",labelWidth:28,tooltip:"Specify the region, such as for US West (Oregon) use ` us-west-2 ` as the region."},a.createElement(s.Select,{"aria-label":"Default Region",className:"width-30",value:w.find((function(e){return e.value===T.jsonData.defaultRegion})),options:w,defaultValue:T.jsonData.defaultRegion,allowCustomValue:!0,onChange:o.onUpdateDatasourceJsonDataOptionSelect(e,"defaultRegion"),formatCreateLabel:function(e){return"Use region: "+e},menuShouldPortal:!0})),e.children)};function b(e){var t=this,n=p(i.useState(e.value||e.default||null),2),r=n[0],o=n[1],m=p(i.useState(r?[r]:[]),2),h=m[0],g=m[1],f=p(i.useState(e.dependencies),2),v=f[0],y=f[1],b=p(i.useState(!1),2),x=b[0],w=b[1],S=p(i.useState(!1),2),C=S[0],E=S[1],I=i.useMemo((function(){var t=[{label:"default ("+e.default+")",value:"__default",description:"Default value set in the data source"}];return e.value&&"__default"!==e.value&&t.push({label:e.value,value:e.value}),t}),[e.default,e.value]),A=p(i.useState(e.default?I:[]),2),j=A[0],R=A[1];return i.useEffect((function(){void 0!==e.resources&&g(e.resources)}),[e.resources]),i.useEffect((function(){var t=e.default?I:[];h.length?(h.forEach((function(e){var n="string"==typeof e?e:e.value;t.find((function(e){return e.value===n}))||("string"==typeof e?t.push({label:e,value:e}):t.push(e))})),R(t)):R([])}),[h,I,e.default]),i.useEffect((function(){l.isEqual(e.dependencies,v)||(E(!1),o(null),e.onChange(null),y(e.dependencies))}),[e,v]),a.createElement(s.InlineField,{label:e.label,labelWidth:e.labelWidth,tooltip:e.tooltip,hidden:e.hidden},a.createElement("div",{"data-testid":e["data-testid"],title:e.title},a.createElement(s.Select,u({},e,{"aria-label":e.label,options:j,onChange:function(t){e.onChange(t),t.value&&o(t.value)},isLoading:x,className:e.className||"min-width-6",onOpenMenu:function(){return e.fetch&&c(t,void 0,void 0,(function(){return d(this,(function(n){switch(n.label){case 0:w(!0),n.label=1;case 1:return n.trys.push([1,,3,4]),[4,c(t,void 0,void 0,(function(){var t;return d(this,(function(n){switch(n.label){case 0:return C?[2]:e.saveOptions?[4,e.saveOptions()]:[3,2];case 1:n.sent(),n.label=2;case 2:return n.trys.push([2,,4,5]),[4,e.fetch()];case 3:return t=n.sent(),g(t),[3,5];case 4:return E(!0),[7];case 5:return[2]}}))}))];case 2:return n.sent(),[3,4];case 3:return w(!1),[7];case 4:return[2]}}))}))},menuShouldPortal:!0}))))}(g=t.rB||(t.rB={}))[g.Previous=0]="Previous",g[g.Null=1]="Null",g[g.Value=2]="Value";var x=[{label:"Previous Value",value:t.rB.Previous},{label:"NULL",value:t.rB.Null},{label:"Value",value:t.rB.Value}];function w(e){return"string"==typeof e?e:e.map((function(e){return function(e){return"'"+String(e).replace(/'/g,"''")+"'"}(e)})).join(",")}t.ConnectionConfig=y,t.SIGV4ConnectionConfig=function(e){var t,n,r,i,s=e.onOptionsChange,o=e.options,l={onOptionsChange:function(e){var t,n,r,i,a=u(u({},o),{jsonData:u(u({},o.jsonData),{sigV4AuthType:e.jsonData.authType,sigV4Profile:e.jsonData.profile,sigV4AssumeRoleArn:e.jsonData.assumeRoleArn,sigV4ExternalId:e.jsonData.externalId,sigV4Region:e.jsonData.defaultRegion,sigV4Endpoint:e.jsonData.endpoint}),secureJsonFields:{sigV4AccessKey:null===(t=e.secureJsonFields)||void 0===t?void 0:t.accessKey,sigV4SecretKey:null===(n=e.secureJsonFields)||void 0===n?void 0:n.secretKey},secureJsonData:{sigV4AccessKey:null===(r=e.secureJsonData)||void 0===r?void 0:r.accessKey,sigV4SecretKey:null===(i=e.secureJsonData)||void 0===i?void 0:i.secretKey}});s(a)},options:u(u({},o),{jsonData:u(u({},o.jsonData),{authType:o.jsonData.sigV4AuthType,profile:o.jsonData.sigV4Profile,assumeRoleArn:o.jsonData.sigV4AssumeRoleArn,externalId:o.jsonData.sigV4ExternalId,defaultRegion:o.jsonData.sigV4Region,endpoint:o.jsonData.sigV4Endpoint}),secureJsonFields:{accessKey:null===(t=o.secureJsonFields)||void 0===t?void 0:t.sigV4AccessKey,secretKey:null===(n=o.secureJsonFields)||void 0===n?void 0:n.sigV4SecretKey},secureJsonData:{accessKey:null===(r=o.secureJsonData)||void 0===r?void 0:r.sigV4AccessKey,secretKey:null===(i=o.secureJsonData)||void 0===i?void 0:i.sigV4SecretKey}})};return a.createElement(a.Fragment,null,a.createElement("div",{className:"gf-form"},a.createElement("h6",null,"SigV4 Auth Details")),a.createElement(y,u({},l,{skipHeader:!0,skipEndpoint:!0})))}},16538:(e,t,n)=>{"use strict";e.exports=n(61933)},48322:e=>{"use strict";e.exports=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){if(t.constructor!==n.constructor)return!1;var r,i,a;if(Array.isArray(t)){if((r=t.length)!=n.length)return!1;for(i=r;0!=i--;)if(!e(t[i],n[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===n.source&&t.flags===n.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===n.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===n.toString();if((r=(a=Object.keys(t)).length)!==Object.keys(n).length)return!1;for(i=r;0!=i--;)if(!Object.prototype.hasOwnProperty.call(n,a[i]))return!1;for(i=r;0!=i--;){var s=a[i];if(("_owner"!==s||!t.$$typeof)&&!e(t[s],n[s]))return!1}return!0}return t!=t&&n!=n}},36993:(e,t,n)=>{e.exports=n(78353)},78353:(e,t)=>{!function(e){"use strict";e.stringify=function e(t){function n(e){return/[^\w-.]/.test(e)?e.replace(/[^\w-.]/g,(function(e){return"$"===e?"!":(e=e.charCodeAt(0))<256?"*"+("00"+e.toString(16)).slice(-2):"**"+("0000"+e.toString(16)).slice(-4)})):e}var r;switch(typeof t){case"number":return isFinite(t)?"~"+t:"~null";case"boolean":return"~"+t;case"string":return"~'"+n(t);case"object":if(!t)return"~null";if(r=[],Array.isArray(t)){for(var i=0;i<t.length;i++)r[i]=e(t[i])||"~null";return"~("+(r.join("")||"~")+")"}for(var a in t)if(t.hasOwnProperty(a)){var s=e(t[a]);s&&r.push(n(a)+s)}return"~("+r.join("~")+")";default:return}};var t={true:!0,false:!1,null:null};e.parse=function(e){if(!e)return e;e=e.replace(/%(25)*27/g,"'");var n=0,r=e.length;function i(t){if(e.charAt(n)!==t)throw new Error("bad JSURL syntax: expected "+t+", got "+(e&&e.charAt(n)));n++}function a(){for(var t,i=n,a="";n<r&&"~"!==(t=e.charAt(n))&&")"!==t;)switch(t){case"*":i<n&&(a+=e.substring(i,n)),"*"===e.charAt(n+1)?(a+=String.fromCharCode(parseInt(e.substring(n+2,n+6),16)),i=n+=6):(a+=String.fromCharCode(parseInt(e.substring(n+1,n+3),16)),i=n+=3);break;case"!":i<n&&(a+=e.substring(i,n)),a+="$",i=++n;break;default:n++}return a+e.substring(i,n)}return function s(){var o,l,u;switch(i("~"),l=e.charAt(n)){case"(":if(n++,"~"===e.charAt(n))if(o=[],")"===e.charAt(n+1))n++;else do{o.push(s())}while("~"===e.charAt(n));else if(o={},")"!==e.charAt(n))do{o[a()]=s()}while("~"===e.charAt(n)&&++n);i(")");break;case"'":n++,o=a();break;default:for(u=n++;n<r&&/[^)~]/.test(e.charAt(n));)n++;var c=e.substring(u,n);if(/[\d\-]/.test(l))o=parseFloat(c);else if(void 0===(o=t[c]))throw new Error("bad value keyword: "+c)}return o}()},e.tryParse=function(t,n){try{return e.parse(t)}catch(e){return n}}}(t)}}]);
//# sourceMappingURL=8250.4d38b3d3a4f4d0cd5427.js.map