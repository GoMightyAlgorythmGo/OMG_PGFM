"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7537],{95009:(e,n,a)=>{a.r(n),a.d(n,{plugin:()=>F});var l,s,t=a(12822),r=a(64681),i=a.n(r),o=a(68404),h=a(23541),u=a(83044),c=a(48147),d=a(6932),f=a(7501),p=a(24643),v=a(61884),g=a(1652),b=a(8771),y=a(78454),m=a(8397),C=a(78837),j=a(29937),x=a(38465),S=a(45916);function w(e){var n;let{value:a,onChange:l}=e;const[s,t]=(0,o.useState)(""),[r,i]=(0,o.useState)(null!==(n=a.query)&&void 0!==n?n:"");(0,o.useEffect)((()=>{t(JSON.stringify(Object.assign({},{query:"*",location:"",ds_uid:"",sort:"",tags:[],kind:[],explain:!1,facet:[{field:"kind"},{field:"tags"}],from:0,limit:20},a),null,2))}),[a]);const h=e=>{r!==a.query&&l(Object.assign({},a,{query:r}))},u=e=>{try{var n;const a=JSON.parse(e);l(a),i(null!==(n=a.query)&&void 0!==n?n:"")}catch(n){console.log("UNABLE TO parse search",e,n)}};return(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)(y.Z,{children:(0,S.jsx)(p._,{label:"Query",grow:!0,labelWidth:12,children:(0,S.jsx)(g.I,{placeholder:"Everything",value:r,onChange:e=>i(e.currentTarget.value),onKeyDown:e=>{"Enter"===e.key&&h()},onBlur:h,spellCheck:!1})})}),(0,S.jsx)(x.p,{height:300,language:"json",value:s,onBlur:u,onSave:u,showMiniMap:!1,showLineNumbers:!0})]})}function R(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}class q extends o.PureComponent{constructor(e){super(e),R(this,"state",{channels:[],channelFields:{}}),R(this,"queryTypes",[{label:"Random Walk",value:j.hR.RandomWalk,description:"Random signal within the selected time range"},{label:"Live Measurements",value:j.hR.LiveMeasurements,description:"Stream real-time measurements from Grafana"},{label:"List public files",value:j.hR.List,description:"Show directory listings for public resources"}]),R(this,"onQueryTypeChange",(e=>{const{onChange:n,query:a,onRunQuery:l}=this.props;n(Object.assign({},a,{queryType:e.value})),l(),this.loadChannelInfo()})),R(this,"onChannelChange",(e=>{const{onChange:n,query:a,onRunQuery:l}=this.props;n(Object.assign({},a,{channel:null==e?void 0:e.value})),l()})),R(this,"onFieldNamesChange",(e=>{var n,a;const{onChange:l,query:s,onRunQuery:t}=this.props;let r=[];if(Array.isArray(e)?r=e.map((e=>e.value)):e.value&&(r=[e.value]),1===r.length&&(null===(n=s.filter)||void 0===n||null===(a=n.fields)||void 0===a||!a.length)&&s.channel){var i;const e=(null!==(i=this.state.channelFields[s.channel])&&void 0!==i?i:[]).find((e=>"time"===e.value||"Time"===e.value));e&&e.value&&e.value!==r[0]&&(r=[e.value,...r])}l(Object.assign({},s,{filter:Object.assign({},s.filter,{fields:r})})),t()})),R(this,"checkAndUpdateValue",((e,n)=>{const{onChange:a,query:l,onRunQuery:s}=this.props;if("buffer"===e){let e;if(n)try{e=1e3*h.intervalToSeconds(n)}catch(e){console.warn("ERROR",e)}a(Object.assign({},l,{buffer:e}))}else a(Object.assign({},l,{[e]:n}));s()})),R(this,"handleEnterKey",(e=>{"Enter"===e.key&&this.checkAndUpdateValue("buffer",e.target.value)})),R(this,"handleBlur",(e=>{this.checkAndUpdateValue("buffer",e.target.value)})),R(this,"onFolderChanged",(e=>{const{onChange:n,query:a,onRunQuery:l}=this.props;n(Object.assign({},a,{path:null==e?void 0:e.value})),l()})),R(this,"onSearchChange",(e=>{const{query:n,onChange:a,onRunQuery:l}=this.props;a(Object.assign({},n,{search:e})),l()})),c.v.featureToggles.panelTitleSearch&&C.Oh&&this.queryTypes.push({label:"Search",value:j.hR.Search,description:"Search for grafana resources"})}loadChannelInfo(){(0,d.i)().fetch({url:"api/live/list"}).subscribe({next:e=>{var n;const a=null===(n=e.data)||void 0===n?void 0:n.channels;if(null!=a&&a.length){const e={},n=a.map((n=>{if(n.data){const a=new Set,l=(0,u.vP)(n.data);for(const e of l.fields)a.add(e.name);e[n.channel]=Array.from(a).map((e=>({value:e,label:e})))}return{value:n.channel,label:n.channel+" ["+n.minute_rate+" msg/min]"}}));this.setState({channelFields:e,channels:n})}}})}loadFolderInfo(){const e={targets:[{queryType:j.hR.List,refId:"A"}]};(0,f.F)().get("-- Grafana --").then((n=>{n.query(e).subscribe({next:e=>{if(e.data.length){const n=e.data[0].fields[0].values.toArray().map((e=>({value:e,label:e})));this.setState({folders:n})}}})}))}componentDidMount(){this.loadChannelInfo()}renderMeasurementsQuery(){var e;let{channel:n,filter:a,buffer:s}=this.props.query,{channels:t,channelFields:r}=this.state,i=t.find((e=>e.value===n));n&&!i&&(i={value:n,label:n,description:`Connected to ${n}`},t=[i,...t]);const o=new Set,u=n&&null!==(e=r[n])&&void 0!==e?e:[];if(null!=a&&a.fields)for(const e of a.fields)o.has(e)||(u.push({value:e,label:`${e} (not loaded)`,description:"Configured, but not found in the query results"}),o.add(e));let c="";return s&&(c=h.secondsToHms(s/1e3)),(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)("div",{className:"gf-form",children:(0,S.jsx)(p._,{label:"Channel",grow:!0,labelWidth:12,children:(0,S.jsx)(v.Ph,{options:t,value:i||"",onChange:this.onChannelChange,allowCustomValue:!0,backspaceRemovesValue:!0,placeholder:"Select measurements channel",isClearable:!0,noOptionsMessage:"Enter channel name",formatCreateLabel:e=>`Connect to: ${e}`})})}),n&&(0,S.jsxs)("div",{className:"gf-form",children:[(0,S.jsx)(p._,{label:"Fields",grow:!0,labelWidth:12,children:(0,S.jsx)(v.Ph,{options:u,value:(null==a?void 0:a.fields)||[],onChange:this.onFieldNamesChange,allowCustomValue:!0,backspaceRemovesValue:!0,placeholder:"All fields",isClearable:!0,noOptionsMessage:"Unable to list all fields",formatCreateLabel:e=>`Field: ${e}`,isSearchable:!0,isMulti:!0})}),(0,S.jsx)(p._,{label:"Buffer",children:(0,S.jsx)(g.I,{placeholder:"Auto",width:12,defaultValue:c,onKeyDown:this.handleEnterKey,onBlur:this.handleBlur,spellCheck:!1})})]}),l||(l=(0,S.jsx)(b.b,{title:"Grafana Live - Measurements",severity:"info",children:"This supports real-time event streams in Grafana core. This feature is under heavy development. Expect the interfaces and structures to change as this becomes more production ready."}))]})}renderListPublicFiles(){let{path:e}=this.props.query,{folders:n}=this.state;n||(n=[],this.loadFolderInfo());const a=n.find((n=>n.value===e));return e&&!a&&(n=[...n,{value:e,label:e}]),(0,S.jsx)(y.Z,{children:(0,S.jsx)(p._,{label:"Path",grow:!0,labelWidth:12,children:(0,S.jsx)(v.Ph,{options:n,value:a||"",onChange:this.onFolderChanged,allowCustomValue:!0,backspaceRemovesValue:!0,placeholder:"Select folder",isClearable:!0,formatCreateLabel:e=>`Folder: ${e}`})})})}renderSnapshotQuery(){var e,n;const{query:a}=this.props;return(0,S.jsx)(y.Z,{children:(0,S.jsx)(p._,{label:"Snapshot",grow:!0,labelWidth:12,children:(0,S.jsx)(m.W,{children:i()("frame",null!==(e=null===(n=a.snapshot)||void 0===n?void 0:n.length)&&void 0!==e?e:0,!0)})})})}render(){var e;const n=Object.assign({},j.wi,this.props.query),{queryType:a}=n;let l=this.queryTypes;return a===j.hR.Snapshot&&(l=[...this.queryTypes,{label:"Snapshot",value:a}]),(0,S.jsxs)(S.Fragment,{children:[a===j.hR.Search&&(s||(s=(0,S.jsx)(b.b,{title:"Grafana Search",severity:"info",children:"Using this datasource to call the new search system is experimental, and subject to change at any time without notice."}))),(0,S.jsx)(y.Z,{children:(0,S.jsx)(p._,{label:"Query type",grow:!0,labelWidth:12,children:(0,S.jsx)(v.Ph,{options:l,value:l.find((e=>e.value===a))||l[0],onChange:this.onQueryTypeChange})})}),a===j.hR.LiveMeasurements&&this.renderMeasurementsQuery(),a===j.hR.List&&this.renderListPublicFiles(),a===j.hR.Snapshot&&this.renderSnapshotQuery(),a===j.hR.Search&&(0,S.jsx)(w,{value:null!==(e=n.search)&&void 0!==e?e:{},onChange:this.onSearchChange})]})}}var k=a(63686);const F=new t.hf(k.k).setQueryEditor(q)}}]);
//# sourceMappingURL=grafanaPlugin.bdf1691aa507195659f0.js.map