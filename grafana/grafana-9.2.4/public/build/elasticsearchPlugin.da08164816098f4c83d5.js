"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9897],{64845:(e,t,i)=>{i.d(t,{f:()=>s});const s=e=>Boolean(e)},664:(e,t,i)=>{i.r(t),i.d(t,{plugin:()=>cs});var s=i(12822),a=i(27549),n=i(68404),l=i(75414),r=i(8771),o=i(9617),d=i(54416),u=i(8397),c=i(24643),g=i(1652);const p=(e,t,i)=>(0,n.useCallback)((s=>{e(i(t,s))}),[e,t,i]),h=(0,n.createContext)(void 0),m=()=>{const e=(0,n.useContext)(h);if(!e)throw new Error("Use DispatchContext first.");return e},v=e=>({name:e,pipelineAgg:""}),f=e=>`var${Math.max(0,...e.map((e=>{var t;return parseInt((null===(t=e.name.match("^var(\\d+)$"))||void 0===t?void 0:t[1])||"0",10)})))+1}`,b=e=>{var t;return"ewma"===(null===(t=e.settings)||void 0===t?void 0:t.model)},y=e=>{var t;return"holt"===(null===(t=e.settings)||void 0===t?void 0:t.model)},x=e=>{var t;return"holt_winters"===(null===(t=e.settings)||void 0===t?void 0:t.model)},j=e=>{var t;return["holt","ewma","holt_winters"].includes((null===(t=e.settings)||void 0===t?void 0:t.model)||"")},_=e=>M[e.type].requiresField,k=e=>M[e.type].isPipelineAgg,w=e=>M[e.type].supportsMultipleBucketPaths,F=e=>M[e.type].supportsMissing,S=e=>M[e.type].hasSettings,O=e=>M[e.type].supportsInlineScript,q=["count","avg","sum","min","max","extended_stats","percentiles","cardinality","raw_document","raw_data","logs","moving_avg","moving_fn","derivative","serial_diff","cumulative_sum","bucket_script","rate","top_metrics"],M={count:{label:"Count",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!1,hasMeta:!1,supportsInlineScript:!1,defaults:{}},avg:{label:"Average",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},sum:{label:"Sum",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},max:{label:"Max",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},min:{label:"Min",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},extended_stats:{label:"Extended Stats",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!0,defaults:{meta:{std_deviation_bounds_lower:!0,std_deviation_bounds_upper:!0}}},percentiles:{label:"Percentiles",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{settings:{percents:["25","50","75","95","99"]}}},cardinality:{label:"Unique Count",requiresField:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},moving_avg:{label:"Moving Average",requiresField:!0,isPipelineAgg:!0,versionRange:"<8.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{model:"simple",window:"5"}}},moving_fn:{label:"Moving Function",requiresField:!0,isPipelineAgg:!0,supportsMultipleBucketPaths:!1,supportsInlineScript:!1,supportsMissing:!1,hasMeta:!1,hasSettings:!0,defaults:{}},derivative:{label:"Derivative",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},serial_diff:{label:"Serial Difference",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{lag:"1"}}},cumulative_sum:{label:"Cumulative Sum",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},bucket_script:{label:"Bucket Script",requiresField:!1,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!0,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{pipelineVariables:[v(f([]))]}},raw_document:{label:"Raw Document (legacy)",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},raw_data:{label:"Raw Data",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},logs:{label:"Logs",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,isSingleMetric:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{limit:"500"}}},top_metrics:{label:"Top Metrics",xpack:!0,requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{order:"desc"}}},rate:{label:"Rate",xpack:!0,requiresField:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!0,hasMeta:!1,defaults:{}}},C={moving_avg:[{label:"window",default:5},{label:"model",default:"simple"},{label:"predict"},{label:"minimize",default:!1}],moving_fn:[{label:"window",default:5},{label:"script"}],derivative:[{label:"unit"}],serial_diff:[{label:"lag"}],cumulative_sum:[{label:"format"}],bucket_script:[]},I=(e,t)=>{const i=t.filter((t=>{var i;return w(t)?null===(i=t.pipelineVariables)||void 0===i?void 0:i.some((t=>t.pipelineAgg===e.id)):_(t)&&e.id===t.field}));return[...i,...i.flatMap((e=>I(e,t)))]},A=[{label:"Avg",value:"avg"},{label:"Min",value:"min"},{label:"Max",value:"max"},{label:"Sum",value:"sum"},{label:"Count",value:"count"},{label:"Std Dev",value:"std_deviation"},{label:"Std Dev Upper",value:"std_deviation_bounds_upper"},{label:"Std Dev Lower",value:"std_deviation_bounds_lower"}],N=[{label:"Simple",value:"simple"},{label:"Linear",value:"linear"},{label:"Exponentially Weighted",value:"ewma"},{label:"Holt Linear",value:"holt"},{label:"Holt Winters",value:"holt_winters"}],P="@HIGHLIGHT@",$="@/HIGHLIGHT@";function D(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"1";return{type:"count",id:e}}function V(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"1";return{type:"date_histogram",id:e,settings:{interval:"auto"}}}const E=(e,t)=>e.find((e=>e.id===t));function T(e,t){var i;return!(null==e||null===(i=e.metrics)||void 0===i||!i.some((e=>e.type===t)))}var B=i(10129);const R=e=>_(e)?`${M[e.type].label} ${e.field}`:M[e.type].label,L=e=>Object.entries(e).reduce(((e,t)=>{let[i,s]=t;if(null==s)return Object.assign({},e);if(Array.isArray(s)&&0===s.length)return Object.assign({},e);if("string"==typeof s&&0===s.length)return Object.assign({},e);if(!Array.isArray(s)&&"object"==typeof s){const t=L(s);return 0===Object.keys(t).length?Object.assign({},e):Object.assign({},e,{[i]:t})}return Object.assign({},e,{[i]:s})}),{}),z=e=>{const t=e.match(/^(\d+)/);return t?t[1]:void 0},W=e=>{var t,i,s,a;return("object"==typeof(null===(t=e.settings)||void 0===t?void 0:t.script)?null===(i=e.settings)||void 0===i||null===(s=i.script)||void 0===s?void 0:s.inline:null===(a=e.settings)||void 0===a?void 0:a.script)||""},H=e=>{if("string"==typeof e)return(0,B.valid)(e)||"8.0.0";switch(e){case 2:return"2.0.0";case 5:return"5.0.0";case 56:return"5.6.0";case 60:return"6.0.0";case 70:return"7.0.0";default:return"8.0.0"}},Q=e=>!!(0,B.gte)(e,"7.10.0");var U=i(14066);const Y=(0,U.PH)("@metrics/add"),G=(0,U.PH)("@metrics/remove"),J=(0,U.PH)("@metrics/toggle_visibility"),K=(0,U.PH)("@metrics/change_field"),Z=(0,U.PH)("@metrics/change_type"),X=(0,U.PH)("@metrics/change_attr"),ee=(0,U.PH)("@metrics/change_setting"),te=(0,U.PH)("@metrics/change_meta"),ie=(0,U.PH)("init"),se=(0,U.PH)("change_query"),ae=(0,U.PH)("change_alias_pattern"),ne=(e,t)=>se.match(t)?t.payload:ie.match(t)?e||"":e,le=(e,t)=>ae.match(t)?t.payload:ie.match(t)?e||"":e;var re=i(69202);const oe={terms:{label:"Terms",requiresField:!0,defaultSettings:{min_doc_count:"1",size:"10",order:"desc",orderBy:"_term"}},filters:{label:"Filters",requiresField:!1,defaultSettings:{filters:[{label:"",query:"*"}]}},geohash_grid:{label:"Geo Hash Grid",requiresField:!0,defaultSettings:{precision:"3"}},date_histogram:{label:"Date Histogram",requiresField:!0,defaultSettings:{interval:"auto",min_doc_count:"0",trimEdges:"0",timeZone:re.RQ.utc}},histogram:{label:"Histogram",requiresField:!0,defaultSettings:{interval:"1000",min_doc_count:"0"}}},de=[{label:"Term value",value:"_term"},{label:"Doc Count",value:"_count"}],ue=[{label:"Top",value:"desc"},{label:"Bottom",value:"asc"}],ce=[{label:"No limit",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"5",value:"5"},{label:"10",value:"10"},{label:"15",value:"15"},{label:"20",value:"20"}],ge=(0,U.PH)("@bucketAggs/add"),pe=(0,U.PH)("@bucketAggs/remove"),he=(0,U.PH)("@bucketAggs/change_type"),me=(0,U.PH)("@bucketAggs/change_field"),ve=(0,U.PH)("@bucketAggs/change_setting"),fe=(e,t)=>{if(Y.match(t))return[...e,D(t.payload)];if(G.match(t)){const i=e.find((e=>e.id===t.payload)),s=[i,...I(i,e)],a=e.filter((e=>!s.some((t=>t.id===e.id))));return 0===a.length?[D("1")]:a}return Z.match(t)?e.filter((e=>!M[t.payload.type].isSingleMetric||e.id===t.payload.id)).map((e=>e.id!==t.payload.id?e:Object.assign({id:e.id,type:t.payload.type},M[t.payload.type].defaults))):K.match(t)?e.map((e=>{if(e.id!==t.payload.id)return e;const i=Object.assign({},e,{field:t.payload.field});return k(e)?Object.assign({},i,{pipelineAgg:t.payload.field}):i})):J.match(t)?e.map((e=>e.id!==t.payload?e:Object.assign({},e,{hide:!e.hide}))):ee.match(t)?e.map((e=>{if(e.id!==t.payload.metric.id)return e;if(S(e)){const i=L(Object.assign({},e.settings,{[t.payload.settingName]:t.payload.newValue}));return Object.assign({},e,{settings:Object.assign({},i)})}return e})):te.match(t)?e.map((e=>e.id!==t.payload.metric.id?e:(e=>M[e.type].hasMeta)(e)?Object.assign({},e,{meta:Object.assign({},e.meta,{[t.payload.meta]:t.payload.newValue})}):e)):X.match(t)?e.map((e=>e.id!==t.payload.metric.id?e:Object.assign({},e,{[t.payload.attribute]:t.payload.newValue}))):ie.match(t)?null!=e&&e.length?e:[D("1")]:e};var be=i(45916);const ye=(0,n.createContext)(void 0),xe=(0,n.createContext)(void 0),je=(0,n.createContext)(void 0),_e=e=>{let{children:t,onChange:i,onRunQuery:s,query:a,datasource:l,range:r}=e;const o=(0,n.useCallback)((e=>{i(e),s()}),[i,s]),d=(u={query:ne,alias:le,metrics:fe,bucketAggs:(c=l.timeField,(e,t)=>{if(ge.match(t)){const i={id:t.payload,type:"terms",settings:oe.terms.defaultSettings},s=e[e.length-1];return"date_histogram"===(null==s?void 0:s.type)?[...e.slice(0,e.length-1),i,s]:[...e,i]}return pe.match(t)?e.filter((e=>e.id!==t.payload)):he.match(t)?e.map((e=>e.id!==t.payload.id?e:{id:e.id,type:t.payload.newType,settings:oe[t.payload.newType].defaultSettings})):me.match(t)?e.map((e=>e.id!==t.payload.id?e:Object.assign({},e,{field:t.payload.newField}))):Z.match(t)?M[t.payload.type].isSingleMetric?[]:0===e.length?[Object.assign({},V("2"),{field:c})]:e:ve.match(t)?e.map((e=>{if(e.id!==t.payload.bucketAgg.id)return e;const i=L(Object.assign({},e.settings,{[t.payload.settingName]:t.payload.newValue}));return Object.assign({},e,{settings:Object.assign({},i)})})):ie.match(t)?null!=e&&e.length?e:[Object.assign({},V("2"),{field:c})]:e})},(e,t)=>{const i={};for(const s in u)i[s]=u[s](e[s],t);return i});var u,c;const g=p((e=>o(Object.assign({},a,e,{timeField:l.timeField}))),a,d),m=!a.metrics||!a.bucketAggs||void 0===a.query,[v,f]=(0,n.useState)(m);return(0,n.useEffect)((()=>{v&&(g(ie()),f(!1))}),[v,g]),m?null:(0,be.jsx)(ye.Provider,{value:l,children:(0,be.jsx)(xe.Provider,{value:a,children:(0,be.jsx)(je.Provider,{value:r,children:(0,be.jsx)(h.Provider,{value:g,children:t})})})})},ke=e=>()=>{const t=(0,n.useContext)(e);if(!t)throw new Error("use ElasticsearchProvider first.");return t},we=ke(xe),Fe=ke(ye),Se=ke(je),Oe=e=>e.id,qe=e=>parseInt(e,10);var Me=i(24085);const Ce=["iconName","onClick","className","label"];const Ie=a.css`
  clip: rect(0 0 0 0);
  clip-path: inset(50%);
  height: 1px;
  overflow: hidden;
  position: absolute;
  white-space: nowrap;
  width: 1px;
`,Ae=e=>{let{iconName:t,onClick:i,className:s,label:n}=e,l=function(e,t){if(null==e)return{};var i,s,a={},n=Object.keys(e);for(s=0;s<n.length;s++)i=n[s],t.indexOf(i)>=0||(a[i]=e[i]);return a}(e,Ce);return(0,be.jsxs)("button",Object.assign({className:(0,a.cx)("gf-form-label gf-form-label--btn query-part",s),onClick:i},l,{children:[(0,be.jsx)("span",{className:Ie,children:n}),(0,be.jsx)(Me.J,{name:t,"aria-hidden":"true"})]}))};var Ne=i(82897),Pe=i(78454),$e=i(55667),De=i(85965);const Ve=e=>{let{children:t,label:i,onRemoveClick:s,onHideClick:a,hidden:n=!1}=e;const l=(0,o.wW)(Ee);return(0,be.jsxs)(Pe.Z,{children:[(0,be.jsx)($e.m,{children:(0,be.jsxs)(u.W,{width:17,as:"div",children:[(0,be.jsx)("span",{children:i}),(0,be.jsxs)("span",{className:l.iconWrapper,children:[a&&(0,be.jsx)(De.h,{name:n?"eye-slash":"eye",onClick:a,size:"sm","aria-pressed":n,"aria-label":"hide metric",className:l.icon,type:"button"}),(0,be.jsx)(De.h,{name:"trash-alt",size:"sm",className:l.icon,onClick:s||Ne.noop,disabled:!s,"aria-label":"remove metric",type:"button"})]})]})}),t]})},Ee=e=>({iconWrapper:a.css`
      display: flex;
    `,icon:a.css`
      color: ${e.colors.text.secondary};
      margin-left: ${e.spacing(.25)};
    `});var Te=i(32302),Be=i(96002),Re=i(58799);const Le=e=>oe[e.type].requiresField,ze=["date_histogram","histogram","terms","filters","geohash_grid"],We=e=>{if(t=e,q.includes(t))return"cardinality"===e?[]:["number"];var t;if((e=>ze.includes(e))(e))switch(e){case"date_histogram":return["date"];case"geohash_grid":return["geo_point"];case"histogram":return["number"];default:return[]}return[]},He=e=>{let{text:t}=e;return{label:t,value:t}},Qe=e=>{const t=Fe(),i=Se(),s=Array.isArray(e)?e:We(e);let a;return async e=>(a||(a=await(0,Re.n)(t.getFields(s,i))),a.filter((t=>{let{text:i}=t;return void 0===e||i.includes(e)})).map(He))},Ue=a.css`
  min-width: 150px;
`,Ye=e=>{let{label:t,children:i,hidden:s=!1}=e;const[l,r]=(0,n.useState)(!1),d=((e,t)=>({wrapper:a.css`
      max-width: 500px;
      display: flex;
      flex-direction: column;
    `,settingsWrapper:a.css`
      padding-top: ${e.spacing(.5)};
    `,icon:a.css`
      margin-right: ${e.spacing(.5)};
    `,button:a.css`
      justify-content: start;
      ${t&&a.css`
        color: ${e.colors.text.disabled};
      `}
    `}))((0,o.l4)(),s);return(0,be.jsx)($e.m,{children:(0,be.jsxs)("div",{className:(0,a.cx)(d.wrapper),children:[(0,be.jsxs)("button",{className:(0,a.cx)("gf-form-label query-part",d.button,Ue),onClick:()=>r(!l),"aria-expanded":l,type:"button",children:[(0,be.jsx)(Me.J,{name:l?"angle-down":"angle-right","aria-hidden":"true",className:d.icon}),t]}),l&&(0,be.jsx)("div",{className:d.settingsWrapper,children:i})]})})};var Ge=i(61884),Je=i(15601);const Ke=e=>{let{options:t,value:i,onChange:s}=e;const[a,l]=(0,n.useState)(((e,t)=>{return void 0===t||e.some((i=t,e=>{let{value:t}=e;return t===i}))?e:[...e,{value:t,label:t}];var i})(t,i));return{onCreateOption:e=>{var t;t=e,l([...a,{value:t,label:t}]),s({value:e})},onChange:s,allowCustomValue:!0,options:a,value:i}},Ze=[{label:"auto",value:"auto"},{label:"10s",value:"10s"},{label:"1m",value:"1m"},{label:"5m",value:"5m"},{label:"10m",value:"10m"},{label:"20m",value:"20m"},{label:"1h",value:"1h"},{label:"1d",value:"1d"}],Xe=(e,t,i)=>{var s;return!i.some((s=e,e=>{let{value:t}=e;return t===s}))&&e.trim().length>0},et=(e,t)=>{var i;return(null===(i=e.value)||void 0===i?void 0:i.startsWith(t))||!1},tt=e=>{var t,i,s,a,l,r,o,d,u,p;let{bucketAgg:h}=e;const v=m(),{current:f}=(0,n.useRef)((0,Ne.uniqueId)("es-date_histogram-"));return(0,be.jsxs)(be.Fragment,{children:[(0,be.jsx)(c._,Object.assign({label:"Interval"},ht,{children:(0,be.jsx)(Ge.Ph,Object.assign({inputId:(0,Ne.uniqueId)("es-date_histogram-interval"),isValidNewOption:Xe,filterOption:et},Ke({options:Ze,value:(null===(t=h.settings)||void 0===t?void 0:t.interval)||(null===(i=oe.date_histogram.defaultSettings)||void 0===i?void 0:i.interval),onChange:e=>{let{value:t}=e;return v(ve({bucketAgg:h,settingName:"interval",newValue:t}))}})))})),(0,be.jsx)(c._,Object.assign({label:"Min Doc Count"},ht,{children:(0,be.jsx)(g.I,{id:`${f}-min_doc_count`,onBlur:e=>v(ve({bucketAgg:h,settingName:"min_doc_count",newValue:e.target.value})),defaultValue:(null===(s=h.settings)||void 0===s?void 0:s.min_doc_count)||(null===(a=oe.date_histogram.defaultSettings)||void 0===a?void 0:a.min_doc_count)})})),(0,be.jsx)(c._,Object.assign({label:"Trim Edges"},ht,{tooltip:"Trim the edges on the timeseries datapoints",children:(0,be.jsx)(g.I,{id:`${f}-trime_edges`,onBlur:e=>v(ve({bucketAgg:h,settingName:"trimEdges",newValue:e.target.value})),defaultValue:(null===(l=h.settings)||void 0===l?void 0:l.trimEdges)||(null===(r=oe.date_histogram.defaultSettings)||void 0===r?void 0:r.trimEdges)})})),(0,be.jsx)(c._,Object.assign({label:"Offset"},ht,{tooltip:"Change the start value of each bucket by the specified positive (+) or negative offset (-) duration, such as 1h for an hour, or 1d for a day",children:(0,be.jsx)(g.I,{id:`${f}-offset`,onBlur:e=>v(ve({bucketAgg:h,settingName:"offset",newValue:e.target.value})),defaultValue:(null===(o=h.settings)||void 0===o?void 0:o.offset)||(null===(d=oe.date_histogram.defaultSettings)||void 0===d?void 0:d.offset)})})),(0,be.jsx)(c._,Object.assign({label:"Timezone"},ht,{children:(0,be.jsx)(Je.O,{value:(null===(u=h.settings)||void 0===u?void 0:u.timeZone)||(null===(p=oe.date_histogram.defaultSettings)||void 0===p?void 0:p.timeZone),includeInternal:[re.RQ.utc],onChange:e=>{v(ve({bucketAgg:h,settingName:"timeZone",newValue:e}))}})}))]})},it=e=>{let{index:t,onAdd:i,onRemove:s,elements:n}=e;return(0,be.jsxs)("div",{className:a.css`
        display: flex;
      `,children:[0===t&&(0,be.jsx)(Ae,{iconName:"plus",onClick:i,label:"add"}),n.length>=2&&(0,be.jsx)(Ae,{iconName:"minus",onClick:s,label:"remove"})]})},st=(0,U.PH)("@bucketAggregations/filter/add"),at=(0,U.PH)("@bucketAggregations/filter/remove"),nt=(0,U.PH)("@bucketAggregations/filter/change"),lt=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;return st.match(t)?[...e,{label:"",query:"*"}]:at.match(t)?e.slice(0,t.payload).concat(e.slice(t.payload+1)):nt.match(t)?e.map(((e,i)=>i!==t.payload.index?e:t.payload.filter)):e},rt=e=>{var t,i,s,l;let{bucketAgg:r}=e;const{current:o}=(0,n.useRef)((0,Ne.uniqueId)("es-filters-")),u=m(),h=p((e=>u(ve({bucketAgg:r,settingName:"filters",newValue:e}))),null===(t=r.settings)||void 0===t?void 0:t.filters,lt);return(0,n.useEffect)((()=>{var e,t;null!==(e=r.settings)&&void 0!==e&&null!==(t=e.filters)&&void 0!==t&&t.length||h(st())}),[h,null===(i=r.settings)||void 0===i||null===(s=i.filters)||void 0===s?void 0:s.length]),(0,be.jsx)(be.Fragment,{children:(0,be.jsx)("div",{className:a.css`
          display: flex;
          flex-direction: column;
        `,children:null===(l=r.settings)||void 0===l?void 0:l.filters.map(((e,t)=>{var i;return(0,be.jsxs)("div",{className:a.css`
              display: flex;
            `,children:[(0,be.jsx)(c._,{label:"Query",labelWidth:8,children:(0,be.jsx)("div",{className:a.css`
                  width: 150px;
                `,children:(0,be.jsx)(d.q,{placeholder:"Lucene Query",portalOrigin:"elasticsearch",onBlur:()=>{},onChange:i=>h(nt({index:t,filter:Object.assign({},e,{query:i})})),query:e.query})})}),(0,be.jsx)(c._,{label:"Label",labelWidth:8,children:(0,be.jsx)(g.I,{width:16,id:`${o}-label-${t}`,placeholder:"Label",onBlur:i=>h(nt({index:t,filter:Object.assign({},e,{label:i.target.value})})),defaultValue:e.label})}),(0,be.jsx)(it,{index:t,elements:(null===(i=r.settings)||void 0===i?void 0:i.filters)||[],onAdd:()=>h(st()),onRemove:()=>h(at(t))})]},t)}))})})},ot=e=>{var t,i,s,a,l,r,o,d,u,p;let{bucketAgg:h}=e;const{metrics:v}=we(),f=gt(v),{current:b}=(0,n.useRef)((0,Ne.uniqueId)("es-terms-")),y=m();return(0,be.jsxs)(be.Fragment,{children:[(0,be.jsx)(c._,Object.assign({label:"Order"},ht,{children:(0,be.jsx)(Ge.Ph,{inputId:`${b}-order`,onChange:e=>y(ve({bucketAgg:h,settingName:"order",newValue:e.value})),options:ue,value:(null===(t=h.settings)||void 0===t?void 0:t.order)||(null===(i=oe.terms.defaultSettings)||void 0===i?void 0:i.order)})})),(0,be.jsx)(c._,Object.assign({label:"Size"},ht,{children:(0,be.jsx)(Ge.Ph,Object.assign({inputId:`${b}-size`},Ke({options:ce,value:(null===(s=h.settings)||void 0===s?void 0:s.size)||(null===(a=oe.terms.defaultSettings)||void 0===a?void 0:a.size),onChange(e){let{value:t}=e;y(ve({bucketAgg:h,settingName:"size",newValue:t}))}})))})),(0,be.jsx)(c._,Object.assign({label:"Min Doc Count"},ht,{children:(0,be.jsx)(g.I,{id:`${b}-min_doc_count`,onBlur:e=>y(ve({bucketAgg:h,settingName:"min_doc_count",newValue:e.target.value})),defaultValue:(null===(l=h.settings)||void 0===l?void 0:l.min_doc_count)||(null===(r=oe.terms.defaultSettings)||void 0===r?void 0:r.min_doc_count)})})),(0,be.jsx)(c._,Object.assign({label:"Order By"},ht,{children:(0,be.jsx)(Ge.Ph,{inputId:`${b}-order_by`,onChange:e=>y(ve({bucketAgg:h,settingName:"orderBy",newValue:e.value})),options:f,value:(null===(o=h.settings)||void 0===o?void 0:o.orderBy)||(null===(d=oe.terms.defaultSettings)||void 0===d?void 0:d.orderBy)})})),(0,be.jsx)(c._,Object.assign({label:"Missing"},ht,{children:(0,be.jsx)(g.I,{id:`${b}-missing`,onBlur:e=>y(ve({bucketAgg:h,settingName:"missing",newValue:e.target.value})),defaultValue:(null===(u=h.settings)||void 0===u?void 0:u.missing)||(null===(p=oe.terms.defaultSettings)||void 0===p?void 0:p.missing)})}))]})};function dt(e){if(!e.meta)return[];return Object.keys(e.meta).filter((t=>{var i;return null===(i=e.meta)||void 0===i?void 0:i[t]})).map((t=>{let i=t;return"std_deviation_bounds_lower"===t&&(i="std_lower"),"std_deviation_bounds_upper"===t&&(i="std_upper"),{label:`${R(e)} (${i})`,value:`${e.id}[${i}]`}}))}function ut(e){var t;return null!==(t=e.settings)&&void 0!==t&&t.percents?e.settings.percents.map((t=>{const i=/^\d+\.\d+/.test(`${t}`)?t:`${t}.0`;return{label:`${R(e)} (${t})`,value:`${e.id}[${i}]`}})):[]}function ct(e){return"top_metrics"!==e.type&&!k(e)}const gt=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const t=e.filter(ct).flatMap((e=>"extended_stats"===e.type?dt(e):"percentiles"===e.type?ut(e):{label:R(e),value:e.id}));return[...de,...t]},pt=e=>t=>t.value===e,ht={labelWidth:16},mt=e=>{var t,i,s,a,l,r;let{bucketAgg:o}=e;const{current:d}=(0,n.useRef)((0,Ne.uniqueId)("es-setting-")),u=m(),p=(e=>{const{metrics:t}=we();switch(e.type){case"terms":{var i,s,a,n;const r=(null===(i=e.settings)||void 0===i?void 0:i.order)||"desc",o=(null===(s=e.settings)||void 0===s?void 0:s.size)||"10",d=parseInt((null===(a=e.settings)||void 0===a?void 0:a.min_doc_count)||"0",10),u=(null===(n=e.settings)||void 0===n?void 0:n.orderBy)||"_term";let c="";var l;if("0"!==o)c=`${null===(l=ue.find(pt(r)))||void 0===l?void 0:l.label} ${o}, `;d>0&&(c+=`Min Doc Count: ${d}, `),c+="Order by: ";const g=de.find(pt(u));if(g)c+=g.label;else{const e=null==t?void 0:t.find((e=>e.id===z(u)));c+=e?R(e):"metric not found"}return"0"===o&&(c+=` (${r})`),c}case"histogram":{var r,o;const t=(null===(r=e.settings)||void 0===r?void 0:r.interval)||1e3,i=(null===(o=e.settings)||void 0===o?void 0:o.min_doc_count)||1;return`Interval: ${t}${i>0?`, Min Doc Count: ${i}`:""}`}case"filters":var d,u;return`Filter Queries (${((null===(d=e.settings)||void 0===d?void 0:d.filters)||(null===(u=oe.filters.defaultSettings)||void 0===u?void 0:u.filters)).length})`;case"geohash_grid":var c;return`Precision: ${Math.max(Math.min(parseInt((null===(c=e.settings)||void 0===c?void 0:c.precision)||"5",10),12),1)}`;case"date_histogram":{var g,p,h;const t=(null===(g=e.settings)||void 0===g?void 0:g.interval)||"auto",i=(null===(p=e.settings)||void 0===p?void 0:p.min_doc_count)||0,s=(null===(h=e.settings)||void 0===h?void 0:h.trimEdges)||0;let a=`Interval: ${t}`;return i>0&&(a+=`, Min Doc Count: ${i}`),s>0&&(a+=`, Trim edges: ${s}`),a}default:return"Settings"}})(o);return(0,be.jsxs)(Ye,{label:p,children:["terms"===o.type&&(0,be.jsx)(ot,{bucketAgg:o}),"date_histogram"===o.type&&(0,be.jsx)(tt,{bucketAgg:o}),"filters"===o.type&&(0,be.jsx)(rt,{bucketAgg:o}),"geohash_grid"===o.type&&(0,be.jsx)(c._,Object.assign({label:"Precision"},ht,{children:(0,be.jsx)(g.I,{id:`${d}-geohash_grid-precision`,onBlur:e=>u(ve({bucketAgg:o,settingName:"precision",newValue:e.target.value})),defaultValue:(null===(t=o.settings)||void 0===t?void 0:t.precision)||(null===(i=oe[o.type].defaultSettings)||void 0===i?void 0:i.precision)})})),"histogram"===o.type&&(0,be.jsxs)(be.Fragment,{children:[(0,be.jsx)(c._,Object.assign({label:"Interval"},ht,{children:(0,be.jsx)(g.I,{id:`${d}-histogram-interval`,onBlur:e=>u(ve({bucketAgg:o,settingName:"interval",newValue:e.target.value})),defaultValue:(null===(s=o.settings)||void 0===s?void 0:s.interval)||(null===(a=oe[o.type].defaultSettings)||void 0===a?void 0:a.interval)})})),(0,be.jsx)(c._,Object.assign({label:"Min Doc Count"},ht,{children:(0,be.jsx)(g.I,{id:`${d}-histogram-min_doc_count`,onBlur:e=>u(ve({bucketAgg:o,settingName:"min_doc_count",newValue:e.target.value})),defaultValue:(null===(l=o.settings)||void 0===l?void 0:l.min_doc_count)||(null===(r=oe[o.type].defaultSettings)||void 0===r?void 0:r.min_doc_count)})}))]})]})},vt=Object.entries(oe).map((e=>{let[t,{label:i}]=e;return{label:i,value:t}})),ft=e=>{let{value:t}=e;const i=m(),s=Qe(t.type);return(0,be.jsxs)(be.Fragment,{children:[(0,be.jsxs)($e.m,{children:[(0,be.jsx)(Te.X,{className:Ue,options:vt,onChange:e=>i(he({id:t.id,newType:e.value})),value:(a=t,{label:oe[a.type].label,value:a.type})}),Le(t)&&(0,be.jsx)(Be.V,{className:Ue,loadOptions:s,onChange:e=>i(me({id:t.id,newField:e.value})),placeholder:"Select Field",value:t.field})]}),(0,be.jsx)(mt,{bucketAgg:t})]});var a},bt=e=>{let{nextId:t}=e;const i=m(),{bucketAggs:s}=we(),a=(null==s?void 0:s.length)||0;return(0,be.jsx)(be.Fragment,{children:s.map(((e,s)=>(0,be.jsxs)(Ve,{label:0===s?"Group By":"Then By",onRemoveClick:a>1&&(()=>i(pe(e.id))),children:[(0,be.jsx)(ft,{value:e}),0===s&&(0,be.jsx)(Ae,{iconName:"plus",onClick:()=>i(ge(t)),label:"add"})]},`${e.type}-${e.id}`)))})},yt=a.css`
  white-space: nowrap;
`,xt=e=>({label:R(e),value:e}),jt=e=>{let{options:t,onChange:i,className:s,value:n}=e;const l=t.find((e=>e.id===n));return(0,be.jsx)(Te.X,{className:(0,a.cx)(s,yt),options:(r=t,r.map(xt)),onChange:i,placeholder:"Select Metric",value:l?xt(l):void 0});var r};var _t=i(72786);function kt(e){let{label:t,settingName:i,metric:s,placeholder:a,tooltip:l}=e;const r=m(),[o]=(0,n.useState)((0,Ne.uniqueId)("es-field-id-")),d=s.settings;let u=(null==d?void 0:d[i])||"";return"script"===i&&(u=W(s)),(0,be.jsx)(c._,{label:t,labelWidth:16,tooltip:l,children:(0,be.jsx)(g.I,{id:o,placeholder:a,onBlur:e=>r(ee({metric:s,settingName:i,newValue:e.target.value})),defaultValue:u})})}const wt=(0,U.PH)("@pipelineVariables/add"),Ft=(0,U.PH)("@pipelineVariables/remove"),St=(0,U.PH)("@pipelineVariables/rename"),Ot=(0,U.PH)("@pipelineVariables/change_metric"),qt=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;return wt.match(t)?[...e,v(f(e))]:Ft.match(t)?e.slice(0,t.payload).concat(e.slice(t.payload+1)):St.match(t)?e.map(((e,i)=>i!==t.payload.index?e:Object.assign({},e,{name:t.payload.newName}))):Ot.match(t)?e.map(((e,i)=>i!==t.payload.index?e:Object.assign({},e,{pipelineAgg:t.payload.newMetric}))):e};var Mt;const Ct=e=>{var t;let{value:i,previousMetrics:s}=e;const l=m(),r=p((e=>l(X({metric:i,attribute:"pipelineVariables",newValue:e}))),i.pipelineVariables,qt);return(0,n.useEffect)((()=>{var e;null!==(e=i.pipelineVariables)&&void 0!==e&&e.length||r(wt())}),[r,null===(t=i.pipelineVariables)||void 0===t?void 0:t.length]),(0,be.jsxs)(be.Fragment,{children:[(0,be.jsxs)("div",{className:a.css`
          display: flex;
        `,children:[Mt||(Mt=(0,be.jsx)(u.W,{width:16,children:"Variables"})),(0,be.jsx)("div",{className:a.css`
            display: grid;
            grid-template-columns: 1fr auto;
            row-gap: 4px;
            margin-bottom: 4px;
          `,children:i.pipelineVariables.map(((e,t)=>(0,be.jsxs)(n.Fragment,{children:[(0,be.jsxs)("div",{className:a.css`
                  display: grid;
                  column-gap: 4px;
                  grid-template-columns: auto auto;
                `,children:[(0,be.jsx)(g.I,{"aria-label":"Variable name",defaultValue:e.name,placeholder:"Variable Name",onBlur:e=>r(St({newName:e.target.value,index:t}))}),(0,be.jsx)(jt,{onChange:e=>r(Ot({newMetric:e.value.id,index:t})),options:s,value:e.pipelineAgg})]}),(0,be.jsx)(it,{index:t,elements:i.pipelineVariables||[],onAdd:()=>r(wt()),onRemove:()=>r(Ft(t))})]},(0,Ne.uniqueId)("es-bs-"))))})]}),(0,be.jsx)(kt,{label:"Script",metric:i,settingName:"script",tooltip:"Elasticsearch v5.0 and above: Scripting language is Painless. Use params.<var> to reference a variable. Elasticsearch pre-v5.0: Scripting language is per default Groovy if not changed. For Groovy use <var> to reference a variable.",placeholder:"params.var1 / params.var2"})]})},It=e=>{var t,i,s,a,l,r,o,d,u,p,h,v;let{metric:f}=e;const j=m(),{current:_}=(0,n.useRef)((0,Ne.uniqueId)("es-moving-avg-"));return(0,be.jsxs)(be.Fragment,{children:[(0,be.jsx)(c._,{label:"Model",labelWidth:16,children:(0,be.jsx)(Ge.Ph,{inputId:`${_}-model`,onChange:e=>j(ee({metric:f,settingName:"model",newValue:e.value})),options:N,value:null===(t=f.settings)||void 0===t?void 0:t.model})}),(0,be.jsx)(kt,{label:"Window",settingName:"window",metric:f,placeholder:"5"}),(0,be.jsx)(kt,{label:"Predict",settingName:"predict",metric:f}),(b(f)||y(f)||x(f))&&(0,be.jsx)(c._,{label:"Alpha",labelWidth:16,children:(0,be.jsx)(g.I,{id:`${_}-alpha`,onBlur:e=>{var t;return j(ee({metric:f,settingName:"settings",newValue:Object.assign({},null===(t=f.settings)||void 0===t?void 0:t.settings,{alpha:e.target.value})}))},defaultValue:null===(i=f.settings)||void 0===i||null===(s=i.settings)||void 0===s?void 0:s.alpha})}),(y(f)||x(f))&&(0,be.jsx)(c._,{label:"Beta",labelWidth:16,children:(0,be.jsx)(g.I,{id:`${_}-beta`,onBlur:e=>{var t;return j(ee({metric:f,settingName:"settings",newValue:Object.assign({},null===(t=f.settings)||void 0===t?void 0:t.settings,{beta:e.target.value})}))},defaultValue:null===(a=f.settings)||void 0===a||null===(l=a.settings)||void 0===l?void 0:l.beta})}),x(f)&&(0,be.jsxs)(be.Fragment,{children:[(0,be.jsx)(c._,{label:"Gamma",labelWidth:16,children:(0,be.jsx)(g.I,{id:`${_}-gamma`,onBlur:e=>{var t;return j(ee({metric:f,settingName:"settings",newValue:Object.assign({},null===(t=f.settings)||void 0===t?void 0:t.settings,{gamma:e.target.value})}))},defaultValue:null===(r=f.settings)||void 0===r||null===(o=r.settings)||void 0===o?void 0:o.gamma})}),(0,be.jsx)(c._,{label:"Period",labelWidth:16,children:(0,be.jsx)(g.I,{id:`${_}-period`,onBlur:e=>{var t;return j(ee({metric:f,settingName:"settings",newValue:Object.assign({},null===(t=f.settings)||void 0===t?void 0:t.settings,{period:e.target.value})}))},defaultValue:null===(d=f.settings)||void 0===d||null===(u=d.settings)||void 0===u?void 0:u.period})}),(0,be.jsx)(c._,{label:"Pad",labelWidth:16,children:(0,be.jsx)(_t.x,{id:`${_}-pad`,onChange:e=>{var t;return j(ee({metric:f,settingName:"settings",newValue:Object.assign({},null===(t=f.settings)||void 0===t?void 0:t.settings,{pad:e.target.checked})}))},checked:!(null===(p=f.settings)||void 0===p||null===(h=p.settings)||void 0===h||!h.pad)})})]}),(b(f)||y(f)||x(f))&&(0,be.jsx)(c._,{label:"Minimize",labelWidth:16,children:(0,be.jsx)(_t.x,{id:`${_}-minimize`,onChange:e=>j(ee({metric:f,settingName:"minimize",newValue:e.target.checked})),checked:!(null===(v=f.settings)||void 0===v||!v.minimize)})})]})},At=e=>({value:e,label:e}),Nt=e=>{var t,i,s,n;let{metric:l}=e;const r=m(),o=Qe(["number","date"]),d=Qe(l.type);return(0,be.jsxs)(be.Fragment,{children:[(0,be.jsx)(c._,{label:"Metrics",labelWidth:16,children:(0,be.jsx)(Ge.M8,{onChange:e=>r(ee({metric:l,settingName:"metrics",newValue:e.map((e=>e.value))})),loadOptions:d,value:null===(t=l.settings)||void 0===t||null===(i=t.metrics)||void 0===i?void 0:i.map(At),closeMenuOnSelect:!1,defaultOptions:!0})}),(0,be.jsx)(c._,{label:"Order",labelWidth:16,children:(0,be.jsx)(Ge.Ph,{onChange:e=>r(ee({metric:l,settingName:"order",newValue:e.value})),options:ue,value:null===(s=l.settings)||void 0===s?void 0:s.order})}),(0,be.jsx)(c._,{label:"Order By",labelWidth:16,className:a.css`
          & > div {
            width: 100%;
          }
        `,children:(0,be.jsx)(Be.V,{className:a.css`
            margin-right: 0;
          `,loadOptions:o,onChange:e=>r(ee({metric:l,settingName:"orderBy",newValue:e.value})),placeholder:"Select Field",value:null===(n=l.settings)||void 0===n?void 0:n.orderBy})})]})},Pt={labelWidth:16},$t=e=>{var t,i,s,a,l,r,o;let{metric:d,previousMetrics:u}=e;const{current:p}=(0,n.useRef)((0,Ne.uniqueId)("es-setting-")),h=m(),v=(e=>{var t,i,s;switch(e.type){case"cardinality":var a;return`Precision threshold: ${(null===(a=e.settings)||void 0===a?void 0:a.precision_threshold)||""}`;case"percentiles":var n;return null!==(t=e.settings)&&void 0!==t&&t.percents&&(null===(i=e.settings)||void 0===i||null===(s=i.percents)||void 0===s?void 0:s.length)>=1?`Values: ${null===(n=e.settings)||void 0===n?void 0:n.percents}`:"Percents: Default";case"extended_stats":{const t=Object.entries(e.meta||{}).map((e=>{var t;let[i,s]=e;return s&&(null===(t=A.find((e=>t=>t.value===e)(i)))||void 0===t?void 0:t.label)})).filter(Boolean);return`Stats: ${t.length>0?t.join(", "):"None selected"}`}case"raw_document":case"raw_data":var l;return`Size: ${(null===(l=e.settings)||void 0===l?void 0:l.size)||500}`;default:return"Options"}})(d),f=we();return(0,be.jsxs)(Ye,{label:v,hidden:d.hide,children:["derivative"===d.type&&(0,be.jsx)(kt,{label:"Unit",metric:d,settingName:"unit"}),"serial_diff"===d.type&&(0,be.jsx)(kt,{label:"Lag",metric:d,settingName:"lag",placeholder:"1"}),"cumulative_sum"===d.type&&(0,be.jsx)(kt,{label:"Format",metric:d,settingName:"format"}),"moving_avg"===d.type&&(0,be.jsx)(It,{metric:d}),"moving_fn"===d.type&&(0,be.jsxs)(be.Fragment,{children:[(0,be.jsx)(kt,{label:"Window",metric:d,settingName:"window"}),(0,be.jsx)(kt,{label:"Script",metric:d,settingName:"script"}),(0,be.jsx)(kt,{label:"Shift",metric:d,settingName:"shift"})]}),"top_metrics"===d.type&&(0,be.jsx)(Nt,{metric:d}),"bucket_script"===d.type&&(0,be.jsx)(Ct,{value:d,previousMetrics:u}),("raw_data"===d.type||"raw_document"===d.type)&&(0,be.jsx)(c._,Object.assign({label:"Size"},Pt,{children:(0,be.jsx)(g.I,{id:`ES-query-${f.refId}_metric-${d.id}-size`,onBlur:e=>h(ee({metric:d,settingName:"size",newValue:e.target.value})),defaultValue:null!==(t=null===(i=d.settings)||void 0===i?void 0:i.size)&&void 0!==t?t:null===(s=M.raw_data.defaults.settings)||void 0===s?void 0:s.size})})),"logs"===d.type&&(0,be.jsx)(kt,{label:"Limit",metric:d,settingName:"limit",placeholder:"500"}),"cardinality"===d.type&&(0,be.jsx)(kt,{label:"Precision Threshold",metric:d,settingName:"precision_threshold"}),"extended_stats"===d.type&&(0,be.jsxs)(be.Fragment,{children:[A.map((e=>{var t,i,s;return(0,be.jsx)(Dt,{stat:e,onChange:t=>h(te({metric:d,meta:e.value,newValue:t})),value:void 0!==(null===(t=d.meta)||void 0===t?void 0:t[e.value])?!(null===(i=d.meta)||void 0===i||!i[e.value]):!(null===(s=M.extended_stats.defaults.meta)||void 0===s||!s[e.value])},e.value)})),(0,be.jsx)(kt,{label:"Sigma",metric:d,settingName:"sigma",placeholder:"3"})]}),"percentiles"===d.type&&(0,be.jsx)(c._,Object.assign({label:"Percentiles"},Pt,{children:(0,be.jsx)(g.I,{id:`${p}-percentiles-percents`,onBlur:e=>h(ee({metric:d,settingName:"percents",newValue:e.target.value.split(",").filter(Boolean)})),defaultValue:(null===(a=d.settings)||void 0===a?void 0:a.percents)||(null===(l=M.percentiles.defaults.settings)||void 0===l?void 0:l.percents),placeholder:"1,5,25,50,75,95,99"})})),"rate"===d.type&&(0,be.jsxs)(be.Fragment,{children:[(0,be.jsx)(c._,Object.assign({label:"Unit"},Pt,{"data-testid":"unit-select",children:(0,be.jsx)(Ge.Ph,{id:`ES-query-${f.refId}_metric-${d.id}-unit`,onChange:e=>h(ee({metric:d,settingName:"unit",newValue:e.value})),options:[{value:"second",label:"Second"},{value:"minute",label:"Minute"},{value:"hour",label:"Hour"},{value:"day",label:"Day"},{value:"week",label:"Week"},{value:"month",label:"Month"},{value:"quarter",label:"Quarter"},{value:"Year",label:"Year"}],value:null===(r=d.settings)||void 0===r?void 0:r.unit})})),(0,be.jsx)(c._,Object.assign({label:"Mode"},Pt,{"data-testid":"mode-select",children:(0,be.jsx)(Ge.Ph,{id:`ES-query-${f.refId}_metric-${d.id}-mode`,onChange:e=>h(ee({metric:d,settingName:"mode",newValue:e.value})),options:[{value:"sum",label:"Sum"},{value:"value_count",label:"Value count"}],value:null===(o=d.settings)||void 0===o?void 0:o.unit})}))]}),O(d)&&(0,be.jsx)(kt,{label:"Script",metric:d,settingName:"script",placeholder:"_value * 1"}),F(d)&&(0,be.jsx)(kt,{label:"Missing",metric:d,settingName:"missing",tooltip:"The missing parameter defines how documents that are missing a value should be treated. By default they will be ignored but it is also possible to treat them as if they had a value"})]})},Dt=e=>{let{stat:t,onChange:i,value:s}=e;const[a]=(0,n.useState)((0,Ne.uniqueId)("es-field-id-"));return(0,n.createElement)(c._,Object.assign({label:t.label},Pt,{key:t.value}),(0,be.jsx)(_t.x,{id:a,onChange:e=>i(e.target.checked),value:s}))},Vt=e=>!M[e.type].isPipelineAgg,Et=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=e.some(Vt);return Object.entries(M).filter((e=>{let[i,{versionRange:s="*"}]=e;return(0,B.satisfies)(t,s)})).filter((e=>{let[t,i]=e;return s||!i.isPipelineAgg})).filter((e=>{let[t,s]=e;return!s.xpack||i})).map((e=>{let[t,{label:i}]=e;return{label:i,value:t}}))},Tt=e=>{let{value:t}=e;const i=(s=(0,o.l4)(),{color:(l=!!t.hide)&&a.css`
        &,
        &:hover,
        label,
        a {
          color: ${l?s.colors.text.disabled:s.colors.text.primary};
        }
      `});var s,l;const r=Fe(),d=we(),u=m(),c=Qe(t.type),g=(0,n.useCallback)((async()=>{const e=await c();return O(t)?[{label:"None"},...e]:e}),[c,t]),p=d.metrics.slice(0,d.metrics.findIndex((e=>e.id===t.id)));return(0,be.jsxs)(be.Fragment,{children:[(0,be.jsxs)($e.m,{children:[(0,be.jsx)(Te.X,{className:(0,a.cx)(i.color,Ue),options:Et(p,r.esVersion,r.xpack),onChange:e=>u(Z({id:t.id,type:e.value})),value:(h=t,{label:M[h.type].label,value:h.type})}),_(t)&&!k(t)&&(0,be.jsx)(Be.V,{className:(0,a.cx)(i.color,Ue),loadOptions:g,onChange:e=>u(K({id:t.id,field:e.value})),placeholder:"Select Field",value:t.field}),k(t)&&!w(t)&&(0,be.jsx)(jt,{className:(0,a.cx)(i.color,Ue),onChange:e=>{var i;return u(K({id:t.id,field:null===(i=e.value)||void 0===i?void 0:i.id}))},options:p,value:t.field})]}),S(t)&&(0,be.jsx)($t,{metric:t,previousMetrics:p})]});var h},Bt=e=>{let{nextId:t}=e;const i=m(),{metrics:s}=we(),a=(null==s?void 0:s.length)||0;return(0,be.jsx)(be.Fragment,{children:null==s?void 0:s.map(((e,s)=>(0,be.jsxs)(Ve,{label:`Metric (${e.id})`,hidden:e.hide,onHideClick:()=>i(J(e.id)),onRemoveClick:a>1&&(()=>i(G(e.id))),children:[(0,be.jsx)(Tt,{value:e}),!M[e.type].isSingleMetric&&0===s&&(0,be.jsx)(Ae,{iconName:"plus",onClick:()=>i(Y(t)),label:"add"})]},`${e.type}-${e.id}`)))})};var Rt,Lt;const zt=e=>({root:a.css`
    display: flex;
  `,queryFieldWrapper:a.css`
    flex-grow: 1;
    margin: 0 ${e.spacing(.5)} ${e.spacing(.5)} 0;
  `}),Wt=e=>{let{value:t,onChange:i}=e;const s=(0,o.wW)(zt);return(0,be.jsx)("div",{className:s.queryFieldWrapper,children:(0,be.jsx)(d.q,{query:t,onBlur:()=>{},onChange:i,placeholder:"Lucene Query",portalOrigin:"elasticsearch"})})},Ht=e=>{var t,i,s;let{value:a}=e;const l=m(),r=(()=>{const{metrics:e,bucketAggs:t}=we();return(0,n.useMemo)((()=>(Math.max(...[...(null==e?void 0:e.map(Oe))||["0"],...(null==t?void 0:t.map(Oe))||["0"]].map(qe))+1).toString()),[e,t])})(),d=(0,o.wW)(zt),p="date_histogram"===(null==a||null===(t=a.bucketAggs)||void 0===t||null===(i=t.slice(-1)[0])||void 0===i?void 0:i.type),h=null===(s=a.metrics)||void 0===s?void 0:s.every((e=>!M[e.type].isSingleMetric));return(0,be.jsxs)(be.Fragment,{children:[(0,be.jsxs)("div",{className:d.root,children:[Lt||(Lt=(0,be.jsx)(u.W,{width:17,children:"Query"})),(0,be.jsx)(Wt,{onChange:e=>l(se(e)),value:null==a?void 0:a.query}),(0,be.jsx)(c._,{label:"Alias",labelWidth:15,disabled:!p,tooltip:"Aliasing only works for timeseries queries (when the last group is 'Date Histogram'). For all other query types this field is ignored.",children:(0,be.jsx)(g.I,{id:`ES-query-${a.refId}_alias`,placeholder:"Alias Pattern",onBlur:e=>l(ae(e.currentTarget.value)),defaultValue:a.alias})})]}),(0,be.jsx)(Bt,{nextId:r}),h&&(0,be.jsx)(bt,{nextId:r})]})};var Qt=i(16538),Ut=i(6251),Yt=i(78837),Gt=i(7356),Jt=i(69721),Kt=i(40920),Zt=i(36345),Xt=i(63672),ei=i(42528),ti=i(40882),ii=i(46587);const{FormField:si,Switch:ai}=ei.vw6,ni=(0,ti.B)((()=>({firstRow:a.css`
    display: flex;
  `,nameField:a.css`
    flex: 2;
  `,regexField:a.css`
    flex: 3;
  `,row:a.css`
    display: flex;
    align-items: baseline;
  `,urlField:a.css`
    flex: 1;
  `,urlDisplayLabelField:a.css`
    flex: 1;
  `}))),li=e=>{const{value:t,onChange:i,onDelete:s,suggestions:a,className:l}=e,r=ni(),[o,d]=function(e){const[t,i]=(0,n.useState)(!!e),s=(0,Zt.Z)(e);return(0,n.useEffect)((()=>{s||!e||t||i(!0),s&&!e&&t&&i(!1)}),[s,e,t]),[t,i]}(t.datasourceUid),u=e=>s=>{i(Object.assign({},t,{[e]:s.currentTarget.value}))};return(0,be.jsxs)("div",{className:l,children:[(0,be.jsxs)("div",{className:r.firstRow+" gf-form",children:[(0,be.jsx)(si,{className:r.nameField,labelWidth:6,inputWidth:null,label:"Field",type:"text",value:t.field,tooltip:"Can be exact field name or a regex pattern that will match on the field name.",onChange:u("field")}),(0,be.jsx)(Kt.zx,{variant:"destructive",title:"Remove field",icon:"times",onClick:e=>{e.preventDefault(),s()}})]}),(0,be.jsxs)("div",{className:"gf-form",children:[(0,be.jsx)(si,{label:o?"Query":"URL",labelWidth:6,inputEl:(0,be.jsx)(ii.v,{placeholder:o?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:e=>i(Object.assign({},t,{url:e})),suggestions:a}),className:r.urlField}),(0,be.jsx)(si,{className:r.urlDisplayLabelField,inputWidth:null,label:"URL Label",type:"text",value:t.urlDisplayLabel,onChange:u("urlDisplayLabel"),tooltip:"Use to override the button label."})]}),(0,be.jsxs)("div",{className:r.row,children:[(0,be.jsx)(ai,{labelClass:"width-6",label:"Internal link",checked:o,onChange:()=>{o&&i(Object.assign({},t,{datasourceUid:void 0})),d(!o)}}),o&&(0,be.jsx)(Xt.q,{tracing:!0,onChange:e=>{i(Object.assign({},t,{datasourceUid:e.uid}))},current:t.datasourceUid})]})]})};var ri;const oi=e=>({infoText:a.css`
      padding-bottom: ${e.spacing(2)};
      color: ${e.colors.text.secondary};
    `,dataLink:a.css`
      margin-bottom: ${e.spacing(1)};
    `}),di=e=>{const{value:t,onChange:i}=e,s=(0,o.wW)(oi);return(0,be.jsxs)(be.Fragment,{children:[ri||(ri=(0,be.jsx)("h3",{className:"page-heading",children:"Data links"})),(0,be.jsx)("div",{className:s.infoText,children:"Add links to existing fields. Links will be shown in log row details next to the field value."}),t&&t.length>0&&(0,be.jsx)("div",{className:"gf-form-group",children:t.map(((e,a)=>(0,be.jsx)(li,{className:s.dataLink,value:e,onChange:e=>{const s=[...t];s.splice(a,1,e),i(s)},onDelete:()=>{const e=[...t];e.splice(a,1),i(e)},suggestions:[{value:Gt.W.valueRaw,label:"Raw value",documentation:"Raw value of the field",origin:Jt.L.Value}]},a)))}),(0,be.jsx)(Kt.zx,{type:"button",variant:"secondary",className:a.css`
          margin-right: 10px;
        `,icon:"plus",onClick:e=>{e.preventDefault();const s=[...t||[],{field:"",url:""}];i(s)},children:"Add"})]})};var ui,ci=i(64624),gi=i(64845);const pi=[{label:"No pattern",value:"none"},{label:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{label:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{label:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{label:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{label:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],hi=[{label:"7.10+",value:"7.10.0"},{label:"8.0+",value:"8.0.0",description:"support for Elasticsearch 8 is currently experimental"}],mi=e=>{var t;let{value:i,onChange:s}=e;const a=hi.find((e=>e.value===i.jsonData.esVersion)),n=!a&&(0,B.valid)(i.jsonData.esVersion)?{label:i.jsonData.esVersion,value:i.jsonData.esVersion}:void 0;return(0,be.jsx)(be.Fragment,{children:(0,be.jsxs)(ci.C,{label:"Elasticsearch details",children:[(0,be.jsx)(c._,{label:"Index name",labelWidth:26,children:(0,be.jsx)(g.I,{id:"es_config_indexName",value:i.database||"",onChange:vi("database",i,s),width:24,placeholder:"es-index-name",required:!0})}),(0,be.jsx)(c._,{label:"Pattern",labelWidth:26,children:(0,be.jsx)(Ge.Ph,{inputId:"es_config_indexPattern",value:pi.find((e=>e.value===(void 0===i.jsonData.interval?"none":i.jsonData.interval))),options:pi,onChange:yi(i,s),width:24})}),(0,be.jsx)(c._,{label:"Time field name",labelWidth:26,children:(0,be.jsx)(g.I,{id:"es_config_timeField",value:i.jsonData.timeField||"",onChange:fi("timeField",i,s),width:24,placeholder:"@timestamp",required:!0})}),(0,be.jsx)(c._,{label:"ElasticSearch version",labelWidth:26,children:(0,be.jsx)(Ge.Ph,{inputId:"es_config_version",options:[n,...hi].filter(gi.f),onChange:e=>{const t=function(e){if(256===e)return 5;return e||5}(i.jsonData.maxConcurrentShardRequests);s(Object.assign({},i,{jsonData:Object.assign({},i.jsonData,{esVersion:e.value,maxConcurrentShardRequests:t})}))},value:a||n,width:24})}),(0,be.jsx)(c._,{label:"Max concurrent Shard Requests",labelWidth:26,children:(0,be.jsx)(g.I,{id:"es_config_shardRequests",value:i.jsonData.maxConcurrentShardRequests||"",onChange:fi("maxConcurrentShardRequests",i,s),width:24})}),(0,be.jsx)(c._,{label:"Min time interval",labelWidth:26,tooltip:(0,be.jsxs)(be.Fragment,{children:["A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example"," ",ui||(ui=(0,be.jsx)("code",{children:"1m"}))," if your data is written every minute."]}),error:"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s",invalid:!!i.jsonData.timeInterval&&!/^\d+(ms|[Mwdhmsy])$/.test(i.jsonData.timeInterval),children:(0,be.jsx)(g.I,{id:"es_config_minTimeInterval",value:i.jsonData.timeInterval||"",onChange:fi("timeInterval",i,s),width:24,placeholder:"10s"})}),(0,be.jsx)(c._,{label:"X-Pack enabled",labelWidth:26,children:(0,be.jsx)(_t.x,{id:"es_config_xpackEnabled",checked:i.jsonData.xpack||!1,onChange:bi("xpack",i,s)})}),i.jsonData.xpack&&(0,be.jsx)(c._,{label:"Include Frozen Indices",labelWidth:26,children:(0,be.jsx)(_t.x,{id:"es_config_frozenIndices",checked:null!==(t=i.jsonData.includeFrozen)&&void 0!==t&&t,onChange:bi("includeFrozen",i,s)})})]})})},vi=(e,t,i)=>s=>{i(Object.assign({},t,{[e]:s.currentTarget.value}))},fi=(e,t,i)=>s=>{i(Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:s.currentTarget.value})}))},bi=(e,t,i)=>s=>{i(Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:s.currentTarget.checked})}))},yi=(e,t)=>i=>{const{database:s}=e,a="none"===i.value?void 0:i.value;if(!s||0===s.length||s.startsWith("[logstash-]")){let i="";if(void 0!==a){const e=pi.find((e=>e.value===a));var n;if(e)i=null!==(n=e.example)&&void 0!==n?n:""}t(Object.assign({},e,{database:i,jsonData:Object.assign({},e.jsonData,{interval:a})}))}else t(Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{interval:a})}))};const xi=e=>{const{value:t,onChange:i}=e,s=e=>s=>{i(Object.assign({},t,{[e]:s.currentTarget.value}))};return(0,be.jsxs)(ci.C,{label:"Logs",children:[(0,be.jsx)(c._,{label:"Message field name",labelWidth:22,children:(0,be.jsx)(g.I,{id:"es_logs-config_logMessageField",value:t.logMessageField,onChange:s("logMessageField"),placeholder:"_source",width:24})}),(0,be.jsx)(c._,{label:"Level field name",labelWidth:22,children:(0,be.jsx)(g.I,{id:"es_logs-config_logLevelField",value:t.logLevelField,onChange:s("logLevelField"),width:24})})]})},ji=e=>{var t;const i=H(e.jsonData.esVersion);return Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{timeField:e.jsonData.timeField||"@timestamp",esVersion:i,maxConcurrentShardRequests:e.jsonData.maxConcurrentShardRequests||5,logMessageField:e.jsonData.logMessageField||"",logLevelField:e.jsonData.logLevelField||"",includeFrozen:null!==(t=e.jsonData.includeFrozen)&&void 0!==t&&t})})};var _i,ki;var wi=i(86558),Fi=i(48049),Si=i(71808),Oi=i(35778),qi=i(14444),Mi=i(71114),Ci=i(51881),Ii=i(17774),Ai=i(82931),Ni=i(91115),Pi=i(56193),$i=i(67922),Di=i(6932),Vi=i(7501),Ei=i(28783),Ti=i(75478),Bi=i(7166);const Ri={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}};class Li{constructor(e,t){var i,s,a;a="en",(s="dateLocale")in(i=this)?Object.defineProperty(i,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):i[s]=a,this.pattern=e,this.interval=t}getIndexForToday(){return this.interval?(0,Ni.zh)().locale(this.dateLocale).format(this.pattern):this.pattern}getIndexList(e,t){if(!this.interval)return this.pattern;const i=Ri[this.interval],s=(0,Ni.CQ)(e||(0,Ni.CQ)(t).add(-7,i.amount)).utc().startOf(i.startOf),a=(0,Ni.CQ)(t||(0,Ni.CQ)(e).add(7,i.amount)).utc().startOf(i.startOf).valueOf(),n=[];for(;s.valueOf()<=a;)n.push(s.locale(this.dateLocale).format(this.pattern)),s.add(1,i.amount);return n}}var zi=i(12901);class Wi extends s.iL{constructor(e,t){var i,s,a;super(),a=void 0,(s="datasource")in(i=this)?Object.defineProperty(i,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):i[s]=a,this.datasource=e,Object.assign(this,t)}importFromAbstractQuery(e){return{metrics:[{id:"1",type:"logs"}],query:this.getElasticsearchQuery(e.labelMatchers),refId:e.refId}}getElasticsearchQuery(e){return e.map((e=>{switch(e.operator){case zi.K2.Equal:return e.name+':"'+e.value+'"';case zi.K2.NotEqual:return"NOT "+e.name+':"'+e.value+'"';case zi.K2.EqualRegEx:return e.name+":/"+e.value+"/";case zi.K2.NotEqualRegEx:return"NOT "+e.name+":/"+e.value+"/"}})).join(" AND ")}}class Hi{constructor(e){var t,i,s;s=void 0,(i="timeField")in(t=this)?Object.defineProperty(t,i,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[i]=s,this.timeField=e.timeField}getRangeFilter(){const e={};return e[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},e}buildTermsAgg(e,t,i){var s;if(t.terms={field:e.field},!e.settings)return t;const a=null!==(s=e.settings)&&void 0!==s&&s.size?parseInt(e.settings.size,10):500;if(t.terms.size=0===a?500:a,void 0!==e.settings.orderBy){t.terms.order={},"_term"===e.settings.orderBy?t.terms.order._key=e.settings.order:t.terms.order[e.settings.orderBy]=e.settings.order;const s=z(e.settings.orderBy);if(s)for(let a of i.metrics||[])if(a.id===s){"count"===a.type?t.terms.order={_count:e.settings.order}:_(a)&&(t.aggs={},t.aggs[a.id]={[a.type]:{field:a.field}});break}}return void 0!==e.settings.min_doc_count&&(t.terms.min_doc_count=parseInt(e.settings.min_doc_count,10),isNaN(t.terms.min_doc_count)&&(t.terms.min_doc_count=e.settings.min_doc_count)),e.settings.missing&&(t.terms.missing=e.settings.missing),t}getDateHistogramAgg(e){const t={},i=e.settings||{};t.field=e.field||this.timeField,t.min_doc_count=i.min_doc_count||0,t.extended_bounds={min:"$timeFrom",max:"$timeTo"},t.format="epoch_millis",i.timeZone&&i.timeZone!==re.RQ.utc&&(t.time_zone=i.timeZone),""!==i.offset&&(t.offset=i.offset);const s="auto"===i.interval?"${__interval_ms}ms":i.interval;return t.fixed_interval=s,t}getHistogramAgg(e){const t={},i=e.settings||{};return t.interval=i.interval,t.field=e.field,t.min_doc_count=i.min_doc_count||0,t}getFiltersAgg(e){const t={};for(let{query:s,label:a}of(null===(i=e.settings)||void 0===i?void 0:i.filters)||[]){var i;t[a||s]={query_string:{query:s,analyze_wildcard:!0}}}return t}documentQuery(e,t){return e.size=t,e.sort=[{[this.timeField]:{order:"desc",unmapped_type:"boolean"}},{_doc:{order:"desc"}}],e.script_fields={},e}addAdhocFilters(e,t){if(!t)return;let i,s,a,n;for(i=0;i<t.length;i++)switch(s=t[i],a={},a[s.key]=s.value,n={},n[s.key]={query:s.value},s.operator){case"=":e.query.bool.must||(e.query.bool.must=[]),e.query.bool.must.push({match_phrase:n});break;case"!=":e.query.bool.must_not||(e.query.bool.must_not=[]),e.query.bool.must_not.push({match_phrase:n});break;case"<":a[s.key]={lt:s.value},e.query.bool.filter.push({range:a});break;case">":a[s.key]={gt:s.value},e.query.bool.filter.push({range:a});break;case"=~":e.query.bool.filter.push({regexp:a});break;case"!~":e.query.bool.filter.push({bool:{must_not:{regexp:a}}})}}build(e,t){var i,s,a,n,l,r,o,d,u;let c,g,p,h,m;e.metrics=e.metrics||[D()],e.bucketAggs=e.bucketAggs||[V()],e.timeField=this.timeField;const v={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};if(e.query&&""!==e.query&&(v.query.bool.filter=[...v.query.bool.filter,{query_string:{analyze_wildcard:!0,query:e.query}}]),this.addAdhocFilters(v,t),0===e.bucketAggs.length&&(c=e.metrics[0],!c||"raw_document"!==c.type&&"raw_data"!==c.type))throw{message:"Invalid query"};if("raw_document"===(null===(i=e.metrics)||void 0===i||null===(s=i[0])||void 0===s?void 0:s.type)||"raw_data"===(null===(a=e.metrics)||void 0===a||null===(n=a[0])||void 0===n?void 0:n.type)){var f;c=e.metrics[0];const t=null!==(f=c.settings)&&void 0!==f&&f.size?parseInt(c.settings.size,10):500;return this.documentQuery(v,t||500)}for(m=v,g=0;g<e.bucketAggs.length;g++){const t=e.bucketAggs[g],i={};switch(t.type){case"date_histogram":i.date_histogram=this.getDateHistogramAgg(t);break;case"histogram":i.histogram=this.getHistogramAgg(t);break;case"filters":i.filters={filters:this.getFiltersAgg(t)};break;case"terms":this.buildTermsAgg(t,i,e);break;case"geohash_grid":var b;i.geohash_grid={field:t.field,precision:null===(b=t.settings)||void 0===b?void 0:b.precision}}m.aggs=m.aggs||{},m.aggs[t.id]=i,m=i}for(m.aggs={},g=0;g<e.metrics.length;g++){if(c=e.metrics[g],"count"===c.type)continue;const t={};let i={};if(k(c))if(w(c)){if(!c.pipelineVariables)continue;for(i={buckets_path:{}},p=0;p<c.pipelineVariables.length;p++)if(h=c.pipelineVariables[p],h.name&&h.pipelineAgg&&/^\d*$/.test(h.pipelineAgg)){const t=E(e.metrics,h.pipelineAgg);t&&("count"===t.type?i.buckets_path[h.name]="_count":i.buckets_path[h.name]=h.pipelineAgg)}}else{if(!c.field||!/^\d*$/.test(c.field))continue;{const t=E(e.metrics,c.field);t&&(i="count"===t.type?{buckets_path:"_count"}:{buckets_path:c.field})}}else _(c)&&(i={field:c.field});if(S(c))switch(Object.entries(c.settings||{}).filter((e=>{let[t,i]=e;return null!==i})).forEach((e=>{let[t,s]=e;i[t]="script"===t?this.buildScript(W(c)):s})),c.type){case"moving_avg":i=Object.assign({},i,void 0!==(null===(l=i)||void 0===l?void 0:l.window)&&{window:this.toNumber(i.window)},void 0!==(null===(r=i)||void 0===r?void 0:r.predict)&&{predict:this.toNumber(i.predict)},j(c)&&{settings:Object.assign({},i.settings,Object.fromEntries(Object.entries(i.settings||{}).filter((e=>{let[t]=e;return["alpha","beta","gamma","period"].includes(t)})).filter((e=>{let[t,i]=e;return void 0!==i})).map((e=>{let[t,i]=e;return[t,this.toNumber(i)]}))))});break;case"serial_diff":i=Object.assign({},i,void 0!==i.lag&&{lag:this.toNumber(i.lag)});break;case"top_metrics":var y,x;if(i={metrics:null===(o=c.settings)||void 0===o||null===(d=o.metrics)||void 0===d?void 0:d.map((e=>({field:e}))),size:1},null!==(u=c.settings)&&void 0!==u&&u.orderBy)i.sort=[{[null===(y=c.settings)||void 0===y?void 0:y.orderBy]:null===(x=c.settings)||void 0===x?void 0:x.order}]}t[c.type]=i,m.aggs[c.id]=t}return v}buildScript(e){return e}toNumber(e){const t=parseFloat(`${e}`);return isNaN(t)?e:t}getTermsQuery(e){const t={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&t.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});let i=500;e.size&&(i=e.size),t.aggs={1:{terms:{field:e.field,size:i,order:{}}}};const{orderBy:s="key",order:a=("doc_count"===s?"desc":"asc")}=e;if(["asc","desc"].indexOf(a)<0)throw{message:`Invalid query sort order ${a}`};switch(s){case"key":case"term":const e="_key";t.aggs[1].terms.order[e]=a;break;case"doc_count":t.aggs[1].terms.order._count=a;break;default:throw{message:`Invalid query sort type ${s}`}}return t}getLogsQuery(e,t,i){let s={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};return this.addAdhocFilters(s,i),e.query&&s.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}}),s=this.documentQuery(s,t),Object.assign({},s,{aggs:this.build(e).aggs,highlight:{fields:{"*":{}},pre_tags:[P],post_tags:[$],fragment_size:2147483647}})}}var Qi,Ui=i(68522);function Yi(e){var t;const i=e.annotation,s=e.onAnnotationChange;return(0,be.jsxs)(be.Fragment,{children:[(0,be.jsx)("div",{className:"gf-form-group",children:(0,be.jsx)(Wt,{value:null===(t=i.target)||void 0===t?void 0:t.query,onChange:e=>{s(Object.assign({},i,{query:e}))}})}),(0,be.jsxs)("div",{className:"gf-form-group",children:[Qi||(Qi=(0,be.jsx)("h6",{children:"Field mappings"})),(0,be.jsxs)(Ui.EditorRow,{children:[(0,be.jsx)(Ui.EditorField,{label:"Time",children:(0,be.jsx)(g.I,{type:"text",placeholder:"@timestamp",value:i.timeField,onChange:e=>{s(Object.assign({},i,{timeField:e.currentTarget.value}))}})}),(0,be.jsx)(Ui.EditorField,{label:"Time End",children:(0,be.jsx)(g.I,{type:"text",value:i.timeEndField,onChange:e=>{s(Object.assign({},i,{timeEndField:e.currentTarget.value}))}})}),(0,be.jsx)(Ui.EditorField,{label:"Text",children:(0,be.jsx)(g.I,{type:"text",value:i.textField,onChange:e=>{s(Object.assign({},i,{textField:e.currentTarget.value}))}})}),(0,be.jsx)(Ui.EditorField,{label:"Tags",children:(0,be.jsx)(g.I,{type:"text",placeholder:"tags",value:i.tagsField,onChange:e=>{s(Object.assign({},i,{tagsField:e.currentTarget.value}))}})})]})]})]})}var Gi=i(81351),Ji=i(94036),Ki=i(32025),Zi=i(39302),Xi=i(90845);const es=`${P}([^@]+)${$}`;class ts{constructor(e,t){var i,s,a;a=()=>{const e=[];for(let t=0;t<this.response.responses.length;t++){const i=this.response.responses[t],s=this.targets[t];if(i.error)throw this.getErrorFromElasticResponse(this.response,i.error);if(i.hits&&i.hits.hits.length>0&&this.processHits(i.hits,e,s),i.aggregations){const s=i.aggregations,a=this.targets[t],n=[],l=new Zi.Z;l.refId=a.refId,this.processBuckets(s,a,n,l,{},0),this.trimDatapoints(n,a),this.nameSeries(n,a);for(let t=0;t<n.length;t++)e.push(n[t]);l.rows.length>0&&e.push(l)}}return{data:e}},(s="processResponseToSeries")in(i=this)?Object.defineProperty(i,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):i[s]=a,this.targets=e,this.response=t,this.targets=e,this.response=t}processMetrics(e,t,i,s){let a;for(let o=0;o<t.metrics.length;o++){const d=t.metrics[o];if(!d.hide)switch(d.type){case"count":a={datapoints:[],metric:"count",props:s,refId:t.refId};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i.doc_count;a.datapoints.push([s,i.key])}i.push(a);break;case"percentiles":{if(0===e.buckets.length)break;const n=e.buckets[0][d.id].values;for(const l in n){a={datapoints:[],metric:"p"+l,props:s,field:d.field,refId:t.refId};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id].values;a.datapoints.push([s[l],i.key])}i.push(a)}break}case"extended_stats":for(const n in d.meta)if(d.meta[n]){a={datapoints:[],metric:n,props:s,field:d.field,refId:t.refId};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id];s.std_deviation_bounds_upper=s.std_deviation_bounds.upper,s.std_deviation_bounds_lower=s.std_deviation_bounds.lower,a.datapoints.push([s[n],i.key])}i.push(a)}break;case"top_metrics":var n,l;if(null!==(n=d.settings)&&void 0!==n&&null!==(l=n.metrics)&&void 0!==l&&l.length)for(const n of null===(r=d.settings)||void 0===r?void 0:r.metrics){var r;a={datapoints:[],metric:d.type,props:s,refId:t.refId,field:n};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id].top.map((e=>e.metrics[n]?e.metrics[n]:null)),l=[s[s.length-1],i.key];a.datapoints.push(l)}i.push(a)}break;default:a={datapoints:[],metric:d.type,metricId:d.id,props:s,refId:t.refId},_(d)&&(a.field=d.field);for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id];void 0!==s&&(s.normalized_value?a.datapoints.push([s.normalized_value,i.key]):a.datapoints.push([s.value,i.key]))}i.push(a)}}}processAggregationDocs(e,t,i,s,a){if(0===s.columns.length){for(const e of(0,Ne.keys)(a))s.addColumn({text:e,filterable:!0});s.addColumn({text:t.field,filterable:!0})}const n=(e,t,i)=>{s.addColumn({text:t}),e.push(i)},l=(0,Ne.isArray)(e.buckets)?e.buckets:[e.buckets];for(const e of l){const t=[];for(const e of(0,Ne.values)(a))t.push(e);t.push(e.key);for(const s of i.metrics||[])switch(s.type){case"count":n(t,this.getMetricName(s.type),e.doc_count);break;case"extended_stats":for(const i in s.meta){if(!s.meta[i])continue;const a=e[s.id];a.std_deviation_bounds_upper=a.std_deviation_bounds.upper,a.std_deviation_bounds_lower=a.std_deviation_bounds.lower,n(t,this.getMetricName(i),a[i])}break;case"percentiles":{const i=e[s.id].values;for(const e in i)n(t,`p${e} ${s.field}`,i[e]);break}case"top_metrics":{var r;const i=this.getMetricName(s.type);if(null!==(r=s.settings)&&void 0!==r&&r.metrics)for(const a of s.settings.metrics){n(t,s.settings.metrics.length>1?`${i} ${a}`:i,e[s.id].top[0].metrics[a])}break}default:{let a=this.getMetricName(s.type);(0,Ne.filter)(i.metrics,{type:s.type}).length>1&&(_(s)&&(a+=" "+s.field),"bucket_script"===s.type&&(a=W(s))),n(t,a,e[s.id].value);break}}s.rows.push(t)}}processBuckets(e,t,i,s,a,n){let l,r,o,d;const u=t.bucketAggs.length-1;for(d in e)if(r=(0,Ne.find)(t.bucketAggs,{id:d}),o=e[d],r)if(n===u)"date_histogram"===r.type?this.processMetrics(o,t,i,a):this.processAggregationDocs(o,r,t,s,a);else for(const e in o.buckets)l=o.buckets[e],a=(0,Ne.clone)(a),void 0!==l.key?a[r.field]=l.key:a.filter=e,l.key_as_string&&(a[r.field]=l.key_as_string),this.processBuckets(l,t,i,s,a,n+1)}getMetricName(e){const t=Object.entries(M).filter((t=>{let[i]=t;return i===e})).map((e=>{let[t,i]=e;return i}))[0];if(t)return t.label;const i=A.find((t=>t.value===e));return i?i.label:e}getSeriesName(e,t,i){let s=this.getMetricName(e.metric);if(t.alias){const i=/\{\{([\s\S]+?)\}\}/g;return t.alias.replace(i,((t,i,a)=>{const n=i||a;return 0===n.indexOf("term ")?e.props[n.substring(5)]:void 0!==e.props[n]?e.props[n]:"metric"===n?s:"field"===n?e.field||"":t}))}if(e.metric in C)if(e.metric&&function(e){return!!M[e].supportsMultipleBucketPaths}(e.metric)){const i=(0,Ne.find)(t.metrics,{id:e.metricId});if(i&&i.settings.script){s=W(i);for(const e of i.pipelineVariables){const i=(0,Ne.find)(t.metrics,{id:e.pipelineAgg});i&&(s=s.replace("params."+e.name,R(i)))}}else s="Unset"}else{const i=(0,Ne.find)(t.metrics,{id:e.field});i?s+=" "+R(i):s="Unset"}else e.field&&(s+=" "+e.field);if(0===(0,Ne.keys)(e.props).length)return s;let a="";for(const t in e.props)a+=e.props[t]+" ";return i?a.trim()+" "+s:a.trim()}nameSeries(e,t){var i;const s=(0,Ne.uniq)((0,Ne.map)(e,"metric")).length,a=(null===(i=t.metrics)||void 0===i?void 0:i.filter((e=>"top_metrics"===e.type))).some((e=>{var t,i;return((null==e||null===(t=e.settings)||void 0===t||null===(i=t.metrics)||void 0===i?void 0:i.length)||0)>1}));for(let i=0;i<e.length;i++){const n=e[i];n.target=this.getSeriesName(n,t,s>1||a)}}processHits(e,t,i){const s="number"==typeof e.total?e.total:e.total.value,a={target:i.refId,type:"docs",refId:i.refId,datapoints:[],total:s,filterable:!0};let n,l,r,o;for(o=0;o<e.hits.length;o++){if(l=e.hits[o],r={_id:l._id,_type:l._type,_index:l._index,sort:l.sort,highlight:l.highlight},l._source)for(n in l._source)r[n]=l._source[n];for(n in l.fields)r[n]=l.fields[n];a.datapoints.push(r)}t.push(a)}trimDatapoints(e,t){const i=(0,Ne.find)(t.bucketAggs,{type:"date_histogram"});if(i&&i.settings&&i.settings.trimEdges){const t=i.settings.trimEdges;for(const i in e){const s=e[i];s.datapoints.length>2*t&&(s.datapoints=s.datapoints.slice(t,s.datapoints.length-t))}}}getErrorFromElasticResponse(e,t){const i={};return i.data=JSON.stringify(t,null,4),t.root_cause&&t.root_cause.length>0&&t.root_cause[0].reason?i.message=t.root_cause[0].reason:i.message=t.reason||"Unknown elastic error response",e.$$config&&(i.config=e.$$config),i}getTimeSeries(){return this.targets.some((e=>T(e,"raw_data")))?this.processResponseToDataFrames(!1):this.processResponseToSeries()}getLogs(e,t){return this.processResponseToDataFrames(!0,e,t)}processResponseToDataFrames(e,t,i){const s=[];for(let n=0;n<this.response.responses.length;n++){const l=this.response.responses[n];if(l.error)throw this.getErrorFromElasticResponse(this.response,l.error);if(l.hits){const{propNames:r,docs:o}=is(l.hits.hits),d=o.length?ss(r.map(ns(o)),e,this.targets[0].timeField,t,i):ss([],e);e&&as(d,"logs");for(const e of o){if(i&&(e.level=e[i]),e.highlight){var a;const t=new RegExp(es,"g"),i=new RegExp(es),s=Object.keys(e.highlight).flatMap((s=>e.highlight[s].flatMap((e=>{const s=e.match(t);return s?s.map((e=>{const t=e.match(i);return t&&t[1]||null})):[]})))).filter(Ne.identity),n=null!==(a=d.meta)&&void 0!==a&&a.searchWords?(0,Ne.uniq)([...d.meta.searchWords,...s]):[...s];d.meta=d.meta?Object.assign({},d.meta,{searchWords:n}):{searchWords:n}}d.add(e)}const u=this.targets[n];d.refId=u.refId,s.push(d)}if(l.aggregations){const t=l.aggregations,i=this.targets[n],a=[],r=new Zi.Z;if(this.processBuckets(t,i,a,r,{},0),this.trimDatapoints(a,i),this.nameSeries(a,i),r.rows.length>0){const e=(0,Gi.g0)(r);e.refId=i.refId,s.push(e)}for(let t=0;t<a.length;t++){let n=(0,Gi.g0)(a[t]);e&&as(n,"graph"),n.refId=i.refId,s.push(n)}}}return{data:s}}}const is=e=>{const t=[];let i=[];for(const s of e){const e=s._source?(0,Xi.default)(s._source):{},a=Object.assign({_id:s._id,_type:s._type,_index:s._index,sort:s.sort,highlight:s.highlight,_source:Object.assign({},e)},e);for(const e of Object.keys(a))-1===i.indexOf(e)&&i.push(e);t.push(a)}return i.sort(),{docs:t,propNames:i}},ss=(e,t,i,s,a)=>{const n=new Ji.v({fields:[]});if(i&&n.addField({config:{filterable:!0},name:i,type:Ki.fS.time}),s){const e=n.addField({name:s,type:Ki.fS.string});n.setParser(e,(e=>e||""))}if(a){const e=n.addField({name:"level",type:Ki.fS.string});n.setParser(e,(e=>e||""))}const l=n.fields.map((e=>e.name));for(const[i,s]of e){if(l.includes(i))continue;if(!t&&"_source"===i)continue;const e=n.addField({config:{filterable:!0},name:i,type:s});n.setParser(e,(e=>e||""))}return n},as=(e,t)=>{let i=e;i.meta?i.meta.preferredVisualisationType=t:i.meta={preferredVisualisationType:t}},ns=e=>t=>{var i;return[t,ls(null===(i=e.find((e=>void 0!==e[t])))||void 0===i?void 0:i[t])]},ls=e=>{switch(typeof e){case"number":return Ki.fS.number;case"string":return Ki.fS.string;default:return Ki.fS.other}};function rs(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const os=["_index","_type","_id","_source","_size","_field_names","_ignored","_routing","_meta"];class ds extends s.MF{constructor(e){var t,i;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,Bi.J)();super(e),rs(this,"basicAuth",void 0),rs(this,"withCredentials",void 0),rs(this,"url",void 0),rs(this,"name",void 0),rs(this,"index",void 0),rs(this,"timeField",void 0),rs(this,"esVersion",void 0),rs(this,"xpack",void 0),rs(this,"interval",void 0),rs(this,"maxConcurrentShardRequests",void 0),rs(this,"queryBuilder",void 0),rs(this,"indexPattern",void 0),rs(this,"logMessageField",void 0),rs(this,"logLevelField",void 0),rs(this,"dataLinks",void 0),rs(this,"languageProvider",void 0),rs(this,"includeFrozen",void 0),rs(this,"isProxyAccess",void 0),rs(this,"timeSrv",void 0),rs(this,"getLogRowContext",(async(e,t)=>{var i;const s=e.dataFrame.fields.find((e=>"sort"===e.name)),a=(null==s?void 0:s.values.get(e.rowIndex))||[e.timeEpochMs],n="FORWARD"===(null==t?void 0:t.direction)?"asc":"desc",l="FORWARD"===(null==t?void 0:t.direction)?this.getQueryHeader("query_then_fetch",(0,Ni.CQ)(e.timeEpochMs)):this.getQueryHeader("query_then_fetch",void 0,(0,Ni.CQ)(e.timeEpochMs)),r=null!==(i=null==t?void 0:t.limit)&&void 0!==i?i:10,o=[l,JSON.stringify({size:r,query:{bool:{filter:[{range:{[this.timeField]:{["FORWARD"===(null==t?void 0:t.direction)?"gte":"lte"]:e.timeEpochMs,format:"epoch_millis"}}}]}},sort:[{[this.timeField]:n},{_doc:n}],search_after:a})].join("\n")+"\n",d=this.getMultiSearchUrl(),u=await(0,Re.n)(this.post(d,o)),c=[{refId:`${e.dataFrame.refId}`,metrics:[{type:"logs",id:"1"}]}],g=new ts(c,function(e,t){if("desc"===t)return e;const i=e.responses[0];return Object.assign({},e,{responses:[Object.assign({},i,{hits:Object.assign({},i.hits,{hits:i.hits.hits.reverse()})})]})}(u,n)),p=g.getLogs(this.logMessageField,this.logLevelField),h=(0,Ne.first)(p.data);if(!h)return{data:[]};const m=h.fields.find((e=>e.name===this.timeField)),v=h.fields.find((e=>e.name===this.logMessageField));return m&&v?{data:[Object.assign({},h,{fields:[...h.fields,Object.assign({},m,{name:"ts"}),Object.assign({},v,{name:"line"})]})]}:p})),this.templateSrv=s,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.index=null!==(t=e.database)&&void 0!==t?t:"",this.isProxyAccess="proxy"===e.access;const a=e.jsonData||{};this.timeField=a.timeField,this.esVersion=H(a.esVersion),this.xpack=Boolean(a.xpack),this.indexPattern=new Li(this.index,a.interval),this.interval=a.timeInterval,this.maxConcurrentShardRequests=a.maxConcurrentShardRequests,this.queryBuilder=new Hi({timeField:this.timeField}),this.logMessageField=a.logMessageField||"",this.logLevelField=a.logLevelField||"",this.dataLinks=a.dataLinks||[],this.includeFrozen=null!==(i=a.includeFrozen)&&void 0!==i&&i,this.annotations={QueryEditor:Yi},""===this.logMessageField&&(this.logMessageField=void 0),""===this.logLevelField&&(this.logLevelField=void 0),this.languageProvider=new Wi(this),this.timeSrv=(0,Ti.$t)()}request(e,t,i,s){if(!this.isProxyAccess){const e=new Error("Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode.");return(0,wi._)((()=>e))}if(!Q(this.esVersion)){const e=new Error("Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) was removed.");return(0,wi._)((()=>e))}const a={url:this.url+"/"+t,method:e,data:i,headers:s};return(this.basicAuth||this.withCredentials)&&(a.withCredentials=!0),this.basicAuth&&(a.headers={Authorization:this.basicAuth}),(0,Di.i)().fetch(a).pipe((0,Oi.U)((e=>(e.data.$$config=e.config,e.data))),(0,qi.K)((e=>{if(e.data){var t,i,s;const a=null!==(t=null!==(i=null===(s=e.data.error)||void 0===s?void 0:s.reason)&&void 0!==i?i:e.data.message)&&void 0!==t?t:"Unknown error";return(0,wi._)({message:"Elasticsearch error: "+a,error:e.data.error})}return(0,wi._)(e)})))}async importFromAbstractQueries(e){return e.map((e=>this.languageProvider.importFromAbstractQuery(e)))}get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,l.JK)(),i=this.indexPattern.getIndexList(t.from,t.to);Array.isArray(i)||(i=[this.indexPattern.getIndexForToday()]);const s=i.map((t=>t+e));return this.requestAllIndices(s)}requestAllIndices(e){const t=e.length;return(0,Fi.R)({initialState:0,condition:e=>e<Math.min(t,7),iterate:e=>e+1}).pipe((0,Mi.z)((i=>this.request("GET",e[t-i-1]).pipe((0,qi.K)((e=>(0,Si.of)({err:e})))))),(0,Ci.n)((e=>{var t;return 404===(null==e||null===(t=e.err)||void 0===t?void 0:t.status)})),(0,Ii.T)((()=>"Could not find an available index for this time range.")),(0,Ai.P)(),(0,Oi.U)((e=>{if(e.err)throw e.err;return e})))}post(e,t){return this.request("POST",e,t,{"Content-Type":"application/x-ndjson"})}annotationQuery(e){const t=e.annotation,i=t.timeField||"@timestamp",s=t.timeEndField||null,a=t.query,n=t.tagsField||"tags",l=t.textField||null,r=[],o={};if(o[i]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},r.push({range:o}),s){const t={};t[s]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},r.push({range:t})}const d=this.interpolateLuceneQuery(a),u={bool:{filter:[{bool:{should:r,minimum_should_match:1}}]}};d&&u.bool.filter.push({query_string:{query:d}});const c={query:u,size:1e4},g={search_type:"query_then_fetch",ignore_unavailable:!0};t.index?g.index=t.index:g.index=this.indexPattern.getIndexList(e.range.from,e.range.to);const p=JSON.stringify(g)+"\n"+JSON.stringify(c)+"\n";return(0,Re.n)(this.post("_msearch",p).pipe((0,Oi.U)((e=>{const a=[],r=e.responses[0].hits.hits,o=(e,t)=>{if(!t)return;const i=t.split(".");let s=e;for(let e=0;e<i.length;e++)if(s=s[i[e]],!s)return console.log("could not find field in annotation: ",t),"";return s};for(let e=0;e<r.length;e++){const d=r[e]._source;let u=o(d,i);if(void 0!==r[e].fields){const t=r[e].fields;((0,Ne.isString)(t[i])||(0,Ne.isNumber)(t[i]))&&(u=t[i])}const c={annotation:t,time:(0,Ni.zh)(u).valueOf(),text:o(d,l),tags:o(d,n)};if(s){const e=o(d,s);e&&(c.timeEnd=(0,Ni.zh)(e).valueOf())}if(t.titleField){const e=o(d,t.titleField);e&&(c.text=e+"\n"+c.text)}"string"==typeof c.tags&&(c.tags=c.tags.split(",")),a.push(c)}return a}))))}interpolateLuceneQuery(e,t){return this.templateSrv.replace(e,t,"lucene")}interpolateVariablesInQueries(e,t){const i=e=>{var i,s;return"filters"===e.type?Object.assign({},e,{settings:Object.assign({},e.settings,{filters:null===(i=e.settings)||void 0===i||null===(s=i.filters)||void 0===s?void 0:s.map((e=>Object.assign({},e,{query:this.interpolateLuceneQuery(e.query,t)||"*"})))})}):e},s=e.map((e=>{var s;return Object.assign({},e,{datasource:this.getRef(),query:this.interpolateLuceneQuery(e.query||"",t),bucketAggs:null===(s=e.bucketAggs)||void 0===s?void 0:s.map(i)})}));return JSON.parse(this.templateSrv.replace(JSON.stringify(s),t))}testDatasource(){return(0,Re.n)(this.getFields(["date"]).pipe((0,Mi.z)((e=>(0,Ne.find)(e,{text:this.timeField})?(0,Si.of)({status:"success",message:"Index OK. Time field name OK."}):(0,Si.of)({status:"error",message:"No date field named "+this.timeField+" found"}))),(0,qi.K)((e=>(console.error(e),e.message?(0,Si.of)({status:"error",message:e.message}):(0,Si.of)({status:"error",message:e.status}))))))}getQueryHeader(e,t,i){const s={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(t,i)};return JSON.stringify(s)}getQueryDisplayText(e){const t=e.metrics,i=e.bucketAggs;let s="";return e.query&&(s+="Query: "+e.query+", "),s+="Metrics: ",s+=null==t?void 0:t.reduce(((e,t)=>{let i=M[t.type].label+"(";return _(t)&&(i+=t.field),w(t)&&(i+=W(t).replace(new RegExp("params.","g"),"")),i+="), ",`${e} ${i}`}),""),s+=null==i?void 0:i.reduce(((e,t,i)=>{let s="";return 0===i&&(s+=" Group by: "),s+=oe[t.type].label+"(",Le(t)&&(s+=t.field),`${e} ${s}), `}),""),e.alias&&(s+="Alias: "+e.alias),s}showContextToggle(){return!0}getLogsVolumeDataProvider(e){if(!e.targets.some((e=>{var t;return 1===(null===(t=e.metrics)||void 0===t?void 0:t.length)&&"logs"===e.metrics[0].type})))return;const t=(0,Ne.cloneDeep)(e);return t.targets=t.targets.map((e=>{var t;const i=[],s=null!==(t=this.timeField)&&void 0!==t?t:"@timestamp";this.logLevelField&&i.push({id:"2",type:"terms",settings:{min_doc_count:"0",size:"0",order:"desc",orderBy:"_count",missing:Pi.in.unknown},field:this.logLevelField}),i.push({id:"3",type:"date_histogram",settings:{interval:"auto",min_doc_count:"0",trimEdges:"0"},field:s});return{refId:e.refId,query:e.query,metrics:[{type:"count",id:"1"}],timeField:s,bucketAggs:i}})),(0,Ei.Bz)(this,t,{range:e.range,targets:e.targets,extractLevel:e=>(0,$i.jx)(e.name||"")})}query(e){let t="";const i=this.interpolateVariablesInQueries((0,Ne.cloneDeep)(e.targets),e.scopedVars),s=[];let a=i.some((e=>T(e,"logs")));const n=this.templateSrv.getAdhocFilters(this.name),l=[];for(const a of i){if(a.hide)continue;let i;if(T(a,"logs")){var r,o,d;a.bucketAggs=[V()];const e=null===(r=a.metrics)||void 0===r?void 0:r.find((e=>"logs"===e.type)),t=null!==(o=e.settings)&&void 0!==o&&o.limit?parseInt(null===(d=e.settings)||void 0===d?void 0:d.limit,10):500;l.push(t),a.metrics=[],i=this.queryBuilder.getLogsQuery(a,t,n)}else l.push(),a.alias&&(a.alias=this.interpolateLuceneQuery(a.alias,e.scopedVars)),i=this.queryBuilder.build(a,n);const u=JSON.stringify(i),c="query_then_fetch";t+=this.getQueryHeader(c,e.range.from,e.range.to)+"\n",t+=u+"\n",s.push(a)}if(0===s.length)return(0,Si.of)({data:[]});t=t.replace(/"\$timeFrom"/g,e.range.from.valueOf().toString()),t=t.replace(/"\$timeTo"/g,e.range.to.valueOf().toString()),t=this.templateSrv.replace(t,e.scopedVars);const u=this.getMultiSearchUrl();return this.post(u,t).pipe((0,Oi.U)((e=>{const t=new ts(s,e);if(a){const e=t.getLogs(this.logMessageField,this.logLevelField);return e.data.forEach(((e,t)=>{!function(e,t,i){i&&(e.meta=Object.assign({},e.meta,{limit:i}));if(!t.length)return;for(const i of e.fields){const e=t.filter((e=>new RegExp(e.field).test(i.name)));0!==e.length&&(i.config=i.config||{},i.config.links=[...(i.config.links,e.map(us))])}}(e,this.dataLinks,l[t])})),e}return t.getTimeSeries()})))}isMetadataField(e){return os.includes(e)}getFields(e,t){const i={float:"number",double:"number",integer:"number",long:"number",date:"date",date_nanos:"date",string:"string",text:"string",scaled_float:"number",nested:"nested",histogram:"number"};return this.get("/_mapping",t).pipe((0,Oi.U)((t=>{const s=(t,s)=>!this.isMetadataField(s)&&(!e||0===e.length||(e.includes(t.type)||e.includes(i[t.type]))),a=[],n={};function l(e){for(const t in e){const i=e[t];if((0,Ne.isObject)(i.properties)&&(a.push(t),l(i.properties)),(0,Ne.isObject)(i.fields)&&(a.push(t),l(i.fields)),(0,Ne.isString)(i.type)){const e=a.concat(t).join(".");s(i,t)&&(n[e]={text:e,type:i.type})}}a.pop()}for(const e in t){const i=t[e];if(i&&i.mappings){l(i.mappings.properties)}}return(0,Ne.map)(n,(e=>e))})))}getTerms(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,l.JK)();const i=this.getQueryHeader("query_then_fetch",t.from,t.to);let s=JSON.stringify(this.queryBuilder.getTermsQuery(e));s=s.replace(/\$timeFrom/g,t.from.valueOf().toString()),s=s.replace(/\$timeTo/g,t.to.valueOf().toString()),s=i+"\n"+s+"\n";const a=this.getMultiSearchUrl();return this.post(a,s).pipe((0,Oi.U)((e=>{if(!e.responses[0].aggregations)return[];const t=e.responses[0].aggregations[1].buckets;return(0,Ne.map)(t,(e=>({text:e.key_as_string||e.key,value:e.key})))})))}getMultiSearchUrl(){const e=new URLSearchParams;return this.maxConcurrentShardRequests&&e.append("max_concurrent_shard_requests",`${this.maxConcurrentShardRequests}`),this.xpack&&this.includeFrozen&&e.append("ignore_throttled","false"),("_msearch?"+e.toString()).replace(/\?$/,"")}metricFindQuery(e,t){const i=null==t?void 0:t.range,s=JSON.parse(e);if(e){if("fields"===s.find)return s.type=this.interpolateLuceneQuery(s.type),(0,Re.n)(this.getFields(s.type,i));if("terms"===s.find)return s.field=this.interpolateLuceneQuery(s.field),s.query=this.interpolateLuceneQuery(s.query),(0,Re.n)(this.getTerms(s,i))}return Promise.resolve([])}getTagKeys(){return(0,Re.n)(this.getFields())}getTagValues(e){const t=this.timeSrv.timeRange();return(0,Re.n)(this.getTerms({field:e.key},t))}targetContainsTemplate(e){if(this.templateSrv.containsTemplate(e.query)||this.templateSrv.containsTemplate(e.alias))return!0;for(const t of e.bucketAggs)if(this.templateSrv.containsTemplate(t.field)||this.objectContainsTemplate(t.settings))return!0;for(const t of e.metrics)if(this.templateSrv.containsTemplate(t.field)||this.objectContainsTemplate(t.settings)||this.objectContainsTemplate(t.meta))return!0;return!1}isPrimitive(e){return null==e||!!["string","number","boolean"].some((e=>"boolean"===e))}objectContainsTemplate(e){if(!e)return!1;for(const t of Object.keys(e))if(this.isPrimitive(e[t])){if(this.templateSrv.containsTemplate(e[t]))return!0}else if(Array.isArray(e[t])){for(const i of e[t])if(this.objectContainsTemplate(i))return!0}else if(this.objectContainsTemplate(e[t]))return!0;return!1}modifyQuery(e,t){var i;if(!t.options)return e;let s=null!==(i=e.query)&&void 0!==i?i:"";switch(t.type){case"ADD_FILTER":s.length>0&&(s+=" AND "),s+=`${t.options.key}:"${t.options.value}"`;break;case"ADD_FILTER_OUT":s.length>0&&(s+=" AND "),s+=`-${t.options.key}:"${t.options.value}"`}return Object.assign({},e,{query:s})}}function us(e){const t=(0,Vi.F)();if(e.datasourceUid){var i;const s=t.getInstanceSettings(e.datasourceUid);return{title:e.urlDisplayLabel||"",url:"",internal:{query:{query:e.url},datasourceUid:e.datasourceUid,datasourceName:null!==(i=null==s?void 0:s.name)&&void 0!==i?i:"Data source not found"}}}return{title:e.urlDisplayLabel||"",url:e.url}}const cs=new s.hf(ds).setQueryEditor((e=>{let{query:t,onChange:i,onRunQuery:s,datasource:a,range:n}=e;return Q(a.esVersion)?(0,be.jsx)(_e,{datasource:a,onChange:i,onRunQuery:s,query:t,range:n||(0,l.JK)(),children:(0,be.jsx)(Ht,{value:t})}):Rt||(Rt=(0,be.jsx)(r.b,{title:"Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) was removed"}))})).setConfigEditor((e=>{const t=(0,n.useRef)("direct"===e.options.access),{options:i,onOptionsChange:s}=e,a=ji(i);(0,n.useEffect)((()=>{(e=>!!(0,B.valid)(e.jsonData.esVersion)&&!!e.jsonData.timeField&&!!e.jsonData.maxConcurrentShardRequests&&void 0!==e.jsonData.logMessageField&&void 0!==e.jsonData.logLevelField)(i)||s(ji(i))}),[]);const l=Q(a.jsonData.esVersion);return(0,be.jsxs)(be.Fragment,{children:["direct"===a.access&&(_i||(_i=(0,be.jsx)(r.b,{title:"Error",severity:"error",children:"Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode."}))),!l&&(ki||(ki=(0,be.jsx)(r.b,{title:"Deprecation notice",severity:"error",children:"Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) was removed"}))),(0,be.jsx)(Ut.E,{defaultUrl:"http://localhost:9200",dataSourceConfig:a,showAccessOptions:t.current,onChange:s,sigV4AuthToggleEnabled:Yt.vc.sigV4AuthEnabled,renderSigV4Editor:(0,be.jsx)(Qt.SIGV4ConnectionConfig,Object.assign({},e))}),(0,be.jsx)(mi,{value:a,onChange:s}),(0,be.jsx)(xi,{value:a.jsonData,onChange:e=>s(Object.assign({},a,{jsonData:e}))}),(0,be.jsx)(di,{value:a.jsonData.dataLinks,onChange:e=>{s(Object.assign({},a,{jsonData:Object.assign({},a.jsonData,{dataLinks:e})}))}})]})}))}}]);
//# sourceMappingURL=elasticsearchPlugin.da08164816098f4c83d5.js.map